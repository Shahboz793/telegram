<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BrandNomi â€” IndexedDB asosida foydalanuvchi profili, tahrir va tiklash bilan sayt</title>
  <style>
    :root{--bg:#0b1220;--card:#0f172a;--text:#e2e8f0;--muted:#94a3b8;--primary:#38bdf8;--accent:#22d3ee;--border:#1e293b;--shadow:0 12px 30px rgba(8,15,40,.35);--radius:14px}
    *{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text)}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
    .logo{font-weight:700;font-size:20px}
    .btn{background:var(--primary);color:white;padding:8px 12px;border-radius:10px;border:0;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--text)}
    .card{background:var(--card);border-radius:12px;padding:16px;border:1px solid var(--border);box-shadow:var(--shadow)}
    .auth-panel{position:fixed;inset:0;display:grid;place-items:center;background:rgba(2,6,23,.6);z-index:60}
    .auth{width:380px;background:var(--card);padding:18px;border-radius:12px;border:1px solid var(--border)}
    .tabs{display:flex;gap:6px;margin-bottom:12px}
    .tabs button{flex:1;padding:8px;border-radius:8px;border:0;background:transparent;color:var(--muted);cursor:pointer}
    .tabs button.active{background:linear-gradient(90deg,var(--primary),var(--accent));color:#022}
    .field{display:grid;margin-bottom:10px}
    .field label{font-size:13px;color:var(--muted);margin-bottom:6px}
    .field input{padding:10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)}
    .hint{font-size:13px;color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center}
    .avatar{width:56px;height:56px;border-radius:50%;display:grid;place-items:center;font-weight:800;letter-spacing:.5px;color:#0b1220;user-select:none}
    .avatar.lg{width:72px;height:72px;font-size:20px}
  </style>
</head>
<body>
  <header class="container">
    <div class="logo">BrandNomi</div>
  </header>

  <main class="container">
    <div id="userArea" class="card" style="margin-top:20px"></div>
  </main>

  <div id="authPanel" class="auth-panel">
    <div class="auth card">
      <div class="tabs">
        <button id="tabLogin" type="button" class="active">Kirish</button>
        <button id="tabRegister" type="button">Ro'yxatdan o'tish</button>
        <button id="tabReset" type="button">Parolni tiklash</button>
      </div>

      <form id="loginForm">
        <div class="field"><label>Login</label><input id="login_username" required></div>
        <div class="field"><label>Parol</label><input id="login_password" type="password" required></div>
        <button class="btn" type="submit">Kirish</button>
        <p id="loginMsg" class="hint"></p>
      </form>

      <form id="registerForm" style="display:none">
        <div class="field"><label>F.I.SH</label><input id="reg_fullname" required></div>
        <div class="field"><label>Login</label><input id="reg_username" required></div>
        <div class="field"><label>Parol</label><input id="reg_password" type="password" required></div>
        <button class="btn" type="submit">Ro'yxatdan o'tish</button>
        <p id="regMsg" class="hint"></p>
      </form>

      <form id="resetForm" style="display:none">
        <div class="field"><label>F.I.SH</label><input id="reset_fullname" required></div>
        <div class="field"><label>Yangi parol</label><input id="reset_newpass" type="password" required></div>
        <button class="btn" type="submit">Tiklash</button>
        <p id="resetMsg" class="hint"></p>
      </form>
    </div>
  </div>

  <div id="editPanel" class="auth-panel" style="display:none">
    <div class="auth card">
      <h3 class="row"><span class="avatar lg" id="editAvatar">AA</span> Profilni tahrirlash</h3>
      <form id="editForm">
        <div class="field"><label>Yangi F.I.SH</label><input id="edit_fullname" required></div>
        <div class="field"><label>Yangi login</label><input id="edit_username" required></div>
        <div class="field"><label>Yangi parol</label><input id="edit_password" type="password" required></div>
        <div class="row" style="justify-content:space-between">
          <button class="btn" type="submit">Saqlash</button>
          <button class="btn ghost" type="button" onclick="document.getElementById('editPanel').style.display='none'">Bekor qilish</button>
        </div>
        <p id="editMsg" class="hint"></p>
      </form>
    </div>
  </div>

  <script>
    const DB_NAME='BrandNomiDB', DB_VERSION=2;
    let db;

    function openDB(){return new Promise((res,rej)=>{const req=indexedDB.open(DB_NAME,DB_VERSION);req.onerror=()=>rej('DB error');req.onsuccess=e=>{db=e.target.result;res(db)};req.onupgradeneeded=e=>{db=e.target.result;if(!db.objectStoreNames.contains('users'))db.createObjectStore('users',{keyPath:'username'});if(!db.objectStoreNames.contains('current'))db.createObjectStore('current',{keyPath:'id'});}})}

    async function tx(store,mode){return db.transaction(store,mode).objectStore(store)}
    async function saveUser(u){const s=tx('users','readwrite');s.put(u)}
    async function getUser(name){return new Promise(r=>{const s=tx('users','readonly');const q=s.get(name);q.onsuccess=()=>r(q.result||null)})}
    async function allUsers(){return new Promise(r=>{const s=tx('users','readonly');const q=s.getAll();q.onsuccess=()=>r(q.result||[])})}
    async function setCur(u){const s=tx('current','readwrite');s.put({id:1,username:u})}
    async function getCur(){return new Promise(r=>{const s=tx('current','readonly');const q=s.get(1);q.onsuccess=()=>r(q.result?q.result.username:null)})}
    async function clrCur(){const s=tx('current','readwrite');s.clear()}

    async function hashString(s){const d=new TextEncoder().encode(s);const h=await crypto.subtle.digest('SHA-256',d);return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('')}

    function initialsFrom(f=''){const p=f.trim().toUpperCase().split(/\s+/);return p.length>1?p[0][0]+p[1][0]:p[0].slice(0,2)}
    function pastelFromSeed(seed=''){let h=0;for(let i=0;i<seed.length;i++)h=(h*31+seed.charCodeAt(i))>>>0;h=h%360;return`hsl(${h} 70% 70%)`}

    const loginForm=document.getElementById('loginForm'),regForm=document.getElementById('registerForm'),resetForm=document.getElementById('resetForm');
    const tabLogin=document.getElementById('tabLogin'),tabRegister=document.getElementById('tabRegister'),tabReset=document.getElementById('tabReset');

    function show(x){[loginForm,regForm,resetForm].forEach(f=>f.style.display='none');document.querySelectorAll('.tabs button').forEach(t=>t.classList.remove('active'));if(x==='login'){loginForm.style.display='block';tabLogin.classList.add('active')}if(x==='register'){regForm.style.display='block';tabRegister.classList.add('active')}if(x==='reset'){resetForm.style.display='block';tabReset.classList.add('active')}}
    tabLogin.onclick=()=>show('login');tabRegister.onclick=()=>show('register');tabReset.onclick=()=>show('reset');

    loginForm.onsubmit=async e=>{e.preventDefault();const u=login_username.value.trim().toLowerCase(),p=login_password.value;const d=await getUser(u);if(!d){loginMsg.textContent='Login topilmadi';return}if(d.passwordHash!==await hashString(p)){loginMsg.textContent='Parol xato';return}await setCur(u);document.getElementById('authPanel').style.display='none';render()}

    regForm.onsubmit=async e=>{e.preventDefault();const f=reg_fullname.value.trim().toLowerCase(),u=reg_username.value.trim().toLowerCase(),p=reg_password.value;if(await getUser(u)){regMsg.textContent='Bu login mavjud';return}const passwordHash=await hashString(p);await saveUser({fullname:f,username:u,passwordHash,avatarColor:pastelFromSeed(u)});await setCur(u);document.getElementById('authPanel').style.display='none';render()}

    resetForm.onsubmit=async e=>{e.preventDefault();const f=reset_fullname.value.trim().toLowerCase(),newp=reset_newpass.value;const users=await allUsers();const target=users.find(x=>x.fullname===f);if(!target){resetMsg.textContent='Bunday ism topilmadi';return}target.passwordHash=await hashString(newp);await saveUser(target);resetMsg.textContent='Parol yangilandi!'}

    document.getElementById('editForm').onsubmit=async e=>{e.preventDefault();const c=await getCur();if(!c)return;const u=await getUser(c);const nf=edit_fullname.value.trim().toLowerCase(),nu=edit_username.value.trim().toLowerCase(),np=edit_password.value;const exist=await getUser(nu);if(nu!==c&&exist){editMsg.textContent='Bu login band';return}const updated={fullname:nf,username:nu,passwordHash:await hashString(np),avatarColor:u.avatarColor||pastelFromSeed(nu)};await saveUser(updated);if(nu!==c){const s=tx('users','readwrite');s.delete(c)}await setCur(nu);editMsg.textContent='Saqlangan!';setTimeout(()=>{document.getElementById('editPanel').style.display='none';render()},800)}

    async function render(){const d=document.getElementById('userArea');const c=await getCur();if(!c){d.innerHTML='<button class="btn" onclick="document.getElementById(\'authPanel\').style.display=\'grid\'">Kirish / Ro\'yxatdan o\'tish</button>';return}const u=await getUser(c);const ini=initialsFrom(u.fullname);const col=u.avatarColor||pastelFromSeed(c);d.innerHTML=`<div class='row'><span class='avatar' style='background:${col}'>${ini}</span><div><b>${u.fullname}</b><br><span class='hint'>@${u.username}</span></div></div><div class='row' style='margin-top:12px'><button class='btn' id='editBtn'>Profilni tahrirlash</button><button class='btn ghost' onclick='clrCur();render()'>Chiqish</button></div>`;document.getElementById('editBtn').onclick=()=>{edit_fullname.value=u.fullname;edit_username.value=u.username;edit_password.value='';editAvatar.textContent=ini;editAvatar.style.background=col;document.getElementById('editPanel').style.display='grid'}}

    openDB().then(()=>render());
  </script>
</body>
</html>
