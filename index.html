<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TestMaster — Login Everywhere (no-pass enforcement)</title>
  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--border:#e5e7eb;
      --primary:#2563eb;--good:#16a34a;--bad:#ef4444;--amber:#f59e0b;
      --radius:14px;--shadow:0 10px 24px rgba(15,23,42,.08)
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;color:var(--text);background:var(--bg)}
    .wrap{max-width:1000px;margin:24px auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:14px}
    h1{margin:0 0 8px}
    .muted{color:var(--muted);font-size:13px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    input{padding:10px;border:1px solid var(--border);border-radius:10px;width:100%}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.ghost{background:#f8fafc}
    .btn.small{padding:6px 10px}
    .flex{display:flex;gap:8px;align-items:center}
    .space{flex:1}
    .hidden{display:none!important}

    /* Big, colorful ABCD buttons */
    .answer-pad{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .opt{padding:16px 22px;border-radius:12px;border:1px solid var(--border);min-width:72px;text-align:center;font-weight:800;font-size:18px;cursor:pointer}
    .opt[data-v="A"]{background:#eff6ff;border-color:#c7d2fe} /* blue */
    .opt[data-v="B"]{background:#ecfdf5;border-color:#bbf7d0} /* green */
    .opt[data-v="C"]{background:#fffbeb;border-color:#fde68a} /* yellow */
    .opt[data-v="D"]{background:#fff1f2;border-color:#fecaca} /* pink */
    .opt.active{box-shadow:0 6px 18px rgba(15,23,42,.08);transform:translateY(-2px)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
    th{font-size:12px;color:var(--muted);text-transform:uppercase}
    .tag{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;border:1px solid #e0e7ff;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>TestMaster</h1>
      <div class="muted">Login “bir xil bo‘lsa” hamma qurilmada kiradi. Logoutdan keyin login eslab qoladi, ammo kirishda tugmani bosish kerak.</div>
    </div>

    <!-- Unified user auth (login+optional pass) -->
    <div class="card" id="authCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Kirish</strong>
        <div class="muted">Ro‘yxatdan o‘tish shart emas: login yozib kirsangiz, shu login saqlanadi.</div>
      </div>
      <div style="margin-top:10px" class="row">
        <div>
          <label>Login (majburiy)</label>
          <input id="userLogin" placeholder="Masalan: AliValiyev" />
        </div>
        <div>
          <label>Kod (ixtiyoriy)</label>
          <input id="userPass" type="password" placeholder="" />
        </div>
      </div>

      <div style="margin-top:10px" class="flex">
        <button class="btn primary" onclick="loginUser()">Kirish</button>
        <button class="btn ghost" onclick="fillDemo()">Demo</button>
        <div class="space"></div>
        <button class="btn small" onclick="runSelfTests()">Self-test</button>
      </div>

      <div style="margin-top:10px" class="muted">
        Eslatma: Login shu brauzerda saqlanadi. Boshqa qurilmada ham shu login bilan kirishingiz mumkin — parol tekshirilmaydi.
      </div>
    </div>

    <!-- Admin login (blank, no code shown) -->
    <div class="card" id="adminAuthCard">
      <strong>Admin kirish</strong>
      <div class="row" style="margin-top:8px">
        <div><input id="adminLogin" placeholder="" /></div>
        <div><input id="adminCode" placeholder="" type="password" /></div>
      </div>
      <div style="margin-top:8px" class="flex">
        <button class="btn primary" onclick="loginAdmin()">Admin sifatida kirish</button>
        <div class="space"></div>
        <div class="muted">Admin qiymatlari ko‘rsatilmaydi.</div>
      </div>
    </div>

    <!-- Admin Panel -->
    <div class="card hidden" id="adminCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Admin — boshqaruv</strong>
        <div><button class="btn small" onclick="logout()">Chiqish</button></div>
      </div>

      <div style="margin-top:10px" class="row">
        <div class="card" style="margin:8px 0">
          <strong>Test yaratish</strong>
          <div style="margin-top:8px">
            <label>Test nomi</label><input id="tName" />
            <label style="margin-top:8px">Maxsus kod</label><input id="tCode" />
            <label style="margin-top:8px">Savollar soni</label><input id="tCount" type="number" value="5" min="1" />
            <div style="margin-top:8px" class="flex">
              <button class="btn" onclick="buildAnswerGrid()">Javob panellari</button>
              <button class="btn primary" onclick="saveTest()">Saqlash</button>
            </div>
            <div id="answerGrid" style="margin-top:8px"></div>
          </div>
        </div>

        <div class="card" style="margin:8px 0">
          <strong>Saqlangan testlar & foydalanuvchilar</strong>
          <div id="adminTests" style="margin-top:8px"></div>
          <div id="adminUsers" style="margin-top:8px"></div>
        </div>
      </div>
    </div>

    <!-- User tests list -->
    <div class="card hidden" id="userCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Saqlangan testlar</strong>
        <div><span id="whoTag" class="tag"></span> <button class="btn small" onclick="logout()">Chiqish</button></div>
      </div>
      <div id="testsList" style="margin-top:10px"></div>
    </div>

    <!-- Play area -->
    <div class="card hidden" id="playCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong id="playTitle">Test</strong>
        <div><button class="btn small" onclick="backToList()">⬅️ Orqaga</button></div>
      </div>
      <div id="playBody" style="margin-top:10px"></div>
      <div style="margin-top:10px" class="flex"><div class="space"></div><button class="btn primary" onclick="finishTest()">Yakunlash</button></div>
    </div>

    <!-- Results -->
    <div class="card hidden" id="resultsCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong id="resTitle">Natijalar</strong>
        <div><button class="btn small" onclick="backToList()">Orqaga</button></div>
      </div>
      <div id="leaderboardWrap" style="margin-top:8px"></div>
      <div id="detailWrap" style="margin-top:8px"></div>
      <div style="margin-top:8px" class="flex">
        <div class="space"></div><button class="btn" onclick="copyTg()">Telegramga nusxa</button>
      </div>
    </div>
  </div>

<script>
/* ===== Storage helpers ===== */
const LS = {
  testsKey: 'tm_tests_v4',
  usersKey: 'tm_users_v4', // stores {login, pass?}
  resultsKey: code=>`tm_results_${code}`,
  lastUserKey: 'tm_last_user_v4',
  get tests(){ return JSON.parse(localStorage.getItem(this.testsKey)||'[]') },
  set tests(v){ localStorage.setItem(this.testsKey, JSON.stringify(v)) },
  get users(){ return JSON.parse(localStorage.getItem(this.usersKey)||'[]') },
  set users(v){ localStorage.setItem(this.usersKey, JSON.stringify(v)) },
  getResults(code){ return JSON.parse(localStorage.getItem(this.resultsKey(code))||'[]') },
  setResults(code, arr){ localStorage.setItem(this.resultsKey(code), JSON.stringify(arr)) }
};

/* ===== Session ===== */
let SESSION = { role:null, login:null };

/* ===== UI helpers ===== */
function show(id,on=true){ document.getElementById(id).classList.toggle('hidden', !on) }
function logout(){
  SESSION={role:null,login:null};
  show('adminCard',false); show('userCard',false); show('playCard',false); show('resultsCard',false);
  show('authCard',true); show('adminAuthCard',true);
}

/* ===== Auth: login works anywhere (no pass enforcement) ===== */
function findUser(login){ return (LS.users||[]).find(u=>u.login.toLowerCase()===login.toLowerCase()); }

function loginUser(){
  const login = document.getElementById('userLogin').value.trim();
  const pass  = document.getElementById('userPass').value.trim();
  if(!login){ alert('Login kiriting'); return; }

  // If user exists: ignore password check (device-agnostic login)
  // If not exists: create it right now (so this login works on this device from now on)
  let u = findUser(login);
  if(!u){
    u = { login, pass }; // pass is optional
    LS.users = [...LS.users, u];
  }
  SESSION = { role:'user', login: u.login };
  localStorage.setItem(LS.lastUserKey, u.login);

  document.getElementById('whoTag').textContent = u.login;
  show('authCard', false); show('adminAuthCard', false);
  show('userCard', true);
  renderTestsList();
}

/* Admin login (fields are blank, code not shown) */
function loginAdmin(){
  const login = document.getElementById('adminLogin').value.trim();
  const code  = document.getElementById('adminCode').value.trim();
  if(login.toLowerCase()==='qwerty' && code==='2768'){
    SESSION = { role:'admin', login:'ADMIN' };
    show('authCard', false); show('adminAuthCard', false);
    show('adminCard', true);
    renderAdminLists();
  } else {
    alert('Admin login yoki kod xato');
  }
}

/* ===== Admin functions (tests & users) ===== */
function buildAnswerGrid(){
  const count = parseInt(document.getElementById('tCount').value||'0');
  const grid = document.getElementById('answerGrid');
  grid.innerHTML = '';
  for(let i=1;i<=count;i++){
    const wrapper = document.createElement('div');
    wrapper.style.margin = '6px 0';
    wrapper.innerHTML = `<strong style="display:inline-block;width:28px">${i}.</strong>`;
    const pad = document.createElement('div'); pad.className='answer-pad';
    ['A','B','C','D'].forEach(ch=>{
      const b = document.createElement('button'); b.className='opt'; b.dataset.v=ch; b.textContent=ch;
      b.addEventListener('click', ()=>{ [...pad.children].forEach(x=>x.classList.remove('active')); b.classList.add('active'); wrapper.dataset.answer=ch; });
      pad.appendChild(b);
    });
    wrapper.appendChild(pad); grid.appendChild(wrapper);
  }
}

function saveTest(){
  const name = document.getElementById('tName').value.trim();
  const code = document.getElementById('tCode').value.trim();
  const count = parseInt(document.getElementById('tCount').value||'0');
  if(!name || !code || !count){ alert('Nomi, kod va savollar soni to\'ldirilsin'); return; }
  const rows = [...document.getElementById('answerGrid').querySelectorAll('div')];
  if(rows.length !== count){ alert('Avval javob panellarini yarating'); return; }
  const answers = rows.map((r,i)=> r.dataset.answer || (alert((i+1)+'-savol uchun javob belgilansin'), null));
  if(answers.some(x=>!x)) return;
  const tests = LS.tests.filter(t=>t.code !== code);
  tests.push({ name, code, count, key:answers });
  LS.tests = tests;
  alert('Test saqlandi');
  document.getElementById('tName').value=''; document.getElementById('tCode').value=''; document.getElementById('tCount').value=5; document.getElementById('answerGrid').innerHTML='';
  renderAdminLists();
}

function renderAdminLists(){
  const tbox = document.getElementById('adminTests'); tbox.innerHTML='';
  if(!LS.tests.length){ tbox.innerHTML = '<div class="muted">Testlar yoʻq</div>'; }
  else {
    LS.tests.forEach(t=>{
      const div = document.createElement('div'); div.className='card'; div.style.margin='6px 0';
      const res = LS.getResults(t.code); const best = res.length? Math.max(...res.map(r=>r.score)) : 0;
      div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><strong>${t.name}</strong><span class="muted">kod: ${t.code} • ${t.count} savol</span></div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button class="btn" onclick="viewResults('${t.code}')">Natijalar</button>
        <button class="btn" onclick="deleteTest('${t.code}')">O'chirish</button>
        <div class="space"></div><span class="tag">Eng yaxshi: ${best}/${t.count}</span>
      </div>`;
      tbox.appendChild(div);
    });
  }

  const ubox = document.getElementById('adminUsers'); ubox.innerHTML='';
  if(!LS.users.length){ ubox.innerHTML='<div class="muted">Foydalanuvchilar yoʻq</div>'; }
  else {
    const table = document.createElement('table'); let html = '<thead><tr><th>#</th><th>Login</th><th>Kod (agar saqlangan bo‘lsa)</th></tr></thead><tbody>';
    LS.users.forEach((u,i)=> html += `<tr><td>${i+1}</td><td>${escapeHtml(u.login)}</td><td>${escapeHtml(u.pass||'—')}</td></tr>`);
    html += '</tbody>'; table.innerHTML = html; ubox.appendChild(table);
  }
}

function deleteTest(code){
  if(!confirm('Testni oʻchirasizmi?')) return;
  LS.tests = LS.tests.filter(t=>t.code!==code);
  localStorage.removeItem(LS.resultsKey(code));
  renderAdminLists();
  alert('Oʻchirildi');
}

/* ===== User: list tests ===== */
function renderTestsList(){
  const box = document.getElementById('testsList'); box.innerHTML='';
  if(!LS.tests.length){ box.innerHTML = '<div class="muted">Testlar yoʻq</div>'; return; }
  LS.tests.forEach(t=>{
    const res = LS.getResults(t.code);
    const best = res.length? Math.max(...res.map(r=>r.score)) : 0;
    const attempted = SESSION.login ? res.some(r=>r.login === SESSION.login) : false;
    const card = document.createElement('div'); card.className='card'; card.style.margin='6px 0';
    card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><strong>${t.name}</strong><span class="muted">${t.count} savol</span></div>`;
    const controls = document.createElement('div'); controls.style.marginTop='8px'; controls.style.display='flex'; controls.style.gap='8px'; controls.style.alignItems='center';
    if(attempted) {
      const pill = document.createElement('span'); pill.className='tag'; pill.textContent='Siz bu testni ishlagansiz'; controls.appendChild(pill);
    } else {
      const btn = document.createElement('button'); btn.className='btn primary'; btn.textContent='Testni ishlash'; btn.onclick = ()=> startTest(t.code); controls.appendChild(btn);
    }
    const btnRes = document.createElement('button'); btnRes.className='btn'; btnRes.textContent='Natijalar'; btnRes.onclick=()=>viewResults(t.code); controls.appendChild(btnRes);
    const spacer = document.createElement('div'); spacer.className='space'; controls.appendChild(spacer);
    const tag = document.createElement('span'); tag.className='tag'; tag.textContent = `Eng: ${best}/${t.count}`; controls.appendChild(tag);
    card.appendChild(controls); box.appendChild(card);
  });
}

/* ===== Play test ===== */
let PLAY = { code:null, key:[], count:0, chosen:[] };

function startTest(code){
  const t = LS.tests.find(x=>x.code===code);
  if(!t){ alert('Test topilmadi'); return; }
  const res = LS.getResults(code);
  if(SESSION.login && res.some(r=>r.login===SESSION.login)){ alert('Siz bu testni allaqachon yakunlagansiz'); return; }
  PLAY = { code:code, key: t.key, count: t.count, chosen: new Array(t.count).fill(null) };
  document.getElementById('playTitle').textContent = `${t.name} — ${t.count} savol`;
  renderPlay();
  show('userCard', false); show('playCard', true);
}

function renderPlay(){
  const body = document.getElementById('playBody'); body.innerHTML='';
  for(let i=0;i<PLAY.count;i++){
    const row = document.createElement('div'); row.className='card'; row.style.margin='6px 0';
    row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><strong>${i+1}.</strong><div class="muted">Savol ${i+1}</div></div>`;
    const pad = document.createElement('div'); pad.className='answer-pad';
    ['A','B','C','D'].forEach(ch=>{
      const b = document.createElement('button'); b.className='opt'; b.dataset.v=ch; b.textContent=ch;
      b.addEventListener('click', ()=>{ PLAY.chosen[i]=ch; [...pad.children].forEach(x=>x.classList.remove('active')); b.classList.add('active'); });
      pad.appendChild(b);
    });
    row.appendChild(pad); body.appendChild(row);
  }
}

function finishTest(){
  if(!SESSION.login){ alert('Kirish talab qilinadi'); return; }
  if(PLAY.chosen.some(x=>x===null)){ if(!confirm('Baʼzi savollar belgilanmagan. Baribir yakunlaysizmi?')) return; }
  const details=[]; let score=0;
  for(let i=0;i<PLAY.count;i++){
    const correct = PLAY.key[i]; const chosen = PLAY.chosen[i];
    const ok = chosen === correct; if(ok) score++;
    details.push({ q:i+1, chosen: chosen||'-', correct, ok });
  }
  const rec = { login: SESSION.login, score, total: PLAY.count, details, date: new Date().toISOString() };
  const arr = LS.getResults(PLAY.code);
  if(arr.some(r=>r.login === SESSION.login)){ alert('Siz bu testni ilgari tugatgansiz'); backToList(); return; }
  arr.push(rec); LS.setResults(PLAY.code, arr);
  viewResults(PLAY.code, rec);
}

/* ===== Results & Leaderboard ===== */
function viewResults(code, justMade=null){
  show('userCard', false); show('playCard', false); show('resultsCard', true);
  const t = LS.tests.find(x=>x.code===code); if(!t){ alert('Test topilmadi'); return; }
  document.getElementById('resTitle').textContent = `${t.name} — Natijalar`;
  const arr = LS.getResults(code).slice().sort((a,b)=> b.score-a.score || new Date(a.date)-new Date(b.date));
  const lb = document.getElementById('leaderboardWrap'); lb.innerHTML='';
  if(!arr.length){ lb.innerHTML = '<div class="muted">Natijalar yoʻq</div>'; }
  else {
    const table = document.createElement('table'); let h = '<thead><tr><th>#</th><th>Login</th><th>Ball</th><th>Sana</th></tr></thead><tbody>';
    arr.forEach((r,i)=> h += `<tr><td>${i+1}</td><td>${escapeHtml(r.login)}</td><td><strong>${r.score}/${r.total}</strong></td><td>${new Date(r.date).toLocaleString()}</td></tr>`);
    h += '</tbody>'; table.innerHTML = h; lb.appendChild(table);
  }

  const dw = document.getElementById('detailWrap');
  if(justMade){ dw.innerHTML = renderDetail(justMade); } else { dw.innerHTML = '<div class="muted">Aynan urinishni ko‘rish uchun testni yakunlang.</div>'; }
}

function renderDetail(rec){
  let html = '<div class="card" style="margin:0">';
  html += `<strong>${escapeHtml(rec.login)}</strong> — <span class="tag">${rec.score}/${rec.total}</span>`;
  html += '<div style="margin-top:8px"><table><thead><tr><th>#</th><th>Tanlangan</th><th>Toʻgʻri</th><th>Holat</th></tr></thead><tbody>';
  rec.details.forEach(d=> html += `<tr><td>${d.q}</td><td>${d.chosen}</td><td>${d.correct}</td><td>${d.ok?'<span style="color:green">toʻgʻri</span>':'<span style="color:red">xato</span>'}</td></tr>`);
  html += '</tbody></table></div></div>';
  return html;
}

/* utils */
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])) }

/* copy to clipboard (stub) */
function copyTg(){ alert('Natijani nusxalash keyingi versiyada qoʻshiladi.'); }

/* Demo filler */
function fillDemo(){ document.getElementById('userLogin').value='demo'; document.getElementById('userPass').value=''; }

/* Self-tests */
function runSelfTests(){
  const out=[];
  try{
    // 1) Login should create user if missing (no pass needed)
    const rnd = 'self_'+Math.random().toString(36).slice(2,6);
    const before = LS.users.length;
    document.getElementById('userLogin').value = rnd;
    document.getElementById('userPass').value = '';
    loginUser();
    if(!findUser(rnd)) throw new Error('user not created on login');
    out.push('✅ Login creates user if missing (no pass)');
    // 2) Admin placeholders blank
    out.push(document.getElementById('adminLogin').placeholder==='' && document.getElementById('adminCode').placeholder==='' ? '✅ Admin fields blank' : '❌ Admin placeholders not blank');
  }catch(e){ out.push('❌ Self-test error: '+e.message); }
  alert(out.join('\n'));
}

/* ===== Boot: prefill last login (no auto-login) ===== */
(function boot(){
  try{
    const last = localStorage.getItem(LS.lastUserKey);
    if(last){
      const u = findUser(last);
      if(u){
        document.getElementById('userLogin').value = u.login;
        // do not auto-login; user must click Kirish (your preference)
      }
    }
  }catch(e){}
})();
</script>
</body>
</html>
