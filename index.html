<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BrandNomi â€” Firebase Login tizimi</title>
  <style>
    :root{--bg:#0b1220;--card:#0f172a;--text:#e2e8f0;--muted:#94a3b8;--primary:#38bdf8;--accent:#22d3ee;--border:#1e293b;--shadow:0 12px 30px rgba(8,15,40,.35);--radius:14px}
    *{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text)}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
    .logo{font-weight:700;font-size:20px}
    .btn{background:var(--primary);color:white;padding:8px 12px;border-radius:10px;border:0;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--text)}
    .card{background:var(--card);border-radius:12px;padding:16px;border:1px solid var(--border);box-shadow:var(--shadow)}
    .auth-panel{position:fixed;inset:0;display:grid;place-items:center;background:rgba(2,6,23,.6);z-index:60}
    .auth{width:420px;background:var(--card);padding:18px;border-radius:12px;border:1px solid var(--border)}
    .tabs{display:flex;gap:6px;margin-bottom:12px}
    .tabs button{flex:1;padding:8px;border-radius:8px;border:0;background:transparent;color:var(--muted);cursor:pointer}
    .tabs button.active{background:linear-gradient(90deg,var(--primary),var(--accent));color:#022}
    .field{display:grid;margin-bottom:10px}
    .field label{font-size:13px;color:var(--muted);margin-bottom:6px}
    .field input{padding:10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)}
    .hint{font-size:13px;color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center}
    .avatar{width:56px;height:56px;border-radius:50%;display:grid;place-items:center;font-weight:800;letter-spacing:.5px;color:#0b1220;user-select:none}
    .avatar.lg{width:72px;height:72px;font-size:20px}
  </style>
</head>
<body>
  <header class="container"><div class="logo">BrandNomi</div></header>
  <main class="container">
    <div id="welcome" class="card">
      <h2>Firebase asosidagi umumiy login tizimi</h2>
      <p class="hint">Roâ€˜yxatdan oâ€˜tish, kirish, parolni tiklash, profilni tahrirlash. Maâ€™lumotlar Firestore bazasida saqlanadi â€” istalgan qurilmadan kirish mumkin.</p>
    </div>
    <div id="userArea" class="card" style="margin-top:20px"></div>
  </main>

  <div id="authPanel" class="auth-panel">
    <div class="auth card">
      <div class="tabs">
        <button id="tabLogin" type="button" class="active">Kirish</button>
        <button id="tabRegister" type="button">Ro'yxatdan o'tish</button>
        <button id="tabReset" type="button">Parolni tiklash</button>
      </div>

      <form id="loginForm">
        <div class="field"><label>Login</label><input id="login_username" required></div>
        <div class="field"><label>Parol</label><input id="login_password" type="password" required></div>
        <button class="btn" type="submit">Kirish</button><p id="loginMsg" class="hint"></p>
      </form>

      <form id="registerForm" style="display:none">
        <div class="field"><label>F.I.SH</label><input id="reg_fullname" required></div>
        <div class="field"><label>Login</label><input id="reg_username" required></div>
        <div class="field"><label>Parol</label><input id="reg_password" type="password" required></div>
        <button class="btn" type="submit">Ro'yxatdan o'tish</button><p id="regMsg" class="hint"></p>
      </form>

      <form id="resetForm" style="display:none">
        <div class="field"><label>F.I.SH</label><input id="reset_fullname" required></div>
        <div class="field"><label>Yangi parol</label><input id="reset_newpass" type="password" required></div>
        <div class="row" style="justify-content:space-between">
          <button class="btn" type="submit">Tiklash</button>
          <button class="btn ghost" type="button" id="remindLoginBtn">Loginni eslatish</button>
        </div>
        <p id="resetMsg" class="hint"></p>
      </form>
    </div>
  </div>

  <div id="editPanel" class="auth-panel" style="display:none">
    <div class="auth card">
      <h3 class="row"><span class="avatar lg" id="editAvatar">AA</span> Profilni tahrirlash</h3>
      <form id="editForm">
        <div class="field"><label>Yangi F.I.SH</label><input id="edit_fullname" required></div>
        <div class="field"><label>Yangi login</label><input id="edit_username" required></div>
        <div class="field"><label>Yangi parol</label><input id="edit_password" type="password" required></div>
        <div class="row" style="justify-content:space-between">
          <button class="btn" type="submit">Saqlash</button>
          <button class="btn ghost" type="button" onclick="document.getElementById('editPanel').style.display='none'">Bekor qilish</button>
        </div>
        <p id="editMsg" class="hint"></p>
      </form>
    </div>
  </div>

  <!-- Firebase kutubxonalar -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <script>
    // ðŸ”¹ SHU JOYGA Oâ€˜ZINGNING FIREBASE CONFIGINGNI QOâ€˜Y!
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- Foydali funksiyalar
    async function hashString(s){const data=new TextEncoder().encode(s);const h=await crypto.subtle.digest('SHA-256',data);return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('');}
    function initialsFrom(n){const p=(n||'').trim().toUpperCase().split(/\\s+/);if(p.length==1)return p[0].slice(0,2);return(p[0][0]||'')+(p[1][0]||'');}
    function pastelFromSeed(s){let h=0;for(let i=0;i<s.length;i++)h=(h*31+s.charCodeAt(i))>>>0;return`hsl(${h%360} 70% 70%)`;}
    const LS_CUR='bn_cur';const cur=()=>sessionStorage.getItem(LS_CUR);const setCur=u=>sessionStorage.setItem(LS_CUR,u);const clearCur=()=>sessionStorage.removeItem(LS_CUR);
    function userRef(u){return db.collection('users').doc(u)}

    // --- UI
    const tabLogin=document.getElementById('tabLogin'),tabRegister=document.getElementById('tabRegister'),tabReset=document.getElementById('tabReset');
    const loginForm=document.getElementById('loginForm'),regForm=document.getElementById('registerForm'),resetForm=document.getElementById('resetForm');
    tabLogin.onclick=()=>show('login');tabRegister.onclick=()=>show('register');tabReset.onclick=()=>show('reset');
    function show(x){[tabLogin,tabRegister,tabReset].forEach(t=>t.classList.remove('active'));loginForm.style.display=regForm.style.display=resetForm.style.display='none';if(x==='login'){tabLogin.classList.add('active');loginForm.style.display='block'}if(x==='register'){tabRegister.classList.add('active');regForm.style.display='block'}if(x==='reset'){tabReset.classList.add('active');resetForm.style.display='block'}}

    // --- Roâ€˜yxatdan oâ€˜tish
    regForm.onsubmit=async e=>{
      e.preventDefault();
      const f=reg_fullname.value.trim().toLowerCase(),l=reg_username.value.trim().toLowerCase(),p=reg_password.value;
      const exist=await userRef(l).get();if(exist.exists){regMsg.textContent='Bu login allaqachon mavjud.';return;}
      await userRef(l).set({fullname:f,fullnameLower:f,username:l,passwordHash:await hashString(p),avatarColor:pastelFromSeed(l),createdAt:Date.now()});
      setCur(l);document.getElementById('authPanel').style.display='none';render();
    };

    // --- Kirish
    loginForm.onsubmit=async e=>{
      e.preventDefault();
      const l=login_username.value.trim().toLowerCase(),p=login_password.value;
      const rec=await userRef(l).get();if(!rec.exists){loginMsg.textContent='Login topilmadi';return;}
      const d=rec.data();if(d.passwordHash!==await hashString(p)){loginMsg.textContent='Parol xato';return;}
      await userRef(l).update({lastLoginAt:Date.now()});setCur(l);document.getElementById('authPanel').style.display='none';render();
    };

    // --- Parolni tiklash
    resetForm.onsubmit=async e=>{
      e.preventDefault();
      const f=reset_fullname.value.trim().toLowerCase(),newp=reset_newpass.value;
      const q=await db.collection('users').where('fullnameLower','==',f).limit(1).get();
      if(q.empty){resetMsg.textContent='Foydalanuvchi topilmadi';return;}
      const doc=q.docs[0];await userRef(doc.id).update({passwordHash:await hashString(newp)});
      resetMsg.textContent='Parol tiklandi! Login: @'+doc.id;setTimeout(()=>show('login'),1500);
    };

    // --- Loginni eslatish
    document.getElementById('remindLoginBtn').onclick=async()=>{
      const f=reset_fullname.value.trim().toLowerCase();if(!f){resetMsg.textContent='Avval F.I.SH kiriting';return;}
      const q=await db.collection('users').where('fullnameLower','==',f).get();if(q.empty){resetMsg.textContent='Topilmadi';return;}
      resetMsg.textContent='Sizning login: '+q.docs.map(d=>'@'+d.id).join(', ');
    };

    // --- Profil tahriri
    document.getElementById('editForm').onsubmit=async e=>{
      e.preventDefault();const c=cur();if(!c)return;
      const r=await userRef(c).get();if(!r.exists)return;
      const nf=edit_fullname.value.trim().toLowerCase(),nu=edit_username.value.trim().toLowerCase(),np=edit_password.value;
      if(nu!==c){const ex=await userRef(nu).get();if(ex.exists){editMsg.textContent='Bu login band.';return;}
        const data=r.data();await userRef(nu).set({...data,fullname:nf,fullnameLower:nf,username:nu,passwordHash:await hashString(np),avatarColor:pastelFromSeed(nu)});
        await userRef(c).delete();setCur(nu);
      }else await userRef(c).update({fullname:nf,fullnameLower:nf,passwordHash:await hashString(np)});
      editMsg.textContent='Yangilandi';setTimeout(()=>{document.getElementById('editPanel').style.display='none';render();},800);
    };

    // --- Koâ€˜rsatish
    async function render(){
      const div=document.getElementById('userArea'),c=cur();if(!c){div.innerHTML='<button class=\"btn\" onclick=\"document.getElementById(\\'authPanel\\').style.display=\\'grid\\'\">Kirish / Ro\\'yxatdan o\\'tish</button>';return;}
      const rec=await userRef(c).get();if(!rec.exists){clearCur();return render();}
      const r=rec.data(),initials=initialsFrom(r.fullname),color=r.avatarColor||pastelFromSeed(r.username);
      const last=r.lastLoginAt?new Date(r.lastLoginAt).toLocaleString():'â€”';
      div.innerHTML=`<div class=\"row\"><span class=\"avatar\" style=\"background:${color}\">${initials}</span><div><b>${r.fullname}</b><br><span class=\"hint\">@${r.username}</span><br><span class=\"hint\">Oxirgi kirish: ${last}</span></div></div><div class=\"row\" style=\"margin-top:12px\"><button class='btn' id='editOpen'>Profilni tahrirlash</button><button class='btn ghost' id='logoutBtn'>Chiqish</button></div>`;
      document.getElementById('logoutBtn').onclick=()=>{clearCur();render()};
      document.getElementById('editOpen').onclick=()=>{edit_fullname.value=r.fullname;edit_username.value=r.username;edit_password.value='';editAvatar.textContent=initials;editAvatar.style.background=color;document.getElementById('editPanel').style.display='grid';};
    }
    render();
  </script>
</body>
</html>
