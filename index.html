<!doctype html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <title>Ona tili Pro ‚Äî Online o‚Äòquv markazi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f3f4f6;
      color:#111827;
    }
    a{text-decoration:none;color:inherit}

    .page{min-height:100vh;display:flex;flex-direction:column;}

    /* HEADER */
    .header{
      position:sticky;top:0;z-index:10;
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 20px;
      background:#0f172a;
      color:#e5e7eb;
      border-bottom:1px solid #1f2937;
    }
    .logo{
      font-weight:800;font-size:20px;
    }
    .logo span{color:#f97316;}
    .nav{display:flex;align-items:center;gap:14px;font-size:14px;}
    .nav a{color:#e5e7eb;opacity:.85;cursor:pointer;}
    .nav a:hover{opacity:1;}
    .nav .user-label{font-size:13px;opacity:.8;}
    .btn-outline{
      border:1px solid #e5e7eb;
      border-radius:999px;
      padding:4px 10px;
      font-size:13px;
      cursor:pointer;
      background:transparent;
      color:#e5e7eb;
    }

    /* LAYOUT */
    .container{
      max-width:1120px;
      margin:0 auto;
      padding:18px 12px 32px;
      flex:1 0 auto;
    }

    .section{
      margin-bottom:18px;
    }
    .hidden{display:none;}

    .card{
      background:#ffffff;
      border-radius:16px;
      padding:16px 16px 18px;
      box-shadow:0 18px 45px rgba(15,23,42,0.08);
      border:1px solid #e5e7eb;
    }
    .card h2{
      font-size:18px;
      margin-bottom:6px;
    }
    .card p.sub{
      font-size:13px;
      color:#6b7280;
      margin-bottom:10px;
    }

    .hero-text{
      font-size:14px;
      color:#4b5563;
    }

    .grid-2{
      display:grid;
      grid-template-columns:minmax(0,0.9fr) minmax(0,1.1fr);
      gap:16px;
    }
    @media(max-width:900px){
      .grid-2{grid-template-columns:minmax(0,1fr);}
    }

    /* FORM */
    .tabs{
      display:flex;
      gap:4px;
      margin-bottom:10px;
      background:#e5e7eb;
      border-radius:999px;
      padding:4px;
      width:max-content;
    }
    .tab-btn{
      border:none;
      border-radius:999px;
      padding:5px 12px;
      font-size:13px;
      cursor:pointer;
      background:transparent;
      color:#374151;
    }
    .tab-btn.active{
      background:#ffffff;
      box-shadow:0 2px 8px rgba(15,23,42,0.18);
      color:#111827;
    }

    .form{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:6px;
    }
    .form-row{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    label{
      font-size:13px;
      color:#4b5563;
    }
    input,textarea,select{
      border-radius:10px;
      border:1px solid #d1d5db;
      padding:8px 10px;
      background:#f9fafb;
      font-size:14px;
      color:#111827;
    }
    textarea{min-height:70px;resize:vertical;}
    .form-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:10px;
    }
    .btn{
      align-self:flex-start;
      padding:8px 16px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      background:linear-gradient(90deg,#6366f1,#ec4899);
      color:#ffffff;
      font-weight:600;
      font-size:14px;
      box-shadow:0 10px 22px rgba(129,140,248,0.45);
      transition:transform .1s ease,box-shadow .1s ease;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 14px 30px rgba(129,140,248,0.6);
    }
    .btn:active{
      transform:translateY(0);
      box-shadow:0 6px 14px rgba(129,140,248,0.4);
    }
    .btn-xs{
      border-radius:999px;
      border:1px solid #d1d5db;
      padding:2px 6px;
      font-size:11px;
      background:#ffffff;
      cursor:pointer;
    }
    .btn-xs:hover{
      background:#f3f4f6;
    }
    .hint{
      font-size:11px;
      color:#6b7280;
    }
    .error{
      font-size:12px;
      color:#b91c1c;
      margin-top:2px;
    }
    .pill{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      background:#eff6ff;
      color:#1d4ed8;
      width:max-content;
    }

    /* COURSES */
    .section-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    .muted{font-size:13px;color:#6b7280;}

    .course-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:12px;
      margin-top:6px;
    }
    .course-card{
      background:#f9fafb;
      border-radius:12px;
      border:1px solid #e5e7eb;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .course-title{
      font-size:15px;
      font-weight:600;
      color:#111827;
    }
    .course-desc{
      font-size:13px;
      color:#4b5563;
      max-height:60px;
      overflow:hidden;
    }
    .course-meta{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:11px;
    }
    .badge{
      padding:2px 8px;
      border-radius:999px;
      background:#e5e7eb;
      color:#374151;
    }
    .badge.free{
      background:#dcfce7;color:#166534;
    }
    .badge.price{
      background:#fef9c3;color:#854d0e;
    }

    .course-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      color:#6b7280;
      margin-top:4px;
      gap:8px;
      flex-wrap:wrap;
    }

    .lesson-list{
      margin-top:6px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .lesson-item{
      background:#ffffff;
      border-radius:10px;
      border:1px solid #e5e7eb;
      padding:8px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      cursor:pointer;
      transition:background .1s ease,box-shadow .1s ease,transform .05s ease;
    }
    .lesson-item:hover{
      background:#eef2ff;
      box-shadow:0 4px 10px rgba(79,70,229,0.15);
      transform:translateY(-1px);
    }
    .lesson-item.locked{
      opacity:.5;
      cursor:not-allowed;
      box-shadow:none;
      background:#f9fafb;
    }
    .lesson-title{
      font-size:13px;
      font-weight:500;
    }
    .lesson-status{
      font-size:11px;
      text-align:right;
    }

    .video-wrapper{
      position:relative;
      padding-bottom:56.25%;
      height:0;
      overflow:hidden;
      border-radius:10px;
      background:#000;
      margin-top:6px;
    }
    .video-wrapper iframe{
      position:absolute;
      top:0;left:0;width:100%;height:100%;
      border:0;
    }

    .mini-form{
      margin-top:6px;
      border-top:1px dashed #e5e7eb;
      padding-top:6px;
    }

    .empty{
      font-size:13px;
      color:#9ca3af;
      margin-top:6px;
    }

    table.user-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      margin-top:4px;
    }
    table.user-table th,
    table.user-table td{
      text-align:left;
      padding:4px 6px;
      border-bottom:1px solid #f3f4f6;
    }
    table.user-table th{
      border-bottom:1px solid #e5e7eb;
      font-weight:600;
      color:#4b5563;
    }

    /* LESSON PLAYER AREA */
    .detail-layout{
      display:grid;
      grid-template-columns:minmax(0,0.8fr) minmax(0,1.4fr);
      gap:12px;
      margin-top:10px;
    }
    @media(max-width:900px){
      .detail-layout{
        grid-template-columns:1fr;
      }
    }

    .lesson-player-box{
      margin-top:0;
      background:#f9fafb;
      border-radius:12px;
      border:1px solid #e5e7eb;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .progress-text{
      font-size:12px;
      color:#4b5563;
      margin-top:4px;
    }
    .progress-bar-wrap{
      margin-top:4px;
      background:#e5e7eb;
      border-radius:999px;
      height:6px;
      overflow:hidden;
    }
    .progress-bar{
      height:100%;
      width:0%;
      border-radius:999px;
      background:linear-gradient(90deg,#22c55e,#16a34a);
      transition:width .2s ease;
    }

    /* MODAL (kurs tanlash) */
    .modal{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modal.hidden{display:none;}
    .modal-backdrop{
      position:absolute;
      inset:0;
      background:rgba(15,23,42,0.55);
      backdrop-filter:blur(4px);
    }
    .modal-content{
      position:relative;
      z-index:1;
      width:95%;
      max-width:900px;
      max-height:85vh;
      background:#ffffff;
      border-radius:16px;
      padding:16px;
      box-shadow:0 24px 60px rgba(15,23,42,0.35);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:4px;
    }
    .modal-body{
      overflow-y:auto;
    }
    .modal-close{
      border:none;
      background:#e5e7eb;
      border-radius:999px;
      padding:4px 10px;
      cursor:pointer;
      font-size:13px;
    }

    /* FOOTER */
    .footer{
      background:#0f172a;
      color:#e5e7eb;
      padding:12px 20px;
      font-size:12px;
      margin-top:auto;
    }
    .footer-inner{
      max-width:1120px;
      margin:0 auto;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:space-between;
      align-items:center;
    }
    .footer small{opacity:.8;}
  </style>

  <!-- FIREBASE (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <!-- YouTube Iframe API -->
  <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
<div class="page">
  <!-- HEADER -->
  <header class="header">
    <div class="logo">Ona tili <span>Pro</span></div>
    <nav class="nav">
      <a id="nav-courses">Kurslar</a>
      <a id="nav-admin" class="hidden">Admin panel</a>
      <span class="user-label" id="current-user-label">Mehmon</span>
      <button class="btn-outline hidden" id="logout-btn">Chiqish</button>
    </nav>
  </header>

  <main class="container">
    <!-- AUTH SECTION -->
    <section id="auth-section" class="section">
      <div class="grid-2">
        <div>
          <div class="card">
            <h2>Xush kelibsiz, online o‚Äòquv markazimizga!</h2>
            <p class="sub">
              Bu yerda siz <b>bilimlaringizni oshirasiz</b> va ‚ÄúOna tili Pro‚Äù kurslari orqali tayyorlana olasiz.
              <br>Admin uchun demo login: <b>admin / admin123</b>
            </p>

            <div class="tabs">
              <button class="tab-btn active" data-tab="login">Kirish</button>
              <button class="tab-btn" data-tab="register">Ro‚Äòyxatdan o‚Äòtish</button>
            </div>

            <!-- Login form -->
            <form id="login-form" class="form">
              <div class="form-row">
                <label for="login-username">Login</label>
                <input id="login-username" required placeholder="Masalan: admin" />
              </div>
              <div class="form-row">
                <label for="login-password">Parol</label>
                <input id="login-password" type="password" required />
              </div>
              <button type="submit" class="btn">Kirish</button>
              <div id="login-error" class="error"></div>
            </form>

            <!-- Register form -->
            <form id="register-form" class="form hidden">
              <div class="form-row">
                <label for="reg-username">Login</label>
                <input id="reg-username" required placeholder="Masalan: talaba01" />
              </div>
              <div class="form-row">
                <label for="reg-password">Parol</label>
                <input id="reg-password" type="password" required />
              </div>
              <div class="form-row">
                <label for="reg-password2">Parolni takrorlang</label>
                <input id="reg-password2" type="password" required />
              </div>
              <p class="hint">
                Ro‚Äòyxatdan o‚Äòtgan foydalanuvchilar kurslarni ko‚Äòrishlari mumkin, lekin
                <b>admin panelga kira olmaydi</b>.
              </p>
              <button type="submit" class="btn">Ro‚Äòyxatdan o‚Äòtish</button>
              <div id="register-error" class="error"></div>
            </form>
          </div>
        </div>

        <div>
          <div class="card">
            <h2>Kurs nomi: ‚ÄúOna tili Pro‚Äù o‚Äòquv markazi</h2>
            <p class="sub">
              Ona tili va adabiyot bo‚Äòyicha onlayn kurslar, testlar va video darslar jamlanmasi.
            </p>
            <p class="hero-text">
              ‚Ä¢ <b>Admin</b> ‚Äî kurs yaratadi, har bir kurs ichiga ko‚Äòplab YouTube
              <b>yashirin (Unlisted)</b> videolarni qo‚Äòshishi mumkin.<br>
              ‚Ä¢ <b>Foydalanuvchi</b> ‚Äî ro‚Äòyxatdan o‚Äòtadi va kurslar ichidagi darslarni tomosha qiladi.<br><br>
              Har bir dars bo‚Äòyicha ko‚Äòrilgan <b>foiz</b> saqlanib boradi. Dars kamida
              <b>90%</b> ko‚Äòrilganda tugallangan hisoblanadi va oldinga yana
              <b>bir nechta darslar ochiladi</b>.
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- ADMIN SECTION -->
    <section id="admin-section" class="section hidden">
      <div class="card">
        <div class="section-header">
          <div>
            <h2>Admin panel</h2>
            <p class="sub">
              Bu qismga faqat admin kirishi mumkin. Kurslar, darslar va foydalanuvchilar shu yerda boshqariladi.
            </p>
          </div>
          <span class="pill">Rol: Admin</span>
        </div>

        <h3 style="font-size:15px;margin-bottom:4px;">Yangi kurs qo‚Äòshish</h3>
        <form id="course-form" class="form">
          <div class="form-row">
            <label for="course-title">Kurs nomi</label>
            <input id="course-title" required placeholder="Masalan: Ona tili Pro ‚Äî 5-sinf" />
          </div>
          <div class="form-row">
            <label for="course-desc">Tavsif</label>
            <textarea id="course-desc" required placeholder="Kurs mazmuni, maqsadi, kimlar uchun..."></textarea>
          </div>
          <div class="form-grid">
            <div class="form-row">
              <label for="course-cat">Yo'nalish</label>
              <input id="course-cat" placeholder="Masalan: Ona tili, Adabiyot..." />
            </div>
            <div class="form-row">
              <label for="course-price">Narx (so'm)</label>
              <input id="course-price" type="number" min="0" placeholder="0 = bepul" />
            </div>
          </div>
          <button type="submit" class="btn">Kursni qo‚Äòshish</button>
          <div id="course-error" class="error"></div>
        </form>

        <hr style="margin:14px 0;border:none;border-top:1px solid #e5e7eb;">

        <div class="section-header">
          <h3 style="font-size:15px;">Mavjud kurslar</h3>
          <span class="muted" id="admin-course-count">0 ta kurs</span>
        </div>
        <div id="admin-course-list"></div>
        <div id="admin-empty" class="empty">Hozircha kurs yo‚Äòq. Yuqoridan kurs qo‚Äòshing.</div>

        <hr style="margin:14px 0;border:none;border-top:1px solid #e5e7eb;">

        <div class="section-header">
          <h3 style="font-size:15px;">Foydalanuvchilar ro‚Äòyxati</h3>
          <span class="muted" id="admin-user-count">0 ta foydalanuvchi</span>
        </div>
        <div id="admin-user-list" class="empty">Ma'lumotlar yuklanmoqda...</div>
      </div>
    </section>

    <!-- USER SECTION -->
    <section id="user-section" class="section hidden">
      <div class="card">
        <div class="section-header">
          <div>
            <h2>Kurslar paneli</h2>
            <p class="sub">
              Ro‚Äòyxatdan o‚Äòtgan barcha foydalanuvchilar bu yerdagi kurslarni ko‚Äòrishi mumkin.
            </p>
          </div>
          <span class="pill" id="user-role-pill">Rol: Foydalanuvchi</span>
        </div>

        <div class="section-header">
          <button class="btn" id="btn-open-course-modal">Kurs tanlash</button>
          <span class="muted" id="user-course-count">0 ta kurs</span>
        </div>

        <!-- Kurslar ro'yxati (mini ko‚Äòrinish) -->
        <div id="user-courses-view">
          <div id="user-course-list" class="course-grid"></div>
          <div id="user-empty" class="empty">
            Hozircha kurslar qo‚Äòshilmagan. Admin panel orqali kurs qo‚Äòshilishi kerak.
          </div>
        </div>

        <!-- Bitta kurs ichiga kirilganda ko‚Äòrinish -->
        <div id="user-course-detail" class="hidden">
          <button class="btn" id="user-back-btn" style="margin-bottom:8px;">‚Üê Kurslar paneliga qaytish</button>
          <h3 id="detail-title" style="font-size:18px;margin-bottom:4px;"></h3>
          <p id="detail-desc" class="muted" style="margin-bottom:8px;"></p>
          <div class="course-meta" id="detail-meta"></div>

          <div class="detail-layout">
            <div id="detail-lessons"></div>

            <div class="lesson-player-box" id="lesson-player-box">
              <div class="muted" id="lesson-player-title">Dars tanlanmagan.</div>
              <div class="video-wrapper hidden" id="lesson-video-wrapper">
                <div id="yt-player"></div>
              </div>
              <div class="progress-text" id="lesson-progress-text"></div>
              <div class="progress-bar-wrap">
                <div class="progress-bar" id="lesson-progress-bar"></div>
              </div>
              <div class="hint" style="margin-top:4px;">
                Dars kamida <b>90%</b> ko‚Äòrilganda tugallangan hisoblanadi.
                1-dars tugallansa, oldinda <b>yana 3 ta dars</b> ochiladi.
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="footer-inner">
      <small>¬© Ona tili Pro online o‚Äòquv markazi ‚Äî bilimlaringiz uchun raqamli hamroh.</small>
      <small>
        Aloqa: <b>+998 90 000 00 00</b> ¬∑ Telegram: <b>@onatili_pro</b>
      </small>
    </div>
  </footer>
</div>

<!-- Kurs tanlash MODAL -->
<div id="course-modal" class="modal hidden">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <div class="modal-header">
      <div>
        <h3 style="font-size:17px;">Kurs tanlash</h3>
        <p class="muted">Kerakli kursni tanlang ‚Äî kurs ichidagi darslar ochiladi.</p>
      </div>
      <button class="modal-close" id="course-modal-close">Yopish ‚úï</button>
    </div>
    <div class="modal-body">
      <div id="course-modal-list" class="course-grid"></div>
    </div>
  </div>
</div>

<script>
  /* YOUTUBE API HOLATI */
  let ytApiReady = false;
  function onYouTubeIframeAPIReady() { ytApiReady = true; }

  /* FIREBASE INIT */
  const firebaseConfig = {
    apiKey: "AIzaSyDVidcgjpUxkg88bxXfIFzmsFydv0rMMao",
    authDomain: "shahboz-5d0a3.firebaseapp.com",
    projectId: "shahboz-5d0a3",
    storageBucket: "shahboz-5d0a3.appspot.com",
    messagingSenderId: "352024095535",
    appId: "1:352024095535:web:6ca630de2c199a33c54fda",
    measurementId: "G-YS5RGZ00EB"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /* LOCAL STATE */
  let data = { currentUser: null, courses: [] };
  const CURRENT_USER_KEY = "talimEduCurrentUser_v1";

  function loadCurrentUserFromLocal() {
    try {
      const raw = localStorage.getItem(CURRENT_USER_KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch { return null; }
  }
  function saveCurrentUserToLocal() {
    if (!data.currentUser) localStorage.removeItem(CURRENT_USER_KEY);
    else localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(data.currentUser));
  }

  async function ensureDefaultAdmin() {
    const ref = db.collection("users").doc("admin");
    const doc = await ref.get();
    if (!doc.exists) {
      await ref.set({ username:"admin", password:"admin123", role:"admin" });
    }
  }

  /* DOM */
  const authSection = document.getElementById("auth-section");
  const adminSection = document.getElementById("admin-section");
  const userSection = document.getElementById("user-section");
  const navAdmin = document.getElementById("nav-admin");
  const navCourses = document.getElementById("nav-courses");
  const logoutBtn = document.getElementById("logout-btn");
  const currentUserLabel = document.getElementById("current-user-label");
  const userRolePill = document.getElementById("user-role-pill");

  const tabButtons = document.querySelectorAll(".tab-btn");
  const loginForm = document.getElementById("login-form");
  const registerForm = document.getElementById("register-form");
  const loginErrorEl = document.getElementById("login-error");
  const registerErrorEl = document.getElementById("register-error");

  const loginUsername = document.getElementById("login-username");
  const loginPassword = document.getElementById("login-password");
  const regUsername = document.getElementById("reg-username");
  const regPassword = document.getElementById("reg-password");
  const regPassword2 = document.getElementById("reg-password2");

  const courseForm = document.getElementById("course-form");
  const courseError = document.getElementById("course-error");
  const adminCourseList = document.getElementById("admin-course-list");
  const adminCourseCount = document.getElementById("admin-course-count");
  const adminEmpty = document.getElementById("admin-empty");

  const adminUserList = document.getElementById("admin-user-list");
  const adminUserCount = document.getElementById("admin-user-count");

  const userCoursesView = document.getElementById("user-courses-view");
  const userCourseDetail = document.getElementById("user-course-detail");
  const userCourseList = document.getElementById("user-course-list");
  const userCourseCount = document.getElementById("user-course-count");
  const userEmpty = document.getElementById("user-empty");
  const userBackBtn = document.getElementById("user-back-btn");

  const detailTitle = document.getElementById("detail-title");
  const detailDesc = document.getElementById("detail-desc");
  const detailMeta = document.getElementById("detail-meta");
  const detailLessons = document.getElementById("detail-lessons");

  const lessonPlayerTitle = document.getElementById("lesson-player-title");
  const lessonVideoWrapper = document.getElementById("lesson-video-wrapper");
  const lessonProgressText = document.getElementById("lesson-progress-text");
  const lessonProgressBar = document.getElementById("lesson-progress-bar");

  const btnOpenCourseModal = document.getElementById("btn-open-course-modal");
  const courseModal = document.getElementById("course-modal");
  const courseModalClose = document.getElementById("course-modal-close");
  const courseModalList = document.getElementById("course-modal-list");

  /* HELPERS */
  function formatPrice(price) {
    const n = Number(price);
    if (!price && price !== 0) return "";
    if (isNaN(n)) return "";
    if (n === 0) return "Bepul";
    return n.toLocaleString("uz-UZ")+" so'm";
  }
  function extractYouTubeId(input) {
    if (!input) return "";
    let url = input.trim();
    let m = url.match(/youtu\.be\/([^?&]+)/);
    if (m) return m[1];
    m = url.match(/v=([^&]+)/);
    if (m) return m[1];
    m = url.match(/embed\/([^?&]+)/);
    if (m) return m[1];
    return url;
  }

  /* PROGRESS Firestore */
  async function loadProgress(username, courseId) {
    const id = `${username}_${courseId}`;
    const ref = db.collection("progress").doc(id);
    const doc = await ref.get();
    if (!doc.exists) return { user:username, courseId, lessons:{} };
    const d = doc.data();
    if (!d.lessons) d.lessons = {};
    return d;
  }
  async function saveLessonProgress(username, courseId, lessonId, percent, completedFlag) {
    const id = `${username}_${courseId}`;
    const ref = db.collection("progress").doc(id);
    const doc = await ref.get();
    let d = doc.exists ? doc.data() : { user:username, courseId, lessons:{} };
    if (!d.lessons) d.lessons = {};
    const prev = d.lessons[lessonId] || { percent:0, completed:false };
    const maxPercent = Math.max(prev.percent||0, percent||0);
    const completed = prev.completed || completedFlag || maxPercent>=90;
    d.lessons[lessonId] = { percent:maxPercent, completed };
    await ref.set(d);
    return d;
  }

  /* FIRESTORE HELPERS */
  async function registerUser(u,p){
    const ref = db.collection("users").doc(u);
    const doc = await ref.get();
    if (doc.exists) throw new Error("exists");
    await ref.set({ username:u, password:p, role:"user" });
  }
  async function loginUser(u,p){
    const ref = db.collection("users").doc(u);
    const doc = await ref.get();
    if (!doc.exists) return null;
    const user = doc.data();
    return user.password===p ? user : null;
  }
  async function addCourseToFirestore(course){
    await db.collection("courses").doc(course.id).set(course);
  }
  async function deleteCourseFromFirestore(courseId){
    await db.collection("courses").doc(courseId).delete();
  }
  async function updateCourseLessons(courseId,lessons){
    await db.collection("courses").doc(courseId).update({ lessons });
  }
  async function loadCoursesFromFirestore(){
    const snap = await db.collection("courses").get();
    data.courses = snap.docs.map(d=>d.data());
  }
  async function refreshCourses(){
    await loadCoursesFromFirestore();
    renderAdminCourses();
    renderUserCourses();
    renderCourseModalList();
  }
  async function loadUsersFromFirestore(){
    const snap = await db.collection("users").get();
    renderAdminUsers(snap.docs.map(d=>d.data()));
  }

  /* RENDER ADMIN USERS */
  function renderAdminUsers(users){
    adminUserCount.textContent = users.length+" ta foydalanuvchi";
    if(!users.length){
      adminUserList.className="empty";
      adminUserList.textContent="Foydalanuvchilar hali yo‚Äòq.";
      return;
    }
    adminUserList.classList.remove("empty");
    adminUserList.innerHTML = `
      <div style="overflow-x:auto;">
        <table class="user-table">
          <thead><tr><th>Login</th><th>Rol</th></tr></thead>
          <tbody>
            ${users.map(u=>`<tr><td>${u.username}</td><td>${u.role}</td></tr>`).join("")}
          </tbody>
        </table>
      </div>`;
  }

  /* RENDER ADMIN COURSES */
  function renderAdminCourses(){
    const courses = data.courses||[];
    adminCourseList.innerHTML="";
    adminCourseCount.textContent=courses.length+" ta kurs";
    if(!courses.length){ adminEmpty.style.display="block"; return; }
    adminEmpty.style.display="none";

    courses.forEach(course=>{
      const div=document.createElement("div");
      div.className="course-card";
      const priceText=formatPrice(course.price);
      const lessons=course.lessons||[];

      let lessonsHtml="";
      if(!lessons.length){
        lessonsHtml=`<div class="empty">Hali dars qo‚Äòshilmagan.</div>`;
      }else{
        lessonsHtml=`
          <div class="lesson-list">
            ${lessons.map((l,i)=>`
              <div class="lesson-item">
                <div class="lesson-title">${i+1}. ${l.title}</div>
                <div class="lesson-status"><span class="muted">ID: ${l.id}</span></div>
              </div>`).join("")}
          </div>`;
      }

      div.innerHTML=`
        <div class="course-title">${course.title}</div>
        <div class="course-desc">${course.description}</div>
        <div class="course-meta">
          ${course.category?`<span class="badge">${course.category}</span>`:""}
          ${priceText?`<span class="badge ${course.price==0?"free":"price"}">${priceText}</span>`:""}
          <span class="badge">Darslar: ${lessons.length}</span>
        </div>
        <div class="course-footer">
          <span class="muted">Kurs ID: ${course.id}</span>
          <button type="button" class="btn-xs btn-delete-course" data-course-id="${course.id}">Kursni o‚Äòchirish</button>
        </div>
        <div class="mini-form">
          <div class="muted" style="margin-bottom:4px;">Ushbu kursga yangi dars/video qo‚Äòshish:</div>
          <form class="lesson-form" data-course-id="${course.id}">
            <div class="form-row">
              <label>Dars nomi</label>
              <input name="lessonTitle" required placeholder="Masalan: 1-dars. Kirish" />
            </div>
            <div class="form-row">
              <label>YouTube havolasi yoki ID</label>
              <input name="lessonUrl" required placeholder="https://youtu.be/... yoki faqat ID" />
              <div class="hint">Videoni YouTube‚Äôda <b>Unlisted</b> qilib yuklash tavsiya etiladi.</div>
            </div>
            <button type="submit" class="btn" style="margin-top:4px;">Darsni qo‚Äòshish</button>
          </form>
        </div>
        ${lessonsHtml}`;
      adminCourseList.appendChild(div);
    });
  }

  adminCourseList.addEventListener("submit",async e=>{
    if(!e.target.classList.contains("lesson-form")) return;
    e.preventDefault();
    if(!data.currentUser || data.currentUser.role!=="admin") return;
    const form=e.target;
    const courseId=form.dataset.courseId;
    const title=form.lessonTitle.value.trim();
    const url=form.lessonUrl.value.trim();
    if(!title||!url) return;
    const videoId=extractYouTubeId(url);
    if(!videoId){ alert("YouTube havola/ID noto‚Äòg‚Äòri."); return; }

    try{
      const course=data.courses.find(c=>c.id===courseId);
      if(!course) return;
      const lessons=course.lessons||[];
      lessons.push({ id:Date.now().toString(), title, videoId });
      await updateCourseLessons(courseId,lessons);
      await refreshCourses();
      form.reset();
    }catch(err){
      console.error(err);
      alert("Darsni saqlashda xatolik yuz berdi.");
    }
  });

  adminCourseList.addEventListener("click",async e=>{
    const btn=e.target.closest(".btn-delete-course");
    if(!btn) return;
    const courseId=btn.dataset.courseId;
    if(!confirm("Kursni o‚Äòchirishni xohlaysizmi?")) return;
    try{
      await deleteCourseFromFirestore(courseId);
      data.courses = data.courses.filter(c=>c.id!==courseId);
      renderAdminCourses();
      renderUserCourses();
      renderCourseModalList();
    }catch(err){
      console.error("Delete error:",err);
      alert("Kursni o‚Äòchirishda xatolik yuz berdi.");
    }
  });

  /* USER COURSES GRID */
  function renderUserCourses(){
    const courses=data.courses||[];
    userCourseList.innerHTML="";
    userCourseCount.textContent=courses.length+" ta kurs";
    if(!courses.length){ userEmpty.style.display="block"; return; }
    userEmpty.style.display="none";

    courses.forEach(course=>{
      const card=document.createElement("div");
      card.className="course-card";
      const priceText=formatPrice(course.price);
      const lessons=course.lessons||[];
      card.innerHTML=`
        <div class="course-title">${course.title}</div>
        <div class="course-desc">${course.description}</div>
        <div class="course-meta">
          ${course.category?`<span class="badge">${course.category}</span>`:""}
          ${priceText?`<span class="badge ${course.price==0?"free":"price"}">${priceText}</span>`:""}
          <span class="badge">Darslar: ${lessons.length}</span>
        </div>
        <div class="course-footer">
          <span class="muted">Kurs ID: ${course.id}</span>
          <button type="button" class="btn btn-open-course" data-course-id="${course.id}">Kursga kirish</button>
        </div>`;
      userCourseList.appendChild(card);
    });
  }

  /* MODAL */
  function renderCourseModalList(){
    const courses=data.courses||[];
    courseModalList.innerHTML="";
    if(!courses.length){
      courseModalList.innerHTML=`<div class="empty">Hozircha kurslar yo‚Äòq.</div>`;
      return;
    }
    courses.forEach(course=>{
      const div=document.createElement("div");
      div.className="course-card";
      const priceText=formatPrice(course.price);
      const lessons=course.lessons||[];
      div.innerHTML=`
        <div class="course-title">${course.title}</div>
        <div class="course-desc">${course.description}</div>
        <div class="course-meta">
          ${course.category?`<span class="badge">${course.category}</span>`:""}
          ${priceText?`<span class="badge ${course.price==0?"free":"price"}">${priceText}</span>`:""}
          <span class="badge">Darslar: ${lessons.length}</span>
        </div>
        <div class="course-footer">
          <button type="button" class="btn btn-open-course-modal" data-course-id="${course.id}">Tanlash</button>
        </div>`;
      courseModalList.appendChild(div);
    });
  }
  function openCourseModal(){ courseModal.classList.remove("hidden"); }
  function closeCourseModal(){ courseModal.classList.add("hidden"); }

  btnOpenCourseModal.addEventListener("click",()=>{
    renderCourseModalList();
    openCourseModal();
  });
  courseModalClose.addEventListener("click",closeCourseModal);
  courseModal.addEventListener("click",e=>{
    if(e.target.classList.contains("modal-backdrop")) closeCourseModal();
  });
  courseModalList.addEventListener("click",async e=>{
    const btn=e.target.closest(".btn-open-course-modal");
    if(!btn) return;
    const courseId=btn.dataset.courseId;
    closeCourseModal();
    await openUserCourseDetail(courseId);
  });

  /* COURSE DETAIL + PROGRESS */
  let currentCourseDetail=null;
  let currentCourseProgress=null;
  let currentPlayer=null;
  let currentLessonId=null;
  let progressInterval=null;
  let lastSavedPercent=0;

  function stopCurrentPlayer(){
    if(progressInterval) {
      clearInterval(progressInterval);
      progressInterval=null;
    }

    if(currentPlayer && typeof currentPlayer.getDuration==="function"){
      try{
        const dur = currentPlayer.getDuration();
        const cur = currentPlayer.getCurrentTime();
        let percent = lastSavedPercent || 0;
        if(dur && dur>0){
          percent = Math.min(100,(cur/dur)*100);
        }
        percent = Math.round(percent);

        const user = data.currentUser;
        const course = currentCourseDetail;
        const lessonIdToSave = currentLessonId;

        if(user && course && lessonIdToSave && percent>0){
          saveLessonProgress(
            user.username,
            course.id,
            lessonIdToSave,
            percent,
            percent>=90
          ).then(updated=>{
            currentCourseProgress = updated;
            renderCourseLessonsList();
          }).catch(err=>console.error("final progress save error",err));
        }
      }catch(err){
        console.error("stopCurrentPlayer error",err);
      }
    }

    if(currentPlayer && currentPlayer.destroy){
      try{ currentPlayer.destroy(); }catch(e){}
    }
    currentPlayer=null;
    currentLessonId=null;
  }

  function renderCourseLessonsList(){
    const course=currentCourseDetail;
    const progress=currentCourseProgress||{lessons:{}};
    const lessons=course.lessons||[];
    if(!lessons.length){
      detailLessons.innerHTML=`<div class="empty">Bu kursga hali dars qo‚Äòshilmagan.</div>`;
      return;
    }

    const progMap = progress.lessons || {};
    let maxCompletedIndex = -1;
    lessons.forEach((lesson,idx)=>{
      const info = progMap[lesson.id] || {percent:0,completed:false};
      if(info.completed && idx>maxCompletedIndex) maxCompletedIndex = idx;
    });

    let html=`<div class="lesson-list">`;
    lessons.forEach((lesson,idx)=>{
      const info=(progMap)[lesson.id]||{percent:0,completed:false};
      const percent=Math.round(info.percent||0);

      let unlocked = (idx===0);
      if(maxCompletedIndex>=0 && idx <= maxCompletedIndex+3){
        unlocked = true;
      }

      const statusText=info.completed
        ?"Tugallangan ‚úÖ"
        :unlocked?(percent>0?`Boshlangan (${percent}%)`:"Boshlanmagan")
        :"Yopiq üîí";
      html+=`
        <div class="lesson-item ${unlocked?"":"locked"}" data-lesson-id="${lesson.id}" data-unlocked="${unlocked?"1":"0"}">
          <div>
            <div class="lesson-title">${idx+1}-dars. ${lesson.title}</div>
            <div class="muted" style="font-size:11px;">Ko‚Äòrilgan: ${percent}%</div>
          </div>
          <div class="lesson-status">${statusText}</div>
        </div>`;
    });
    html+=`</div>`;
    detailLessons.innerHTML=html;
  }

  async function openLessonPlayer(lesson){
    if(!currentCourseDetail || !data.currentUser) return;

    // Eski videoni ‚Äúpauza‚Äù qilib, progressni saqlaymiz
    stopCurrentPlayer();

    currentLessonId=lesson.id;
    lessonPlayerTitle.textContent=lesson.title;
    lessonVideoWrapper.classList.remove("hidden");
    lessonProgressText.textContent="Ko‚Äòrilmoqda: 0%";
    lessonProgressBar.style.width="0%";
    lastSavedPercent=0;

    if(!ytApiReady){
      lessonProgressText.textContent="YouTube API yuklanmoqda...";
      const check=setInterval(()=>{
        if(ytApiReady){
          clearInterval(check);
          openLessonPlayer(lesson);
        }
      },500);
      return;
    }
    currentPlayer=new YT.Player("yt-player",{
      videoId:lesson.videoId,
      playerVars:{rel:0,modestbranding:1},
      events:{
        onReady:()=>{
          const info=(currentCourseProgress.lessons||{})[lesson.id]||{percent:0};
          if(info.percent && info.percent<95){
            const dur=currentPlayer.getDuration();
            const start=(info.percent/100)*dur;
            if(start && isFinite(start)) currentPlayer.seekTo(start,true);
          }
          currentPlayer.playVideo();
          startProgressInterval();
        }
      }
    });
  }

  function startProgressInterval(){
    if(!currentPlayer) return;
    if(progressInterval) clearInterval(progressInterval);
    progressInterval=setInterval(async ()=>{
      if(!currentPlayer||typeof currentPlayer.getDuration!=="function") return;
      const dur=currentPlayer.getDuration();
      if(!dur||dur<=0) return;
      const cur=currentPlayer.getCurrentTime();
      const percent=Math.min(100,(cur/dur)*100);
      const rounded=Math.round(percent);
      lessonProgressText.textContent=`Ko‚Äòrilgan: ${rounded}%`;
      lessonProgressBar.style.width=rounded+"%";

      if(!data.currentUser||!currentCourseDetail||!currentLessonId) return;

      const lp = (currentCourseProgress?.lessons || {})[currentLessonId];
      const alreadyCompleted = lp && lp.completed;
      // Agar dars allaqachon tugallangan bo‚Äòlsa, qayta tomosha progressini yozmaymiz
      if(alreadyCompleted) return;

      if(rounded-lastSavedPercent>=15 || rounded>=90){
        lastSavedPercent=rounded;
        try{
          const updated=await saveLessonProgress(
            data.currentUser.username,
            currentCourseDetail.id,
            currentLessonId,
            rounded,
            rounded>=90
          );
          currentCourseProgress=updated;
          renderCourseLessonsList();
        }catch(err){ console.error("progress error",err); }
      }
    },5000);
  }

  async function openUserCourseDetail(courseId){
    const course=data.courses.find(c=>c.id===courseId);
    if(!course || !data.currentUser) return;
    currentCourseDetail=course;
    currentCourseProgress=await loadProgress(data.currentUser.username,courseId);
    detailTitle.textContent=course.title;
    detailDesc.textContent=course.description||"";
    const priceText=formatPrice(course.price);
    detailMeta.innerHTML=`
      ${course.category?`<span class="badge">${course.category}</span>`:""}
      ${priceText?`<span class="badge ${course.price==0?"free":"price"}">${priceText}</span>`:""}
      <span class="badge">Darslar: ${(course.lessons||[]).length}</span>`;
    renderCourseLessonsList();
    lessonPlayerTitle.textContent="Dars tanlanmagan.";
    lessonVideoWrapper.classList.add("hidden");
    lessonProgressText.textContent="";
    lessonProgressBar.style.width="0%";
    userCoursesView.classList.add("hidden");
    userCourseDetail.classList.remove("hidden");
  }

  detailLessons.addEventListener("click",async e=>{
    const item=e.target.closest(".lesson-item");
    if(!item) return;
    const unlocked=item.dataset.unlocked==="1";
    if(!unlocked){
      alert("Bu dars hozircha yopiq. Oldingi darslarni tugallab keyin kiring.");
      return;
    }
    const lessonId=item.dataset.lessonId;
    const lesson=(currentCourseDetail.lessons||[]).find(l=>l.id===lessonId);
    if(!lesson) return;
    await openLessonPlayer(lesson);
  });

  function showUserCoursesList(){
    stopCurrentPlayer();
    userCoursesView.classList.remove("hidden");
    userCourseDetail.classList.add("hidden");
  }

  userCourseList.addEventListener("click",async e=>{
    const btn=e.target.closest(".btn-open-course");
    if(!btn) return;
    await openUserCourseDetail(btn.dataset.courseId);
  });
  userBackBtn.addEventListener("click",showUserCoursesList);

  /* UI UPDATE */
  function updateUI(){
    const user=data.currentUser;
    if(!user){
      authSection.classList.remove("hidden");
      adminSection.classList.add("hidden");
      userSection.classList.add("hidden");
      navAdmin.classList.add("hidden");
      logoutBtn.classList.add("hidden");
      currentUserLabel.textContent="Mehmon";
      userRolePill.textContent="Rol: Foydalanuvchi";
      return;
    }
    authSection.classList.add("hidden");
    userSection.classList.remove("hidden");
    logoutBtn.classList.remove("hidden");
    currentUserLabel.textContent=user.username;
    if(user.role==="admin"){
      navAdmin.classList.remove("hidden");
      userRolePill.textContent="Rol: Admin (foydalanuvchi rejimi)";
    }else{
      navAdmin.classList.add("hidden");
      userRolePill.textContent="Rol: Foydalanuvchi";
    }
    showUserCoursesList();
  }

  /* AUTH TABS */
  tabButtons.forEach(btn=>{
    btn.addEventListener("click",()=>{
      tabButtons.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const tab=btn.dataset.tab;
      if(tab==="login"){
        loginForm.classList.remove("hidden");
        registerForm.classList.add("hidden");
        loginErrorEl.textContent="";
      }else{
        loginForm.classList.add("hidden");
        registerForm.classList.remove("hidden");
        registerErrorEl.textContent="";
      }
    });
  });

  /* LOGIN */
  loginForm.addEventListener("submit",async e=>{
    e.preventDefault();
    loginErrorEl.textContent="";
    const u=loginUsername.value.trim();
    const p=loginPassword.value;
    if(!u||!p){ loginErrorEl.textContent="Login va parolni kiriting."; return; }
    try{
      const user=await loginUser(u,p);
      if(!user){ loginErrorEl.textContent="Login yoki parol noto‚Äòg‚Äòri."; return; }
      data.currentUser={username:user.username,role:user.role};
      saveCurrentUserToLocal();
      loginForm.reset();
      updateUI();
      await refreshCourses();
      await loadUsersFromFirestore();
    }catch(err){
      console.error(err);
      loginErrorEl.textContent="Kirishda xatolik yuz berdi.";
    }
  });

  /* REGISTER */
  registerForm.addEventListener("submit",async e=>{
    e.preventDefault();
    registerErrorEl.textContent="";
    const u=regUsername.value.trim();
    const p=regPassword.value;
    const p2=regPassword2.value;
    if(!u||!p){ registerErrorEl.textContent="Login va parolni kiriting."; return; }
    if(p!==p2){ registerErrorEl.textContent="Parollar mos kelmadi."; return; }
    try{
      await registerUser(u,p);
      data.currentUser={username:u,role:"user"};
      saveCurrentUserToLocal();
      registerForm.reset();
      updateUI();
      await refreshCourses();
      await loadUsersFromFirestore();
    }catch(err){
      if(err.message==="exists") registerErrorEl.textContent="Bu login band.";
      else{ console.error(err); registerErrorEl.textContent="Ro‚Äòyxatdan o‚Äòtishda xatolik."; }
    }
  });

  logoutBtn.addEventListener("click",()=>{
    data.currentUser=null;
    saveCurrentUserToLocal();
    updateUI();
  });

  /* COURSE ADD (ADMIN) */
  courseForm.addEventListener("submit",async e=>{
    e.preventDefault();
    if(!data.currentUser || data.currentUser.role!=="admin") return;
    courseError.textContent="";
    const title=document.getElementById("course-title").value.trim();
    const desc=document.getElementById("course-desc").value.trim();
    const cat=document.getElementById("course-cat").value.trim();
    const price=document.getElementById("course-price").value.trim();
    if(!title||!desc){ courseError.textContent="Kurs nomi va tavsifi majburiy."; return; }
    const newCourse={ id:Date.now().toString(), title, description:desc, category:cat, price, lessons:[] };
    try{
      await addCourseToFirestore(newCourse);
      courseForm.reset();
      await refreshCourses();
    }catch(err){
      console.error(err);
      courseError.textContent="Kursni saqlashda xatolik.";
    }
  });

  /* NAV */
  navCourses.addEventListener("click",e=>{
    e.preventDefault();
    if(!data.currentUser){
      authSection.classList.remove("hidden");
      adminSection.classList.add("hidden");
      userSection.classList.add("hidden");
      const loginTabBtn=document.querySelector('.tab-btn[data-tab="login"]');
      if(loginTabBtn) loginTabBtn.click();
      return;
    }
    adminSection.classList.add("hidden");
    userSection.classList.remove("hidden");
    showUserCoursesList();
  });
  navAdmin.addEventListener("click",e=>{
    e.preventDefault();
    if(!data.currentUser || data.currentUser.role!=="admin") return;
    userSection.classList.add("hidden");
    adminSection.classList.remove("hidden");
  });

  // Tab yopilganda ham progressni oxirgi marta saqlashga urinamiz
  window.addEventListener("beforeunload",()=>{
    stopCurrentPlayer();
  });

  /* INIT */
  (async function initApp(){
    try{
      await ensureDefaultAdmin();
      data.currentUser=loadCurrentUserFromLocal();
      updateUI();
      await refreshCourses();
      await loadUsersFromFirestore();
    }catch(err){ console.error("init error",err); }
  })();
</script>
</body>
</html>
