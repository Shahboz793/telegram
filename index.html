<!doctype html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <title>Ona tili Pro ‚Äî Online o‚Äòquv markazi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:linear-gradient(180deg,#0f172a 0%,#111827 25%,#f97316 25.1%,#fef3c7 60%,#f3f4f6 100%);
      color:#111827;
    }
    a{text-decoration:none;color:inherit}
    .page{min-height:100vh;display:flex;flex-direction:column;}

    /* HEADER */
    .header{
      position:sticky;top:0;z-index:10;
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 16px;
      background:linear-gradient(90deg,#020617,#0f172a,#111827);
      color:#e5e7eb;
      border-bottom:1px solid rgba(148,163,184,0.4);
      box-shadow:0 12px 30px rgba(15,23,42,0.7);
    }
    .logo{
      font-weight:800;font-size:22px;letter-spacing:.06em;
      text-transform:uppercase;
    }
    .logo span{
      color:#f97316;
      text-shadow:0 0 12px rgba(249,115,22,0.9);
    }
    .nav{display:flex;align-items:center;gap:12px;font-size:14px;}
    .nav a{
      color:#e5e7eb;opacity:.85;cursor:pointer;
      padding:4px 10px;border-radius:999px;
      transition:background .15s,opacity .15s,transform .1s;
    }
    .nav a:hover{
      opacity:1;
      background:rgba(15,23,42,0.7);
      transform:translateY(-1px);
    }
    .nav .user-label{font-size:13px;opacity:.8;}
    .btn-outline{
      border:1px solid rgba(248,250,252,0.9);
      border-radius:999px;
      padding:6px 16px;
      font-size:13px;
      cursor:pointer;
      background:radial-gradient(circle at 0 0,#1d4ed8 0,#0f172a 40%,#020617 100%);
      color:#e5e7eb;
      box-shadow:0 6px 16px rgba(15,23,42,0.8),
                 0 0 12px rgba(96,165,250,0.6);
      transition:transform .1s ease,box-shadow .1s ease,filter .1s ease;
    }
    .btn-outline:hover{
      transform:translateY(-2px);
      box-shadow:0 10px 26px rgba(15,23,42,0.9),
                 0 0 16px rgba(96,165,250,0.9);
      filter:brightness(1.05);
    }
    .btn-outline:active{
      transform:translateY(0);
      box-shadow:0 4px 10px rgba(15,23,42,0.8);
    }

    /* LAYOUT */
    .container{
      max-width:1120px;
      margin:0 auto;
      padding:18px 12px 32px;
      flex:1 0 auto;
    }
    .section{margin-bottom:18px;}
    .hidden{display:none;}

    .card{
      background:rgba(255,255,255,0.97);
      border-radius:20px;
      padding:18px 16px 20px;
      box-shadow:
        0 18px 45px rgba(15,23,42,0.22),
        0 0 0 1px rgba(148,163,184,0.35);
      border:1px solid rgba(148,163,184,0.5);
      backdrop-filter:blur(12px);
    }
    .card h2{
      font-size:18px;
      margin-bottom:6px;
    }
    .card p.sub{
      font-size:13px;
      color:#6b7280;
      margin-bottom:10px;
    }
    .hero-text{font-size:14px;color:#4b5563;}

    .grid-2{
      display:grid;
      grid-template-columns:minmax(0,0.9fr) minmax(0,1.1fr);
      gap:16px;
    }

    /* FORM */
    .tabs{
      display:flex;
      gap:4px;
      margin-bottom:10px;
      background:linear-gradient(90deg,#e5e7eb,#f3f4f6);
      border-radius:999px;
      padding:4px;
      width:max-content;
      box-shadow:inset 0 0 0 1px rgba(148,163,184,0.5);
    }
    .tab-btn{
      border:none;
      border-radius:999px;
      padding:6px 14px;
      font-size:13px;
      cursor:pointer;
      background:transparent;
      color:#374151;
    }
    .tab-btn.active{
      background:#ffffff;
      box-shadow:0 3px 10px rgba(15,23,42,0.26);
      color:#111827;
    }

    .form{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:6px;
    }
    .form-row{display:flex;flex-direction:column;gap:4px;}
    label{font-size:13px;color:#4b5563;}
    input,textarea,select{
      border-radius:12px;
      border:1px solid #d1d5db;
      padding:9px 11px;
      background:linear-gradient(135deg,#f9fafb,#ffffff);
      font-size:15px;
      color:#111827;
      box-shadow:0 2px 5px rgba(148,163,184,0.35) inset;
    }
    textarea{min-height:70px;resize:vertical;}
    .form-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:10px;
    }

    .btn{
      align-self:flex-start;
      padding:9px 20px;
      border-radius:999px;
      border:1px solid rgba(249,115,22,0.95);
      cursor:pointer;
      background:radial-gradient(circle at 0 0,#f97316 0,#ea580c 40%,#facc15 100%);
      color:#ffffff;
      font-weight:700;
      font-size:15px;
      letter-spacing:.02em;
      box-shadow:
        0 10px 26px rgba(248,113,22,0.8),
        0 0 18px rgba(249,115,22,0.9);
      transition:transform .1s ease,box-shadow .1s ease,filter .1s ease;
    }
    .btn:hover{
      transform:translateY(-2px);
      box-shadow:
        0 16px 34px rgba(248,113,22,0.9),
        0 0 26px rgba(249,115,22,1);
      filter:brightness(1.04);
    }
    .btn:active{
      transform:translateY(0);
      box-shadow:0 6px 16px rgba(248,113,22,0.85);
    }
    .btn-xs{
      border-radius:999px;
      border:1px solid #d1d5db;
      padding:4px 10px;
      font-size:11px;
      background:linear-gradient(135deg,#ffffff,#f3f4f6);
      cursor:pointer;
      box-shadow:
        0 2px 6px rgba(148,163,184,0.6),
        0 0 6px rgba(148,163,184,0.4);
    }
    .btn-xs:hover{background:#f3f4f6;}

    .hint{font-size:11px;color:#6b7280;}
    .error{font-size:12px;color:#b91c1c;margin-top:2px;}
    .pill{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      background:radial-gradient(circle at 0 0,#dbeafe 0,#eff6ff 40%,#ffffff 100%);
      color:#1d4ed8;
      width:max-content;
      box-shadow:0 2px 6px rgba(59,130,246,0.4);
    }

    /* COURSES */
    .section-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    .muted{font-size:13px;color:#6b7280;}

    .course-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:12px;
      margin-top:6px;
    }
    .course-card{
      background:linear-gradient(135deg,#ffffff,#f9fafb);
      border-radius:16px;
      border:1px solid rgba(209,213,219,0.8);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      box-shadow:0 8px 18px rgba(148,163,184,0.45);
    }
    .course-title{font-size:15px;font-weight:600;color:#111827;}
    .course-desc{
      font-size:13px;
      color:#4b5563;
      max-height:60px;
      overflow:hidden;
    }
    .course-meta{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:11px;
    }
    .badge{
      padding:3px 8px;
      border-radius:999px;
      background:#e5e7eb;
      color:#374151;
    }
    .badge.free{background:#dcfce7;color:#166534;}
    .badge.price{background:#fef9c3;color:#854d0e;}

    .course-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      color:#6b7280;
      margin-top:4px;
      gap:8px;
      flex-wrap:wrap;
    }

    .lesson-list{
      margin-top:6px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .lesson-item{
      background:#ffffff;
      border-radius:12px;
      border:1px solid #e5e7eb;
      padding:9px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      cursor:pointer;
      transition:background .1s ease,box-shadow .1s ease,transform .05s ease,border-color .1s ease;
      box-shadow:0 4px 10px rgba(148,163,184,0.45);
    }
    .lesson-item:hover{
      background:#eef2ff;
      box-shadow:0 7px 16px rgba(79,70,229,0.55);
      transform:translateY(-1px);
      border-color:#818cf8;
    }
    .lesson-item.locked{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
      background:#f9fafb;
    }
    .lesson-title{font-size:13px;font-weight:500;}
    .lesson-status{font-size:11px;text-align:right;display:flex;gap:4px;flex-wrap:wrap;justify-content:flex-end;}

    .video-wrapper{
      position:relative;
      padding-bottom:56.25%;
      height:0;
      overflow:hidden;
      border-radius:14px;
      background:#000;
      margin-top:6px;
      box-shadow:0 12px 28px rgba(15,23,42,0.9);
    }
    .video-wrapper iframe{
      position:absolute;
      top:0;left:0;width:100%;height:100%;
      border:0;
    }

    .mini-form{
      margin-top:6px;
      border-top:1px dashed #e5e7eb;
      padding-top:6px;
    }

    .empty{font-size:13px;color:#9ca3af;margin-top:6px;}

    table.user-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      margin-top:4px;
    }
    table.user-table th,
    table.user-table td{
      text-align:left;
      padding:4px 6px;
      border-bottom:1px solid #f3f4f6;
    }
    table.user-table th{
      border-bottom:1px solid #e5e7eb;
      font-weight:600;
      color:#4b5563;
    }

    /* LESSON PLAYER AREA */
    .detail-layout{
      display:grid;
      grid-template-columns:minmax(0,0.8fr) minmax(0,1.4fr);
      gap:12px;
      margin-top:10px;
    }

    .lesson-player-box{
      margin-top:0;
      background:linear-gradient(135deg,#eff6ff,#f9fafb);
      border-radius:16px;
      border:1px solid #dbeafe;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      box-shadow:0 10px 24px rgba(59,130,246,0.4);
    }
    .lesson-actions{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .lesson-actions .btn-outline,
    .lesson-actions .btn-xs{
      flex:1 0 auto;
    }

    .progress-text{font-size:12px;color:#4b5563;margin-top:4px;}
    .progress-bar-wrap{
      margin-top:4px;
      background:#e5e7eb;
      border-radius:999px;
      height:7px;
      overflow:hidden;
    }
    .progress-bar{
      height:100%;
      width:0%;
      border-radius:999px;
      background:linear-gradient(90deg,#22c55e,#16a34a);
      transition:width .2s ease;
    }

    /* QUIZ OVERLAY (FULL SCREEN) */
    .quiz-overlay{
      position:fixed;
      inset:0;
      z-index:60;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .quiz-overlay.hidden{display:none;}
    .quiz-overlay-backdrop{
      position:absolute;
      inset:0;
      background:rgba(15,23,42,0.9);
      backdrop-filter:blur(8px);
    }
    .quiz-overlay-content{
      position:relative;
      z-index:1;
      width:100%;
      max-width:960px;
      max-height:95vh;
      padding:16px;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .quiz-overlay-box{
      width:100%;
      max-height:100%;
      overflow-y:auto;
      background:#fefce8;
      border-radius:18px;
      border:1px solid #fde68a;
      box-shadow:0 24px 60px rgba(15,23,42,0.95);
      padding:16px 14px 18px;
    }
    .quiz-overlay-title{
      font-size:22px;
      font-weight:800;
      text-align:center;
      margin-bottom:8px;
      color:#92400e;
    }
    .quiz-overlay-sub{
      font-size:15px;
      text-align:center;
      margin-bottom:12px;
      color:#78350f;
    }

    .quiz-question{
      margin-top:8px;
      padding:10px;
      border-radius:14px;
      background:#ffffff;
      border:1px solid #e5e7eb;
      box-shadow:0 4px 12px rgba(148,163,184,0.4);
    }
    .quiz-question-title{
      font-weight:600;
      margin-bottom:4px;
      font-size:15px;
    }
    .quiz-options{
      margin-top:6px;
      display:flex;
      flex-direction:column;
      gap:5px;
    }
    .quiz-option label{
      display:flex;
      gap:6px;
      align-items:flex-start;
      font-size:13px;
      cursor:pointer;
    }

    .quiz-timer{
      margin-top:6px;
      font-size:13px;
      font-weight:600;
      color:#b91c1c;
      text-align:right;
    }

    .quiz-result-item{
      margin-top:6px;
      padding:8px;
      border-radius:12px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      font-size:13px;
    }
    .quiz-correct{
      color:#15803d;
      font-weight:600;
    }
    .quiz-wrong{
      color:#b91c1c;
      font-weight:600;
    }

    .quiz-ranking-table{
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
      font-size:13px;
    }
    .quiz-ranking-table th,
    .quiz-ranking-table td{
      padding:6px 8px;
      border-bottom:1px solid #fee2e2;
      text-align:left;
    }
    .quiz-ranking-table th{
      background:#fef2f2;
      font-weight:600;
      color:#7f1d1d;
    }
    .quiz-ranking-row-me{
      background:#fef9c3;
    }

    /* Kurs tanlash MODAL */
    .modal{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modal.hidden{display:none;}
    .modal-backdrop{
      position:absolute;
      inset:0;
      background:rgba(15,23,42,0.65);
      backdrop-filter:blur(6px);
    }
    .modal-content{
      position:relative;
      z-index:1;
      width:95%;
      max-width:900px;
      max-height:85vh;
      background:#ffffff;
      border-radius:18px;
      padding:16px;
      box-shadow:0 24px 60px rgba(15,23,42,0.75);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:4px;
    }
    .modal-body{overflow-y:auto;}
    .modal-close{
      border:none;
      background:#e5e7eb;
      border-radius:999px;
      padding:4px 10px;
      cursor:pointer;
      font-size:13px;
    }

    /* FOOTER */
    .footer{
      background:#0f172a;
      color:#e5e7eb;
      padding:12px 20px;
      font-size:12px;
      margin-top:auto;
    }
    .footer-inner{
      max-width:1120px;
      margin:0 auto;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:space-between;
      align-items:center;
    }
    .footer small{opacity:.8;}

    /* ===== MOBIL MOSLASH ===== */
    @media(max-width:768px){
      .header{
        flex-direction:column;
        align-items:flex-start;
        gap:6px;
      }
      .nav{
        width:100%;
        justify-content:space-between;
      }
      .container{
        padding:14px 10px 22px;
      }
      .grid-2{
        grid-template-columns:minmax(0,1fr);
      }
      .card{
        padding:14px 12px 16px;
        border-radius:18px;
      }
      .btn,
      .btn-outline{
        width:100%;
        text-align:center;
      }
      .course-grid{
        grid-template-columns:minmax(0,1fr);
      }
      .detail-layout{
        grid-template-columns:1fr;
      }
      .lesson-item{
        padding:9px 9px;
      }
      .quiz-overlay-box{
        border-radius:0;
        max-width:100%;
        height:100%;
      }
      .quiz-overlay-title{font-size:20px;}
      .quiz-overlay-sub{font-size:14px;}
    }
  </style>

  <!-- FIREBASE (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <!-- YOUTUBE IFRAME API -->
  <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
<div class="page">
  <!-- HEADER -->
  <header class="header">
    <div class="logo">Ona tili <span>Pro</span></div>
    <nav class="nav">
      <a id="nav-courses">Kurslar</a>
      <a id="nav-admin" class="hidden">Admin panel</a>
      <span class="user-label" id="current-user-label">Mehmon</span>
      <button class="btn-outline hidden" id="logout-btn">Chiqish</button>
    </nav>
  </header>

  <main class="container">
    <!-- AUTH SECTION -->
    <section id="auth-section" class="section">
      <div class="grid-2">
        <div>
          <div class="card">
            <h2>Xush kelibsiz, online o‚Äòquv markazimizga!</h2>
            <p class="sub">
              Bu yerda siz <b>bilimlaringizni oshirasiz</b> va ‚ÄúOna tili Pro‚Äù kurslari orqali tayyorlana olasiz.
              <br><span style="font-size:12px;color:#9ca3af;">(Admin ma‚Äôlumotlari alohida beriladi)</span>
            </p>

            <div class="tabs">
              <button class="tab-btn active" data-tab="login">Kirish</button>
              <button class="tab-btn" data-tab="register">Ro‚Äòyxatdan o‚Äòtish</button>
            </div>

            <!-- Login form -->
            <form id="login-form" class="form">
              <div class="form-row">
                <label for="login-username">Login</label>
                <input id="login-username" required placeholder="Masalan: talaba01" />
              </div>
              <div class="form-row">
                <label for="login-password">Parol</label>
                <input id="login-password" type="password" required />
              </div>
              <button type="submit" class="btn">Kirish</button>
              <div id="login-error" class="error"></div>
            </form>

            <!-- Register form -->
            <form id="register-form" class="form hidden">
              <div class="form-row">
                <label for="reg-username">Login</label>
                <input id="reg-username" required placeholder="Masalan: talaba01" />
              </div>
              <div class="form-row">
                <label for="reg-password">Parol</label>
                <input id="reg-password" type="password" required />
              </div>
              <div class="form-row">
                <label for="reg-password2">Parolni takrorlang</label>
                <input id="reg-password2" type="password" required />
              </div>
              <p class="hint">
                Ro‚Äòyxatdan o‚Äòtgan foydalanuvchilar kurslarni ko‚Äòrishlari mumkin, lekin
                <b>admin panelga kira olmaydi</b>.
              </p>
              <button type="submit" class="btn">Ro‚Äòyxatdan o‚Äòtish</button>
              <div id="register-error" class="error"></div>
            </form>
          </div>
        </div>

        <div>
          <div class="card">
            <h2>Kurs nomi: ‚ÄúOna tili Pro‚Äù o‚Äòquv markazi</h2>
            <p class="sub">
              Ona tili va adabiyot bo‚Äòyicha onlayn kurslar, testlar va video darslar jamlanmasi.
            </p>
            <p class="hero-text">
              ‚Ä¢ <b>Admin</b> ‚Äî kurs yaratadi, har bir kurs ichiga ko‚Äòplab YouTube
              <b>yashirin (Unlisted)</b> videolarni qo‚Äòshishi mumkin.<br>
              ‚Ä¢ <b>Foydalanuvchi</b> ‚Äî ro‚Äòyxatdan o‚Äòtadi va kurslar ichidagi darslarni tomosha qiladi.<br><br>
              Har bir dars bo‚Äòyicha ko‚Äòrilgan <b>foiz</b> saqlanib boradi. Dars kamida
              <b>90%</b> ko‚Äòrilganda tugallangan hisoblanadi va oldinga yana
              <b>3 ta dars</b> ochiladi.<br>
              Agar darsga <b>quiz</b> biriktirilgan bo‚Äòlsa, dars tugayotganida
              ekranni batamom egallagan <b>katta quiz oynasi</b> chiqadi.
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- ADMIN SECTION -->
    <section id="admin-section" class="section hidden">
      <div class="card">
        <div class="section-header">
          <div>
            <h2>Admin panel</h2>
            <p class="sub">
              Bu qismga faqat admin kirishi mumkin. Kurslar, darslar va foydalanuvchilar shu yerda boshqariladi.
            </p>
          </div>
          <span class="pill">Rol: Admin</span>
        </div>

        <h3 style="font-size:15px;margin-bottom:4px;">Yangi kurs qo‚Äòshish</h3>
        <form id="course-form" class="form">
          <div class="form-row">
            <label for="course-title">Kurs nomi</label>
            <input id="course-title" required placeholder="Masalan: Ona tili Pro ‚Äî 5-sinf" />
          </div>
          <div class="form-row">
            <label for="course-desc">Tavsif</label>
            <textarea id="course-desc" required placeholder="Kurs mazmuni, maqsadi, kimlar uchun..."></textarea>
          </div>
          <div class="form-grid">
            <div class="form-row">
              <label for="course-cat">Yo'nalish</label>
              <input id="course-cat" placeholder="Masalan: Ona tili, Adabiyot..." />
            </div>
            <div class="form-row">
              <label for="course-price">Narx (so'm)</label>
              <input id="course-price" type="number" min="0" placeholder="0 = bepul" />
            </div>
          </div>
          <button type="submit" class="btn">Kursni qo‚Äòshish</button>
          <div id="course-error" class="error"></div>
        </form>

        <hr style="margin:14px 0;border:none;border-top:1px solid #e5e7eb;">

        <div class="section-header">
          <h3 style="font-size:15px;">Mavjud kurslar</h3>
          <span class="muted" id="admin-course-count">0 ta kurs</span>
        </div>
        <div id="admin-course-list"></div>
        <div id="admin-empty" class="empty">Hozircha kurs yo‚Äòq. Yuqoridan kurs qo‚Äòshing.</div>

        <hr style="margin:14px 0;border:none;border-top:1px solid #e5e7eb;">

        <div class="section-header">
          <h3 style="font-size:15px;">Foydalanuvchilar ro‚Äòyxati</h3>
          <span class="muted" id="admin-user-count">0 ta foydalanuvchi</span>
        </div>
        <div id="admin-user-list" class="empty">Ma'lumotlar yuklanmoqda...</div>
      </div>
    </section>

    <!-- USER SECTION -->
    <section id="user-section" class="section hidden">
      <div class="card">
        <div class="section-header">
          <div>
            <h2>Kurslar paneli</h2>
            <p class="sub">
              Ro‚Äòyxatdan o‚Äòtgan barcha foydalanuvchilar bu yerdagi kurslarni ko‚Äòrishi mumkin.
            </p>
          </div>
          <span class="pill" id="user-role-pill">Rol: Foydalanuvchi</span>
        </div>

        <div class="section-header">
          <button class="btn" id="btn-open-course-modal">Kurs tanlash</button>
          <span class="muted" id="user-course-count">0 ta kurs</span>
        </div>

        <!-- Kurslar ro'yxati -->
        <div id="user-courses-view">
          <div id="user-course-list" class="course-grid"></div>
          <div id="user-empty" class="empty">
            Hozircha kurslar qo‚Äòshilmagan. Admin panel orqali kurs qo‚Äòshilishi kerak.
          </div>
        </div>

        <!-- Bitta kurs ichiga kirilganda -->
        <div id="user-course-detail" class="hidden">
          <button class="btn" id="user-back-btn" style="margin-bottom:8px;">‚Üê Kurslar paneliga qaytish</button>
          <h3 id="detail-title" style="font-size:18px;margin-bottom:4px;"></h3>
          <p id="detail-desc" class="muted" style="margin-bottom:8px;"></p>
          <div class="course-meta" id="detail-meta"></div>

          <div class="detail-layout">
            <div id="detail-lessons"></div>

            <div class="lesson-player-box">
              <div class="muted" id="lesson-player-title">Dars tanlanmagan.</div>
              <div class="video-wrapper hidden" id="lesson-video-wrapper">
                <div id="yt-player"></div>
              </div>
              <div class="lesson-actions">
                <button class="btn-outline hidden" id="lesson-fullscreen-btn">Fullscreen (landscape)</button>
                <button class="btn-outline hidden" id="lesson-show-results-btn">Natijalar (reyting)</button>
              </div>
              <div class="progress-text" id="lesson-progress-text"></div>
              <div class="progress-bar-wrap">
                <div class="progress-bar" id="lesson-progress-bar"></div>
              </div>
              <div class="hint" style="margin-top:4px;">
                Dars kamida <b>90%</b> ko‚Äòrilganda tugallangan hisoblanadi.
                1-dars tugallansa, oldinda <b>yana 3 ta dars</b> ochiladi.
                Agar darsga quiz biriktirilgan bo‚Äòlsa, dars tugayotganida
                ekranni egallagan <b>quiz oynasi</b> chiqadi.
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="footer-inner">
      <small>¬© Ona tili Pro online o‚Äòquv markazi ‚Äî bilimlaringiz uchun raqamli hamroh.</small>
      <small>
        Aloqa: <b>+998 90 000 00 00</b> ¬∑ Telegram: <b>@onatili_pro</b>
      </small>
    </div>
  </footer>
</div>

<!-- Kurs tanlash MODAL -->
<div id="course-modal" class="modal hidden">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <div class="modal-header">
      <div>
        <h3 style="font-size:17px;">Kurs tanlash</h3>
        <p class="muted">Kerakli kursni tanlang ‚Äî kurs ichidagi darslar ochiladi.</p>
      </div>
      <button class="modal-close" id="course-modal-close">Yopish ‚úï</button>
    </div>
    <div class="modal-body">
      <div id="course-modal-list" class="course-grid"></div>
    </div>
  </div>
</div>

<!-- QUIZ FULLSCREEN OVERLAY -->
<div id="quiz-overlay" class="quiz-overlay hidden">
  <div class="quiz-overlay-backdrop"></div>
  <div class="quiz-overlay-content">
    <div class="quiz-overlay-box" id="quiz-overlay-box">
      <!-- JS orqali to‚Äòldiriladi -->
    </div>
  </div>
</div>

<script>
  /* YOUTUBE API HOLATI */
  let ytApiReady = false;
  function onYouTubeIframeAPIReady(){ ytApiReady = true; }

  /* FIREBASE INIT */
  const firebaseConfig = {
    apiKey: "AIzaSyDVidcgjpUxkg88bxXfIFzmsFydv0rMMao",
    authDomain: "shahboz-5d0a3.firebaseapp.com",
    projectId: "shahboz-5d0a3",
    storageBucket: "shahboz-5d0a3.appspot.com",
    messagingSenderId: "352024095535",
    appId: "1:352024095535:web:6ca630de2c199a33c54fda",
    measurementId: "G-YS5RGZ00EB"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /* LOCAL STATE */
  let data = { currentUser:null, courses:[] };
  const CURRENT_USER_KEY = "talimEduCurrentUser_v1";
  const REMEMBER_CREDENTIALS_KEY = "talimEduRemember_v1";

  /* DOM */
  const authSection = document.getElementById("auth-section");
  const adminSection = document.getElementById("admin-section");
  const userSection = document.getElementById("user-section");
  const navAdmin = document.getElementById("nav-admin");
  const navCourses = document.getElementById("nav-courses");
  const logoutBtn = document.getElementById("logout-btn");
  const currentUserLabel = document.getElementById("current-user-label");
  const userRolePill = document.getElementById("user-role-pill");

  const tabButtons = document.querySelectorAll(".tab-btn");
  const loginForm = document.getElementById("login-form");
  const registerForm = document.getElementById("register-form");
  const loginErrorEl = document.getElementById("login-error");
  const registerErrorEl = document.getElementById("register-error");

  const loginUsername = document.getElementById("login-username");
  const loginPassword = document.getElementById("login-password");
  const regUsername = document.getElementById("reg-username");
  const regPassword = document.getElementById("reg-password");
  const regPassword2 = document.getElementById("reg-password2");

  const courseForm = document.getElementById("course-form");
  const courseError = document.getElementById("course-error");
  const adminCourseList = document.getElementById("admin-course-list");
  const adminCourseCount = document.getElementById("admin-course-count");
  const adminEmpty = document.getElementById("admin-empty");

  const adminUserList = document.getElementById("admin-user-list");
  const adminUserCount = document.getElementById("admin-user-count");

  const userCoursesView = document.getElementById("user-courses-view");
  const userCourseDetail = document.getElementById("user-course-detail");
  const userCourseList = document.getElementById("user-course-list");
  const userCourseCount = document.getElementById("user-course-count");
  const userEmpty = document.getElementById("user-empty");
  const userBackBtn = document.getElementById("user-back-btn");

  const detailTitle = document.getElementById("detail-title");
  const detailDesc = document.getElementById("detail-desc");
  const detailMeta = document.getElementById("detail-meta");
  const detailLessons = document.getElementById("detail-lessons");

  const lessonPlayerTitle = document.getElementById("lesson-player-title");
  const lessonVideoWrapper = document.getElementById("lesson-video-wrapper");
  const lessonProgressText = document.getElementById("lesson-progress-text");
  const lessonProgressBar = document.getElementById("lesson-progress-bar");

  const btnOpenCourseModal = document.getElementById("btn-open-course-modal");
  const courseModal = document.getElementById("course-modal");
  const courseModalClose = document.getElementById("course-modal-close");
  const courseModalList = document.getElementById("course-modal-list");

  const quizOverlay = document.getElementById("quiz-overlay");
  const quizOverlayBox = document.getElementById("quiz-overlay-box");

  const lessonFullscreenBtn = document.getElementById("lesson-fullscreen-btn");
  const lessonShowResultsBtn = document.getElementById("lesson-show-results-btn");

  /* HELPERS: localStorage */
  function loadCurrentUserFromLocal(){
    try{
      const raw = localStorage.getItem(CURRENT_USER_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch{ return null; }
  }
  function saveCurrentUserToLocal(){
    if(!data.currentUser) localStorage.removeItem(CURRENT_USER_KEY);
    else localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(data.currentUser));
  }
  function saveRememberedCredentials(username,password){
    try{
      localStorage.setItem(REMEMBER_CREDENTIALS_KEY, JSON.stringify({username,password}));
    }catch{}
  }
  function loadRememberedCredentials(){
    try{
      const raw = localStorage.getItem(REMEMBER_CREDENTIALS_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch{ return null; }
  }

  /* PAROLNI HASH QILISH (SHA-256) */
  async function hashPassword(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  async function ensureDefaultAdmin(){
    const adminUsername = "Shahbozbek0603";
    const adminPlain = "06032768shahbozqwertyasdf";
    const ref = db.collection("users").doc(adminUsername);
    const doc = await ref.get();
    if(!doc.exists){
      const passwordHash = await hashPassword(adminPlain);
      await ref.set({ username:adminUsername, passwordHash, role:"admin" });
    }
  }

  function formatPrice(price){
    const n = Number(price);
    if(!price && price!==0) return "";
    if(isNaN(n)) return "";
    if(n===0) return "Bepul";
    return n.toLocaleString("uz-UZ")+" so'm";
  }
  function extractYouTubeId(input){
    if(!input) return "";
    let url = input.trim();
    let m = url.match(/youtu\.be\/([^?&]+)/);
    if(m) return m[1];
    m = url.match(/v=([^&]+)/);
    if(m) return m[1];
    m = url.match(/embed\/([^?&]+)/);
    if(m) return m[1];
    return url;
  }
  function getMotivationMessage(score,total){
    if(!total) return "";
    const percent = Math.round((score/total)*100);
    if(percent===100) return "Ajoyib! Barcha savollarga to‚Äòg‚Äòri javob berdingiz ‚Äî zo‚Äòr natija! üî•";
    if(percent>=80) return "Judayam yaxshi! Bir-ikki kichik xato ‚Äî lekin bilimingiz mustahkam. Davom eting! üí™";
    if(percent>=60) return "Yaxshi urinish! Ba‚Äôzi joylarni yana bir bor takrorlab chiqsangiz, natija yanada oshadi. üëç";
    if(percent>=30) return "Yomon emas. Lekin ayrim joylarni yana bir bor ko‚Äòrib chiqsangiz yanada yaxshi bo‚Äòladi. üôÇ";
    return "Hali hammasi oldinda. Bu darsni qayta ko‚Äòrib, yana bir urinish qilishingiz kerak. Siz albatta uddalaysiz! üå±";
  }

  function getCurrentLesson(){
    if(!data.currentUser || !currentCourseDetail || !currentLessonId) return null;
    return (currentCourseDetail.lessons||[]).find(l=>l.id===currentLessonId) || null;
  }

  /* PROGRESS (Firestore) */
  async function loadProgress(username,courseId){
    const id = `${username}_${courseId}`;
    const ref = db.collection("progress").doc(id);
    const doc = await ref.get();
    if(!doc.exists) return { user:username, courseId, lessons:{} };
    const d = doc.data();
    if(!d.lessons) d.lessons = {};
    return d;
  }

  async function saveLessonProgress(username,courseId,lessonId,percent,completedFlag){
    const id = `${username}_${courseId}`;
    const ref = db.collection("progress").doc(id);
    const doc = await ref.get();
    let d = doc.exists ? doc.data() : { user:username, courseId, lessons:{} };
    if(!d.lessons) d.lessons = {};
    const prev = d.lessons[lessonId] || {};
    const maxPercent = Math.max(prev.percent||0, percent||0);
    const videoCompleted = prev.videoCompleted || completedFlag || maxPercent>=90;
    d.lessons[lessonId] = { ...prev, percent:maxPercent, videoCompleted };
    await ref.set(d);
    return d;
  }

  async function saveLessonQuizAttempt(username,courseId,lessonId,scorePercent){
    const id = `${username}_${courseId}`;
    const ref = db.collection("progress").doc(id);
    const doc = await ref.get();
    let d = doc.exists ? doc.data() : { user:username, courseId, lessons:{} };
    if(!d.lessons) d.lessons = {};
    const prev = d.lessons[lessonId] || {};
    const attempts = (prev.quizAttempts||0)+1;
    const quizBestPercent = Math.max(prev.quizBestPercent||0, scorePercent||0);
    const quizPassed = prev.quizPassed || scorePercent>=30;
    d.lessons[lessonId] = { ...prev, quizAttempts:attempts, quizBestPercent, quizPassed };
    await ref.set(d);

    const key = `${courseId}__${lessonId}`;
    const resId = `${courseId}_${lessonId}_${username}`;
    await db.collection("lessonQuizResults").doc(resId).set({
      key,
      courseId,
      lessonId,
      username,
      scorePercent,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    return d;
  }

  async function fetchLessonRanking(courseId,lessonId){
    const key = `${courseId}__${lessonId}`;
    const snap = await db.collection("lessonQuizResults")
      .where("key","==",key)
      .get();
    const list = snap.docs.map(d=>d.data());
    list.sort((a,b)=>b.scorePercent - a.scorePercent);
    return list;
  }

  /* FIRESTORE HELPERS */
  async function registerUser(u,p){
    const ref = db.collection("users").doc(u);
    const doc = await ref.get();
    if(doc.exists) throw new Error("exists");
    await ref.set({ username:u, password:p, role:"user" });
  }

  async function loginUser(u,p){
    const ref = db.collection("users").doc(u);
    const doc = await ref.get();
    if(!doc.exists) return null;
    const user = doc.data();

    // Admin: hash orqali
    if(user.passwordHash){
      const hash = await hashPassword(p);
      if(hash===user.passwordHash) return user;
      return null;
    }
    // Oddiy foydalanuvchi: oddiy parol
    if(user.password !== undefined){
      return user.password===p ? user : null;
    }
    return null;
  }

  async function addCourseToFirestore(course){
    await db.collection("courses").doc(course.id).set(course);
  }
  async function deleteCourseFromFirestore(courseId){
    await db.collection("courses").doc(courseId).delete();
  }
  async function updateCourseLessons(courseId,lessons){
    await db.collection("courses").doc(courseId).update({ lessons });
  }
  async function loadCoursesFromFirestore(){
    const snap = await db.collection("courses").get();
    data.courses = snap.docs.map(d=>d.data());
  }
  async function refreshCourses(){
    await loadCoursesFromFirestore();
    renderAdminCourses();
    renderUserCourses();
    renderCourseModalList();
  }
  async function loadUsersFromFirestore(){
    const snap = await db.collection("users").get();
    renderAdminUsers(snap.docs.map(d=>d.data()));
  }

  /* RENDER ADMIN USERS */
  function renderAdminUsers(users){
    adminUserCount.textContent = users.length+" ta foydalanuvchi";
    if(!users.length){
      adminUserList.className="empty";
      adminUserList.textContent="Foydalanuvchilar hali yo‚Äòq.";
      return;
    }
    adminUserList.classList.remove("empty");
    adminUserList.innerHTML = `
      <div style="overflow-x:auto;">
        <table class="user-table">
          <thead><tr><th>Login</th><th>Rol</th></tr></thead>
          <tbody>${users.map(u=>`<tr><td>${u.username}</td><td>${u.role}</td></tr>`).join("")}</tbody>
        </table>
      </div>`;
  }

  /* RENDER ADMIN COURSES + QUIZ BUILDER */
  function renderAdminCourses(){
    const courses = data.courses||[];
    adminCourseList.innerHTML="";
    adminCourseCount.textContent = courses.length+" ta kurs";
    if(!courses.length){ adminEmpty.style.display="block"; return; }
    adminEmpty.style.display="none";

    courses.forEach(course=>{
      const div = document.createElement("div");
      div.className = "course-card";
      const priceText = formatPrice(course.price);
      const lessons = course.lessons||[];

      let lessonsHtml = "";
      if(!lessons.length){
        lessonsHtml = `<div class="empty">Hali dars qo‚Äòshilmagan.</div>`;
      }else{
        lessonsHtml = `
          <div class="lesson-list">
            ${lessons.map((l,i)=>`
              <div class="lesson-item">
                <div>
                  <div class="lesson-title">${i+1}. ${l.title}</div>
                  <div class="muted" style="font-size:11px;">
                    ID: ${l.id}
                    ${l.quiz && l.quiz.length ? " ¬∑ Quiz savollar: "+l.quiz.length+" ta" : ""}
                  </div>
                </div>
                <div class="lesson-status">
                  <button type="button" class="btn-xs btn-lesson-up"
                          data-course-id="${course.id}" data-lesson-id="${l.id}">‚Üë</button>
                  <button type="button" class="btn-xs btn-lesson-down"
                          data-course-id="${course.id}" data-lesson-id="${l.id}">‚Üì</button>
                  <button type="button" class="btn-xs btn-lesson-delete"
                          data-course-id="${course.id}" data-lesson-id="${l.id}">O‚Äòchirish</button>
                </div>
              </div>
            `).join("")}
          </div>`;
      }

      div.innerHTML = `
        <div class="course-title">${course.title}</div>
        <div class="course-desc">${course.description}</div>
        <div class="course-meta">
          ${course.category?`<span class="badge">${course.category}</span>`:""}
          ${priceText?`<span class="badge ${course.price==0?"free":"price"}">${priceText}</span>`:""}
          <span class="badge">Darslar: ${lessons.length}</span>
        </div>
        <div class="course-footer">
          <span class="muted">Kurs ID: ${course.id}</span>
          <button type="button" class="btn-xs btn-delete-course" data-course-id="${course.id}">Kursni o‚Äòchirish</button>
        </div>

        <div class="mini-form">
          <div class="muted" style="margin-bottom:4px;">Ushbu kursga yangi dars/video qo‚Äòshish:</div>
          <form class="lesson-form" data-course-id="${course.id}">
            <div class="form-row">
              <label>Dars nomi</label>
              <input name="lessonTitle" required placeholder="Masalan: 1-dars. Kirish" />
            </div>
            <div class="form-row">
              <label>YouTube havolasi yoki ID</label>
              <input name="lessonUrl" required placeholder="https://youtu.be/... yoki faqat ID" />
              <div class="hint">Videoni YouTube‚Äôda <b>Unlisted</b> qilib yuklash tavsiya etiladi.</div>
            </div>

            <div class="form-row" style="margin-top:4px;">
              <label>
                <input type="checkbox" name="enableQuiz" class="quiz-toggle" />
                Ushbu darsga <b>quiz savollari</b> qo‚Äòshaman
              </label>
            </div>

            <div class="quiz-builder hidden">
              <div class="muted" style="font-size:11px;margin-bottom:4px;">
                Har bir savol uchun matn va A/B/C/D variantlarni kiriting,
                keyin to‚Äòg‚Äòri javobni va vaqtni (soniya) tanlang.
              </div>
              <div class="quiz-questions"></div>
              <button type="button" class="btn-xs btn-add-question" style="margin-top:4px;">+ Savol qo‚Äòshish</button>
            </div>

            <button type="submit" class="btn" style="margin-top:6px;">Darsni qo‚Äòshish</button>
          </form>
        </div>

        ${lessonsHtml}
      `;
      adminCourseList.appendChild(div);
    });
  }

  /* Quiz builder: on/off */
  adminCourseList.addEventListener("change",e=>{
    if(!e.target.classList.contains("quiz-toggle")) return;
    const form = e.target.closest("form");
    const builder = form.querySelector(".quiz-builder");
    if(!builder) return;
    builder.classList.toggle("hidden", !e.target.checked);
  });

  /* Quiz builder: savol qo‚Äòshish */
  adminCourseList.addEventListener("click",e=>{
    const btn = e.target.closest(".btn-add-question");
    if(!btn) return;
    const form = btn.closest("form");
    const container = form.querySelector(".quiz-questions");
    if(!container) return;
    const index = container.children.length + 1;
    const block = document.createElement("div");
    block.className = "quiz-question-block";
    block.style.marginTop = "6px";
    block.innerHTML = `
      <div class="form-row">
        <label>${index}-savol matni</label>
        <input class="q-text" required placeholder="Savol matni" />
      </div>
      <div class="form-grid" style="margin-top:4px;">
        <div class="form-row">
          <label>A)</label>
          <input class="q-opt-a" required />
        </div>
        <div class="form-row">
          <label>B)</label>
          <input class="q-opt-b" required />
        </div>
        <div class="form-row">
          <label>C)</label>
          <input class="q-opt-c" required />
        </div>
        <div class="form-row">
          <label>D)</label>
          <input class="q-opt-d" required />
        </div>
      </div>
      <div class="form-grid" style="margin-top:4px;">
        <div class="form-row">
          <label>To‚Äòg‚Äòri javob</label>
          <select class="q-correct">
            <option value="0">A</option>
            <option value="1">B</option>
            <option value="2">C</option>
            <option value="3">D</option>
          </select>
        </div>
        <div class="form-row">
          <label>Savol vaqti (soniya)</label>
          <input type="number" class="q-time" min="5" value="30" />
        </div>
      </div>
      <hr style="margin-top:6px;border:none;border-top:1px dashed #e5e7eb;">
    `;
    container.appendChild(block);
  });

  /* Admin: dars qo‚Äòshish */
  adminCourseList.addEventListener("submit",async e=>{
    if(!e.target.classList.contains("lesson-form")) return;
    e.preventDefault();
    if(!data.currentUser || data.currentUser.role!=="admin") return;

    const form = e.target;
    const courseId = form.dataset.courseId;
    const title = form.lessonTitle.value.trim();
    const url = form.lessonUrl.value.trim();
    if(!title || !url) return;
    const videoId = extractYouTubeId(url);
    if(!videoId){ alert("YouTube havola/ID noto‚Äòg‚Äòri."); return; }

    let quiz = [];
    const quizToggle = form.querySelector(".quiz-toggle");
    if(quizToggle && quizToggle.checked){
      const blocks = form.querySelectorAll(".quiz-question-block");
      blocks.forEach((block,idx)=>{
        const text = block.querySelector(".q-text")?.value.trim() || "";
        const a = block.querySelector(".q-opt-a")?.value.trim() || "";
        const b = block.querySelector(".q-opt-b")?.value.trim() || "";
        const c = block.querySelector(".q-opt-c")?.value.trim() || "";
        const d = block.querySelector(".q-opt-d")?.value.trim() || "";
        const correctRaw = block.querySelector(".q-correct")?.value;
        const timeRaw = parseInt(block.querySelector(".q-time")?.value,10);
        const correctIndex = correctRaw!==undefined ? parseInt(correctRaw,10) : 0;
        const timeLimit = (!isNaN(timeRaw) && timeRaw>0) ? timeRaw : 30;
        if(text && a && b && c && d){
          quiz.push({
            id: Date.now().toString()+"_"+idx,
            question:text,
            options:[a,b,c,d],
            correctIndex:isNaN(correctIndex)?0:correctIndex,
            timeLimit:timeLimit
          });
        }
      });
    }

    try{
      const course = data.courses.find(c=>c.id===courseId);
      if(!course) return;
      const lessons = course.lessons || [];
      lessons.push({
        id: Date.now().toString(),
        title,
        videoId,
        quiz
      });
      await updateCourseLessons(courseId,lessons);
      await refreshCourses();
      form.reset();
    }catch(err){
      console.error(err);
      alert("Darsni saqlashda xatolik yuz berdi.");
    }
  });

  /* Admin: kurs / dars o‚Äòchirish va tartiblash */
  adminCourseList.addEventListener("click",async e=>{
    const courseDel = e.target.closest(".btn-delete-course");
    const lessonDel = e.target.closest(".btn-lesson-delete");
    const lessonUp  = e.target.closest(".btn-lesson-up");
    const lessonDown= e.target.closest(".btn-lesson-down");

    if(courseDel){
      const courseId = courseDel.dataset.courseId;
      if(!confirm("Kursni o‚Äòchirishni xohlaysizmi?")) return;
      try{
        await deleteCourseFromFirestore(courseId);
        data.courses = data.courses.filter(c=>c.id!==courseId);
        renderAdminCourses();
        renderUserCourses();
        renderCourseModalList();
      }catch(err){
        console.error(err);
        alert("Kursni o‚Äòchirishda xatolik yuz berdi.");
      }
      return;
    }

    if(!lessonDel && !lessonUp && !lessonDown) return;
    if(!data.currentUser || data.currentUser.role!=="admin") return;

    const btn = lessonDel || lessonUp || lessonDown;
    const courseId = btn.dataset.courseId;
    const lessonId = btn.dataset.lessonId;
    const course = data.courses.find(c=>c.id===courseId);
    if(!course) return;
    const lessons = course.lessons || [];
    const idx = lessons.findIndex(l=>l.id===lessonId);
    if(idx===-1) return;

    try{
      if(lessonDel){
        if(!confirm("Bu darsni o‚Äòchirishni xohlaysizmi?")) return;
        lessons.splice(idx,1);
      }else if(lessonUp){
        if(idx===0) return;
        [lessons[idx-1],lessons[idx]] = [lessons[idx],lessons[idx-1]];
      }else if(lessonDown){
        if(idx===lessons.length-1) return;
        [lessons[idx],lessons[idx+1]] = [lessons[idx+1],lessons[idx]];
      }
      await updateCourseLessons(courseId,lessons);
      await refreshCourses();
    }catch(err){
      console.error(err);
      alert("Darsni yangilashda xatolik yuz berdi.");
    }
  });

  /* USER COURSES GRID */
  function renderUserCourses(){
    const courses = data.courses||[];
    userCourseList.innerHTML="";
    userCourseCount.textContent = courses.length+" ta kurs";
    if(!courses.length){ userEmpty.style.display="block"; return; }
    userEmpty.style.display="none";

    courses.forEach(course=>{
      const card = document.createElement("div");
      card.className="course-card";
      const priceText = formatPrice(course.price);
      const lessons = course.lessons||[];
      card.innerHTML = `
        <div class="course-title">${course.title}</div>
        <div class="course-desc">${course.description}</div>
        <div class="course-meta">
          ${course.category?`<span class="badge">${course.category}</span>`:""}
          ${priceText?`<span class="badge ${course.price==0?"free":"price"}">${priceText}</span>`:""}
          <span class="badge">Darslar: ${lessons.length}</span>
        </div>
        <div class="course-footer">
          <span class="muted">Kurs ID: ${course.id}</span>
          <button type="button" class="btn btn-open-course" data-course-id="${course.id}">Kursga kirish</button>
        </div>`;
      userCourseList.appendChild(card);
    });
  }

  /* MODAL Kurs tanlash */
  function renderCourseModalList(){
    const courses = data.courses||[];
    courseModalList.innerHTML="";
    if(!courses.length){
      courseModalList.innerHTML=`<div class="empty">Hozircha kurslar yo‚Äòq.</div>`;
      return;
    }
    courses.forEach(course=>{
      const div = document.createElement("div");
      div.className="course-card";
      const priceText = formatPrice(course.price);
      const lessons = course.lessons||[];
      div.innerHTML = `
        <div class="course-title">${course.title}</div>
        <div class="course-desc">${course.description}</div>
        <div class="course-meta">
          ${course.category?`<span class="badge">${course.category}</span>`:""}
          ${priceText?`<span class="badge ${course.price==0?"free":"price"}">${priceText}</span>`:""}
          <span class="badge">Darslar: ${lessons.length}</span>
        </div>
        <div class="course-footer">
          <button type="button" class="btn btn-open-course-modal" data-course-id="${course.id}">Tanlash</button>
        </div>`;
      courseModalList.appendChild(div);
    });
  }
  function openCourseModal(){ courseModal.classList.remove("hidden"); }
  function closeCourseModal(){ courseModal.classList.add("hidden"); }

  btnOpenCourseModal.addEventListener("click",()=>{
    renderCourseModalList();
    openCourseModal();
  });
  courseModalClose.addEventListener("click",closeCourseModal);
  courseModal.addEventListener("click",e=>{
    if(e.target.classList.contains("modal-backdrop")) closeCourseModal();
  });
  courseModalList.addEventListener("click",async e=>{
    const btn = e.target.closest(".btn-open-course-modal");
    if(!btn) return;
    const courseId = btn.dataset.courseId;
    closeCourseModal();
    await openUserCourseDetail(courseId);
  });

  /* LESSON / PLAYER / QUIZ STATE */
  let currentCourseDetail = null;
  let currentCourseProgress = null;
  let currentPlayer = null;
  let currentLessonId = null;
  let progressInterval = null;
  let lastSavedPercent = 0;
  let quizShownForLesson = false;

  let currentLessonQuiz = [];

  let quizTimerId = null;
  let quizCurrentIndex = 0;
  let quizAnswers = {};
  let quizRemaining = 0;
  let autoNextTimeoutId = null;

  function clearQuizTimer(){
    if(quizTimerId){
      clearInterval(quizTimerId);
      quizTimerId = null;
    }
  }
  function clearAutoNext(){
    if(autoNextTimeoutId){
      clearTimeout(autoNextTimeoutId);
      autoNextTimeoutId = null;
    }
  }

  /* Progressni bir marta majburan saqlash (sahifadan chiqishda) */
  async function saveCurrentLessonProgressOnce(){
    try{
      if(!currentPlayer || !currentCourseDetail || !currentLessonId || !data.currentUser) return;
      if(typeof currentPlayer.getDuration!=="function") return;
      const dur = currentPlayer.getDuration();
      const cur = currentPlayer.getCurrentTime ? currentPlayer.getCurrentTime() : 0;
      if(!dur || dur<=0) return;
      let percent = Math.min(100, (cur/dur)*100);
      if(dur - cur <= 7){ // oxirgi 7 soniya ichida bo'lsa, to'liq deb hisoblaymiz
        percent = 100;
      }
      const p = await saveLessonProgress(data.currentUser.username,currentCourseDetail.id,currentLessonId,percent,false);
      currentCourseProgress = p;
    }catch(err){
      console.error("saveCurrentLessonProgressOnce error",err);
    }
  }

  /* Progress tracking intervali */
  function stopProgressTracking(){
    if(progressInterval){
      clearInterval(progressInterval);
      progressInterval = null;
    }
  }

  async function updateProgressFromPlayer(force){
    try{
      if(!currentPlayer || !currentCourseDetail || !currentLessonId || !data.currentUser) return;
      if(typeof currentPlayer.getDuration!=="function") return;
      const dur = currentPlayer.getDuration();
      const cur = currentPlayer.getCurrentTime ? currentPlayer.getCurrentTime() : 0;
      if(!dur || dur<=0) return;

      let percent = Math.min(100, (cur/dur)*100);
      if(dur - cur <= 7){ // oxirgi 7 soniya
        percent = 100;
      }

      if(!force && percent - lastSavedPercent < 2) return;
      lastSavedPercent = percent;

      const p = await saveLessonProgress(
        data.currentUser.username,
        currentCourseDetail.id,
        currentLessonId,
        percent,
        false
      );
      currentCourseProgress = p;
      updateLessonProgressUI();
      renderLessonList(currentCourseDetail,currentCourseProgress);
    }catch(err){
      console.error("updateProgressFromPlayer error",err);
    }
  }

  function startProgressTracking(){
    stopProgressTracking();
    if(!currentPlayer) return;
    progressInterval = setInterval(async ()=>{
      await updateProgressFromPlayer(false);
      // Quiz trigger: oxirgi 7 soniya
      const lesson = getCurrentLesson();
      if(!lesson || !lesson.quiz || !lesson.quiz.length) return;
      if(quizShownForLesson) return;
      if(typeof currentPlayer.getDuration!=="function") return;
      const dur = currentPlayer.getDuration();
      const cur = currentPlayer.getCurrentTime ? currentPlayer.getCurrentTime() : 0;
      if(dur && cur && dur - cur <= 7){
        quizShownForLesson = true;
        currentPlayer.pauseVideo();
        openQuizForCurrentLesson();
      }
    },5000);
  }

  function updateLessonProgressUI(){
    if(!currentCourseProgress || !currentLessonId){
      lessonProgressText.textContent = "";
      lessonProgressBar.style.width = "0%";
      return;
    }
    const s = currentCourseProgress.lessons?.[currentLessonId];
    const percent = s?.percent || 0;
    const videoCompleted = !!s?.videoCompleted;
    const quizBest = s?.quizBestPercent || 0;
    const quizAttempts = s?.quizAttempts || 0;

    let txt = `Ko‚Äòrilgan: ${percent.toFixed(1)}%`;
    if(videoCompleted) txt += " ¬∑ Video tugallangan ‚úÖ";
    if(quizAttempts>0){
      txt += ` ¬∑ Quiz: eng yaxshi natija ${quizBest.toFixed(1)}% (${quizAttempts} urinish)`;
    }
    lessonProgressText.textContent = txt;
    lessonProgressBar.style.width = `${Math.min(100,percent)}%`;
  }

  /* LESSON UNLOCK LOGIC
     - 0-indexdagi dars har doim ochiq
     - Agar darsda quiz bo‚Äòlsa: videoCompleted && quizPassed bo‚Äòlsa "tugallangan" hisoblanadi
     - Dars tugallanganda undan keyingi 3 ta darsni ochamiz
  */
  function computeUnlockedLessonIndexes(course,progress){
    const lessons = course.lessons || [];
    const unlocked = new Set();
    if(!lessons.length) return unlocked;
    unlocked.add(0);
    const progLessons = (progress && progress.lessons) || {};

    lessons.forEach((l,idx)=>{
      const st = progLessons[l.id] || {};
      const hasQuiz = l.quiz && l.quiz.length>0;
      const completed = hasQuiz ? (st.videoCompleted && st.quizPassed) : !!st.videoCompleted;
      if(completed){
        unlocked.add(idx);
        if(idx+1 < lessons.length) unlocked.add(idx+1);
        if(idx+2 < lessons.length) unlocked.add(idx+2);
        if(idx+3 < lessons.length) unlocked.add(idx+3);
      }
    });
    return unlocked;
  }

  function renderLessonList(course,progress){
    const lessons = course.lessons || [];
    detailLessons.innerHTML = "";
    if(!lessons.length){
      detailLessons.innerHTML = `<div class="empty">Bu kursda hali dars yo‚Äòq.</div>`;
      return;
    }
    const unlockedIndexes = computeUnlockedLessonIndexes(course,progress);
    const progLessons = (progress && progress.lessons) || {};

    const list = document.createElement("div");
    list.className="lesson-list";

    lessons.forEach((l,idx)=>{
      const item = document.createElement("div");
      const st = progLessons[l.id] || {};
      const percent = st.percent || 0;
      const hasQuiz = l.quiz && l.quiz.length>0;
      const hasQuizPassed = !!st.quizPassed;
      const isUnlocked = unlockedIndexes.has(idx);

      item.className = "lesson-item";
      if(!isUnlocked) item.classList.add("locked");
      item.dataset.lessonId = l.id;

      let status = `Ko‚Äòrilgan: ${percent.toFixed(1)}%`;
      if(st.videoCompleted) status += " ¬∑ Video ‚úÖ";
      if(hasQuiz){
        if(hasQuizPassed) status += ` ¬∑ Quiz ‚úÖ (${(st.quizBestPercent||0).toFixed(1)}%)`;
        else if(st.quizAttempts>0) status += ` ¬∑ Quiz ‚ùå (${(st.quizBestPercent||0).toFixed(1)}%)`;
        else status += " ¬∑ Quiz mavjud";
      }

      item.innerHTML = `
        <div>
          <div class="lesson-title">${idx+1}-dars. ${l.title}</div>
          <div class="muted" style="font-size:11px;">ID: ${l.id}${hasQuiz?" ¬∑ Quiz savollar: "+l.quiz.length+" ta":""}</div>
        </div>
        <div class="lesson-status">${status}</div>
      `;

      if(isUnlocked){
        item.addEventListener("click",()=>openLesson(l.id));
      }
      list.appendChild(item);
    });

    detailLessons.appendChild(list);
  }

  async function openUserCourseDetail(courseId){
    if(!data.currentUser){
      alert("Avval tizimga kiring.");
      return;
    }
    const course = (data.courses||[]).find(c=>c.id===courseId);
    if(!course){
      alert("Kurs topilmadi.");
      return;
    }
    currentCourseDetail = course;
    currentCourseProgress = await loadProgress(data.currentUser.username, courseId);
    quizShownForLesson = false;
    currentLessonId = null;

    userCoursesView.classList.add("hidden");
    userCourseDetail.classList.remove("hidden");

    detailTitle.textContent = course.title;
    detailDesc.textContent = course.description;
    detailMeta.innerHTML = "";
    if(course.category){
      const span = document.createElement("span");
      span.className="badge";
      span.textContent = course.category;
      detailMeta.appendChild(span);
    }
    const priceText = formatPrice(course.price);
    if(priceText){
      const span2 = document.createElement("span");
      span2.className="badge "+(course.price==0?"free":"price");
      span2.textContent = priceText;
      detailMeta.appendChild(span2);
    }
    const span3 = document.createElement("span");
    span3.className="badge";
    span3.textContent = "Darslar: "+(course.lessons?course.lessons.length:0);
    detailMeta.appendChild(span3);

    renderLessonList(course,currentCourseProgress);
    lessonPlayerTitle.textContent = "Dars tanlanmagan.";
    lessonVideoWrapper.classList.add("hidden");
    lessonFullscreenBtn.classList.add("hidden");
    lessonShowResultsBtn.classList.add("hidden");
    lessonProgressText.textContent = "";
    lessonProgressBar.style.width="0%";
  }

  async function openLesson(lessonId){
    const lesson = (currentCourseDetail.lessons||[]).find(l=>l.id===lessonId);
    if(!lesson) return;
    currentLessonId = lessonId;
    quizShownForLesson = false;
    currentLessonQuiz = lesson.quiz || [];
    lastSavedPercent = 0;

    lessonPlayerTitle.textContent = lesson.title;
    lessonVideoWrapper.classList.remove("hidden");
    lessonFullscreenBtn.classList.remove("hidden");
    lessonShowResultsBtn.classList.toggle("hidden", !(lesson.quiz && lesson.quiz.length));

    // Player yaratish / almashtirish
    if(ytApiReady){
      if(currentPlayer){
        currentPlayer.loadVideoById(lesson.videoId);
      }else{
        currentPlayer = new YT.Player("yt-player",{
          videoId: lesson.videoId,
          playerVars:{
            rel:0,
            playsinline:1,
            modestbranding:1,
            controls:1
          },
          events:{
            onReady:(ev)=>{
              startProgressTracking();
            },
            onStateChange:(ev)=>{
              if(ev.data === YT.PlayerState.PLAYING){
                startProgressTracking();
              }else if(ev.data === YT.PlayerState.PAUSED){
                stopProgressTracking();
              }else if(ev.data === YT.PlayerState.ENDED){
                stopProgressTracking();
                // To'liq ko'rildi
                saveLessonProgress(
                  data.currentUser.username,
                  currentCourseDetail.id,
                  currentLessonId,
                  100,
                  true
                ).then(p=>{
                  currentCourseProgress = p;
                  updateLessonProgressUI();
                  renderLessonList(currentCourseDetail,currentCourseProgress);
                  // Agar quiz bo'lsa va hali ko'rinmagan bo'lsa
                  if(currentLessonQuiz.length && !quizShownForLesson){
                    quizShownForLesson = true;
                    openQuizForCurrentLesson();
                  }
                });
              }
            }
          }
        });
      }
    }else{
      // Iframe fallback
      document.getElementById("yt-player").innerHTML =
        `<iframe src="https://www.youtube.com/embed/${lesson.videoId}?rel=0&playsinline=1"
           allowfullscreen></iframe>`;
    }

    // Dars progressini yangilash
    updateLessonProgressUI();
  }

  userBackBtn.addEventListener("click",()=>{
    stopProgressTracking();
    userCourseDetail.classList.add("hidden");
    userCoursesView.classList.remove("hidden");
  });

  /* FULLSCREEN (LANDSCAPE) BUTTON */
  lessonFullscreenBtn.addEventListener("click",async ()=>{
    const el = lessonVideoWrapper;
    if(!el) return;
    try{
      if(el.requestFullscreen) await el.requestFullscreen();
      else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    }catch(e){}
    if(screen.orientation && screen.orientation.lock){
      screen.orientation.lock("landscape").catch(()=>{});
    }
  });

  document.addEventListener("fullscreenchange",()=>{
    if(!document.fullscreenElement){
      if(screen.orientation && screen.orientation.unlock){
        screen.orientation.unlock().catch(()=>{});
      }
    }
  });

  /* QUIZ LOGIC */
  function openQuizOverlay(){
    quizOverlay.classList.remove("hidden");
  }
  function closeQuizOverlay(){
    quizOverlay.classList.add("hidden");
    clearQuizTimer();
    clearAutoNext();
  }

  function renderQuizQuestionView(){
    const total = currentLessonQuiz.length;
    const q = currentLessonQuiz[quizCurrentIndex];
    if(!q){
      renderQuizResultView();
      return;
    }
    quizOverlayBox.innerHTML = `
      <div>
        <div class="quiz-overlay-title">Quiz ‚Äî ${quizCurrentIndex+1}/${total} savol</div>
        <div class="quiz-overlay-sub">
          Dars bo‚Äòyicha savollarga javob bering. Har bir savol uchun alohida vaqt beriladi.
        </div>

        <div class="quiz-question">
          <div class="quiz-question-title">${q.question}</div>
          <div class="quiz-options">
            ${q.options.map((opt,idx)=>`
              <div class="quiz-option">
                <label>
                  <input type="radio" name="quiz-option" value="${idx}" ${quizAnswers[quizCurrentIndex]==idx?"checked":""} />
                  <span>${String.fromCharCode(65+idx)}) ${opt}</span>
                </label>
              </div>
            `).join("")}
          </div>
          <div class="quiz-timer" id="quiz-timer-label"></div>
        </div>

        <div style="margin-top:10px;display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;">
          <button class="btn-xs" id="quiz-close-btn">Testni to‚Äòxtatish</button>
          <button class="btn" id="quiz-next-btn">${quizCurrentIndex===total-1?"Natijani ko‚Äòrish":"Keyingi savol ‚Üí"}</button>
        </div>
      </div>
    `;
    startQuestionTimer();
  }

  function startQuestionTimer(){
    clearQuizTimer();
    clearAutoNext();
    const q = currentLessonQuiz[quizCurrentIndex];
    if(!q) return;
    quizRemaining = q.timeLimit || 30;
    const label = document.getElementById("quiz-timer-label");
    if(label) label.textContent = `Qolgan vaqt: ${quizRemaining} soniya`;
    quizTimerId = setInterval(()=>{
      quizRemaining--;
      if(label) label.textContent = `Qolgan vaqt: ${quizRemaining} soniya`;
      if(quizRemaining<=0){
        clearQuizTimer();
        handleQuizNext(true);
      }
    },1000);
  }

  function handleQuizNext(auto){
    const q = currentLessonQuiz[quizCurrentIndex];
    if(!q){
      renderQuizResultView();
      return;
    }
    const checked = quizOverlayBox.querySelector('input[name="quiz-option"]:checked');
    if(checked){
      quizAnswers[quizCurrentIndex] = parseInt(checked.value,10);
    }else if(!auto){
      // hech narsa tanlamagan bo'lsa, avtomatik keyingiga o'tish yoki ogohlantirish
      // auto=false bo'lsa foydalanuvchiga xabarsiz ham o'tib ketaveramiz
    }
    quizCurrentIndex++;
    if(quizCurrentIndex >= currentLessonQuiz.length){
      renderQuizResultView();
    }else{
      renderQuizQuestionView();
    }
  }

  async function renderQuizResultView(){
    clearQuizTimer();
    clearAutoNext();

    const total = currentLessonQuiz.length;
    let correctCount = 0;

    const detailsHtml = currentLessonQuiz.map((q,idx)=>{
      const userAns = quizAnswers[idx];
      const isCorrect = userAns===q.correctIndex;
      if(isCorrect) correctCount++;
      const letters = ["A","B","C","D"];
      const userText = userAns!=null ? (letters[userAns]+") "+q.options[userAns]) : "Tanlanmagan";
      const correctText = letters[q.correctIndex]+") "+q.options[q.correctIndex];
      return `
        <div class="quiz-result-item">
          <div><b>${idx+1}-savol:</b> ${q.question}</div>
          <div>Javobingiz: <span class="${isCorrect?"quiz-correct":"quiz-wrong"}">${userText}</span></div>
          <div>To‚Äòg‚Äòri javob: <b>${correctText}</b></div>
        </div>
      `;
    }).join("");

    const percent = total>0 ? Math.round((correctCount/total)*100) : 0;
    const motivation = getMotivationMessage(correctCount,total);
    const passed = percent>=30;

    if(data.currentUser && currentCourseDetail && currentLessonId){
      try{
        const p = await saveLessonQuizAttempt(
          data.currentUser.username,
          currentCourseDetail.id,
          currentLessonId,
          percent
        );
        currentCourseProgress = p;
        updateLessonProgressUI();
        renderLessonList(currentCourseDetail,currentCourseProgress);
      }catch(err){
        console.error("saveLessonQuizAttempt error",err);
      }
    }

    let conditionText = "";
    if(passed){
      conditionText = "‚úÖ Siz testdan muvaffaqiyatli o‚Äòtdingiz. Endi keyingi darslar bosqichma-bosqich ochiladi.";
    }else{
      conditionText = "‚ùå Siz bu darsni to‚Äòliq o‚Äòzlashtira olmadingiz. Darsni qayta ko‚Äòrib, testni qayta ishlashingiz kerak. Natija <b>30%</b> dan yuqori bo‚Äòlishi shart.";
    }

    quizOverlayBox.innerHTML = `
      <div>
        <div class="quiz-overlay-title">Quiz natijasi</div>
        <div class="quiz-overlay-sub">
          Umumiy natija: <b>${correctCount}/${total}</b> ta to‚Äòg‚Äòri javob ‚Äî <b>${percent}%</b>
        </div>
        <div class="quiz-result-item">
          <div>${motivation}</div>
          <div style="margin-top:6px;">${conditionText}</div>
        </div>
        ${detailsHtml}
        <div style="margin-top:10px;display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;">
          <button class="btn-xs" id="quiz-close-btn">Yopish</button>
          <button class="btn" id="quiz-open-ranking-btn">Reytingni ko‚Äòrish</button>
        </div>
      </div>
    `;
  }

  function openQuizForCurrentLesson(){
    if(!currentLessonQuiz || !currentLessonQuiz.length){
      alert("Bu dars uchun quiz mavjud emas.");
      return;
    }
    quizCurrentIndex = 0;
    quizAnswers = {};
    openQuizOverlay();
    renderQuizQuestionView();
  }

  quizOverlayBox.addEventListener("click",async e=>{
    if(e.target.id==="quiz-close-btn"){
      closeQuizOverlay();
      return;
    }
    if(e.target.id==="quiz-next-btn"){
      handleQuizNext(false);
      return;
    }
    if(e.target.id==="quiz-open-ranking-btn"){
      if(!currentCourseDetail || !currentLessonId) return;
      const list = await fetchLessonRanking(currentCourseDetail.id,currentLessonId);
      renderRankingView(list);
      return;
    }
  });

  async function renderRankingView(list){
    const username = data.currentUser?.username || "";
    if(!currentCourseDetail || !currentLessonId){
      quizOverlayBox.innerHTML = `<div class="quiz-result-item">Ma'lumot topilmadi.</div>`;
      return;
    }
    const rows = list.map((r,idx)=>{
      const isMe = r.username===username;
      return `
        <tr class="${isMe?"quiz-ranking-row-me":""}">
          <td>${idx+1}</td>
          <td>${r.username}</td>
          <td>${(r.scorePercent||0).toFixed(1)}%</td>
        </tr>
      `;
    }).join("");

    quizOverlayBox.innerHTML = `
      <div>
        <div class="quiz-overlay-title">Reyting jadvali</div>
        <div class="quiz-overlay-sub">
          Kurs: <b>${currentCourseDetail.title}</b><br>
          Dars: <b>${getCurrentLesson()?.title||""}</b>
        </div>
        ${
          list.length
          ? `<table class="quiz-ranking-table">
              <thead>
                <tr><th>#</th><th>Foydalanuvchi</th><th>Natija</th></tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>`
          : `<div class="quiz-result-item">Hali hech kim bu quizni ishlamagan.</div>`
        }
        <div style="margin-top:10px;text-align:right;">
          <button class="btn-xs" id="quiz-close-btn">Yopish</button>
        </div>
      </div>
    `;
  }

  lessonShowResultsBtn.addEventListener("click",async ()=>{
    if(!currentCourseDetail || !currentLessonId){
      alert("Avval darsni tanlang.");
      return;
    }
    const list = await fetchLessonRanking(currentCourseDetail.id,currentLessonId);
    openQuizOverlay();
    renderRankingView(list);
  });

  /* HEADER / AUTH UI */
  function showAuthView(){
    authSection.classList.remove("hidden");
    adminSection.classList.add("hidden");
    userSection.classList.add("hidden");
    navAdmin.classList.add("hidden");
    logoutBtn.classList.add("hidden");
    currentUserLabel.textContent = "Mehmon";
  }

  function showUserView(){
    authSection.classList.add("hidden");
    adminSection.classList.add("hidden");
    userSection.classList.remove("hidden");
    logoutBtn.classList.remove("hidden");
    currentUserLabel.textContent = data.currentUser?.username || "Foydalanuvchi";
    userRolePill.textContent = "Rol: "+(data.currentUser?.role==="admin"?"Admin + Foydalanuvchi":"Foydalanuvchi");
    navAdmin.classList.toggle("hidden", data.currentUser?.role!=="admin");
    userCoursesView.classList.remove("hidden");
    userCourseDetail.classList.add("hidden");
  }

  function showAdminView(){
    authSection.classList.add("hidden");
    adminSection.classList.remove("hidden");
    userSection.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
    currentUserLabel.textContent = data.currentUser?.username || "Admin";
    navAdmin.classList.remove("hidden");
  }

  tabButtons.forEach(btn=>{
    btn.addEventListener("click",()=>{
      tabButtons.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      if(tab==="login"){
        loginForm.classList.remove("hidden");
        registerForm.classList.add("hidden");
      }else{
        loginForm.classList.add("hidden");
        registerForm.classList.remove("hidden");
      }
    });
  });

  loginForm.addEventListener("submit",async e=>{
    e.preventDefault();
    loginErrorEl.textContent = "";
    const u = loginUsername.value.trim();
    const p = loginPassword.value;
    if(!u || !p){
      loginErrorEl.textContent = "Login va parolni kiriting.";
      return;
    }
    try{
      const user = await loginUser(u,p);
      if(!user){
        loginErrorEl.textContent = "Login yoki parol noto‚Äòg‚Äòri.";
        return;
      }
      data.currentUser = { username:user.username, role:user.role || "user" };
      saveCurrentUserToLocal();
      saveRememberedCredentials(u,p);
      showUserView();
      if(data.currentUser.role==="admin"){
        await loadUsersFromFirestore();
      }
    }catch(err){
      console.error(err);
      loginErrorEl.textContent = "Tizimga kirishda xatolik yuz berdi.";
    }
  });

  registerForm.addEventListener("submit",async e=>{
    e.preventDefault();
    registerErrorEl.textContent = "";
    const u = regUsername.value.trim();
    const p1 = regPassword.value;
    const p2 = regPassword2.value;
    if(!u || !p1 || !p2){
      registerErrorEl.textContent = "Barcha maydonlarni to‚Äòldiring.";
      return;
    }
    if(p1!==p2){
      registerErrorEl.textContent = "Parollar mos emas.";
      return;
    }
    if(u.length<3){
      registerErrorEl.textContent = "Login kamida 3 ta belgidan iborat bo‚Äòlsin.";
      return;
    }
    try{
      await registerUser(u,p1);
      registerErrorEl.style.color = "#15803d";
      registerErrorEl.textContent = "Muvaffaqiyatli ro‚Äòyxatdan o‚Äòtdingiz. Endi 'Kirish' orqali tizimga kiring.";
      regPassword.value="";
      regPassword2.value="";
    }catch(err){
      if(err.message==="exists"){
        registerErrorEl.textContent = "Bu login allaqachon band.";
      }else{
        console.error(err);
        registerErrorEl.textContent = "Ro‚Äòyxatdan o‚Äòtishda xatolik yuz berdi.";
      }
    }
  });

  logoutBtn.addEventListener("click",()=>{
    data.currentUser = null;
    saveCurrentUserToLocal();
    stopProgressTracking();
    if(currentPlayer && currentPlayer.stopVideo){
      try{ currentPlayer.stopVideo(); }catch(e){}
    }
    showAuthView();
  });

  navCourses.addEventListener("click",()=>{
    if(!data.currentUser){
      window.scrollTo({top:0,behavior:"smooth"});
      return;
    }
    showUserView();
  });

  navAdmin.addEventListener("click",async ()=>{
    if(!data.currentUser || data.currentUser.role!=="admin"){
      alert("Admin panelga faqat admin kira oladi.");
      return;
    }
    showAdminView();
    await loadUsersFromFirestore();
  });

  userCourseList.addEventListener("click",async e=>{
    const btn = e.target.closest(".btn-open-course");
    if(!btn) return;
    const courseId = btn.dataset.courseId;
    await openUserCourseDetail(courseId);
  });

  /* Init */
  async function initApp(){
    try{
      await ensureDefaultAdmin();
    }catch(e){
      console.error("ensureDefaultAdmin error",e);
    }

    // Login formni avto-to‚Äòldirish
    const remembered = loadRememberedCredentials();
    if(remembered){
      if(remembered.username) loginUsername.value = remembered.username;
      if(remembered.password) loginPassword.value = remembered.password;
    }

    // Avvalgi userni yuklab olish
    const savedUser = loadCurrentUserFromLocal();
    if(savedUser){
      data.currentUser = savedUser;
      showUserView();
      if(savedUser.role==="admin"){
        await loadUsersFromFirestore();
      }
    }else{
      showAuthView();
    }

    await refreshCourses();
  }

  window.addEventListener("beforeunload",()=>{
    saveCurrentLessonProgressOnce();
  });

  initApp();
</script>
</body>
</html>
