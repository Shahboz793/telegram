<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Video Menyu (Telegram WebApp)</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0b0c10;
      --card:rgba(255,255,255,.06);
      --card2:rgba(0,0,0,.25);
      --stroke:rgba(255,255,255,.12);
      --text:#fff;
      --muted:rgba(255,255,255,.72);
      --accent1:#ff3b3b;
      --accent2:#ff7a18;
      --ok:#4cd964;
      --warn:#ffcc00;
      --danger:#ff3b3b;
      color-scheme: dark;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(255,59,59,.18), transparent 55%),
                  radial-gradient(900px 600px at 90% 10%, rgba(255,122,24,.14), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .app{max-width:820px;margin:0 auto;padding:14px 14px 84px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px;border:1px solid var(--stroke);border-radius:16px;background:var(--card);
      position:sticky;top:10px;z-index:5;backdrop-filter: blur(10px);
    }
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand .t{font-weight:900;letter-spacing:.2px}
    .brand .s{font-size:12px;color:var(--muted)}
    .pill{
      padding:8px 10px;border-radius:999px;border:1px solid var(--stroke);background:var(--card2);
      font-size:12px;color:var(--muted);white-space:nowrap;
    }
    .tabs{
      margin-top:12px;
      display:flex;gap:10px;
      border:1px solid var(--stroke);
      background:var(--card);
      padding:10px;border-radius:16px;
    }
    .tabbtn{
      flex:1;
      border:1px solid transparent;
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 10px;border-radius:14px;
      font-weight:800;
      cursor:pointer;
    }
    .tabbtn.active{
      background: linear-gradient(135deg, rgba(255,59,59,.95), rgba(255,122,24,.95));
      border-color: rgba(255,255,255,.18);
    }

    .panel{margin-top:12px}
    .card{
      border:1px solid var(--stroke);
      background:var(--card);
      border-radius:16px;
      padding:12px;
    }
    .row{display:flex;gap:10px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .input, select{
      width:100%;
      padding:12px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.28);
      color:var(--text);
      outline:none;
    }
    .btn{
      padding:12px 14px;border-radius:14px;border:0;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color:#fff;font-weight:900;cursor:pointer;
      white-space:nowrap;
    }
    .btn.ghost{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      font-weight:800;
    }
    .btn.danger{
      background: rgba(255,59,59,.18);
      border:1px solid rgba(255,59,59,.35);
    }
    .btn.ok{
      background: rgba(76,217,100,.18);
      border:1px solid rgba(76,217,100,.35);
    }
    .muted{color:var(--muted);font-size:13px;line-height:1.5}
    .sep{height:1px;background:rgba(255,255,255,.10);margin:12px 0}

    .list{display:grid;gap:10px;margin-top:12px}
    .item{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      border-radius:16px;
      padding:12px;
      display:flex;gap:12px;align-items:flex-start;justify-content:space-between;
    }
    .item .left{display:flex;flex-direction:column;gap:6px;min-width:0}
    .item .name{font-weight:900}
    .item .meta{font-size:12px;color:var(--muted);word-break:break-all}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      font-size:11px;color:rgba(255,255,255,.84);
      padding:6px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      width:max-content;
    }
    .tag.tg{border-color:rgba(255,122,24,.35);background:rgba(255,122,24,.10)}
    .tag.mp4{border-color:rgba(76,217,100,.35);background:rgba(76,217,100,.10)}
    .tag.yt{border-color:rgba(255,59,59,.35);background:rgba(255,59,59,.10)}
    .tag.pdf{border-color:rgba(255,204,0,.35);background:rgba(255,204,0,.10)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    /* Fullscreen viewer */
    body.viewer-on{overflow:hidden}
    #viewer{
      position:fixed;inset:0;z-index:99999;
      background:#000;
      display:none;
    }
    body.viewer-on #viewer{display:block}
    #viewerHeader{
      position:fixed;top:10px;left:10px;right:10px;z-index:100000;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:10px 10px;border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    #viewerTitle{font-weight:900;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    #viewerBody{
      position:absolute;inset:0;
      display:grid;place-items:center;
      padding-top:64px;
    }
    #viewerBody video{width:100%;height:100%;object-fit:contain}
    #viewerBody iframe{width:100%;height:100%;border:0;background:#111}
    .centerBox{
      max-width:540px;
      margin:0 14px;
      padding:16px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      text-align:center;
    }
    .centerBox .big{font-weight:900;margin-bottom:6px}
    .centerBox .small{color:var(--muted);font-size:13px;line-height:1.5}
    .footerBar{
      position:fixed;left:0;right:0;bottom:0;z-index:4;
      padding:12px 14px;
      background: linear-gradient(180deg, transparent, rgba(0,0,0,.55));
    }
    .footerBar .note{
      max-width:820px;margin:0 auto;
      font-size:12px;color:rgba(255,255,255,.75);
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="topbar">
      <div class="brand">
        <div class="t">Video Menyu</div>
        <div class="s" id="subline">Telegram WebApp ichida ishlaydi</div>
      </div>
      <div class="pill" id="userPill">User: —</div>
    </div>

    <div class="tabs">
      <button class="tabbtn active" id="tabView">Ko‘rish</button>
      <button class="tabbtn" id="tabAdd">Qo‘shish</button>
    </div>

    <!-- VIEW PANEL -->
    <div class="panel" id="panelView">
      <div class="card">
        <div class="row wrap">
          <input class="input" id="search" placeholder="Qidirish (nom bo‘yicha)..." />
          <button class="btn ghost" id="exportBtn" type="button">Export</button>
          <button class="btn ghost" id="importBtn" type="button">Import</button>
        </div>
        <div class="sep"></div>
        <div class="muted">
          Ochiq Telegram postlar, yopiq <code>t.me/c/...</code> postlar, MP4 yoki YouTube linklar qo‘shishingiz mumkin.
          Yopiq postlar bosilganda Telegram ichida ochiladi.
        </div>
      </div>

      <div class="list" id="list"></div>
    </div>

    <!-- ADD PANEL -->
    <div class="panel" id="panelAdd" style="display:none">
      <div class="card">
        <div class="muted" id="adminHint">
          Link qo‘shish menyusi.
        </div>
        <div class="sep"></div>

        <div class="row wrap">
          <input class="input" id="titleInput" placeholder="Video nomi (masalan: 1-dars video)" />
        </div>

        <div class="row wrap" style="margin-top:10px">
          <input class="input" id="urlInput" placeholder="Video link (MP4 / YouTube / t.me/...)" />
        </div>

        <div class="row wrap" style="margin-top:10px">
          <select id="typeSelect" class="input" style="max-width:240px">
            <option value="auto" selected>Auto aniqlash</option>
            <option value="mp4">Direct MP4 (video)</option>
            <option value="youtube">YouTube</option>
            <option value="tg">Telegram post</option>
            <option value="pdf">PDF</option>
            <option value="link">Oddiy link</option>
          </select>
          <button class="btn ok" id="saveBtn" type="button">Saqlash</button>
          <button class="btn danger" id="clearBtn" type="button">Tozalash</button>
        </div>

        <div class="sep"></div>
        <div class="muted">
          Masalan yopiq link: <code>https://t.me/c/3086001686/2/17260</code><br>
          Masalan ochiq link: <code>https://t.me/kanalNomi/123</code><br>
          MP4: <code>https://site.com/video.mp4</code>
        </div>
      </div>
    </div>

    <div class="footerBar">
      <div class="note" id="footNote">Host: HTTPS bo‘lsin (GitHub Pages). WebApp sifatida bot menyusidan oching.</div>
    </div>
  </div>

  <!-- FULLSCREEN VIEWER -->
  <div id="viewer">
    <div id="viewerHeader">
      <button class="btn ghost" id="backBtn" type="button">← Orqaga</button>
      <div id="viewerTitle">—</div>
      <button class="btn" id="openTgBtn" type="button">Telegram’da ochish</button>
    </div>
    <div id="viewerBody"></div>
  </div>

  <script>
    /* =========================
       SETTINGS
    ========================== */

    // (Ixtiyoriy) faqat siz link qo‘sha olishingiz uchun admin ID lar:
    // Agar bo‘sh qoldirsangiz hamma qo‘sha oladi.
    const ADMIN_TG_IDS = []; // masalan: [123456789]

    const STORAGE_KEY = "video_menu_items_v1";

    /* =========================
       TELEGRAM INIT
    ========================== */
    const tg = window.Telegram?.WebApp;
    try {
      tg?.ready?.();
      tg?.expand?.();
      tg?.disableVerticalSwipes?.();
    } catch(e){}

    const userPill = document.getElementById("userPill");
    const subline  = document.getElementById("subline");

    function getTgUser() {
      return tg?.initDataUnsafe?.user || null;
    }
    function isAdmin() {
      if (!ADMIN_TG_IDS.length) return true;
      const u = getTgUser();
      return !!u && ADMIN_TG_IDS.includes(Number(u.id));
    }

    (function renderUser(){
      const u = getTgUser();
      if (u) {
        const name = [u.first_name, u.last_name].filter(Boolean).join(" ");
        userPill.textContent = `User: ${name || "—"} (${u.id})`;
        subline.textContent = "Telegram WebApp: ulangan";
      } else {
        userPill.textContent = "User: aniqlanmadi";
        subline.textContent = "Eslatma: Botdan WebApp qilib oching";
      }
    })();

    /* =========================
       DATA
    ========================== */
    function loadItems(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function saveItems(items){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }
    function uid(){
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    let items = loadItems();

    /* =========================
       UI ELEMENTS
    ========================== */
    const tabView = document.getElementById("tabView");
    const tabAdd  = document.getElementById("tabAdd");
    const panelView = document.getElementById("panelView");
    const panelAdd  = document.getElementById("panelAdd");

    const listEl = document.getElementById("list");
    const searchEl = document.getElementById("search");

    const titleInput = document.getElementById("titleInput");
    const urlInput   = document.getElementById("urlInput");
    const typeSelect = document.getElementById("typeSelect");
    const saveBtn    = document.getElementById("saveBtn");
    const clearBtn   = document.getElementById("clearBtn");

    const exportBtn  = document.getElementById("exportBtn");
    const importBtn  = document.getElementById("importBtn");

    const viewer     = document.getElementById("viewer");
    const viewerBody = document.getElementById("viewerBody");
    const viewerTitle= document.getElementById("viewerTitle");
    const backBtn    = document.getElementById("backBtn");
    const openTgBtn  = document.getElementById("openTgBtn");

    const adminHint  = document.getElementById("adminHint");

    /* =========================
       TABS
    ========================== */
    function setTab(which){
      const addAllowed = isAdmin();
      tabAdd.style.display = addAllowed ? "" : "none";
      adminHint.textContent = addAllowed
        ? "Link qo‘shish menyusi."
        : "Sizda link qo‘shish huquqi yo‘q.";

      if (which === "add" && !addAllowed) which = "view";

      tabView.classList.toggle("active", which === "view");
      tabAdd.classList.toggle("active", which === "add");
      panelView.style.display = which === "view" ? "" : "none";
      panelAdd.style.display  = which === "add"  ? "" : "none";
    }
    tabView.addEventListener("click", () => setTab("view"));
    tabAdd.addEventListener("click",  () => setTab("add"));
    setTab("view");

    /* =========================
       LINK TYPE HELPERS
    ========================== */
    function normalizeUrl(u){
      u = (u || "").trim();
      if (!u) return "";
      // Allow "t.me/xxx" without protocol
      if (/^t\.me\//i.test(u)) u = "https://" + u;
      if (/^telegram\.me\//i.test(u)) u = "https://" + u;
      return u;
    }

    function hostOf(url){
      try{ return new URL(url).hostname.replace(/^www\./,''); } catch(e){ return ""; }
    }

    function isTelegramUrl(url){
      const h = hostOf(url);
      return (h === "t.me" || h === "telegram.me");
    }

    function isPrivateTgC(url){
      try{
        const u = new URL(url);
        return isTelegramUrl(url) && u.pathname.startsWith("/c/");
      }catch(e){ return false; }
    }

    function isYouTube(url){
      const h = hostOf(url);
      return ["youtube.com","m.youtube.com","youtu.be"].includes(h);
    }

    function isDirectVideo(url){
      return /\.(mp4|webm|ogg)(\?.*)?$/i.test(url);
    }

    function isPdf(url){
      return /\.pdf(\?.*)?$/i.test(url);
    }

    function detectType(url){
      if (isTelegramUrl(url)) return "tg";
      if (isDirectVideo(url)) return "mp4";
      if (isYouTube(url)) return "youtube";
      if (isPdf(url)) return "pdf";
      return "link";
    }

    function tgSingle(url){
      // add ?single=1 for Telegram message view
      try{
        const u = new URL(url);
        if (isTelegramUrl(url) && !u.searchParams.has("single")) u.searchParams.set("single","1");
        return u.toString();
      }catch(e){
        return url;
      }
    }

    /* =========================
       RENDER LIST
    ========================== */
    function tagHtml(type){
      if (type === "tg") return `<span class="tag tg">Telegram</span>`;
      if (type === "mp4") return `<span class="tag mp4">MP4</span>`;
      if (type === "youtube") return `<span class="tag yt">YouTube</span>`;
      if (type === "pdf") return `<span class="tag pdf">PDF</span>`;
      return `<span class="tag">Link</span>`;
    }

    function render(){
      const q = (searchEl.value || "").trim().toLowerCase();
      const filtered = items
        .slice()
        .sort((a,b) => (b.createdAt||0) - (a.createdAt||0))
        .filter(it => !q || (it.title||"").toLowerCase().includes(q));

      if (!filtered.length){
        listEl.innerHTML = `
          <div class="card">
            <div class="muted">
              Hali hech narsa yo‘q. “Qo‘shish” bo‘limidan video link qo‘shing.
            </div>
          </div>
        `;
        return;
      }

      listEl.innerHTML = filtered.map(it => {
        const t = it.type === "auto" ? detectType(it.url) : it.type;
        return `
          <div class="item" data-id="${it.id}">
            <div class="left">
              <div class="row" style="gap:8px;align-items:center">
                <div class="name" style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(it.title || "Nomsiz")}</div>
                ${tagHtml(t)}
              </div>
              <div class="meta">${escapeHtml(it.url)}</div>
            </div>
            <div class="actions">
              <button class="btn" data-act="open">Ochish</button>
              <button class="btn ghost" data-act="edit">Tahrir</button>
              <button class="btn danger ghost" data-act="del">O‘chirish</button>
            </div>
          </div>
        `;
      }).join("");
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    searchEl.addEventListener("input", render);

    listEl.addEventListener("click", (e) => {
      const itemEl = e.target.closest(".item");
      if (!itemEl) return;
      const id = itemEl.getAttribute("data-id");
      const it = items.find(x => x.id === id);
      if (!it) return;

      const act = e.target.getAttribute("data-act");
      if (act === "open") openItem(it);
      if (act === "edit") editItem(it);
      if (act === "del") deleteItem(it);
    });

    /* =========================
       ADD / EDIT / DELETE
    ========================== */
    function resetForm(){
      titleInput.value = "";
      urlInput.value = "";
      typeSelect.value = "auto";
    }

    saveBtn.addEventListener("click", () => {
      if (!isAdmin()){
        alert("Sizda link qo‘shish huquqi yo‘q.");
        return;
      }
      const title = (titleInput.value || "").trim();
      const urlRaw = (urlInput.value || "").trim();
      const url = normalizeUrl(urlRaw);
      const type = typeSelect.value;

      if (!title) { alert("Video nomini kiriting."); return; }
      if (!url)   { alert("Link kiriting."); return; }

      items.push({ id: uid(), title, url, type, createdAt: Date.now() });
      saveItems(items);
      resetForm();
      setTab("view");
      render();
    });

    clearBtn.addEventListener("click", resetForm);

    function editItem(it){
      if (!isAdmin()){
        alert("Sizda tahrirlash huquqi yo‘q.");
        return;
      }
      const newTitle = prompt("Yangi nom:", it.title || "");
      if (newTitle === null) return;
      const newUrl = prompt("Yangi link:", it.url || "");
      if (newUrl === null) return;

      const t = prompt("Type: auto / mp4 / youtube / tg / pdf / link", it.type || "auto");
      if (t === null) return;

      it.title = (newTitle || "").trim() || it.title;
      it.url   = normalizeUrl(newUrl || it.url);
      it.type  = (t || "auto").trim().toLowerCase();
      saveItems(items);
      render();
    }

    function deleteItem(it){
      if (!isAdmin()){
        alert("Sizda o‘chirish huquqi yo‘q.");
        return;
      }
      if (!confirm(`O‘chirish: "${it.title}" ?`)) return;
      items = items.filter(x => x.id !== it.id);
      saveItems(items);
      render();
    }

    /* =========================
       EXPORT / IMPORT
    ========================== */
    exportBtn.addEventListener("click", async () => {
      const data = JSON.stringify(items, null, 2);
      try{
        await navigator.clipboard.writeText(data);
        alert("Export nusxa olindi (clipboard).");
      }catch(e){
        prompt("Quyidagini nusxa oling:", data);
      }
    });

    importBtn.addEventListener("click", () => {
      if (!isAdmin()){
        alert("Sizda import huquqi yo‘q.");
        return;
      }
      const raw = prompt("JSON ni joylang (paste):");
      if (!raw) return;
      try{
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) throw new Error("not array");
        // minimal validation
        const cleaned = arr
          .filter(x => x && typeof x === "object")
          .map(x => ({
            id: String(x.id || uid()),
            title: String(x.title || "Nomsiz"),
            url: normalizeUrl(String(x.url || "")),
            type: String(x.type || "auto"),
            createdAt: Number(x.createdAt || Date.now())
          }))
          .filter(x => x.url);

        items = cleaned;
        saveItems(items);
        render();
        alert("Import bo‘ldi.");
      }catch(e){
        alert("JSON xato. Tekshirib qayta urinib ko‘ring.");
      }
    });

    /* =========================
       VIEWER OPEN/CLOSE
    ========================== */
    let currentOpenUrl = "";

    function showViewer(title, url){
      currentOpenUrl = url;
      viewerTitle.textContent = title || "—";
      document.body.classList.add("viewer-on");

      if (tg?.BackButton){
        tg.BackButton.show();
        tg.BackButton.onClick(closeViewer);
      }
      history.pushState({ viewer: true }, "");
    }

    function closeViewer(){
      viewerBody.innerHTML = "";
      document.body.classList.remove("viewer-on");
      currentOpenUrl = "";

      if (tg?.BackButton) tg.BackButton.hide();
    }

    backBtn.addEventListener("click", closeViewer);

    openTgBtn.addEventListener("click", () => {
      if (!currentOpenUrl) return;
      openInTelegram(currentOpenUrl);
    });

    window.addEventListener("popstate", () => {
      if (document.body.classList.contains("viewer-on")) closeViewer();
    });

    function openInTelegram(url){
      const finalUrl = tgSingle(url);
      try{
        if (tg?.openTelegramLink){
          tg.openTelegramLink(finalUrl);
          return;
        }
        if (tg?.openLink){
          tg.openLink(finalUrl, { try_instant_view: false });
          return;
        }
      }catch(e){}
      window.location.href = finalUrl;
    }

    /* =========================
       OPEN ITEM LOGIC
    ========================== */
    function openItem(it){
      const url = normalizeUrl(it.url);
      const type = (it.type === "auto") ? detectType(url) : it.type;

      showViewer(it.title, url);

      // Always keep a Telegram-open option visible:
      openTgBtn.style.display = isTelegramUrl(url) ? "" : "none";

      // Telegram links:
      if (type === "tg" && isTelegramUrl(url)){
        // Private t.me/c/... => cannot embed => open in Telegram
        if (isPrivateTgC(url)){
          viewerBody.innerHTML = `
            <div class="centerBox">
              <div class="big">Yopiq post</div>
              <div class="small">
                Bu <code>t.me/c/...</code> link. Uni sayt ichida player qilib ko‘rsatib bo‘lmaydi.
                “Telegram’da ochish” tugmasini bosing.
              </div>
              <div style="margin-top:12px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
                <button class="btn" onclick="window.__openTgNow()">Telegram’da ochish</button>
                <button class="btn ghost" onclick="window.__closeViewerNow()">Orqaga</button>
              </div>
            </div>
          `;
          window.__openTgNow = () => openInTelegram(url);
          window.__closeViewerNow = () => closeViewer();
          return;
        }

        // Public t.me/... => try embed widget, fallback openTelegramLink
        renderTelegramWidget(url, it.title);
        return;
      }

      // Direct MP4
      if (type === "mp4"){
        viewerBody.innerHTML = `<video src="${escapeHtml(url)}" controls playsinline></video>`;
        return;
      }

      // YouTube
      if (type === "youtube"){
        const embed = youtubeEmbedUrl(url);
        viewerBody.innerHTML = `<iframe src="${escapeHtml(embed)}" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`;
        return;
      }

      // PDF
      if (type === "pdf"){
        viewerBody.innerHTML = `<iframe src="${escapeHtml(url)}#toolbar=0&navpanes=0&scrollbar=0"></iframe>`;
        return;
      }

      // Fallback link
      viewerBody.innerHTML = `
        <div class="centerBox">
          <div class="big">Link</div>
          <div class="small">Bu link uchun ichki player topilmadi. “Telegram’da ochish” yoki brauzerda oching.</div>
          <div style="margin-top:12px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
            <button class="btn" onclick="window.open('${escapeJs(url)}','_blank')">Brauzerda ochish</button>
            ${isTelegramUrl(url) ? `<button class="btn" onclick="window.__openTgNow()">Telegram’da ochish</button>` : ``}
            <button class="btn ghost" onclick="window.__closeViewerNow()">Orqaga</button>
          </div>
        </div>
      `;
      window.__openTgNow = () => openInTelegram(url);
      window.__closeViewerNow = () => closeViewer();
    }

    function escapeJs(s){
      return String(s||"").replaceAll("\\","\\\\").replaceAll("'","\\'");
    }

    function youtubeEmbedUrl(url){
      try{
        const u = new URL(url);
        if (u.hostname === "youtu.be"){
          const id = u.pathname.replace("/","");
          return `https://www.youtube.com/embed/${id}?rel=0&modestbranding=1`;
        }
        if (u.hostname.includes("youtube.com")){
          const id = u.searchParams.get("v");
          if (id) return `https://www.youtube.com/embed/${id}?rel=0&modestbranding=1`;
          // /shorts/ID
          const m = u.pathname.match(/\/shorts\/([^\/]+)/i);
          if (m) return `https://www.youtube.com/embed/${m[1]}?rel=0&modestbranding=1`;
        }
      }catch(e){}
      return url;
    }

    function renderTelegramWidget(url, title){
      // Try to embed public post using Telegram widget.
      // If widget cannot render, user can still open in Telegram.
      viewerBody.innerHTML = `
        <div class="centerBox">
          <div class="big">Telegram post</div>
          <div class="small">Agar post embed bo‘lmasa, “Telegram’da ochish”dan foydalaning.</div>
          <div style="margin-top:12px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
            <button class="btn" onclick="window.__openTgNow()">Telegram’da ochish</button>
            <button class="btn ghost" onclick="window.__closeViewerNow()">Orqaga</button>
          </div>
        </div>
        <div style="width:min(720px,100%);margin:14px auto 0;padding:0 14px">
          <div id="tgWidgetMount"></div>
        </div>
      `;
      window.__openTgNow = () => openInTelegram(url);
      window.__closeViewerNow = () => closeViewer();

      const ref = publicPostRef(url);
      if (!ref){
        return; // can’t embed => keep fallback
      }

      const mount = document.getElementById("tgWidgetMount");
      mount.innerHTML = "";

      const block = document.createElement("blockquote");
      block.className = "telegram-post";
      block.setAttribute("data-telegram-post", ref);
      block.setAttribute("data-width", "100%");
      mount.appendChild(block);

      // Load widget script fresh
      const s = document.createElement("script");
      s.async = true;
      s.src = "https://telegram.org/js/telegram-widget.js?22";
      mount.appendChild(s);
    }

    // Build ref like "channel/123" from https://t.me/channel/123
    function publicPostRef(url){
      try{
        const u = new URL(url);
        if (!isTelegramUrl(url)) return null;

        const parts = u.pathname.split("/").filter(Boolean);
        // expected: [username, msgid] or [username, topic, msgid]
        if (parts.length < 2) return null;
        const username = parts[0];
        const last = parts[parts.length - 1];
        if (!/^\d+$/.test(last)) return null;

        // Widget typically supports "username/msgid"
        return `${username}/${last}`;
      }catch(e){
        return null;
      }
    }

    /* =========================
       INIT
    ========================== */
    render();
  </script>
</body>
</html>
