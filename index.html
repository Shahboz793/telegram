<!doctype html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <title>Ta'lim Edu — Kurs Platforma (HTML + JS + Firestore)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f3f4f6;
      color:#111827;
    }
    a{text-decoration:none;color:inherit}

    .page{min-height:100vh;}

    /* HEADER */
    .header{
      position:sticky;top:0;z-index:10;
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 20px;
      background:#0f172a;
      color:#e5e7eb;
      border-bottom:1px solid #1f2937;
    }
    .logo{
      font-weight:800;font-size:20px;
    }
    .logo span{color:#f97316;}
    .nav{display:flex;align-items:center;gap:14px;font-size:14px;}
    .nav a{color:#e5e7eb;opacity:.85;}
    .nav a:hover{opacity:1;}
    .nav .user-label{font-size:13px;opacity:.8;}
    .btn-outline{
      border:1px solid #e5e7eb;
      border-radius:999px;
      padding:4px 10px;
      font-size:13px;
      cursor:pointer;
      background:transparent;
      color:#e5e7eb;
    }

    /* LAYOUT */
    .container{
      max-width:1120px;
      margin:0 auto;
      padding:18px 12px 32px;
    }

    .section{
      margin-bottom:18px;
    }
    .hidden{display:none;}

    .card{
      background:#ffffff;
      border-radius:16px;
      padding:16px 16px 18px;
      box-shadow:0 18px 45px rgba(15,23,42,0.08);
      border:1px solid #e5e7eb;
    }
    .card h2{
      font-size:18px;
      margin-bottom:6px;
    }
    .card p.sub{
      font-size:13px;
      color:#6b7280;
      margin-bottom:10px;
    }

    .hero-text{
      font-size:14px;
      color:#4b5563;
    }

    .grid-2{
      display:grid;
      grid-template-columns:minmax(0,0.9fr) minmax(0,1.1fr);
      gap:16px;
    }
    @media(max-width:900px){
      .grid-2{grid-template-columns:minmax(0,1fr);}
    }

    /* FORM */
    .tabs{
      display:flex;
      gap:4px;
      margin-bottom:10px;
      background:#e5e7eb;
      border-radius:999px;
      padding:4px;
      width:max-content;
    }
    .tab-btn{
      border:none;
      border-radius:999px;
      padding:5px 12px;
      font-size:13px;
      cursor:pointer;
      background:transparent;
      color:#374151;
    }
    .tab-btn.active{
      background:#ffffff;
      box-shadow:0 2px 8px rgba(15,23,42,0.18);
      color:#111827;
    }

    .form{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:6px;
    }
    .form-row{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    label{
      font-size:13px;
      color:#4b5563;
    }
    input,textarea,select{
      border-radius:10px;
      border:1px solid #d1d5db;
      padding:8px 10px;
      background:#f9fafb;
      font-size:14px;
      color:#111827;
    }
    textarea{min-height:70px;resize:vertical;}
    .form-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:10px;
    }
    .btn{
      align-self:flex-start;
      padding:8px 16px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      background:linear-gradient(90deg,#6366f1,#ec4899);
      color:#ffffff;
      font-weight:600;
      font-size:14px;
      box-shadow:0 10px 22px rgba(129,140,248,0.45);
      transition:transform .1s ease,box-shadow .1s ease;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 14px 30px rgba(129,140,248,0.6);
    }
    .btn:active{
      transform:translateY(0);
      box-shadow:0 6px 14px rgba(129,140,248,0.4);
    }
    .hint{
      font-size:11px;
      color:#6b7280;
    }
    .error{
      font-size:12px;
      color:#b91c1c;
      margin-top:2px;
    }
    .pill{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      background:#eff6ff;
      color:#1d4ed8;
      width:max-content;
    }

    /* COURSES */
    .section-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    .muted{font-size:13px;color:#6b7280;}

    .course-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:12px;
      margin-top:6px;
    }
    .course-card{
      background:#f9fafb;
      border-radius:12px;
      border:1px solid #e5e7eb;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .course-title{
      font-size:15px;
      font-weight:600;
      color:#111827;
    }
    .course-desc{
      font-size:13px;
      color:#4b5563;
      max-height:60px;
      overflow:hidden;
    }
    .course-meta{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:11px;
    }
    .badge{
      padding:2px 8px;
      border-radius:999px;
      background:#e5e7eb;
      color:#374151;
    }
    .badge.free{
      background:#dcfce7;color:#166534;
    }
    .badge.price{
      background:#fef9c3;color:#854d0e;
    }

    .course-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      color:#6b7280;
      margin-top:4px;
    }

    .video-wrapper{
      position:relative;
      padding-bottom:56.25%;
      height:0;
      overflow:hidden;
      border-radius:8px;
      background:#000;
    }
    .video-wrapper #yt-player-container{
      position:absolute;
      top:0;left:0;width:100%;height:100%;
    }

    .empty{
      font-size:13px;
      color:#9ca3af;
      margin-top:6px;
    }

    /* ADMIN LESSON LIST (delete) */
    .admin-lessons{
      margin-top:6px;
      border-top:1px dashed #e5e7eb;
      padding-top:6px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .admin-lesson-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      font-size:12px;
      background:#f9fafb;
      border-radius:8px;
      padding:4px 6px;
      border:1px solid #e5e7eb;
    }
    .admin-lesson-title{flex:1;}
    .btn-xs{
      border:none;
      border-radius:999px;
      padding:3px 8px;
      font-size:11px;
      cursor:pointer;
      background:#fee2e2;
      color:#b91c1c;
    }
    .btn-xs:hover{background:#fecaca;}

    /* USER PLAYER + PLAYLIST */
    .course-player{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .lesson-playlist{
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height:200px;
      overflow:auto;
    }
    .lesson-playlist-item{
      border:none;
      width:100%;
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      cursor:pointer;
      text-align:left;
    }
    .lesson-playlist-item:hover{
      background:#eff6ff;
      border-color:#bfdbfe;
    }
    .lesson-playlist-item.active{
      background:#111827;
      color:#f9fafb;
      border-color:#111827;
    }
    .lesson-thumb{
      width:64px;
      height:40px;
      flex-shrink:0;
      border-radius:6px;
      overflow:hidden;
      background:#111827;
    }
    .lesson-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .lesson-info{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .lesson-meta{
      font-size:11px;
      color:#6b7280;
    }
    .lesson-playlist-item.active .lesson-meta{
      color:#e5e7eb;
    }

    .loading{
      font-size:13px;
      color:#6b7280;
      margin-top:6px;
    }
  </style>
</head>
<body>
<div class="page">
  <!-- HEADER -->
  <header class="header">
    <div class="logo">Ta'lim <span>Edu</span></div>
    <nav class="nav">
      <a href="#user-section" id="nav-courses">Kurslar</a>
      <a href="#admin-section" id="nav-admin" class="hidden">Admin panel</a>
      <span class="user-label" id="current-user-label">Mehmon</span>
      <button class="btn-outline" id="logout-btn" style="display:none;">Chiqish</button>
    </nav>
  </header>

  <main class="container">
    <!-- AUTH SECTION -->
    <section id="auth-section" class="section">
      <div class="grid-2">
        <div>
          <div class="card">
            <h2>Xush kelibsiz!</h2>
            <p class="sub">
              Kirish yoki ro‘yxatdan o‘tish orqali kurs platformasiga ulanishingiz mumkin.
              <br>Admin uchun demo login: <b>admin / admin123</b>
            </p>

            <div class="tabs">
              <button class="tab-btn active" data-tab="login">Kirish</button>
              <button class="tab-btn" data-tab="register">Ro‘yxatdan o‘tish</button>
            </div>

            <!-- Login form -->
            <form id="login-form" class="form">
              <div class="form-row">
                <label for="login-username">Login</label>
                <input id="login-username" required placeholder="Masalan: admin" />
              </div>
              <div class="form-row">
                <label for="login-password">Parol</label>
                <input id="login-password" type="password" required />
              </div>
              <button type="submit" class="btn">Kirish</button>
              <div id="login-error" class="error"></div>
            </form>

            <!-- Register form -->
            <form id="register-form" class="form hidden">
              <div class="form-row">
                <label for="reg-username">Login</label>
                <input id="reg-username" required placeholder="Masalan: talaba01" />
              </div>
              <div class="form-row">
                <label for="reg-password">Parol</label>
                <input id="reg-password" type="password" required />
              </div>
              <div class="form-row">
                <label for="reg-password2">Parolni takrorlang</label>
                <input id="reg-password2" type="password" required />
              </div>
              <p class="hint">Ro‘yxatdan o‘tgan foydalanuvchilar <b>kurslarni ko‘rishi</b> mumkin, lekin admin panelga kira olmaydi.</p>
              <button type="submit" class="btn">Ro‘yxatdan o‘tish</button>
              <div id="register-error" class="error"></div>
            </form>
          </div>
        </div>

        <div>
          <div class="card">
            <h2>Platforma haqida</h2>
            <p class="sub">
              Bu Ta'lim Edu uchun HTML + CSS + JS + Firestore asosida yaratilgan demo kurs tizimi.
            </p>
            <p class="hero-text">
              • <b>Admin</b> — kurs yaratadi, har bir kurs ichiga ko‘plab YouTube <b>Unlisted</b> videolarni qo‘shishi mumkin.<br>
              • <b>Foydalanuvchi</b> — ro‘yxatdan o‘tadi va <b>kurslar ichidagi darslarni tomosha qiladi</b>.<br><br>
              Ma'lumotlar Firestore’da saqlanadi, shuning uchun boshqa telefon va kompyuterdan kirganda ham kurslar ko‘rinadi.
            </p>
            <p id="load-status" class="loading">Ma'lumotlar yuklanmoqda...</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ADMIN SECTION -->
    <section id="admin-section" class="section hidden">
      <div class="card">
        <div class="section-header">
          <div>
            <h2>Admin panel</h2>
            <p class="sub">Bu qismga faqat admin kirishi mumkin. Kurslar va darslar shu yerda boshqariladi.</p>
          </div>
          <span class="pill">Rol: Admin</span>
        </div>

        <h3 style="font-size:15px;margin-bottom:4px;">Yangi kurs qo‘shish</h3>
        <form id="course-form" class="form">
          <div class="form-row">
            <label for="course-title">Kurs nomi</label>
            <input id="course-title" required placeholder="Masalan: Boshlang'ich JavaScript" />
          </div>
          <div class="form-row">
            <label for="course-desc">Tavsif</label>
            <textarea id="course-desc" required placeholder="Kurs mazmuni, maqsadi, kimlar uchun..."></textarea>
          </div>
          <div class="form-grid">
            <div class="form-row">
              <label for="course-cat">Yo'nalish</label>
              <input id="course-cat" placeholder="Dasturlash, Biznes, Dizayn..." />
            </div>
            <div class="form-row">
              <label for="course-price">Narx (so'm)</label>
              <input id="course-price" type="number" min="0" placeholder="0 = bepul" />
            </div>
          </div>
          <button type="submit" class="btn">Kursni qo‘shish</button>
          <div id="course-error" class="error"></div>
        </form>

        <hr style="margin:14px 0;border:none;border-top:1px solid #e5e7eb;">

        <div class="section-header">
          <h3 style="font-size:15px;">Mavjud kurslar</h3>
          <span class="muted" id="admin-course-count">0 ta kurs</span>
        </div>
        <div id="admin-course-list"></div>
        <div id="admin-empty" class="empty">Hozircha kurs yo‘q. Yuqoridan kurs qo‘shing.</div>
      </div>
    </section>

    <!-- USER SECTION -->
    <section id="user-section" class="section hidden">
      <div class="card">
        <div class="section-header">
          <div>
            <h2>Kurslar paneli</h2>
            <p class="sub">Ro‘yxatdan o‘tgan barcha foydalanuvchilar bu yerdagi kurslarni ko‘rishi mumkin.</p>
          </div>
          <span class="pill" id="user-role-pill">Rol: Foydalanuvchi</span>
        </div>

        <div class="section-header">
          <span class="muted" id="user-course-count">0 ta kurs</span>
        </div>

        <div id="user-course-list" class="course-grid"></div>
        <div id="user-empty" class="empty">
          Hozircha kurslar qo‘shilmagan. Admin panel orqali kurs qo‘shilishi kerak.
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Barcha JS: Firestore + UI + YouTube player -->
<script type="module">
  // ---------- FIREBASE IMPORTLAR ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  // ---------- FIREBASE CONFIG — SENIKI QO'YILDI ----------
  const firebaseConfig = {
    apiKey: "AIzaSyDVidcgjpUxkg88bxXfIFzmsFydv0rMMao",
    authDomain: "shahboz-5d0a3.firebaseapp.com",
    projectId: "shahboz-5d0a3",
    storageBucket: "shahboz-5d0a3.firebasestorage.app",
    messagingSenderId: "352024095535",
    appId: "1:352024095535:web:6ca630de2c199a33c54fda",
    measurementId: "G-YS5RGZ00EB"
  };

  // Firebase init
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const DATA_DOC = doc(db, "talimEdu", "appData");

  // ---------- LOCAL HOLAT ----------
  const CURRENT_USER_KEY = "talimEduCurrentUser_v1";

  let data = {
    users: [],
    courses: [] // {id,title,description,category,price,lessons:[{id,title,videoId}]}
  };
  let currentUser = loadCurrentUserLocal();
  let isDataLoaded = false;

  const loadStatus = document.getElementById("load-status");

  // Firestore'dan ma'lumot yuklash
  async function loadDataFromFirestore() {
    try {
      const snap = await getDoc(DATA_DOC);
      if (!snap.exists()) {
        const initial = {
          users: [
            { username: "admin", password: "admin123", role: "admin" }
          ],
          courses: []
        };
        await setDoc(DATA_DOC, initial);
        return initial;
      }
      const d = snap.data() || {};
      if (!Array.isArray(d.users)) d.users = [];
      if (!Array.isArray(d.courses)) d.courses = [];
      if (!d.users.some(u => u.username === "admin" && u.role === "admin")) {
        d.users.push({ username: "admin", password: "admin123", role: "admin" });
      }
      await setDoc(DATA_DOC, d);
      return d;
    } catch (err) {
      console.error("Firestore yuklash xatosi:", err);
      if (loadStatus) loadStatus.textContent = "Ma'lumotlarni yuklashda xato. Internet va Firebase sozlamalarini tekshiring.";
      return {
        users: [
          { username: "admin", password: "admin123", role: "admin" }
        ],
        courses: []
      };
    }
  }

  async function saveDataToFirestore() {
    try {
      await setDoc(DATA_DOC, data);
    } catch (err) {
      console.error("Firestore saqlash xatosi:", err);
      alert("Ma'lumotni Firestore'ga saqlashda xato bo‘ldi. Internetni tekshiring.");
    }
  }

  function loadCurrentUserLocal() {
    const raw = localStorage.getItem(CURRENT_USER_KEY);
    if (!raw) return null;
    try {
      return JSON.parse(raw);
    } catch {
      return null;
    }
  }

  function saveCurrentUserLocal() {
    if (currentUser) {
      localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser));
    } else {
      localStorage.removeItem(CURRENT_USER_KEY);
    }
  }

  function ensureLoaded() {
    if (!isDataLoaded) {
      alert("Ma'lumotlar hali yuklanmoqda. Biroz kutib qayta urinib ko‘ring.");
      return false;
    }
    return true;
  }

  // ---------- DOM ELEMENTLAR ----------
  const authSection = document.getElementById("auth-section");
  const adminSection = document.getElementById("admin-section");
  const userSection = document.getElementById("user-section");
  const navAdmin = document.getElementById("nav-admin");
  const logoutBtn = document.getElementById("logout-btn");
  const currentUserLabel = document.getElementById("current-user-label");
  const userRolePill = document.getElementById("user-role-pill");

  const tabButtons = document.querySelectorAll(".tab-btn");
  const loginForm = document.getElementById("login-form");
  const registerForm = document.getElementById("register-form");
  const loginErrorEl = document.getElementById("login-error");
  const registerErrorEl = document.getElementById("register-error");

  const courseForm = document.getElementById("course-form");
  const courseError = document.getElementById("course-error");
  const adminCourseList = document.getElementById("admin-course-list");
  const adminCourseCount = document.getElementById("admin-course-count");
  const adminEmpty = document.getElementById("admin-empty");

  const userCourseList = document.getElementById("user-course-list");
  const userCourseCount = document.getElementById("user-course-count");
  const userEmpty = document.getElementById("user-empty");

  // ---------- TABS ----------
  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      tabButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      if (tab === "login") {
        loginForm.classList.remove("hidden");
        registerForm.classList.add("hidden");
        loginErrorEl.textContent = "";
      } else {
        loginForm.classList.add("hidden");
        registerForm.classList.remove("hidden");
        registerErrorEl.textContent = "";
      }
    });
  });

  // ---------- LOGIN ----------
  loginForm.addEventListener("submit", async e => {
    e.preventDefault();
    if (!ensureLoaded()) return;

    loginErrorEl.textContent = "";
    const username = document.getElementById("login-username").value.trim();
    const password = document.getElementById("login-password").value;

    const user = data.users.find(u => u.username === username && u.password === password);
    if (!user) {
      loginErrorEl.textContent = "Login yoki parol noto‘g‘ri.";
      return;
    }

    currentUser = { username: user.username, role: user.role };
    saveCurrentUserLocal();
    loginForm.reset();
    updateUI();
  });

  // ---------- REGISTER ----------
  registerForm.addEventListener("submit", async e => {
    e.preventDefault();
    if (!ensureLoaded()) return;

    registerErrorEl.textContent = "";
    const username = document.getElementById("reg-username").value.trim();
    const password = document.getElementById("reg-password").value;
    const password2 = document.getElementById("reg-password2").value;

    if (!username || !password) {
      registerErrorEl.textContent = "Login va parolni kiriting.";
      return;
    }
    if (password !== password2) {
      registerErrorEl.textContent = "Parollar mos kelmadi.";
      return;
    }
    if (data.users.some(u => u.username === username)) {
      registerErrorEl.textContent = "Bu login band. Boshqa login tanlang.";
      return;
    }

    data.users.push({ username, password, role: "user" });
    await saveDataToFirestore();
    currentUser = { username, role: "user" };
    saveCurrentUserLocal();
    registerForm.reset();
    updateUI();
  });

  // ---------- LOGOUT ----------
  logoutBtn.addEventListener("click", () => {
    currentUser = null;
    saveCurrentUserLocal();
    updateUI();
  });

  // ---------- KURS QO‘SHISH (ADMIN) ----------
  courseForm.addEventListener("submit", async e => {
    e.preventDefault();
    if (!ensureLoaded()) return;
    if (!currentUser || currentUser.role !== "admin") return;

    courseError.textContent = "";
    const title = document.getElementById("course-title").value.trim();
    const desc = document.getElementById("course-desc").value.trim();
    const cat = document.getElementById("course-cat").value.trim();
    const price = document.getElementById("course-price").value.trim();

    if (!title || !desc) {
      courseError.textContent = "Kurs nomi va tavsifi majburiy.";
      return;
    }

    const newCourse = {
      id: Date.now().toString(),
      title,
      description: desc,
      category: cat,
      price,
      lessons: []
    };
    data.courses.push(newCourse);
    await saveDataToFirestore();
    courseForm.reset();
    renderAdminCourses();
    renderUserCourses();
  });

  function formatPrice(price) {
    const n = Number(price);
    if (!price || isNaN(n)) return "";
    if (n === 0) return "Bepul";
    return n.toLocaleString("uz-UZ") + " so'm";
  }

  function extractYouTubeId(input) {
    if (!input) return "";
    let url = input.trim();
    let m = url.match(/youtu\.be\/([^?&]+)/);
    if (m) return m[1];
    m = url.match(/v=([^&]+)/);
    if (m) return m[1];
    m = url.match(/embed\/([^?&]+)/);
    if (m) return m[1];
    return url;
  }

  // ---------- ADMIN KURSLAR RENDER ----------
  function renderAdminCourses() {
    const courses = data.courses || [];
    adminCourseList.innerHTML = "";
    adminCourseCount.textContent = courses.length + " ta kurs";

    if (courses.length === 0) {
      adminEmpty.style.display = "block";
      return;
    }
    adminEmpty.style.display = "none";

    courses.forEach(course => {
      const div = document.createElement("div");
      div.className = "course-card";

      let lessonsAdminHtml = "";
      if (course.lessons && course.lessons.length > 0) {
        lessonsAdminHtml = `
          <div class="admin-lessons">
            ${course.lessons.map((lesson, idx) => `
              <div class="admin-lesson-row">
                <span class="admin-lesson-title">${idx + 1}-dars: ${lesson.title}</span>
                <button type="button"
                        class="btn-xs"
                        data-action="delete-lesson"
                        data-course-id="${course.id}"
                        data-lesson-id="${lesson.id}">
                  O‘chirish
                </button>
              </div>
            `).join("")}
          </div>
        `;
      }

      div.innerHTML = `
        <div class="course-title">${course.title}</div>
        <div class="course-desc">${course.description}</div>
        <div class="course-meta">
          ${course.category ? `<span class="badge">${course.category}</span>` : ""}
          ${formatPrice(course.price) ? `<span class="badge ${course.price == 0 ? "free" : "price"}">${formatPrice(course.price)}</span>` : ""}
          <span class="badge">Darslar: ${course.lessons ? course.lessons.length : 0}</span>
        </div>
        <div class="mini-form">
          <div class="muted" style="margin-bottom:4px;">Ushbu kursga yangi dars/video qo‘shish:</div>
          <form class="lesson-form" data-course-id="${course.id}">
            <div class="form-row">
              <label>Dars nomi</label>
              <input name="lessonTitle" required placeholder="Masalan: 1-dars. Kirish" />
            </div>
            <div class="form-row">
              <label>YouTube havolasi yoki ID</label>
              <input name="lessonUrl" required placeholder="https://youtu.be/... yoki faqat ID" />
              <div class="hint">Videoni YouTube’da <b>Unlisted (yashirin)</b> qilib yuklash tavsiya etiladi.</div>
            </div>
            <button type="submit" class="btn" style="margin-top:4px;">Darsni qo‘shish</button>
          </form>
        </div>
        ${lessonsAdminHtml}
      `;
      adminCourseList.appendChild(div);
    });
  }

  // Dars qo‘shish (admin)
  adminCourseList.addEventListener("submit", async e => {
    if (!e.target.classList.contains("lesson-form")) return;
    e.preventDefault();
    if (!ensureLoaded()) return;
    if (!currentUser || currentUser.role !== "admin") return;

    const form = e.target;
    const courseId = form.dataset.courseId;
    const title = form.lessonTitle.value.trim();
    const url = form.lessonUrl.value.trim();
    if (!title || !url) return;

    const course = data.courses.find(c => c.id === courseId);
    if (!course) return;

    const videoId = extractYouTubeId(url);
    if (!videoId) {
      alert("YouTube havola/ID noto‘g‘ri bo‘lishi mumkin.");
      return;
    }

    course.lessons = course.lessons || [];
    course.lessons.push({
      id: Date.now().toString(),
      title,
      videoId
    });
    await saveDataToFirestore();
    form.reset();
    renderAdminCourses();
    renderUserCourses();
  });

  // Darsni o‘chirish (admin)
  adminCourseList.addEventListener("click", async e => {
    const btn = e.target.closest(".btn-xs[data-action='delete-lesson']");
    if (!btn) return;
    if (!ensureLoaded()) return;
    if (!currentUser || currentUser.role !== "admin") return;

    const courseId = btn.dataset.courseId;
    const lessonId = btn.dataset.lessonId;

    const course = data.courses.find(c => c.id === courseId);
    if (!course || !course.lessons) return;

    const idx = course.lessons.findIndex(l => l.id === lessonId);
    if (idx === -1) return;

    if (!confirm("Bu darsni o‘chirmoqchimisiz?")) return;

    course.lessons.splice(idx, 1);
    await saveDataToFirestore();
    renderAdminCourses();
    renderUserCourses();
  });

  // ---------- USER VIEW + YOUTUBE PLAYER ----------
  let ytApiReady = false;
  const players = {}; // { [courseId]: { player: YT.Player, currentIndex:number } }

  function renderUserCourses() {
    const courses = data.courses || [];
    userCourseList.innerHTML = "";
    userCourseCount.textContent = courses.length + " ta kurs";

    if (courses.length === 0) {
      userEmpty.style.display = "block";
      return;
    }
    userEmpty.style.display = "none";

    courses.forEach(course => {
      const card = document.createElement("div");
      card.className = "course-card";

      const priceText = formatPrice(course.price);
      const hasLessons = course.lessons && course.lessons.length > 0;

      let lessonsHtml = "";
      if (!hasLessons) {
        lessonsHtml = `<div class="empty">Bu kursga hali dars qo‘shilmagan.</div>`;
      } else {
        lessonsHtml = `
          <div class="course-player" data-course-id="${course.id}">
            <div class="video-wrapper">
              <div id="player-${course.id}"></div>
            </div>
            <div class="lesson-playlist">
              ${course.lessons.map((lesson, idx) => `
                <button type="button"
                        class="lesson-playlist-item ${idx === 0 ? "active" : ""}"
                        data-course-id="${course.id}"
                        data-lesson-id="${lesson.id}"
                        data-index="${idx}">
                  <div class="lesson-thumb">
                    <img src="https://img.youtube.com/vi/${lesson.videoId}/mqdefault.jpg" alt="">
                  </div>
                  <div class="lesson-info">
                    <div class="lesson-title">${lesson.title}</div>
                    <div class="lesson-meta">Dars ${idx + 1}</div>
                  </div>
                </button>
              `).join("")}
            </div>
          </div>
        `;
      }

      card.innerHTML = `
        <div class="course-title">${course.title}</div>
        <div class="course-desc">${course.description}</div>
        <div class="course-meta">
          ${course.category ? `<span class="badge">${course.category}</span>` : ""}
          ${priceText ? `<span class="badge ${course.price == 0 ? "free" : "price"}">${priceText}</span>` : ""}
          <span class="badge">Darslar: ${course.lessons ? course.lessons.length : 0}</span>
        </div>
        <div class="course-footer">
          <span class="muted">Kurs ID: ${course.id}</span>
        </div>
        ${lessonsHtml}
      `;
      userCourseList.appendChild(card);
    });

    setupAllPlayers();
  }

  userCourseList.addEventListener("click", e => {
    const btn = e.target.closest(".lesson-playlist-item");
    if (!btn) return;

    const courseId = btn.dataset.courseId;
    const index = Number(btn.dataset.index);
    const course = data.courses.find(c => c.id === courseId);
    if (!course || !course.lessons || !course.lessons[index]) return;

    const lesson = course.lessons[index];
    const info = players[courseId];
    if (!info || !info.player || !lesson.videoId) return;

    info.currentIndex = index;
    info.player.loadVideoById(lesson.videoId);
    updateActivePlaylistItem(courseId, index);
  });

  function updateActivePlaylistItem(courseId, activeIndex) {
    const playlistItems = document.querySelectorAll(`.lesson-playlist-item[data-course-id="${courseId}"]`);
    playlistItems.forEach(btn => {
      const idx = Number(btn.dataset.index);
      if (idx === activeIndex) {
        btn.classList.add("active");
      } else {
        btn.classList.remove("active");
      }
    });
  }

  function setupAllPlayers() {
    if (!ytApiReady) return;

    // eski playerlarni tozalash
    for (const cid in players) {
      if (players[cid].player && typeof players[cid].player.destroy === "function") {
        try { players[cid].player.destroy(); } catch (e) {}
      }
    }

    // yangidan yaratish
    (data.courses || []).forEach(course => {
      if (!course.lessons || course.lessons.length === 0) return;
      const containerId = "player-" + course.id;
      const container = document.getElementById(containerId);
      if (!container) return;

      const firstLesson = course.lessons[0];
      if (!firstLesson || !firstLesson.videoId) return;

      players[course.id] = {
        player: new YT.Player(containerId, {
          videoId: firstLesson.videoId,
          playerVars: {
            rel: 0,
            modestbranding: 1,
            controls: 1,
            fs: 0,
            iv_load_policy: 3
          },
          events: {
            'onStateChange': (event) => handlePlayerStateChange(event, course.id)
          }
        }),
        currentIndex: 0
      };
    });
  }

  function handlePlayerStateChange(event, courseId) {
    if (event.data !== YT.PlayerState.ENDED) return;

    const course = data.courses.find(c => c.id === courseId);
    if (!course || !course.lessons || course.lessons.length === 0) return;

    const info = players[courseId];
    if (!info) return;

    const currentIndex = info.currentIndex || 0;
    const nextIndex = currentIndex + 1;
    if (nextIndex >= course.lessons.length) return;

    const currentLesson = course.lessons[currentIndex];
    const nextLesson = course.lessons[nextIndex];

    const confirmText = `${currentLesson.title} tugadi. Keyingi dars "${nextLesson.title}" ga o'tasizmi?`;
    if (confirm(confirmText)) {
      info.currentIndex = nextIndex;
      info.player.loadVideoById(nextLesson.videoId);
      updateActivePlaylistItem(courseId, nextIndex);
    }
  }

  // YouTube API callback'ni globalga ulab qo'yamiz
  window.onYouTubeIframeAPIReady = function() {
    ytApiReady = true;
    setupAllPlayers();
  };

  // ---------- UI UPDATE ----------
  function updateUI() {
    const user = currentUser;
    if (!user) {
      authSection.classList.remove("hidden");
      adminSection.classList.add("hidden");
      userSection.classList.add("hidden");
      navAdmin.classList.add("hidden");
      logoutBtn.style.display = "none";
      currentUserLabel.textContent = "Mehmon";
      return;
    }

    authSection.classList.add("hidden");
    userSection.classList.remove("hidden");
    logoutBtn.style.display = "inline-block";
    currentUserLabel.textContent = user.username;

    if (user.role === "admin") {
      adminSection.classList.remove("hidden");
      navAdmin.classList.remove("hidden");
      userRolePill.textContent = "Rol: Admin (foydalanuvchi rejimi)";
    } else {
      adminSection.classList.add("hidden");
      navAdmin.classList.add("hidden");
      userRolePill.textContent = "Rol: Foydalanuvchi";
    }

    renderAdminCourses();
    renderUserCourses();
  }

  // ---------- INIT ----------
  (async function init() {
    if (loadStatus) loadStatus.textContent = "Ma'lumotlar yuklanmoqda...";
    data = await loadDataFromFirestore();
    isDataLoaded = true;
    if (loadStatus) loadStatus.textContent = "Ma'lumotlar muvaffaqiyatli yuklandi.";
    updateUI();
  })();
</script>

<!-- YouTube IFrame API (modul emas, oddiy script) -->
<script src="https://www.youtube.com/iframe_api"></script>
</body>
</html>
