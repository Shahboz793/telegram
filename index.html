<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TestMaster ‚Äî BUXORO_EDU</title>
  <style>
    :root{
      --bg1:#0f172a; --bg2:#1e293b; --grad1:#111827; --grad2:#0b1220;
      --card:rgba(255,255,255,.08); --glass:rgba(255,255,255,.06);
      --text:#e5e7eb; --muted:#9ca3af; --border:rgba(255,255,255,.16);
      --primary:#60a5fa;--primary-2:#3b82f6;--accent:#a78bfa;
      --good:#22c55e;--bad:#ef4444;--amber:#f59e0b;
      --shadow:0 24px 60px rgba(0,0,0,.35); --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Arial,Segoe UI,Roboto,sans-serif; color:var(--text);
      background: radial-gradient(1200px 700px at 15% 10%, rgba(96,165,250,.18), transparent 50%),
                  radial-gradient(1000px 600px at 85% 10%, rgba(167,139,250,.2), transparent 50%),
                  linear-gradient(160deg, var(--grad1), var(--grad2));
      min-height:100dvh;
    }
    .wrap{max-width:1100px;margin:28px auto;padding:18px}
    .brand{
      display:flex;align-items:center;gap:14px;padding:16px 18px;border-radius:20px;
      background:linear-gradient(90deg, rgba(96,165,250,.12), rgba(167,139,250,.12));
      border:1px solid var(--border); box-shadow:var(--shadow)
    }
    .logo{
      width:46px;height:46px;border-radius:12px;
      background:conic-gradient(from 0deg, #60a5fa, #a78bfa, #60a5fa);
      filter:brightness(1.05) saturate(1.2); box-shadow:0 10px 30px rgba(96,165,250,.35);
    }
    h1{margin:0;font-size:22px;letter-spacing:.3px}
    .brand small{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }

    .card{
      background:var(--card); backdrop-filter: blur(10px);
      border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:16px; margin-bottom:16px
    }
    .panel-title{display:flex;align-items:center;gap:10px}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--glass);color:var(--muted);font-size:12px}

    input, select{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--border);
      background:rgba(255,255,255,.04); color:var(--text); outline:none
    }
    input::placeholder{color:#94a3b8}
    label{display:block;margin:10px 0 6px;font-size:13px;color:var(--muted)}

    .btn{
      padding:10px 14px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.06); color:var(--text); cursor:pointer; transition:.15s
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 10px 24px rgba(0,0,0,.25)}
    .btn.primary{background:linear-gradient(180deg, rgba(96,165,250,.35), rgba(96,165,250,.25)); border-color:#3b82f6}
    .btn.ghost{background:rgba(255,255,255,.04)}
    .btn.small{padding:7px 10px;font-size:13px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .flex{display:flex;gap:10px;align-items:center}
    .space{flex:1}
    .hidden{display:none!important}

    /* ABCD yirik tugmalar */
    .answer-pad{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    .opt{
      padding:18px 26px;border-radius:14px;border:1px solid var(--border);min-width:76px;
      text-align:center;font-weight:800;font-size:20px;cursor:pointer;transition:.12s;
      background:rgba(255,255,255,.04)
    }
    .opt[data-v="A"]{background:linear-gradient(180deg, rgba(96,165,250,.10), rgba(96,165,250,.06))}
    .opt[data-v="B"]{background:linear-gradient(180deg, rgba(34,197,94,.10), rgba(34,197,94,.06))}
    .opt[data-v="C"]{background:linear-gradient(180deg, rgba(245,158,11,.12), rgba(245,158,11,.06))}
    .opt[data-v="D"]{background:linear-gradient(180deg, rgba(244,114,182,.12), rgba(244,114,182,.06))}
    .opt:hover{transform:translateY(-2px)}
    /* üî¥ Admin tanlov holati */
    .opt.active-admin{
      background:#fee2e2!important; border-color:#fca5a5!important;
      box-shadow:0 0 0 3px rgba(239,68,68,.25); transform:translateY(-2px)
    }
    /* üîµ User tanlov holati */
    .opt.active-user{
      background:#dbeafe!important; border-color:#60a5fa!important;
      box-shadow:0 0 0 3px rgba(59,130,246,.25); transform:translateY(-2px)
    }

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}

    .tag{display:inline-block;padding:6px 10px;border-radius:999px;
      background:rgba(96,165,250,.15);border:1px solid rgba(96,165,250,.35);font-size:12px}

    /* Footer */
    footer{
      margin:24px auto 30px; max-width:1100px; padding:14px 18px; border-radius:16px;
      background:linear-gradient(90deg, rgba(96,165,250,.14), rgba(167,139,250,.14));
      border:1px solid var(--border); color:#cbd5e1; display:flex;justify-content:space-between;align-items:center
    }
    footer a{color:#bfdbfe;text-decoration:none}
    footer a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Brand header -->
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>TestMaster ‚Äî BUXORO_EDU</h1>
        <small>Professional test tizimi: admin uchun tez kiritish, foydalanuvchi uchun toza muhit, reyting va TG yuborish.</small>
      </div>
      <div class="space"></div>
      <span class="pill">v1.1</span>
    </div>

    <!-- Auth panels -->
    <div class="grid">
      <div class="card" id="authCard">
        <div class="panel-title"><strong>Kirish</strong><span class="pill">Foydalanuvchi</span></div>
        <div style="margin-top:10px" class="row">
          <div>
            <label>Login (majburiy)</label>
            <input id="userLogin" placeholder="Masalan: AliValiyev" />
          </div>
          <div>
            <label>Kod (ixtiyoriy)</label>
            <input id="userPass" type="password" placeholder="" />
          </div>
        </div>
        <div style="margin-top:10px" class="flex">
          <button class="btn primary" onclick="loginUser()">Kirish</button>
          <button class="btn ghost" onclick="fillDemo()">Demo</button>
          <div class="space"></div>
          <button class="btn small" onclick="runSelfTests()">Self-test</button>
        </div>
        <div style="margin-top:10px;color:var(--muted);font-size:13px">
          Login shu brauzerda saqlanadi. Boshqa qurilmada ham shu login bilan kirishingiz mumkin ‚Äî parol tekshirilmaydi.
        </div>
      </div>

      <div class="card" id="adminAuthCard">
        <div class="panel-title"><strong>Admin kirish</strong><span class="pill">Maxfiy</span></div>
        <div class="row" style="margin-top:8px">
          <div><input id="adminLogin" placeholder="" /></div>
          <div><input id="adminCode" placeholder="" type="password" /></div>
        </div>
        <div style="margin-top:8px" class="flex">
          <button class="btn primary" onclick="loginAdmin()">Admin sifatida kirish</button>
          <div class="space"></div>
          <span style="color:var(--muted);font-size:13px">Admin qiymatlari ko‚Äòrsatilmaydi.</span>
        </div>
      </div>
    </div>

    <!-- Admin Panel -->
    <div class="card hidden" id="adminCard">
      <div class="flex">
        <div class="panel-title"><strong>Admin ‚Äî boshqaruv</strong><span class="pill">Test yaratish</span></div>
        <div class="space"></div>
        <button class="btn small" onclick="logout()">Chiqish</button>
      </div>

      <div class="grid" style="margin-top:10px">
        <div class="card" style="margin:0">
          <strong>Test yaratish</strong>
          <div style="margin-top:10px">
            <label>Test nomi</label><input id="tName" />
            <label style="margin-top:10px">Maxsus kod</label><input id="tCode" />
            <label style="margin-top:10px">Savollar soni</label><input id="tCount" type="number" value="5" min="1" />
            <div style="margin-top:10px" class="flex">
              <button class="btn" onclick="buildAnswerGrid()">Javob panellari</button>
              <button class="btn primary" onclick="saveTest()">Saqlash</button>
            </div>
            <div id="answerGrid" style="margin-top:10px"></div>
          </div>
        </div>

        <div class="card" style="margin:0">
          <strong>Saqlangan testlar & foydalanuvchilar</strong>
          <div id="adminTests" style="margin-top:10px"></div>
          <div id="adminUsers" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

    <!-- User tests list -->
    <div class="card hidden" id="userCard">
      <div class="flex">
        <div class="panel-title"><strong>Saqlangan testlar</strong><span class="pill">Ro‚Äòyxat</span></div>
        <div class="space"></div>
        <span id="whoTag" class="tag"></span>
        <button class="btn small" onclick="logout()">Chiqish</button>
      </div>
      <div id="testsList" style="margin-top:12px"></div>
    </div>

    <!-- Test play -->
    <div class="card hidden" id="playCard">
      <div class="flex">
        <div class="panel-title"><strong id="playTitle">Test</strong><span class="pill">Ishlash</span></div>
        <div class="space"></div>
        <button class="btn small" onclick="backToList()">‚¨ÖÔ∏è Orqaga</button>
      </div>
      <div id="playBody" style="margin-top:12px"></div>
      <div class="flex" style="margin-top:12px">
        <div class="space"></div>
        <button class="btn primary" onclick="finishTest()">Yakunlash</button>
      </div>
    </div>

    <!-- Results -->
    <div class="card hidden" id="resultsCard">
      <div class="flex">
        <div class="panel-title"><strong id="resTitle">Natijalar</strong><span class="pill">Reyting</span></div>
        <div class="space"></div>
        <button class="btn small" onclick="backToList()">‚¨ÖÔ∏è Orqaga</button>
      </div>
      <div id="leaderboardWrap" style="margin-top:12px"></div>
      <div id="detailWrap" style="margin-top:12px"></div>
      <div class="flex" style="margin-top:12px">
        <div class="space"></div><button class="btn" onclick="copyTg()">Telegramga yuborish</button>
      </div>
    </div>
  </div>

  <footer>
    <div>¬© 2025 TestMaster ‚Äî professional sinov muhiti</div>
    <div>Pastda: <a href="#" title="BUXORO_EDU">BUXORO_EDU o‚Äòquv markazi sayti</a></div>
  </footer>

<script>
/* ===== Storage helpers ===== */
const LS = {
  testsKey: 'tm_tests_v4',
  usersKey: 'tm_users_v4',
  resultsKey: code=>`tm_results_${code}`,
  attemptsKey: code=>`tm_attempts_${code}`,              // NEW: attempts per test
  lastUserKey: 'tm_last_user_v4',
  get tests(){ return JSON.parse(localStorage.getItem(this.testsKey)||'[]') },
  set tests(v){ localStorage.setItem(this.testsKey, JSON.stringify(v)) },
  get users(){ return JSON.parse(localStorage.getItem(this.usersKey)||'[]') },
  set users(v){ localStorage.setItem(this.usersKey, JSON.stringify(v)) },
  getResults(code){ return JSON.parse(localStorage.getItem(this.resultsKey(code))||'[]') },
  setResults(code, arr){ localStorage.setItem(this.resultsKey(code), JSON.stringify(arr)) },
  getAttempts(code){ return JSON.parse(localStorage.getItem(this.attemptsKey(code))||'{}') },
  setAttempts(code, obj){ localStorage.setItem(this.attemptsKey(code), JSON.stringify(obj)) }
};

/* ===== Session ===== */
let SESSION = { role:null, login:null };

/* ===== UI helpers ===== */
function show(id,on=true){ document.getElementById(id).classList.toggle('hidden', !on) }
function logout(){
  SESSION={role:null,login:null};
  show('adminCard',false); show('userCard',false); show('playCard',false); show('resultsCard',false);
  show('authCard',true); show('adminAuthCard',true);
}
function backToList(){
  if(SESSION.role === 'user'){
    show('playCard', false); show('resultsCard', false);
    show('userCard', true); renderTestsList();
  } else if(SESSION.role === 'admin'){
    show('resultsCard', false); show('playCard', false);
    show('adminCard', true); renderAdminLists();
  } else {
    show('authCard', true); show('adminAuthCard', true);
    show('userCard', false); show('adminCard', false); show('playCard', false); show('resultsCard', false);
  }
}

/* ===== Auth (login anywhere; pass optional) ===== */
function findUser(login){ return (LS.users||[]).find(u=>u.login.toLowerCase()===login.toLowerCase()); }
function loginUser(){
  const login = document.getElementById('userLogin').value.trim();
  const pass  = document.getElementById('userPass').value.trim();
  if(!login){ alert('Login kiriting'); return; }
  let u = findUser(login);
  if(!u){ u = { login, pass }; LS.users = [...LS.users, u]; }
  SESSION = { role:'user', login: u.login };
  localStorage.setItem(LS.lastUserKey, u.login);
  document.getElementById('whoTag').textContent = u.login;
  show('authCard', false); show('adminAuthCard', false); show('userCard', true);
  renderTestsList();
}
function loginAdmin(){
  const login = document.getElementById('adminLogin').value.trim();
  const code  = document.getElementById('adminCode').value.trim();
  if(login.toLowerCase()==='qwerty' && code==='2768'){
    SESSION = { role:'admin', login:'ADMIN' };
    show('authCard', false); show('adminAuthCard', false); show('adminCard', true);
    renderAdminLists();
  } else alert('Admin login yoki kod xato');
}

/* ===== Admin: Test yaratish (qizil tanlov) ===== */
function buildAnswerGrid(){
  const count = parseInt(document.getElementById('tCount').value||'0');
  const grid = document.getElementById('answerGrid'); grid.innerHTML = '';
  for(let i=1;i<=count;i++){
    const row = document.createElement('div');
    row.style.margin = '6px 0';
    row.innerHTML = `<strong style="display:inline-block;width:28px">${i}.</strong>`;
    const pad = document.createElement('div'); pad.className='answer-pad';
    ['A','B','C','D'].forEach(ch=>{
      const b = document.createElement('button'); b.className='opt'; b.dataset.v=ch; b.textContent=ch;
      b.addEventListener('click', ()=>{
        for(const x of pad.children){ x.classList.remove('active-admin'); }
        b.classList.add('active-admin');
        row.dataset.answer = ch;
      });
      pad.appendChild(b);
    });
    row.appendChild(pad); grid.appendChild(row);
  }
}
function saveTest(){
  const name = document.getElementById('tName').value.trim();
  const code = document.getElementById('tCode').value.trim();
  const count = parseInt(document.getElementById('tCount').value||'0');
  if(!name || !code || !count){ alert('Nomi, kod va savollar soni to\'ldirilsin'); return; }
  const rows = [...document.getElementById('answerGrid').querySelectorAll('div')];
  const qrows = rows.filter(d=>d.querySelector && d.querySelector('.answer-pad'));
  if(qrows.length !== count){ alert('Avval javob panellarini yarating'); return; }
  const answers = qrows.map((r,i)=> r.dataset.answer || (alert((i+1)+'-savol uchun javob belgilansin'), null));
  if(answers.some(x=>!x)) return;
  const tests = LS.tests.filter(t=>t.code !== code);
  tests.push({ name, code, count, key:answers });
  LS.tests = tests;
  alert('Test saqlandi');
  document.getElementById('tName').value=''; document.getElementById('tCode').value=''; document.getElementById('tCount').value=5; document.getElementById('answerGrid').innerHTML='';
  renderAdminLists();
}
function renderAdminLists(){
  const tbox = document.getElementById('adminTests'); tbox.innerHTML='';
  if(!LS.tests.length){ tbox.innerHTML = '<div class="muted">Testlar yo ªq</div>'; }
  else {
    LS.tests.forEach(t=>{
      const div = document.createElement('div'); div.className='card'; div.style.margin='6px 0';
      const res = LS.getResults(t.code); const best = res.length? Math.max(...res.map(r=>r.score)) : 0;
      div.innerHTML = `<div class="flex"><strong>${t.name}</strong><div class="space"></div><span class="pill">kod: ${t.code} ‚Ä¢ ${t.count} savol</span></div>
      <div class="flex" style="margin-top:8px">
        <button class="btn" onclick="viewResults('${t.code}')">Natijalar</button>
        <button class="btn" onclick="deleteTest('${t.code}')">O'chirish</button>
        <div class="space"></div><span class="tag">Eng yaxshi: ${best}/${t.count}</span>
      </div>`;
      tbox.appendChild(div);
    });
  }
  const ubox = document.getElementById('adminUsers'); ubox.innerHTML='';
  if(!LS.users.length){ ubox.innerHTML='<div class="muted">Foydalanuvchilar yo ªq</div>'; }
  else {
    const table = document.createElement('table'); let html = '<thead><tr><th>#</th><th>Login</th><th>Kod (agar saqlangan bo‚Äòlsa)</th></tr></thead><tbody>';
    LS.users.forEach((u,i)=> html += `<tr><td>${i+1}</td><td>${escapeHtml(u.login)}</td><td>${escapeHtml(u.pass||'‚Äî')}</td></tr>`);
    html += '</tbody>'; table.innerHTML = html; ubox.appendChild(table);
  }
}
function deleteTest(code){
  if(!confirm('Testni o ªchirasizmi?')) return;
  LS.tests = LS.tests.filter(t=>t.code!==code);
  localStorage.removeItem(LS.resultsKey(code));
  renderAdminLists();
  alert('O ªchirildi');
}

/* ===== User: list tests (attempts & retake) ===== */
function renderTestsList(){
  const box = document.getElementById('testsList'); box.innerHTML='';
  if(!LS.tests.length){ box.innerHTML = '<div class="muted">Testlar yo ªq</div>'; return; }
  LS.tests.forEach(t=>{
    const res = LS.getResults(t.code);
    const attempts = LS.getAttempts(t.code);
    const used = SESSION.login ? (attempts[SESSION.login]||0) : 0;
    const best = res.length?Math.max(...res.map(r=>r.score)):0;
    const haveRecord = SESSION.login ? res.some(r=>r.login===SESSION.login) : false;

    const card = document.createElement('div'); card.className='card'; card.style.margin='6px 0';
    card.innerHTML = `<div class="flex"><strong>${t.name}</strong><div class="space"></div><span class="pill">${t.count} savol</span></div>`;

    const controls = document.createElement('div'); controls.className='flex'; controls.style.marginTop='10px';
    if(used>=3){
      const tag=document.createElement('span'); tag.className='tag'; tag.textContent='Urinishlar: 3/3'; controls.appendChild(tag);
    }else{
      const btn = document.createElement('button'); btn.className='btn primary';
      btn.textContent = haveRecord ? 'Qayta ishlash' : 'Testni ishlash';
      btn.onclick=()=> startTest(t.code);
      controls.appendChild(btn);
      const left=document.createElement('span'); left.className='pill'; left.textContent = `Urinish: ${used}/3`;
      controls.appendChild(left);
    }
    const btnRes = document.createElement('button'); btnRes.className='btn'; btnRes.textContent='Natijalar'; btnRes.onclick=()=>viewResults(t.code); controls.appendChild(btnRes);
    const spacer = document.createElement('div'); spacer.className='space'; controls.appendChild(spacer);
    const tag2 = document.createElement('span'); tag2.className='tag'; tag2.textContent = `Eng: ${best}/${t.count}`; controls.appendChild(tag2);
    card.appendChild(controls); box.appendChild(card);
  });
}

/* ===== Play test (user side ‚Äî single choice, blue) ===== */
let PLAY = { code:null, key:[], count:0, chosen:[] };

function startTest(code){
  if(!SESSION.login){ alert('Avval kirish qiling'); return; }
  const t = LS.tests.find(x=>x.code===code);
  if(!t){ alert('Test topilmadi'); return; }

  // attempts check (max 3)
  const attempts = LS.getAttempts(code);
  const used = attempts[SESSION.login]||0;
  if(used>=3){ alert('Bu testni 3 martadan ko‚Äòp ishlay olmaysiz.'); return; }

  PLAY = { code:code, key: t.key, count: t.count, chosen: new Array(t.count).fill(null) };
  document.getElementById('playTitle').textContent = `${t.name} ‚Äî ${t.count} savol`;
  renderPlay();
  show('userCard', false); show('playCard', true);
}
function renderPlay(){
  const body = document.getElementById('playBody'); body.innerHTML='';
  for(let i=0;i<PLAY.count;i++){
    const row = document.createElement('div'); row.className='card'; row.style.margin='6px 0';
    row.innerHTML = `<div class="flex"><strong>${i+1}.</strong><div class="space"></div><span class="pill">Variant tanlang</span></div>`;
    const pad = document.createElement('div'); pad.className='answer-pad';
    ['A','B','C','D'].forEach(ch=>{
      const b = document.createElement('button'); b.className='opt'; b.dataset.v=ch; b.textContent=ch;
      b.addEventListener('click', ()=>{
        for(const x of pad.children){ x.classList.remove('active-user'); }
        b.classList.add('active-user');
        PLAY.chosen[i]=ch;
      });
      pad.appendChild(b);
    });
    row.appendChild(pad); body.appendChild(row);
  }
}

function finishTest(){
  if(!SESSION.login){ alert('Kirish talab qilinadi'); return; }
  if(PLAY.chosen.some(x=>x===null)){ if(!confirm('Ba ºzi savollar belgilanmagan. Baribir yakunlaysizmi?')) return; }

  // score
  const details=[]; let score=0;
  for(let i=0;i<PLAY.count;i++){
    const correct = PLAY.key[i]; const chosen = PLAY.chosen[i];
    const ok = chosen === correct; if(ok) score++;
    details.push({ q:i+1, chosen: chosen||'-', correct, ok });
  }
  const newRec = { login: SESSION.login, score, total: PLAY.count, details, date: new Date().toISOString() };

  // attempts ++
  const attempts = LS.getAttempts(PLAY.code);
  attempts[SESSION.login] = (attempts[SESSION.login]||0)+1;
  LS.setAttempts(PLAY.code, attempts);

  // keep only ONE result per login (use BEST)
  const arr = LS.getResults(PLAY.code);
  const idx = arr.findIndex(r=>r.login===SESSION.login);
  if(idx<0){
    arr.push(newRec);
  }else{
    const old = arr[idx];
    if(newRec.score > old.score){
      arr[idx] = newRec; // replace with better result
    } // else keep old best
  }
  LS.setResults(PLAY.code, arr);

  viewResults(PLAY.code, newRec);
}

/* ===== Results & Leaderboard + Telegram yuborish ===== */
let __lastTgText = '';

function viewResults(code, justMade=null){
  show('userCard', false); show('playCard', false); show('resultsCard', true);
  const t = LS.tests.find(x=>x.code===code); if(!t){ alert('Test topilmadi'); return; }
  document.getElementById('resTitle').textContent = `${t.name} ‚Äî Natijalar`;

  const arr = LS.getResults(code).slice().sort((a,b)=> b.score-a.score || new Date(a.date)-new Date(b.date));
  const lb = document.getElementById('leaderboardWrap'); lb.innerHTML='';
  if(!arr.length){ lb.innerHTML = '<div class="muted">Natijalar yo ªq</div>'; }
  else {
    const table = document.createElement('table'); let h = '<thead><tr><th>#</th><th>Login</th><th>Ball</th><th>Sana</th></tr></thead><tbody>';
    arr.forEach((r,i)=> h += `<tr><td>${i+1}</td><td>${escapeHtml(r.login)}</td><td><strong>${r.score}/${r.total}</strong></td><td>${new Date(r.date).toLocaleString()}</td></tr>`);
    h += '</tbody>'; table.innerHTML = h; lb.appendChild(table);
  }

  const dw = document.getElementById('detailWrap');
  if(justMade){
    dw.innerHTML = renderDetail(justMade);
    __lastTgText = makeTgText(t, justMade);
  } else {
    // Agar hozirgina ishlanmagan bo‚Äòlsa ham ‚Äî SESSION.login uchun yozuv topib beramiz
    const mine = SESSION.login ? arr.find(r=>r.login===SESSION.login) : null;
    if(mine){
      dw.innerHTML = renderDetail(mine);
      __lastTgText = makeTgText(t, mine);
    } else {
      dw.innerHTML = '<div class="muted">Aynan bir urinishni ko‚Äòrish uchun testni yakunlang yoki o‚Äòz natijangiz yo‚Äòq.</div>';
      __lastTgText = '';
    }
  }
}
function renderDetail(rec){
  let html = '<div class="card" style="margin:0">';
  html += `<strong>${escapeHtml(rec.login)}</strong> ‚Äî <span class="tag">${rec.score}/${rec.total}</span>`;
  html += '<div style="margin-top:10px"><table><thead><tr><th>#</th><th>Tanlangan</th><th>To ªg ªri</th><th>Holat</th></tr></thead><tbody>';
  rec.details.forEach(d=> html += `<tr><td>${d.q}</td><td>${d.chosen}</td><td>${d.correct}</td><td>${d.ok?'<span style="color:#22c55e">to‚Äòg‚Äòri</span>':'<span style="color:#ef4444">xato</span>'}</td></tr>`);
  html += '</tbody></table></div></div>';
  return html;
}

/* Telegram matni va yuborish */
function makeTgText(test, rec){
  const lines = [];
  lines.push(`üß™ Test: ${test.name}${test.code ? ' ('+test.code+')':''}`);
  lines.push(`üë§ Login: ${rec.login}`);
  lines.push(`üìä Natija: ${rec.score}/${rec.total}`);
  lines.push('---');
  rec.details.forEach(d=>{
    lines.push(`${d.q}) tanlandi: ${d.chosen} | to‚Äòg‚Äòri: ${d.correct} ${d.ok?'‚úÖ':'‚ùå'}`);
  });
  return lines.join('\n');
}
function copyTg(){
  if(!__lastTgText){ alert('Avval o‚Äòzingizning natijangizni oching (yoki testni tugating).'); return; }
  // Avval Web Share API orqali bevosita ‚Äúulashish‚Äù (Telegram tanlasa bo‚Äòladi)
  if(navigator.share){
    navigator.share({ text: __lastTgText })
      .catch(()=>fallbackClipboard());
  }else{
    fallbackClipboard();
  }
}
function fallbackClipboard(){
  navigator.clipboard.writeText(__lastTgText)
    .then(()=> alert('‚úÖ Matn nusxalandi! Endi Telegramga yuboring (yopishtiring).'))
    .catch(()=> alert('‚ùå Nusxalashda xato. Brauzer ruxsatlarini tekshiring.'));
}

/* ===== Utils ===== */
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])) }

/* Demo filler */
function fillDemo(){ document.getElementById('userLogin').value='demo'; document.getElementById('userPass').value=''; }

/* Self-tests */
function runSelfTests(){
  const out=[];
  try{
    const rnd = 'self_'+Math.random().toString(36).slice(2,6);
    document.getElementById('userLogin').value = rnd;
    document.getElementById('userPass').value = '';
    loginUser();
    if(!findUser(rnd)) throw new Error('user not created on login');
    out.push('‚úÖ Login creates user if missing (no pass)');
    out.push(document.getElementById('adminLogin').placeholder==='' && document.getElementById('adminCode').placeholder==='' ? '‚úÖ Admin fields blank' : '‚ùå Admin placeholders not blank');
  }catch(e){ out.push('‚ùå Self-test error: '+e.message); }
  alert(out.join('\n'));
}

/* ===== Boot: prefill last login ===== */
(function boot(){
  try{
    const last = localStorage.getItem(LS.lastUserKey);
    if(last){
      const u = findUser(last);
      if(u){ document.getElementById('userLogin').value = u.login; }
    }
  }catch(e){}
})();
</script>
</body>
</html>
