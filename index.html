<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BrandNomi â€” Firebase (Firestore) bilan umumiy login bazasi</title>
  <style>
    :root{--bg:#0b1220;--card:#0f172a;--text:#e2e8f0;--muted:#94a3b8;--primary:#38bdf8;--accent:#22d3ee;--border:#1e293b;--shadow:0 12px 30px rgba(8,15,40,.35);--radius:14px}
    *{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text)}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
    .logo{font-weight:700;font-size:20px}
    .btn{background:var(--primary);color:white;padding:8px 12px;border-radius:10px;border:0;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--text)}
    .card{background:var(--card);border-radius:12px;padding:16px;border:1px solid var(--border);box-shadow:var(--shadow)}
    .auth-panel{position:fixed;inset:0;display:grid;place-items:center;background:rgba(2,6,23,.6);z-index:60}
    .auth{width:420px;background:var(--card);padding:18px;border-radius:12px;border:1px solid var(--border)}
    .tabs{display:flex;gap:6px;margin-bottom:12px}
    .tabs button{flex:1;padding:8px;border-radius:8px;border:0;background:transparent;color:var(--muted);cursor:pointer}
    .tabs button.active{background:linear-gradient(90deg,var(--primary),var(--accent));color:#022}
    .field{display:grid;margin-bottom:10px}
    .field label{font-size:13px;color:var(--muted);margin-bottom:6px}
    .field input{padding:10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)}
    .hint{font-size:13px;color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center}
    .avatar{width:56px;height:56px;border-radius:50%;display:grid;place-items:center;font-weight:800;letter-spacing:.5px;color:#0b1220;user-select:none}
    .avatar.lg{width:72px;height:72px;font-size:20px}
  </style>
</head>
<body>
  <!-- ðŸ”§ KO'RSATMA: Firebase Project yaratib, Firestore'ni yoqing. Quyidagi config maydonlarini o'zingiznikiga almashtiring.  -->
  <header class="container">
    <div class="logo">BrandNomi</div>
  </header>

  <main class="container">
    <div id="welcome" class="card">
      <h2>Umumiy login bazasi (Firebase Firestore)</h2>
      <p class="hint">Ro'yxatdan o'tish, kirish, F.I.SH orqali parolni tiklash, profil tahriri. Loginlar Firestore'ga yoziladi â€” istalgan qurilmadan ishlaydi.</p>
    </div>

    <div id="userArea" class="card" style="margin-top:20px"></div>
  </main>

  <div id="authPanel" class="auth-panel">
    <div class="auth card">
      <div class="tabs">
        <button id="tabLogin" type="button" class="active">Kirish</button>
        <button id="tabRegister" type="button">Ro'yxatdan o'tish</button>
        <button id="tabReset" type="button">Parolni tiklash</button>
      </div>

      <form id="loginForm">
        <div class="field"><label>Login</label><input id="login_username" required></div>
        <div class="field"><label>Parol</label><input id="login_password" type="password" required></div>
        <button class="btn" type="submit">Kirish</button>
        <p id="loginMsg" class="hint"></p>
      </form>

      <form id="registerForm" style="display:none">
        <div class="field"><label>F.I.SH</label><input id="reg_fullname" required></div>
        <div class="field"><label>Login</label><input id="reg_username" required></div>
        <div class="field"><label>Parol</label><input id="reg_password" type="password" required></div>
        <button class="btn" type="submit">Ro'yxatdan o'tish</button>
        <p id="regMsg" class="hint"></p>
      </form>

      <form id="resetForm" style="display:none">
        <div class="field"><label>F.I.SH</label><input id="reset_fullname" required></div>
        <div class="field"><label>Yangi parol</label><input id="reset_newpass" type="password" required></div>
        <div class="row" style="justify-content:space-between">
          <button class="btn" type="submit">Tiklash</button>
          <button class="btn ghost" type="button" id="remindLoginBtn">Loginni eslatish</button>
        </div>
        <p id="resetMsg" class="hint"></p>
      </form>
    </div>
  </div>

  <div id="editPanel" class="auth-panel" style="display:none">
    <div class="auth card">
      <h3 class="row"><span class="avatar lg" id="editAvatar">AA</span> Profilni tahrirlash</h3>
      <form id="editForm">
        <div class="field"><label>Yangi F.I.SH</label><input id="edit_fullname" required></div>
        <div class="field"><label>Yangi login</label><input id="edit_username" required></div>
        <div class="field"><label>Yangi parol</label><input id="edit_password" type="password" required></div>
        <div class="row" style="justify-content:space-between">
          <button class="btn" type="submit">Saqlash</button>
          <button class="btn ghost" type="button" onclick="document.getElementById('editPanel').style.display='none'">Bekor qilish</button>
        </div>
        <p id="editMsg" class="hint"></p>
      </form>
    </div>
  </div>

  <!-- Firebase CDN (Compat SDK: oddiy yozish uchun) -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <script>
    // 1) Firebase config â€” BU YERNI O'ZGARTIRING (o'zingizning project ma'lumotlari bilan)
    const firebaseConfig = {
      apiKey: "PASTE_YOUR_apiKey",
      authDomain: "PASTE_YOUR_authDomain",
      projectId: "PASTE_YOUR_projectId",
      // Agar Firestore offline persistence yoki hosting ishlatsangiz, kerakli maydonlarni ham qo'shishingiz mumkin
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2) Yordamchi
    async function hashString(s){
      const data=new TextEncoder().encode(s);
      const h=await crypto.subtle.digest('SHA-256',data);
      return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    function initialsFrom(fullname=''){
      const parts=(fullname||'').trim().toUpperCase().split(/\s+/).filter(Boolean);
      if(parts.length===0)return'??';
      if(parts.length===1)return parts[0].slice(0,2);
      return(parts[0][0]||'')+(parts[1][0]||'');
    }
    function pastelFromSeed(seed=''){
      let h=0;for(let i=0;i<seed.length;i++){h=(h*31+seed.charCodeAt(i))>>>0}
      h=h%360;return`hsl(${h} 70% 70%)`;
    }

    // 3) Sessiya (auto-login yo'q)
    const LS_CUR='bn_current_v1';
    const cur=()=>sessionStorage.getItem(LS_CUR);
    const setCur=u=>sessionStorage.setItem(LS_CUR,u);
    const clearCur=()=>sessionStorage.removeItem(LS_CUR);

    // 4) UI elementlar
    const tabLogin=document.getElementById('tabLogin');
    const tabRegister=document.getElementById('tabRegister');
    const tabReset=document.getElementById('tabReset');
    const loginForm=document.getElementById('loginForm');
    const regForm=document.getElementById('registerForm');
    const resetForm=document.getElementById('resetForm');

    tabLogin.onclick=()=>show('login');
    tabRegister.onclick=()=>show('register');
    tabReset.onclick=()=>show('reset');
    function show(x){
      [tabLogin,tabRegister,tabReset].forEach(t=>t.classList.remove('active'));
      loginForm.style.display=regForm.style.display=resetForm.style.display='none';
      if(x==='login'){tabLogin.classList.add('active');loginForm.style.display='block'}
      if(x==='register'){tabRegister.classList.add('active');regForm.style.display='block'}
      if(x==='reset'){tabReset.classList.add('active');resetForm.style.display='block'}
    }

    // 5) Firestore: users kolleksiyasi
    //    Hujjat ID = username (lowercase, unique)
    function userRef(username){return db.collection('users').doc(username)}

    async function getUser(username){
      const snap = await userRef(username).get();
      return snap.exists ? snap.data() : null;
    }

    async function setUser(username, data){
      await userRef(username).set(data, { merge:false });
    }

    async function updateUser(username, data){
      await userRef(username).set(data, { merge:true });
    }

    async function deleteUser(username){
      await userRef(username).delete();
    }

    // 6) Ro'yxatdan o'tish
    regForm.onsubmit=async e=>{
      e.preventDefault();
      const fullname=reg_fullname.value.trim().toLowerCase();
      const username=reg_username.value.trim().toLowerCase();
      const password=reg_password.value;

      const exist=await getUser(username);
      if(exist){regMsg.textContent='Bu login allaqachon mavjud.';return}

      const user={
        username,
        fullname,
        fullnameLower: fullname,
        passwordHash: await hashString(password),
        avatarColor: pastelFromSeed(username),
        lastLoginAt: null,
        createdAt: Date.now()
      };
      await setUser(username, user);
      setCur(username);
      document.getElementById('authPanel').style.display='none';
      render();
    }

    // 7) Kirish
    loginForm.onsubmit=async e=>{
      e.preventDefault();
      const username=login_username.value.trim().toLowerCase();
      const password=login_password.value;
      const rec=await getUser(username);
      if(!rec){loginMsg.textContent='Login topilmadi';return}
      if(rec.passwordHash!==await hashString(password)){loginMsg.textContent='Parol xato';return}
      await updateUser(username,{lastLoginAt:Date.now()});
      setCur(username);
      document.getElementById('authPanel').style.display='none';
      render();
    }

    // 8) Parolni F.I.SH orqali tiklash + loginni ko'rsatish + login oynasiga qaytish
    resetForm.onsubmit=async e=>{
      e.preventDefault();
      const fullname=reset_fullname.value.trim().toLowerCase();
      const newp=reset_newpass.value;

      const qSnap = await db.collection('users').where('fullnameLower','==',fullname).limit(1).get();
      if(qSnap.empty){resetMsg.textContent='Bunday ismli foydalanuvchi topilmadi.';return}

      const doc = qSnap.docs[0];
      const username = doc.id;
      await updateUser(username,{passwordHash:await hashString(newp)});
      resetMsg.textContent = `Parol tiklandi! Sizning login: @${username}`;
      setTimeout(()=>{show('login')},1500);
    }

    // 9) Loginni eslatish (F.I.SH bo'yicha) â€” bir nechta topilsa, barchasini ko'rsatadi
    document.getElementById('remindLoginBtn').onclick=async()=>{
      const fullname=reset_fullname.value.trim().toLowerCase();
      if(!fullname){resetMsg.textContent='Avval F.I.SH kiriting.';return}
      const qSnap = await db.collection('users').where('fullnameLower','==',fullname).get();
      if(qSnap.empty){resetMsg.textContent='Bunday F.I.SH topilmadi.';return}
      const logins = qSnap.docs.map(d=>`@${d.id}`).join(', ');
      resetMsg.textContent = (qSnap.size===1) ? `Sizning login: ${logins}` : `Mos loginlar: ${logins}`;
    }

    // 10) Profilni tahrirlash (login unikal tekshiruvi + username o'zgarishi)
    document.getElementById('editForm').onsubmit=async e=>{
      e.preventDefault();
      const current=cur(); if(!current) return;
      const rec=await getUser(current);
      if(!rec) return;

      const newFull=edit_fullname.value.trim().toLowerCase();
      const newUser=edit_username.value.trim().toLowerCase();
      const newPass=edit_password.value;

      if(newUser!==current){
        const exist=await getUser(newUser);
        if(exist){editMsg.textContent='Bu login band.';return}
        // yangi hujjatga ko'chirish
        const newData={...rec, fullname:newFull, fullnameLower:newFull, username:newUser, passwordHash:await hashString(newPass)};
        // rang barqarorligi: agar login o'zgarsa â€” yangidan generatsiya qilamiz
        newData.avatarColor = pastelFromSeed(newUser);
        await setUser(newUser,newData);
        await deleteUser(current);
        setCur(newUser);
      }else{
        await updateUser(current,{
          fullname:newFull,
          fullnameLower:newFull,
          passwordHash:await hashString(newPass)
        });
      }
      editMsg.textContent='Maâ€™lumotlar saqlandi!';
      setTimeout(()=>{document.getElementById('editPanel').style.display='none';render()},800);
    }

    // 11) UI render
    async function render(){
      const div=document.getElementById('userArea');
      const c=cur();
      if(!c){
        div.innerHTML='<button class="btn" onclick="document.getElementById(\'authPanel\').style.display=\'grid\'">Kirish / Ro\'yxatdan o\'tish</button>';
        return;
      }
      const rec=await getUser(c);
      if(!rec){clearCur();return render()}
      const initials=initialsFrom(rec.fullname);
      const color=rec.avatarColor||pastelFromSeed(rec.username);
      const last = rec.lastLoginAt ? new Date(rec.lastLoginAt).toLocaleString() : 'â€”';
      div.innerHTML=`
        <div class="row">
          <span class="avatar" style="background:${color}">${initials}</span>
          <div>
            <div><b>${rec.fullname}</b></div>
            <div class="hint">@${rec.username}</div>
            <div class="hint">Oxirgi kirish: ${last}</div>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class='btn' id='editOpen'>Profilni tahrirlash</button>
          <button class='btn ghost' id='logoutBtn'>Chiqish</button>
        </div>`;

      document.getElementById('logoutBtn').onclick=()=>{clearCur();render()};
      document.getElementById('editOpen').onclick=()=>{
        document.getElementById('edit_fullname').value=rec.fullname;
        document.getElementById('edit_username').value=rec.username;
        document.getElementById('edit_password').value='';
        const ea=document.getElementById('editAvatar');
        ea.textContent=initials;ea.style.background=color;
        document.getElementById('editPanel').style.display='grid';
      }
    }

    // Boshlash
    render();
  </script>

  <!-- ðŸ” Tavsiya etilgan Firestore qoidalari (Rules) â€” Development uchun (keyinroq cheklang):
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /users/{username} {
        allow read, write: if true; // â—ï¸faqat sinov uchun. Productionda albatta cheklang!
      }
    }
  }
  -->
</body>
</html>
