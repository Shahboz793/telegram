<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TestMaster ‚Äî BUXORO_EDU (Cloud, Auth)</title>
  <style>
    :root{
      --grad1:#111827; --grad2:#0b1220;
      --card:rgba(255,255,255,.08); --glass:rgba(255,255,255,.06);
      --text:#e5e7eb; --muted:#9ca3af; --border:rgba(255,255,255,.16);
      --primary:#60a5fa;--primary-2:#3b82f6;--accent:#a78bfa;
      --good:#22c55e;--bad:#ef4444;--amber:#f59e0b;
      --shadow:0 24px 60px rgba(0,0,0,.35); --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Arial,Segoe UI,Roboto,sans-serif; color:var(--text);
      background: radial-gradient(1200px 700px at 15% 10%, rgba(96,165,250,.18), transparent 50%),
                  radial-gradient(1000px 600px at 85% 10%, rgba(167,139,250,.2), transparent 50%),
                  linear-gradient(160deg, var(--grad1), var(--grad2));
      min-height:100dvh;
    }
    .wrap{max-width:1100px;margin:28px auto;padding:18px}
    .brand{
      display:flex;align-items:center;gap:14px;padding:16px 18px;border-radius:20px;
      background:linear-gradient(90deg, rgba(96,165,250,.12), rgba(167,139,250,.12));
      border:1px solid var(--border); box-shadow:var(--shadow)
    }
    .logo{width:46px;height:46px;border-radius:12px;background:conic-gradient(from 0deg,#60a5fa,#a78bfa,#60a5fa);filter:brightness(1.05) saturate(1.2);box-shadow:0 10px 30px rgba(96,165,250,.35)}
    h1{margin:0;font-size:22px;letter-spacing:.3px}
    .brand small{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card);backdrop-filter: blur(10px);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
    .panel-title{display:flex;align-items:center;gap:10px}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--glass);color:var(--muted);font-size:12px}

    input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text);outline:none}
    input::placeholder{color:#94a3b8}
    label{display:block;margin:10px 0 6px;font-size:13px;color:var(--muted)}

    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);cursor:pointer;transition:.15s}
    .btn:hover{transform:translateY(-1px); box-shadow:0 10px 24px rgba(0,0,0,.25)}
    .btn.primary{background:linear-gradient(180deg, rgba(96,165,250,.35), rgba(96,165,250,.25)); border-color:#3b82f6}
    .btn.small{padding:7px 10px;font-size:13px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .flex{display:flex;gap:10px;align-items:center}
    .space{flex:1}
    .hidden{display:none!important}

    .answer-pad{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    .opt{padding:18px 26px;border-radius:14px;border:1px solid var(--border);min-width:76px;text-align:center;font-weight:800;font-size:20px;cursor:pointer;transition:.12s;background:rgba(255,255,255,.04)}
    .opt[data-v="A"]{background:linear-gradient(180deg, rgba(96,165,250,.10), rgba(96,165,250,.06))}
    .opt[data-v="B"]{background:linear-gradient(180deg, rgba(34,197,94,.10), rgba(34,197,94,.06))}
    .opt[data-v="C"]{background:linear-gradient(180deg, rgba(245,158,11,.12), rgba(245,158,11,.06))}
    .opt[data-v="D"]{background:linear-gradient(180deg, rgba(244,114,182,.12), rgba(244,114,182,.06))}
    .opt:hover{transform:translateY(-2px)}
    .opt.active-admin{background:#fee2e2!important;border-color:#fca5a5!important;box-shadow:0 0 0 3px rgba(239,68,68,.25);transform:translateY(-2px)}
    .opt.active-user{background:#dbeafe!important;border-color:#60a5fa!important;box-shadow:0 0 0 3px rgba(59,130,246,.25);transform:translateY(-2px)}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}

    .tag{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(96,165,250,.15);border:1px solid rgba(96,165,250,.35);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>TestMaster ‚Äî BUXORO_EDU</h1>
        <small>Bulutga saqlanadigan professional test tizimi (Auth + Firestore)</small>
      </div>
      <div class="space"></div>
      <span class="pill">Cloud v2.0 (Auth)</span>
    </div>

    <div class="grid">
      <!-- AUTH -->
      <div class="card" id="authCard">
        <div class="panel-title"><strong>Foydalanuvchi</strong><span class="pill">Kirish / Ro‚Äòyxatdan o‚Äòtish</span></div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Email</label>
            <input id="userEmail" type="email" placeholder="email@example.com" />
          </div>
          <div>
            <label>Parol</label>
            <input id="userPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
        </div>
        <div class="flex" style="margin-top:10px">
          <button class="btn primary" id="btnLogin">Kirish</button>
          <button class="btn" id="btnRegister">Ro‚Äòyxatdan o‚Äòtish</button>
          <div class="space"></div>
          <button class="btn small" id="btnLogout" disabled>Chiqish</button>
        </div>
        <div style="margin-top:8px;color:var(--muted);font-size:13px">
          Kirgandan keyin sahifa sizning holatingizni avtomatik yangilaydi. Admin bo‚Äòlsangiz, admin panel ochiladi.
        </div>
      </div>

      <!-- ADMIN PANEL -->
      <div class="card hidden" id="adminCard">
        <div class="flex">
          <div class="panel-title"><strong>Admin ‚Äî boshqaruv</strong><span class="pill">Test yaratish</span></div>
          <div class="space"></div>
          <span id="adminTag" class="tag"></span>
        </div>

        <div class="grid" style="margin-top:10px">
          <div class="card" style="margin:0">
            <strong>Test yaratish</strong>
            <div style="margin-top:10px">
              <label>Test nomi</label><input id="tName" />
              <label style="margin-top:10px">Maxsus kod</label><input id="tCode" />
              <label style="margin-top:10px">Savollar soni</label><input id="tCount" type="number" value="5" min="1" />
              <div class="flex" style="margin-top:10px">
                <button class="btn" id="btnBuildGrid">Javob panellari</button>
                <button class="btn primary" id="btnSaveTest">Saqlash</button>
              </div>
              <div id="answerGrid" style="margin-top:10px"></div>
            </div>
          </div>

          <div class="card" style="margin:0">
            <strong>Saqlangan testlar</strong>
            <div id="adminTests" style="margin-top:10px"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- USER LIST -->
    <div class="card hidden" id="userCard">
      <div class="flex">
        <div class="panel-title"><strong>Saqlangan testlar</strong><span class="pill">Ro‚Äòyxat</span></div>
        <div class="space"></div>
        <span id="whoTag" class="tag"></span>
      </div>
      <div id="testsList" style="margin-top:12px"></div>
    </div>

    <!-- PLAY -->
    <div class="card hidden" id="playCard">
      <div class="flex">
        <div class="panel-title"><strong id="playTitle">Test</strong><span class="pill">Ishlash</span></div>
        <div class="space"></div>
        <button class="btn small" id="btnBack1">‚¨ÖÔ∏è Orqaga</button>
      </div>
      <div id="playBody" style="margin-top:12px"></div>
      <div class="flex" style="margin-top:12px">
        <div class="space"></div>
        <button class="btn primary" id="btnFinish">Yakunlash</button>
      </div>
    </div>

    <!-- RESULTS -->
    <div class="card hidden" id="resultsCard">
      <div class="flex">
        <div class="panel-title"><strong id="resTitle">Natijalar</strong><span class="pill">Reyting</span></div>
        <div class="space"></div>
        <button class="btn small" id="btnBack2">‚¨ÖÔ∏è Orqaga</button>
      </div>
      <div id="leaderboardWrap" style="margin-top:12px"></div>
      <div id="detailWrap" style="margin-top:12px"></div>
      <div class="flex" style="margin-top:12px">
        <div class="space"></div><button class="btn" id="btnTg">Telegramga yuborish</button>
      </div>
    </div>
  </div>

  <footer style="opacity:.8;text-align:center;margin:18px 0">¬© 2025 TestMaster ‚Äî Firestore Cloud</footer>

<!-- ===== APP SCRIPT ===== -->
<script type="module">
  // Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, deleteDoc,
    collection, getDocs, query, where
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
  import {
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

  // --- Config (sizniki)
  const firebaseConfig = {
    apiKey: "AIzaSyDVidcgjpUxkg88bxXfIFzmsFydv0rMMao",
    authDomain: "shahboz-5d0a3.firebaseapp.com",
    projectId: "shahboz-5d0a3",
    storageBucket: "shahboz-5d0a3.firebasestorage.app",
    messagingSenderId: "352024095535",
    appId: "1:352024095535:web:6ca630de2c199a33c54fda",
    measurementId: "G-YS5RGZ00EB"
  };

  const app  = initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const auth = getAuth(app);

  // --- Helpers
  const $ = id => document.getElementById(id);
  const show = (id, on=true) => $(id).classList.toggle('hidden', !on);
  const escapeHtml = s => (s||'').toString().replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const isEmail = v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);

  // --- Admin check (admins/{uid} mavjudmi?)
  async function isAdmin(uid){
    if(!uid) return false;
    const snap = await getDoc(doc(db,'admins', uid));
    return snap.exists();
  }

  // --- DB Layer
  const DB = {
    // tests
    async saveTest({name, code, count, key}){
      await setDoc(doc(db,'tests', code), { name, code, count, key, updatedAt: Date.now() });
    },
    async deleteTest(code){ await deleteDoc(doc(db,'tests', code)); },
    async allTests(){
      const qs = await getDocs(collection(db,'tests')); const arr=[]; qs.forEach(d=>arr.push(d.data()));
      return arr.sort((a,b)=>a.name.localeCompare(b.name));
    },
    // attempts
    async getAttempts(code, uid){
      const id = `${code}__${uid}`;
      const snap = await getDoc(doc(db,'attempts', id));
      return snap.exists()? (snap.data().count||0) : 0;
    },
    async incAttempt(code, uid, login){
      const id = `${code}__${uid}`;
      const n = await this.getAttempts(code, uid)+1;
      await setDoc(doc(db,'attempts', id), { code, uid, login, count:n, updatedAt: Date.now() });
      return n;
    },
    // results
    async getResults(code){
      const qs = await getDocs(query(collection(db,'results'), where('code','==',code)));
      const arr=[]; qs.forEach(d=>arr.push(d.data()));
      return arr.sort((a,b)=> b.score-a.score || a.date-b.date);
    },
    async upsertBestResult(rec){
      const id = `${rec.code}__${rec.uid}`;
      const ref = doc(db,'results', id);
      const cur = await getDoc(ref);
      if(!cur.exists() || (rec.score > (cur.data().score||0))){
        await setDoc(ref, rec);
      }
    },
    async bestOfUser(code, uid){
      const id = `${code}__${uid}`;
      const snap = await getDoc(doc(db,'results', id));
      return snap.exists()? snap.data() : null;
    }
  };

  // --- Session
  let SESSION = { uid:null, email:null, admin:false };
  function resetUI(){
    show('adminCard', false); show('userCard', false); show('playCard', false); show('resultsCard', false);
    // authCard doim ko‚Äòrinadi (kirish/chiqish)
    $('whoTag').textContent = SESSION.email || '';
    $('adminTag').textContent = SESSION.admin ? 'ADMIN' : '';
    $('btnLogout').disabled = !SESSION.uid;
  }

  // --- Auth handlers
  $('btnRegister').addEventListener('click', async ()=>{
    const email = $('userEmail').value.trim();
    const pass  = $('userPass').value.trim();
    if(!isEmail(email)) return alert('Email kiriting (to‚Äòg‚Äòri formatda).');
    if(!pass) return alert('Parol kiriting.');
    try{
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      // optional: users/{uid} profilini saqlab qo‚Äòyamiz
      await setDoc(doc(db,'users', cred.user.uid), { uid: cred.user.uid, email, createdAt: Date.now() });
      alert('Ro‚Äòyxatdan o‚Äòtildi! Endi kirishingiz mumkin.');
    }catch(e){ alert('Xatolik: '+e.message); }
  });

  $('btnLogin').addEventListener('click', async ()=>{
    const email = $('userEmail').value.trim();
    const pass  = $('userPass').value.trim();
    if(!isEmail(email) || !pass) return alert('Email va parol kiriting.');
    try{
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(e){ alert('Kirish xatosi: '+e.message); }
  });

  $('btnLogout').addEventListener('click', async ()=>{
    try{ await signOut(auth); }catch(e){ alert('Chiqishda xato: '+e.message); }
  });

  // --- Auth state listener
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      SESSION.uid = user.uid;
      SESSION.email = user.email || '(email yo‚Äòq)';
      try{ localStorage.setItem('tm_last_login', SESSION.email); }catch(_){}
      SESSION.admin = await isAdmin(SESSION.uid);
      $('whoTag').textContent = SESSION.email;
      $('adminTag').textContent = SESSION.admin ? 'ADMIN' : '';
      show('userCard', true);
      if(SESSION.admin) show('adminCard', true);
      await renderTestsList();
      if(SESSION.admin) await drawTestsListForAdmin();
    }else{
      SESSION = { uid:null, email:null, admin:false };
      resetUI();
    }
  });

  // --- Admin UI
  $('btnBuildGrid').addEventListener('click', buildAnswerGrid);
  $('btnSaveTest').addEventListener('click', saveTest);

  function buildAnswerGrid(){
    const count = parseInt($('tCount').value||'0');
    const grid = $('answerGrid'); grid.innerHTML='';
    for(let i=1;i<=count;i++){
      const row = document.createElement('div');
      row.style.margin='6px 0';
      row.innerHTML = `<strong style="display:inline-block;width:28px">${i}.</strong>`;
      const pad = document.createElement('div'); pad.className='answer-pad';
      ['A','B','C','D'].forEach(ch=>{
        const b=document.createElement('button'); b.className='opt'; b.dataset.v=ch; b.textContent=ch;
        b.addEventListener('click',()=>{
          for(const x of pad.children) x.classList.remove('active-admin');
          b.classList.add('active-admin'); row.dataset.answer=ch;
        });
        pad.appendChild(b);
      });
      row.appendChild(pad); grid.appendChild(row);
    }
  }

  async function saveTest(){
    try{
      if(!SESSION.admin) return alert('Faqat admin yozishi mumkin.');
      const name = $('tName').value.trim();
      const code = $('tCode').value.trim();
      const count= parseInt($('tCount').value||'0');
      if(!name || !code || !count) return alert('Nomi, kod, savollar soni to‚Äòldirilsin.');
      const rows=[...$('answerGrid').querySelectorAll('div')].filter(x=>x.querySelector&&x.querySelector('.answer-pad'));
      if(rows.length!==count) return alert('Avval javob panellarini yarating.');
      const key = rows.map((r,i)=> r.dataset.answer || (alert(`${i+1}-savol uchun javob belgilang`), null));
      if(key.some(x=>!x)) return;
      await DB.saveTest({name,code,count,key});
      alert('Test saqlandi.');
      $('tName').value=''; $('tCode').value=''; $('tCount').value=5; $('answerGrid').innerHTML='';
      await drawTestsListForAdmin();
      await renderTestsList();
    }catch(e){ alert('Saqlash xatosi: '+e.message); }
  }

  async function drawTestsListForAdmin(){
    const box = $('adminTests'); box.innerHTML='';
    const tests = await DB.allTests();
    if(!tests.length){ box.innerHTML='<div class="muted">Testlar yo‚Äòq</div>'; return; }
    for(const t of tests){
      const res = await DB.getResults(t.code);
      const best = res.length ? Math.max(...res.map(r=>r.score)) : 0;
      const div = document.createElement('div'); div.className='card'; div.style.margin='6px 0';
      div.innerHTML = `
        <div class="flex">
          <strong>${escapeHtml(t.name)}</strong>
          <div class="space"></div>
          <span class="pill">kod: ${escapeHtml(t.code)} ‚Ä¢ ${t.count} savol</span>
        </div>
        <div class="flex" style="margin-top:8px">
          <button class="btn small" onclick="viewResults('${t.code}')">Natijalar</button>
          <button class="btn small" onclick="(async()=>{await DB.deleteTest('${t.code}'); await drawTestsListForAdmin(); await renderTestsList();})();">O'chirish</button>
          <div class="space"></div><span class="tag">Eng yaxshi: ${best}/${t.count}</span>
        </div>`;
      box.appendChild(div);
    }
  }
  window.viewResults = viewResults; // global

  // --- User list & play
  async function renderTestsList(){
    const box = $('testsList'); box.innerHTML='';
    const tests = await DB.allTests();
    if(!tests.length){ box.innerHTML = '<div class="muted">Testlar yo ªq</div>'; return; }
    for(const t of tests){
      const res  = await DB.getResults(t.code);
      const best = res.length? Math.max(...res.map(r=>r.score)) : 0;
      const used = SESSION.uid ? await DB.getAttempts(t.code, SESSION.uid) : 0;
      const mine = SESSION.uid ? await DB.bestOfUser(t.code, SESSION.uid) : null;

      const card = document.createElement('div'); card.className='card'; card.style.margin='6px 0';
      card.innerHTML = `<div class="flex"><strong>${escapeHtml(t.name)}</strong><div class="space"></div><span class="pill">${t.count} savol</span></div>`;
      const controls = document.createElement('div'); controls.className='flex'; controls.style.marginTop='10px';
      if(used>=3){
        const tag=document.createElement('span'); tag.className='tag'; tag.textContent='Urinishlar: 3/3'; controls.appendChild(tag);
      }else{
        const btn=document.createElement('button'); btn.className='btn primary'; btn.textContent = mine ? 'Qayta ishlash' : 'Testni ishlash';
        btn.onclick=()=> startTest(t.code); controls.appendChild(btn);
        const left=document.createElement('span'); left.className='pill'; left.textContent=`Urinish: ${used}/3`; controls.appendChild(left);
      }
      const btnRes=document.createElement('button'); btnRes.className='btn'; btnRes.textContent='Natijalar'; btnRes.onclick=()=>viewResults(t.code); controls.appendChild(btnRes);
      const spacer=document.createElement('div'); spacer.className='space'; controls.appendChild(spacer);
      const tag2=document.createElement('span'); tag2.className='tag'; tag2.textContent=`Eng: ${best}/${t.count}`; controls.appendChild(tag2);
      card.appendChild(controls); box.appendChild(card);
    }
  }
  window.startTest = startTest;

  let PLAY = { code:null, key:[], count:0, chosen:[] };

  async function startTest(code){
    if(!SESSION.uid) return alert('Avval kiring.');
    const tests = await DB.allTests();
    const t = tests.find(x=>x.code===code);
    if(!t) return alert('Test topilmadi');
    const used = await DB.getAttempts(code, SESSION.uid);
    if(used>=3) return alert('Bu testni 3 martadan ko‚Äòp ishlay olmaysiz.');
    PLAY = { code:code, key:t.key, count:t.count, chosen:new Array(t.count).fill(null) };
    $('playTitle').textContent = `${t.name} ‚Äî ${t.count} savol`;
    renderPlay();
    show('userCard', false); show('playCard', true);
  }

  function renderPlay(){
    const body = $('playBody'); body.innerHTML='';
    for(let i=0;i<PLAY.count;i++){
      const row=document.createElement('div'); row.className='card'; row.style.margin='6px 0';
      row.innerHTML = `<div class="flex"><strong>${i+1}.</strong><div class="space"></div><span class="pill">Variant tanlang</span></div>`;
      const pad=document.createElement('div'); pad.className='answer-pad';
      ['A','B','C','D'].forEach(ch=>{
        const b=document.createElement('button'); b.className='opt'; b.dataset.v=ch; b.textContent=ch;
        b.addEventListener('click',()=>{ for(const x of pad.children) x.classList.remove('active-user'); b.classList.add('active-user'); PLAY.chosen[i]=ch; });
        pad.appendChild(b);
      });
      row.appendChild(pad); body.appendChild(row);
    }
  }

  async function finishTest(){
    if(!SESSION.uid) return alert('Kirish talab qilinadi.');
    if(PLAY.chosen.some(x=>x===null) && !confirm('Ba ºzi savollar belgilanmagan. Baribir yakunlaysizmi?')) return;

    const details=[]; let score=0;
    for(let i=0;i<PLAY.count;i++){
      const correct=PLAY.key[i]; const chosen=PLAY.chosen[i]; const ok=(chosen===correct); if(ok) score++;
      details.push({ q:i+1, chosen: chosen||'-', correct, ok });
    }
    await DB.incAttempt(PLAY.code, SESSION.uid, SESSION.email);
    const rec = { uid:SESSION.uid, login:SESSION.email, code:PLAY.code, score, total:PLAY.count, details, date:Date.now() };
    await DB.upsertBestResult(rec);
    await viewResults(PLAY.code, rec);
  }
  $('btnFinish').addEventListener('click', finishTest);
  $('btnBack1').addEventListener('click', ()=>{ show('playCard',false); show('userCard',true); });

  // --- Results + share
  let __lastTgText = '';
  function makeTgText(test, rec){
    const lines=[];
    lines.push(`üß™ Test: ${test.name}${test.code?' ('+test.code+')':''}`);
    lines.push(`üë§ Login: ${rec.login}`);
    lines.push(`üìä Natija: ${rec.score}/${rec.total}`);
    lines.push('---');
    rec.details.forEach(d=> lines.push(`${d.q}) tanlandi: ${d.chosen} | to‚Äòg‚Äòri: ${d.correct} ${d.ok?'‚úÖ':'‚ùå'}`));
    return lines.join('\n');
  }
  function renderDetail(rec){
    let html = '<div class="card" style="margin:0">';
    html += `<strong>${escapeHtml(rec.login)}</strong> ‚Äî <span class="tag">${rec.score}/${rec.total}</span>`;
    html += '<div style="margin-top:10px"><table><thead><tr><th>#</th><th>Tanlangan</th><th>To ªg ªri</th><th>Holat</th></tr></thead><tbody>';
    rec.details.forEach(d=> html += `<tr><td>${d.q}</td><td>${d.chosen}</td><td>${d.correct}</td><td>${d.ok?'<span style="color:#22c55e">to‚Äòg‚Äòri</span>':'<span style="color:#ef4444">xato</span>'}</td></tr>`);
    html += '</tbody></table></div></div>'; return html;
  }

  async function viewResults(code, justMade=null){
    show('userCard', false); show('playCard', false); show('resultsCard', true);
    const tests = await DB.allTests(); const t = tests.find(x=>x.code===code); if(!t){ alert('Test topilmadi'); return; }
    $('resTitle').textContent = `${t.name} ‚Äî Natijalar`;

    const arr = await DB.getResults(code);
    const lb = $('leaderboardWrap'); lb.innerHTML='';
    if(!arr.length){ lb.innerHTML = '<div class="muted">Natijalar yo ªq</div>'; }
    else{
      let h = '<table><thead><tr><th>#</th><th>Login</th><th>Ball</th><th>Sana</th></tr></thead><tbody>';
      arr.forEach((r,i)=> h += `<tr><td>${i+1}</td><td>${escapeHtml(r.login)}</td><td><strong>${r.score}/${r.total}</strong></td><td>${new Date(r.date).toLocaleString()}</td></tr>`);
      h += '</tbody></table>'; lb.innerHTML = h;
    }

    const dw = $('detailWrap');
    const mine = justMade || (SESSION.uid ? await DB.bestOfUser(code, SESSION.uid) : null);
    if(mine){ dw.innerHTML = renderDetail(mine); __lastTgText = makeTgText(t, mine); }
    else { dw.innerHTML = '<div class="muted">O‚Äòzingizning urinishni ko‚Äòrish uchun testni yakunlang.</div>'; __lastTgText=''; }
  }
  $('btnBack2').addEventListener('click', ()=>{ show('resultsCard',false); show('userCard',true); });

  function fallbackClipboard(){
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(__lastTgText)
        .then(()=> alert('‚úÖ Matn nusxalandi! Telegramga yuborishingiz mumkin.'))
        .catch(()=> prompt('Matnni qo‚Äòlda nusxalang (Ctrl+C):', __lastTgText));
    } else {
      prompt('Matnni qo‚Äòlda nusxalang (Ctrl+C):', __lastTgText);
    }
  }
  function copyTg(){
    if(!__lastTgText) return alert('Avval o‚Äòzingizning natijangizni oching (yoki testni tugating).');
    if(navigator.share){ navigator.share({ text: __lastTgText }).catch(()=>fallbackClipboard()); }
    else fallbackClipboard();
  }
  $('btnTg').addEventListener('click', copyTg);

  // Start (UI reset)
  resetUI();
  // Avvalgi emailni to‚Äòldirib qo‚Äòyish
  try{ const last = localStorage.getItem('tm_last_login'); if(last) $('userEmail').value = last; }catch(_){}
</script>
</body>
</html>
