<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Radar Mobile PWA — Server + Overspeed</title>
  <meta name="theme-color" content="#0ea5e9">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="assets/icon-192.png" sizes="192x192">
  <link rel="icon" href="assets/icon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

  <style>
    :root{
      --bg:#f8fbff;--card:#fff;--accent:#0ea5e9;--accent-700:#0284c7;
      --danger:#ef4444;--warn:#f59e0b;--muted:#475569;--radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#eef9ff,#f2f9ff)}
    .app{display:flex;flex-direction:column;height:100vh;gap:8px;padding:10px}
    header{display:flex;align-items:center;gap:10px;padding:6px 8px;border-radius:12px;background:var(--card);box-shadow:0 6px 20px rgba(2,6,23,.06)}
    .brand .title{font-weight:800;font-size:16px}
    .brand .sub{font-size:12px;color:var(--muted)}
    .mapwrap{flex:1;border-radius:12px;overflow:hidden;box-shadow:0 10px 34px rgba(2,6,23,.06)}
    #map{height:100%;min-height:320px}
    .panel{background:var(--card);border-radius:14px;padding:12px;box-shadow:0 16px 40px rgba(2,6,23,.12)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{background:var(--accent);color:#fff;border:0;padding:12px 14px;border-radius:12px;font-weight:700}
    .btn.ghost{background:transparent;color:var(--accent);border:2px solid rgba(14,165,233,.15)}
    .small{font-size:12px;color:var(--muted)}
    .badge{display:inline-flex;align-items:center;justify-content:center;width:84px;height:84px;border-radius:50%;background:#fff;border:3px solid #e6f2fb;box-shadow:0 10px 24px rgba(2,6,23,.08);font-weight:900;font-size:18px}
    .badgerow{display:flex;gap:12px;margin-left:auto}
    .alert{padding:10px;border-radius:10px;margin-top:8px}
    .a500{background:#f0f9ff;border-left:6px solid #0ea5e9;color:#0369a1}
    .a300{background:#fff7ed;border-left:6px solid #f59e0b;color:#b45309}
    .a100{background:#fff1f2;border-left:6px solid #ef4444;color:#991b1b}
    .overspeed{background:#fee2e2;border-left:8px solid #ef4444;color:#991b1b;font-weight:800}
    .list{max-height:180px;overflow:auto;margin-top:8px;display:flex;flex-direction:column;gap:6px}
    .item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px solid #eaf2f9;border-radius:10px}
    input[type="file"]{display:none}
    input[type="number"]{padding:8px;border:1px solid #e6eef9;border-radius:10px;width:90px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,#06b6d4,#0284c7);display:flex;align-items:center;justify-content:center;color:white;font-weight:800">R</div>
      <div class="brand">
        <div class="title">Radar Mobile PWA</div>
        <div class="sub">Serverdan radar + Offline + Overspeed</div>
      </div>
      <div class="badgerow">
        <div class="badge"><div><div class="small">TEZLIK</div><div id="curSpeed">—</div></div></div>
        <div class="badge"><div><div class="small">LIMIT</div><div id="curLimit">—</div></div></div>
      </div>
    </header>

    <div class="mapwrap"><div id="map"></div></div>

    <div class="panel">
      <div class="row">
        <button id="start" class="btn">Boshlash</button>
        <button id="add" class="btn ghost">Joylashuvni qoʻsh</button>
        <button id="center" class="btn ghost">Markazga</button>
        <button id="clear" class="btn ghost">Oʻchirish</button>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="fetch" class="btn">Serverdan yuklash</button>
        <input id="api" style="flex:1;padding:10px;border:1px solid #e6eef9;border-radius:10px" placeholder="API URL (JSON) — masalan: https://domain/radars.json">
      </div>

      <div class="row" style="margin-top:8px">
        <label for="overs-voice" class="btn ghost">tezlik_oshirdingiz.mp3</label>
        <input id="overs-voice" type="file" accept="audio/*">
        <label for="alert-voice" class="btn ghost">Alert ovozi (1x)</label>
        <input id="alert-voice" type="file" accept="audio/*">
        <label for="drowsy-voices" class="btn ghost">Hushyorlik MP3</label>
        <input id="drowsy-voices" type="file" accept="audio/*" multiple>
        <span class="small">Interval (daq):</span>
        <input id="drowsy-min" type="number" min="1" value="5">
        <button id="drowsy-toggle" class="btn ghost">Hushyorlik: OFF</button>
      </div>

      <div id="overs" style="margin-top:8px"></div>
      <div id="alerts"></div>
      <div class="list" id="list"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
  // ====== Service Worker Registration ======
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('./sw.js').catch(console.warn);
    });
  }

  (function(){
    // ===== Config =====
    const TH = { A500:500, A300:300, A100:100 };
    const STORAGE = 'radars_server_v1';

    // ===== State =====
    let map, userMarker, userCircle, watchId=null, lastPos=null, lastSpeed=null;
    let audioReady=false;
    let alertVoice=null, oversVoice=null;
    let drowsyFiles=[], drowsyIndex=0, drowsyTimer=null;
    let currentLimit=null, oversLastFire=0; // rate-limit

    const curSpeedEl = document.getElementById('curSpeed');
    const curLimitEl = document.getElementById('curLimit');
    const list = document.getElementById('list');
    const alerts = document.getElementById('alerts');
    const overs = document.getElementById('overs');

    // Buttons / inputs
    const btnStart = document.getElementById('start');
    const btnAdd = document.getElementById('add');
    const btnCenter = document.getElementById('center');
    const btnClear = document.getElementById('clear');
    const btnFetch = document.getElementById('fetch');
    const apiInput = document.getElementById('api');
    const inpAlert = document.getElementById('alert-voice');
    const inpOvers = document.getElementById('overs-voice');
    const inpDrowsy = document.getElementById('drowsy-voices');
    const inpDMin = document.getElementById('drowsy-min');
    const btnDToggle = document.getElementById('drowsy-toggle');

    // ===== Utils =====
    function toRad(v){return v*Math.PI/180;}
    function dist(aLat,aLon,bLat,bLon){
      const R=6371000, dLat=toRad(bLat-aLat), dLon=toRad(bLon-aLon);
      const A=Math.sin(dLat/2)**2 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLon/2)**2;
      return R*(2*Math.atan2(Math.sqrt(A),Math.sqrt(1-A)));
    }
    function mps2kmh(m){return Math.round(m*3.6*10)/10;}
    function uid(){return 'r'+Date.now()+Math.random().toString(36).slice(2,8);}

    // ===== Storage =====
    function load(){try{return JSON.parse(localStorage.getItem(STORAGE))||[]}catch(e){return []}}
    function save(a){localStorage.setItem(STORAGE, JSON.stringify(a));}

    // ===== Map =====
    const layers={}; // id -> {marker,c500,c300,c100,meta}
    function initMap(){
      map = L.map('map',{zoomControl:false, attributionControl:false}).setView([41.311081,69.240562],13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
      map.on('contextmenu', e=>quickAdd(e.latlng.lat, e.latlng.lng));
      renderRadars();
    }
    function clearLayers(){
      Object.values(layers).forEach(Ly=>{
        if(Ly.marker) map.removeLayer(Ly.marker);
        if(Ly.c500) map.removeLayer(Ly.c500);
        if(Ly.c300) map.removeLayer(Ly.c300);
        if(Ly.c100) map.removeLayer(Ly.c100);
      });
      for(const k in layers) delete layers[k];
    }
    function renderRadars(){
      clearLayers(); list.innerHTML='';
      const arr = load();
      arr.forEach((r,i)=>{
        const m = L.marker([r.lat,r.lon]).addTo(map).bindPopup(`<b>Radar #${i+1}</b><br>Limit: ${r.limit} km/h`);
        const c500=L.circle([r.lat,r.lon],{radius:TH.A500,color:'#0ea5e9',fill:false}).addTo(map);
        const c300=L.circle([r.lat,r.lon],{radius:TH.A300,color:'#f59e0b',fill:false}).addTo(map);
        const c100=L.circle([r.lat,r.lon],{radius:TH.A100,color:'#ef4444',fill:false}).addTo(map);
        layers[r.id]={marker:m,c500,c300,c100,meta:r};

        const row=document.createElement('div'); row.className='item';
        row.innerHTML = `<div><b>Radar #${i+1}</b><div class="small">${r.lat.toFixed(5)}, ${r.lon.toFixed(5)}</div><div class="small">Limit: ${r.limit} km/h</div></div>`;
        const right=document.createElement('div');
        const b1=document.createElement('button'); b1.className='btn ghost'; b1.textContent='Markaz'; b1.onclick=()=>map.setView([r.lat,r.lon],16);
        const b2=document.createElement('button'); b2.className='btn ghost'; b2.textContent='Oʻchir'; b2.onclick=()=>{ const a=load().filter(x=>x.id!==r.id); save(a); renderRadars(); };
        right.appendChild(b1); right.appendChild(b2);
        row.appendChild(right); list.appendChild(row);
      });
    }

    // ===== Add / Quick Add =====
    function addRadar(lat,lon,limit){
      const Lm=parseInt(limit); if(isNaN(Lm)||Lm<=0){alert('Limit notoʻgʻri'); return;}
      const arr=load(); arr.push({id:uid(),lat,lon,limit:Lm,created:Date.now()}); save(arr); renderRadars();
    }
    function quickAdd(lat,lon){
      const lim=prompt('Radar maksimal tezligi (km/h)','70'); if(lim===null) return; addRadar(lat,lon,lim);
    }

    // ===== Fetch from Server =====
    async function fetchFromServer(){
      const url = apiInput.value.trim();
      if(!url){ alert('API URL kiriting'); return; }
      try{
        const res = await fetch(url, {cache:'no-store'});
        const data = await res.json();
        if(!Array.isArray(data)) throw new Error('JSON array bo\'lishi kerak');
        // expected fields: [{lat, lon, limit}]
        const normalized = data.map(d=>({id: d.id || uid(), lat: Number(d.lat), lon: Number(d.lon), limit: Number(d.limit||70)}))
                               .filter(x=>!isNaN(x.lat)&&!isNaN(x.lon)&&!isNaN(x.limit));
        // merge (by id if exists, else append)
        const base = load();
        const ids = new Set(base.map(b=>b.id));
        normalized.forEach(n=>{ if(!ids.has(n.id)) base.push(n); });
        save(base);
        renderRadars();
        alert('Serverdan yuklandi: ' + normalized.length + ' ta radar');
      }catch(e){
        alert('Yuklash xatoligi: ' + e.message);
      }
    }

    // ===== Geolocation =====
    function startWatch(){
      if(watchId!==null) return;
      if(!navigator.geolocation){alert('Geolocation yo‘q'); return;}
      watchId = navigator.geolocation.watchPosition(onPos, onGeoErr, {enableHighAccuracy:true, maximumAge:500, timeout:10000});
    }
    function onGeoErr(err){ console.warn('GPS xatoligi', err); }
    function onPos(p){
      const lat=p.coords.latitude, lon=p.coords.longitude, ts=p.timestamp||Date.now();
      if(!userMarker){
        userMarker=L.circleMarker([lat,lon],{radius:8,color:'#0284c7',fillColor:'#06b6d4',fillOpacity:.9}).addTo(map);
        userCircle=L.circle([lat,lon],{radius:10,color:'#93c5fd',fillColor:'#dbeafe',fillOpacity:.25}).addTo(map);
        map.setView([lat,lon],15);
      } else { userMarker.setLatLng([lat,lon]); userCircle.setLatLng([lat,lon]); }
      // speed
      let s=null;
      if(p.coords.speed!=null && !isNaN(p.coords.speed)) s=p.coords.speed;
      else if(lastPos){ const d=dist(lastPos.lat,lastPos.lon,lat,lon); const dt=(ts-lastPos.ts)/1000; if(dt>0) s=d/dt; }
      if(s!=null) lastSpeed=s;
      const kmh = lastSpeed? mps2kmh(lastSpeed):null;
      curSpeedEl.textContent = kmh? kmh : '—';

      // compute applicable limit: take nearest radar within 500 m (lowest limit if tie)
      const arr = load();
      let nearest = null;
      arr.forEach(r=>{
        const d = dist(lat,lon,r.lat,r.lon);
        if(d<=TH.A500){
          if(!nearest || d<nearest.d || (Math.abs(d-nearest.d)<1 && r.limit<nearest.limit)){
            nearest = {id:r.id, d, limit:r.limit};
          }
        }
      });
      currentLimit = nearest ? nearest.limit : null;
      curLimitEl.textContent = currentLimit != null ? currentLimit : '—';

      // overspeed check
      overs.innerHTML='';
      if(kmh!=null && currentLimit!=null && kmh > currentLimit + 1){
        const div = document.createElement('div');
        div.className='alert overspeed';
        const diff = Math.round(kmh - currentLimit);
        div.innerHTML = `<b>Tezlik oshdi!</b> — ${kmh} km/h (limit ${currentLimit}) — kamaytiring ${diff} km/h`;
        overs.appendChild(div);
        // audio once per 10s
        if(audioReady && Date.now() - oversLastFire > 10000){
          oversLastFire = Date.now();
          if(oversVoice) playOnce(oversVoice);
        }
      }

      // Proximity alerts
      handleAlerts({lat,lon});

      lastPos={lat,lon,ts};
    }

    // ===== Alerts (500/300/100 + optional voice) =====
    const lastFired = {}; // id+level -> ts
    function handleAlerts({lat,lon}){
      alerts.innerHTML='';
      const arr = load();
      const msgs=[];
      arr.forEach(r=>{
        const d = Math.round(dist(lat,lon,r.lat,r.lon));
        let level=null;
        if(d<=TH.A100) level='A100';
        else if(d<=TH.A300) level='A300';
        else if(d<=TH.A500) level='A500';
        if(level){
          msgs.push({id:r.id, d, limit:r.limit, level});
        }
      });
      msgs.sort((a,b)=>a.d - b.d);
      msgs.forEach(m=>{
        const div = document.createElement('div');
        if(m.level==='A100') div.className='alert a100';
        else if(m.level==='A300') div.className='alert a300';
        else div.className='alert a500';
        const title = m.level==='A100' ? '100 m: Xavf! Radar juda yaqin' :
                       m.level==='A300' ? '300 m: Tezlikni pasaytiring' :
                                          '500 m: Radar yaqin';
        div.innerHTML = `<b>${title}</b><div class="small">${m.d} m qoldi — max ${m.limit} km/h</div>`;
        alerts.appendChild(div);
        maybeSound({id:m.id, level:m.level});
      });
    }
    function maybeSound({id,level}){
      if(!audioReady) return;
      const key = id+'-'+level;
      const now = Date.now();
      if((now - (lastFired[key]||0)) < 6000) return;
      lastFired[key]=now;
      // 3s tone + 1x alertVoice
      tone(level);
      if(alertVoice) playOnce(alertVoice);
    }
    function tone(level){
      const freq = level==='A100' ? 520 : (level==='A300' ? 440 : 360);
      const dur = 3.0;
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type='sine'; o.frequency.value=freq; g.gain.value=0.06;
        o.connect(g); g.connect(ctx.destination);
        o.start(0); setTimeout(()=>{ o.stop(); ctx.close(); }, dur*1000);
        if(navigator.vibrate){ navigator.vibrate([200,100,200]); }
      }catch(e){}
    }
    function playOnce(file){
      const url = URL.createObjectURL(file);
      const a = new Audio(url);
      a.play().finally(()=> URL.revokeObjectURL(url));
    }

    // ===== Drowsy (playlist) =====
    function startDrowsy(){
      stopDrowsy();
      const mins = Math.max(1, parseInt(inpDMin.value)||5);
      if(drowsyFiles.length===0){ alert('Hushyorlik uchun MP3 tanlang'); return; }
      btnDToggle.textContent='Hushyorlik: ON';
      drowsyTimer = setInterval(()=>{
        if(!audioReady) return;
        const file = drowsyFiles[drowsyIndex % drowsyFiles.length];
        drowsyIndex++;
        playOnce(file);
      }, mins*60000);
    }
    function stopDrowsy(){
      if(drowsyTimer){ clearInterval(drowsyTimer); drowsyTimer=null; }
      btnDToggle.textContent='Hushyorlik: OFF';
    }

    // ===== Events =====
    btnStart.addEventListener('click',()=>{ audioReady=true; startWatch(); btnStart.disabled=true; btnStart.textContent='Ishlayapti'; });
    btnAdd.addEventListener('click',()=>{
      if(!lastPos){ alert('Avval GPSni ishga tushiring'); return; }
      const lim=prompt('Radar maksimal tezligi (km/h)','70'); if(lim===null) return;
      addRadar(lastPos.lat,lastPos.lon,lim);
    });
    btnCenter.addEventListener('click',()=>{ if(lastPos) map.setView([lastPos.lat,lastPos.lon],15); });
    btnClear.addEventListener('click',()=>{ if(confirm('Hamma radarlarni o‘chirilsinmi?')){ localStorage.removeItem(STORAGE); renderRadars(); } });
    btnFetch.addEventListener('click', fetchFromServer);

    inpAlert.addEventListener('change',e=>{ alertVoice = e.target.files[0]||null; });
    inpOvers.addEventListener('change',e=>{ oversVoice = e.target.files[0]||null; });
    inpDrowsy.addEventListener('change',e=>{ drowsyFiles = Array.from(e.target.files||[]); drowsyIndex=0; });
    btnDToggle.addEventListener('click',()=>{ if(drowsyTimer) stopDrowsy(); else startDrowsy(); });

    initMap();
  })();
  </script>
</body>
</html>
