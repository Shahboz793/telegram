<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TestMaster ‚Äî BUXORO_EDU (Cloud)</title>
  <style>
    :root{
      --grad1:#111827; --grad2:#0b1220;
      --card:rgba(255,255,255,.08); --glass:rgba(255,255,255,.06);
      --text:#e5e7eb; --muted:#9ca3af; --border:rgba(255,255,255,.16);
      --primary:#60a5fa;--primary-2:#3b82f6;--accent:#a78bfa;
      --good:#22c55e;--bad:#ef4444;--amber:#f59e0b;
      --shadow:0 24px 60px rgba(0,0,0,.35); --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Arial,Segoe UI,Roboto,sans-serif; color:var(--text);
      background: radial-gradient(1200px 700px at 15% 10%, rgba(96,165,250,.18), transparent 50%),
                  radial-gradient(1000px 600px at 85% 10%, rgba(167,139,250,.2), transparent 50%),
                  linear-gradient(160deg, var(--grad1), var(--grad2));
      min-height:100dvh;
    }
    .wrap{max-width:1100px;margin:28px auto;padding:18px}
    .brand{
      display:flex;align-items:center;gap:14px;padding:16px 18px;border-radius:20px;
      background:linear-gradient(90deg, rgba(96,165,250,.12), rgba(167,139,250,.12));
      border:1px solid var(--border); box-shadow:var(--shadow)
    }
    .logo{
      width:46px;height:46px;border-radius:12px;
      background:conic-gradient(from 0deg, #60a5fa, #a78bfa, #60a5fa);
      filter:brightness(1.05) saturate(1.2); box-shadow:0 10px 30px rgba(96,165,250,.35);
    }
    h1{margin:0;font-size:22px;letter-spacing:.3px}
    .brand small{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }

    .card{
      background:var(--card); backdrop-filter: blur(10px);
      border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:16px; margin-bottom:16px
    }
    .panel-title{display:flex;align-items:center;gap:10px}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--glass);color:var(--muted);font-size:12px}

    input{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--border);
      background:rgba(255,255,255,.04); color:var(--text); outline:none
    }
    input::placeholder{color:#94a3b8}
    label{display:block;margin:10px 0 6px;font-size:13px;color:var(--muted)}

    .btn{
      padding:10px 14px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.06); color:var(--text); cursor:pointer; transition:.15s
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 10px 24px rgba(0,0,0,.25)}
    .btn.primary{background:linear-gradient(180deg, rgba(96,165,250,.35), rgba(96,165,250,.25)); border-color:#3b82f6}
    .btn.ghost{background:rgba(255,255,255,.04)}
    .btn.small{padding:7px 10px;font-size:13px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .flex{display:flex;gap:10px;align-items:center}
    .space{flex:1}
    .hidden{display:none!important}

    .answer-pad{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    .opt{
      padding:18px 26px;border-radius:14px;border:1px solid var(--border);min-width:76px;
      text-align:center;font-weight:800;font-size:20px;cursor:pointer;transition:.12s;
      background:rgba(255,255,255,.04)
    }
    .opt[data-v="A"]{background:linear-gradient(180deg, rgba(96,165,250,.10), rgba(96,165,250,.06))}
    .opt[data-v="B"]{background:linear-gradient(180deg, rgba(34,197,94,.10), rgba(34,197,94,.06))}
    .opt[data-v="C"]{background:linear-gradient(180deg, rgba(245,158,11,.12), rgba(245,158,11,.06))}
    .opt[data-v="D"]{background:linear-gradient(180deg, rgba(244,114,182,.12), rgba(244,114,182,.06))}
    .opt:hover{transform:translateY(-2px)}
    .opt.active-admin{background:#fee2e2!important; border-color:#fca5a5!important; box-shadow:0 0 0 3px rgba(239,68,68,.25); transform:translateY(-2px)}
    .opt.active-user{background:#dbeafe!important; border-color:#60a5fa!important; box-shadow:0 0 0 3px rgba(59,130,246,.25); transform:translateY(-2px)}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}

    .tag{display:inline-block;padding:6px 10px;border-radius:999px;
      background:rgba(96,165,250,.15);border:1px solid rgba(96,165,250,.35);font-size:12px}

    .collapsible-head{
      display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--border); cursor:pointer
    }
    .chev{display:inline-block;transition:.15s}
    .chev.open{transform:rotate(90deg)}
    .head-right{display:flex;gap:8px;align-items:center}
    .search-row{display:flex;gap:8px;align-items:center;margin:10px 0}
    .tabs{display:flex;gap:8px;margin-top:8px}
    .tab{padding:8px 12px;border-radius:10px;border:1px solid var(--border);cursor:pointer;background:var(--glass)}
    .tab.active{background:linear-gradient(180deg, rgba(96,165,250,.35), rgba(96,165,250,.2));border-color:#3b82f6}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>TestMaster ‚Äî BUXORO_EDU</h1>
        <small>Bulutga saqlanadigan professional test tizimi (Firestore)</small>
      </div>
      <div class="space"></div>
      <span class="pill">Cloud v1.0</span>
    </div>

    <div class="grid">
      <!-- Foydalanuvchi auth -->
      <div class="card" id="authCard">
        <div class="panel-title"><strong>Foydalanuvchi</strong><span class="pill">Kirish / Ro‚Äòyxatdan o‚Äòtish</span></div>

        <div class="tabs">
          <div id="tabLogin" class="tab active" onclick="switchAuth('login')">Kirish</div>
          <div id="tabReg" class="tab" onclick="switchAuth('reg')">Ro‚Äòyxatdan o‚Äòtish</div>
        </div>

        <div id="loginPanel" style="margin-top:10px">
          <div class="row">
            <div>
              <label>Login (majburiy)</label>
              <input id="userLogin" placeholder="Masalan: AliValiyev" />
            </div>
            <div>
              <label>Kod / Parol (majburiy)</label>
              <input id="userPass" type="password" />
            </div>
          </div>
          <div style="margin-top:10px" class="flex">
            <button class="btn primary" onclick="loginUser()">Kirish</button>
            <button class="btn ghost" onclick="fillDemo()">Demo</button>
            <div class="space"></div>
          </div>
          <div style="margin-top:10px;color:var(--muted);font-size:13px">
            Login bulutda saqlanadi. Istalgan qurilmadan kiring ‚Äî <b>parol mos</b> bo‚Äòlishi shart.
          </div>
        </div>

        <div id="regPanel" class="hidden" style="margin-top:10px">
          <div class="row">
            <div>
              <label>Login (majburiy)</label>
              <input id="regLogin" placeholder="Yangi login" />
            </div>
            <div>
              <label>Kod / Parol (majburiy)</label>
              <input id="regPass" type="password" placeholder="Kamida 1 belgi" />
            </div>
          </div>
          <div style="margin-top:10px" class="flex">
            <button class="btn primary" onclick="registerUser()">Ro‚Äòyxatdan o‚Äòtish</button>
            <div class="space"></div>
            <span class="pill">Ro‚Äòyxatdan so‚Äòng ‚ÄúKirish‚Äù orqali kiring</span>
          </div>
        </div>
      </div>

      <!-- Admin auth -->
      <div class="card" id="adminAuthCard">
        <div class="panel-title"><strong>Admin kirish</strong><span class="pill">Maxfiy</span></div>
        <div class="row" style="margin-top:8px">
          <div><input id="adminLogin" placeholder="admin login" /></div>
          <div><input id="adminCode" placeholder="kod" type="password" /></div>
        </div>
        <div style="margin-top:8px" class="flex">
          <button class="btn primary" onclick="loginAdmin()">Admin sifatida kirish</button>
          <div class="space"></div>
          <span style="color:var(--muted);font-size:13px">Admin qiymatlari ko‚Äòrsatilmaydi.</span>
        </div>
      </div>
    </div>

    <!-- Admin panel -->
    <div class="card hidden" id="adminCard">
      <div class="flex">
        <div class="panel-title"><strong>Admin ‚Äî boshqaruv</strong><span class="pill">Test yaratish</span></div>
        <div class="space"></div>
        <button class="btn small" onclick="logout()">Chiqish</button>
      </div>

      <div class="grid" style="margin-top:10px">
        <div class="card" style="margin:0">
          <strong>Test yaratish</strong>
          <div style="margin-top:10px">
            <label>Test nomi</label><input id="tName" />
            <label style="margin-top:10px">Maxsus kod</label><input id="tCode" />
            <label style="margin-top:10px">Savollar soni</label><input id="tCount" type="number" value="5" min="1" />
            <div style="margin-top:10px" class="flex">
              <button class="btn" onclick="buildAnswerGrid()">Javob panellari</button>
              <button class="btn primary" onclick="saveTest()">Saqlash</button>
            </div>
            <div id="answerGrid" style="margin-top:10px"></div>
          </div>
        </div>

        <div class="card" style="margin:0">
          <strong>Saqlangan testlar & foydalanuvchilar</strong>

          <div class="collapsible-head" id="testsHead" style="margin-top:10px">
            <span class="chev" id="testsChev">‚ñ∂</span>
            <span><strong>Saqlangan testlar</strong></span>
            <div class="space"></div>
            <span class="pill" id="testsCount">0 ta</span>
            <button class="btn small" id="toggleTestsBtn">Ko‚Äòrsatish</button>
          </div>
          <div id="adminTests" class="hidden" style="margin-top:10px"></div>

          <div class="collapsible-head" id="usersHead" style="margin-top:14px">
            <span class="chev" id="usersChev">‚ñ∂</span>
            <span><strong>Foydalanuvchilar</strong></span>
            <div class="space"></div>
            <span class="pill" id="usersCount">0 ta</span>
            <button class="btn small" id="toggleUsersBtn">Ko‚Äòrsatish</button>
          </div>
          <div id="usersBox" class="hidden" style="margin-top:10px">
            <div class="search-row">
              <input id="usersSearch" placeholder="Login bo‚Äòyicha qidirish..." />
              <button class="btn small" onclick="clearUsersSearch()">Tozalash</button>
            </div>
            <div id="adminUsers"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- User test ro‚Äòyxati -->
    <div class="card hidden" id="userCard">
      <div class="flex">
        <div class="panel-title"><strong>Saqlangan testlar</strong><span class="pill">Ro‚Äòyxat</span></div>
        <div class="space"></div>
        <span id="whoTag" class="tag"></span>
        <button class="btn small" onclick="logout()">Chiqish</button>
      </div>
      <div id="testsList" style="margin-top:12px"></div>
    </div>

    <!-- Test o‚Äòynash -->
    <div class="card hidden" id="playCard">
      <div class="flex">
        <div class="panel-title"><strong id="playTitle">Test</strong><span class="pill">Ishlash</span></div>
        <div class="space"></div>
        <button class="btn small" onclick="backToList()">‚¨ÖÔ∏è Orqaga</button>
      </div>
      <div id="playBody" style="margin-top:12px"></div>
      <div class="flex" style="margin-top:12px">
        <div class="space"></div>
        <button class="btn primary" onclick="finishTest()">Yakunlash</button>
      </div>
    </div>

    <!-- Natijalar -->
    <div class="card hidden" id="resultsCard">
      <div class="flex">
        <div class="panel-title"><strong id="resTitle">Natijalar</strong><span class="pill">Reyting</span></div>
        <div class="space"></div>
        <button class="btn small" onclick="backToList()">‚¨ÖÔ∏è Orqaga</button>
      </div>
      <div id="leaderboardWrap" style="margin-top:12px"></div>
      <div id="detailWrap" style="margin-top:12px"></div>
      <div class="flex" style="margin-top:12px">
        <div class="space"></div><button class="btn" onclick="copyTg()">Telegramga yuborish</button>
      </div>
    </div>
  </div>

  <footer style="opacity:.8;text-align:center;margin:18px 0">
    ¬© 2025 TestMaster ‚Äî Firestore Cloud
  </footer>

<!-- ===== BULUT REJIM: FIREBASE + FIRESTORE ===== -->
<script type="module">
  /* Firebase modullari (CDN) */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, deleteDoc,
    collection, getDocs, query, where
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  /* ‚úÖ Config */
  const firebaseConfig = {
    apiKey: "AIzaSyDVidcgjpUxkg88bxXfIFzmsFydv0rMMao",
    authDomain: "shahboz-5d0a3.firebaseapp.com",
    projectId: "shahboz-5d0a3",
    storageBucket: "shahboz-5d0a3.firebasestorage.app",
    messagingSenderId: "352024095535",
    appId: "1:352024095535:web:6ca630de2c199a33c54fda",
    measurementId: "G-YS5RGZ00EB"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  /* === Yordamchilar === */
  function show(id,on=true){ document.getElementById(id).classList.toggle('hidden', !on) }
  function escapeHtml(s){ return (s||'').toString().replace(/[&<>"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])) }
  function switchAuth(mode){
    const isLogin = mode==='login';
    document.getElementById('loginPanel').classList.toggle('hidden', !isLogin);
    document.getElementById('regPanel').classList.toggle('hidden', isLogin);
    document.getElementById('tabLogin').classList.toggle('active', isLogin);
    document.getElementById('tabReg').classList.toggle('active', !isLogin);
  }
  window.switchAuth = switchAuth;

  async function sha256(text){
    const buf = new TextEncoder().encode(text);
    const hash = await crypto.subtle.digest('SHA-256', buf);
    return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  /* === DB qatlam === */
  const DB = {
    async findUser(login){
      const id = login.toLowerCase();
      const snap = await getDoc(doc(db,'users', id));
      return snap.exists()? snap.data() : null;
    },
    async registerUser(login, pass){
      const id = login.toLowerCase();
      if(await this.findUser(login)) throw new Error('exists');
      await setDoc(doc(db,'users', id), { login, passHash: await sha256(pass), createdAt: Date.now() });
    },
    async allUsers(){
      const qs = await getDocs(collection(db,'users')); const arr=[];
      qs.forEach(d=>arr.push(d.data()));
      return arr.sort((a,b)=>a.login.localeCompare(b.login));
    },

    async saveTest({name, code, count, key}){
      await setDoc(doc(db,'tests', code), { name, code, count, key, updatedAt: Date.now() });
    },
    async deleteTest(code){ await deleteDoc(doc(db,'tests', code)); },
    async allTests(){
      const qs = await getDocs(collection(db,'tests')); const arr=[];
      qs.forEach(d=>arr.push(d.data()));
      return arr.sort((a,b)=>a.name.localeCompare(b.name));
    },

    async getAttempts(code, login){
      const id = `${code}__${login.toLowerCase()}`;
      const snap = await getDoc(doc(db,'attempts', id));
      return snap.exists() ? (snap.data().count||0) : 0;
    },
    async incAttempt(code, login){
      const id = `${code}__${login.toLowerCase()}`;
      const n = await this.getAttempts(code, login)+1;
      await setDoc(doc(db,'attempts', id), { code, login, count:n, updatedAt: Date.now() });
      return n;
    },

    async getResults(code){
      const qs = await getDocs(query(collection(db,'results'), where('code','==',code)));
      const arr=[]; qs.forEach(d=>arr.push(d.data()));
      return arr.sort((a,b)=> b.score-a.score || a.date-b.date);
    },
    async upsertBestResult(rec){
      const id = `${rec.code}__${rec.login.toLowerCase()}`;
      const ref = doc(db,'results', id);
      const cur = await getDoc(ref);
      if(!cur.exists() || (rec.score > (cur.data().score||0))){
        await setDoc(ref, rec);
      }
    },
    async bestOfUser(code, login){
      const id = `${code}__${login.toLowerCase()}`;
      const snap = await getDoc(doc(db,'results', id));
      return snap.exists()? snap.data(): null;
    }
  };

  /* === Session va umumiy UI === */
  let SESSION = { role:null, login:null };
  function logout(){
    SESSION={role:null,login:null};
    show('adminCard',false); show('userCard',false); show('playCard',false); show('resultsCard',false);
    show('authCard',true); show('adminAuthCard',true);
  }
  window.logout = logout;

  async function backToList(){
    if(SESSION.role==='user'){ show('playCard',false); show('resultsCard',false); show('userCard',true); await renderTestsList(); }
    else if(SESSION.role==='admin'){ show('resultsCard',false); show('playCard',false); show('adminCard',true); await renderAdminLists(); }
    else { show('authCard',true); show('adminAuthCard',true); show('userCard',false); show('adminCard',false); show('playCard',false); show('resultsCard',false); }
  }
  window.backToList = backToList;

  /* === Auth === */
  async function registerUser(){
    const login = document.getElementById('regLogin').value.trim();
    const pass  = document.getElementById('regPass').value.trim();
    if(!login) return alert('Login kiriting');
    if(!pass)  return alert('Parol kiriting');
    try{
      await DB.registerUser(login, pass);
      document.getElementById('userLogin').value = login;
      document.getElementById('userPass').value = '';
      switchAuth('login');
      alert('Ro‚Äòyxatdan o‚Äòtildi! Endi login-parol bilan kiring.');
    }catch(e){
      if(e.message==='exists') alert('Bu login band. Boshqa login tanlang.');
      else alert('Xatolik: '+e.message);
    }
  }
  window.registerUser = registerUser;

  async function loginUser(){
    const login = document.getElementById('userLogin').value.trim();
    const pass  = document.getElementById('userPass').value.trim();
    if(!login || !pass) return alert('Login va parol kiriting');
    const u = await DB.findUser(login);
    if(!u) return alert('Bunday login topilmadi. Avval ro‚Äòyxatdan o‚Äòting.');
    if(u.passHash !== await sha256(pass)) return alert('Parol noto‚Äòg‚Äòri.');
    SESSION = { role:'user', login: u.login };
    document.getElementById('whoTag').textContent = u.login;
    // So'nggi loginni eslab qo'yamiz
    try{ localStorage.setItem('tm_last_login', u.login); }catch(e){}
    show('authCard',false); show('adminAuthCard',false); show('userCard',true);
    await renderTestsList();
  }
  window.loginUser = loginUser;

  async function loginAdmin(){
    const login = document.getElementById('adminLogin').value.trim();
    const code  = document.getElementById('adminCode').value.trim();
    if(login.toLowerCase()==='qwerty' && code==='2768'){
      SESSION = { role:'admin', login:'ADMIN' };
      show('authCard',false); show('adminAuthCard',false); show('adminCard',true);
      await renderAdminLists();
    } else alert('Admin login yoki kod xato');
  }
  window.loginAdmin = loginAdmin;

  /* === Admin: UI === */
  let TESTS_OPEN=false, USERS_OPEN=false, USERS_PAGE=1, USERS_PAGE_SIZE=20, USERS_QUERY='';
  function clearUsersSearch(){
    USERS_QUERY=''; const inp=document.getElementById('usersSearch'); if(inp) inp.value='';
    renderUsersPage();
  }
  window.clearUsersSearch = clearUsersSearch;

  async function renderAdminLists(){
    const tests = await DB.allTests();
    const users = await DB.allUsers();
    const testsCountEl = document.getElementById('testsCount');
    const usersCountEl = document.getElementById('usersCount');
    if(testsCountEl) testsCountEl.textContent = `${tests.length} ta`;
    if(usersCountEl) usersCountEl.textContent = `${users.length} ta`;

    const tBtn=document.getElementById('toggleTestsBtn');
    const uBtn=document.getElementById('toggleUsersBtn');
    if(tBtn && !tBtn._bound){
      tBtn._bound=true;
      tBtn.addEventListener('click', async ()=>{
        TESTS_OPEN=!TESTS_OPEN;
        tBtn.textContent = TESTS_OPEN?'Yopish':'Ko‚Äòrsatish';
        document.getElementById('testsChev').classList.toggle('open', TESTS_OPEN);
        show('adminTests', TESTS_OPEN);
        if(TESTS_OPEN) await drawTestsListForAdmin();
      });
    }
    if(uBtn && !uBtn._bound){
      uBtn._bound=true;
      uBtn.addEventListener('click', async ()=>{
        USERS_OPEN=!USERS_OPEN;
        uBtn.textContent = USERS_OPEN?'Yopish':'Ko‚Äòrsatish';
        document.getElementById('usersChev').classList.toggle('open', USERS_OPEN);
        show('usersBox', USERS_OPEN);
        if(USERS_OPEN){ USERS_PAGE=1; await renderUsersPage(); }
      });
    }

    if(TESTS_OPEN) await drawTestsListForAdmin();
    if(USERS_OPEN)  await renderUsersPage();

    const s = document.getElementById('usersSearch');
    if(s && !s._bound){
      s._bound=true;
      s.addEventListener('input', ()=>{
        USERS_QUERY = s.value.trim().toLowerCase();
        USERS_PAGE = 1;
        renderUsersPage();
      });
    }
  }
  window.renderAdminLists = renderAdminLists;

  async function drawTestsListForAdmin(){
    const tbox = document.getElementById('adminTests'); if(!tbox) return;
    const tests = await DB.allTests(); tbox.innerHTML='';
    if(!tests.length){ tbox.innerHTML = '<div class="muted">Testlar yo‚Äòq</div>'; return; }
    for(const t of tests){
      const res = await DB.getResults(t.code);
      const best = res.length ? Math.max(...res.map(r=>r.score)) : 0;
      const div = document.createElement('div'); div.className='card'; div.style.margin='6px 0';
      div.innerHTML = `
        <div class="flex">
          <strong>${t.name}</strong>
          <div class="space"></div>
          <span class="pill">kod: ${t.code} ‚Ä¢ ${t.count} savol</span>
        </div>
        <div class="flex" style="margin-top:8px">
          <button class="btn" onclick="viewResults('${t.code}')">Natijalar</button>
          <button class="btn" onclick="(async()=>{await DB.deleteTest('${t.code}'); await drawTestsListForAdmin();})();">O'chirish</button>
          <div class="space"></div><span class="tag">Eng yaxshi: ${best}/${t.count}</span>
        </div>`;
      tbox.appendChild(div);
    }
  }
  window.drawTestsListForAdmin = drawTestsListForAdmin;

  async function renderUsersPage(){
    const box = document.getElementById('adminUsers');
    if(!box) return;
    const list = await DB.allUsers();
    const filtered = USERS_QUERY ? list.filter(u=> (u.login||'').toLowerCase().includes(USERS_QUERY)) : list.slice();
    const total = filtered.length;
    const start = (USERS_PAGE-1)*USERS_PAGE_SIZE;
    const end = Math.min(start + USERS_PAGE_SIZE, total);
    const slice = filtered.slice(start, end);

    const usersCountEl = document.getElementById('usersCount');
    if(usersCountEl) usersCountEl.textContent = `${total} ta`;

    if(!slice.length){
      box.innerHTML = '<div class="muted" style="margin-top:8px">Natija topilmadi</div>';
      return;
    }

    let html = `
      <div class="flex" style="margin:8px 0">
        <span class="pill">Ko‚Äòrinmoqda: ${start+1}‚Äì${end} / ${total}</span>
        <div class="space"></div>
        <div class="flex" style="gap:6px">
          <button class="btn small" ${USERS_PAGE<=1?'disabled':''} onclick="USERS_PAGE=Math.max(1,USERS_PAGE-1);renderUsersPage()">‚¨ÖÔ∏è Oldingi</button>
          <button class="btn small" ${end>=total?'disabled':''} onclick="USERS_PAGE=Math.min(Math.ceil(${total}/USERS_PAGE_SIZE),USERS_PAGE+1);renderUsersPage()">Keyingi ‚û°Ô∏è</button>
        </div>
      </div>
      <table>
        <thead><tr><th>#</th><th>Login</th><th>Parol xeshi</th></tr></thead><tbody>
    `;
    slice.forEach((u,i)=>{
      html += `<tr>
        <td>${start + i + 1}</td>
        <td>${escapeHtml(u.login)}</td>
        <td>${(u.passHash||'‚Äî').slice(0,10)}‚Ä¶</td>
      </tr>`;
    });
    html += `</tbody></table>
      <div class="flex" style="margin:10px 0 2px">
        <div class="space"></div>
        <div class="flex" style="gap:6px">
          <button class="btn small" ${USERS_PAGE<=1?'disabled':''} onclick="USERS_PAGE=Math.max(1,USERS_PAGE-1);renderUsersPage()">‚¨ÖÔ∏è Oldingi</button>
          <button class="btn small" ${end>=total?'disabled':''} onclick="USERS_PAGE=Math.min(Math.ceil(${total}/USERS_PAGE_SIZE),USERS_PAGE+1);renderUsersPage()">Keyingi ‚û°Ô∏è</button>
        </div>
      </div>`;
    box.innerHTML = html;
  }
  window.renderUsersPage = renderUsersPage;

  /* === Test yaratish (UI) === */
  function buildAnswerGrid(){
    const count = parseInt(document.getElementById('tCount').value||'0');
    const grid = document.getElementById('answerGrid'); grid.innerHTML = '';
    for(let i=1;i<=count;i++){
      const row = document.createElement('div');
      row.style.margin = '6px 0';
      row.innerHTML = `<strong style="display:inline-block;width:28px">${i}.</strong>`;
      const pad = document.createElement('div'); pad.className='answer-pad';
      ['A','B','C','D'].forEach(ch=>{
        const b = document.createElement('button'); b.className='opt'; b.dataset.v=ch; b.textContent=ch;
        b.addEventListener('click', ()=>{
          for(const x of pad.children){ x.classList.remove('active-admin'); }
          b.classList.add('active-admin');
          row.dataset.answer = ch;
        });
        pad.appendChild(b);
      });
      row.appendChild(pad); grid.appendChild(row);
    }
  }
  window.buildAnswerGrid = buildAnswerGrid;

  async function saveTest(){
    const name = document.getElementById('tName').value.trim();
    const code = document.getElementById('tCode').value.trim();
    const count = parseInt(document.getElementById('tCount').value||'0');
    if(!name || !code || !count){ alert('Nomi, kod va savollar soni to\'ldirilsin'); return; }
    const rows = [...document.getElementById('answerGrid').querySelectorAll('div')];
    const qrows = rows.filter(d=>d.querySelector && d.querySelector('.answer-pad'));
    if(qrows.length !== count){ alert('Avval javob panellarini yarating'); return; }
    const key = qrows.map((r,i)=> r.dataset.answer || (alert((i+1)+'-savol uchun javob belgilansin'), null));
    if(key.some(x=>!x)) return;
    await DB.saveTest({ name, code, count, key });
    alert('Test saqlandi (bulut)');
    document.getElementById('tName').value=''; document.getElementById('tCode').value=''; document.getElementById('tCount').value=5; document.getElementById('answerGrid').innerHTML='';
    await renderAdminLists();
  }
  window.saveTest = saveTest;

  /* === User: test ro‚Äòyxati, o‚Äòynash === */
  async function renderTestsList(){
    const box = document.getElementById('testsList'); box.innerHTML='';
    const tests = await DB.allTests();
    if(!tests.length){ box.innerHTML = '<div class="muted">Testlar yo ªq</div>'; return; }
    for(const t of tests){
      const res   = await DB.getResults(t.code);
      const best  = res.length? Math.max(...res.map(r=>r.score)) : 0;
      const used  = await DB.getAttempts(t.code, SESSION.login);
      const mine  = await DB.bestOfUser(t.code, SESSION.login);
      const have  = !!mine;

      const card = document.createElement('div'); card.className='card'; card.style.margin='6px 0';
      card.innerHTML = `<div class="flex"><strong>${t.name}</strong><div class="space"></div><span class="pill">${t.count} savol</span></div>`;
      const controls = document.createElement('div'); controls.className='flex'; controls.style.marginTop='10px';
      if(used>=3){
        const tag=document.createElement('span'); tag.className='tag'; tag.textContent='Urinishlar: 3/3'; controls.appendChild(tag);
      }else{
        const btn = document.createElement('button'); btn.className='btn primary';
        btn.textContent = have ? 'Qayta ishlash' : 'Testni ishlash';
        btn.onclick=()=> startTest(t.code);
        controls.appendChild(btn);
        const left=document.createElement('span'); left.className='pill'; left.textContent = `Urinish: ${used}/3`;
        controls.appendChild(left);
      }
      const btnRes = document.createElement('button'); btnRes.className='btn'; btnRes.textContent='Natijalar'; btnRes.onclick=()=>viewResults(t.code); controls.appendChild(btnRes);
      const spacer = document.createElement('div'); spacer.className='space'; controls.appendChild(spacer);
      const tag2 = document.createElement('span'); tag2.className='tag'; tag2.textContent = `Eng: ${best}/${t.count}`; controls.appendChild(tag2);
      card.appendChild(controls); box.appendChild(card);
    }
  }
  window.renderTestsList = renderTestsList;

  let PLAY = { code:null, key:[], count:0, chosen:[] };

  async function startTest(code){
    if(!SESSION.login){ alert('Avval kirish qiling'); return; }
    const tests = await DB.allTests();
    const t = tests.find(x=>x.code===code);
    if(!t){ alert('Test topilmadi'); return; }
    const used = await DB.getAttempts(code, SESSION.login);
    if(used>=3){ alert('Bu testni 3 martadan ko‚Äòp ishlay olmaysiz.'); return; }

    PLAY = { code:code, key: t.key, count: t.count, chosen: new Array(t.count).fill(null) };
    document.getElementById('playTitle').textContent = `${t.name} ‚Äî ${t.count} savol`;
    renderPlay();
    show('userCard', false); show('playCard', true);
  }
  window.startTest = startTest;

  function renderPlay(){
    const body = document.getElementById('playBody'); body.innerHTML='';
    for(let i=0;i<PLAY.count;i++){
      const row = document.createElement('div'); row.className='card'; row.style.margin='6px 0';
      row.innerHTML = `<div class="flex"><strong>${i+1}.</strong><div class="space"></div><span class="pill">Variant tanlang</span></div>`;
      const pad = document.createElement('div'); pad.className='answer-pad';
      ['A','B','C','D'].forEach(ch=>{
        const b = document.createElement('button'); b.className='opt'; b.dataset.v=ch; b.textContent=ch;
        b.addEventListener('click', ()=>{
          for(const x of pad.children){ x.classList.remove('active-user'); }
          b.classList.add('active-user');
          PLAY.chosen[i]=ch;
        });
        pad.appendChild(b);
      });
      row.appendChild(pad); body.appendChild(row);
    }
  }
  window.renderPlay = renderPlay;

  async function finishTest(){
    if(!SESSION.login){ alert('Kirish talab qilinadi'); return; }
    if(PLAY.chosen.some(x=>x===null)){ if(!confirm('Ba ºzi savollar belgilanmagan. Baribir yakunlaysizmi?')) return; }

    const details=[]; let score=0;
    for(let i=0;i<PLAY.count;i++){
      const correct = PLAY.key[i]; const chosen = PLAY.chosen[i];
      const ok = chosen === correct; if(ok) score++;
      details.push({ q:i+1, chosen: chosen||'-', correct, ok });
    }
    // urinish +1
    await DB.incAttempt(PLAY.code, SESSION.login);
    // eng yaxshi natijani saqlash
    const rec = { login: SESSION.login, code: PLAY.code, score, total: PLAY.count, details, date: Date.now() };
    await DB.upsertBestResult(rec);

    await viewResults(PLAY.code, rec);
  }
  window.finishTest = finishTest;

  /* === Natijalar + TG === */
  let __lastTgText = '';
  function makeTgText(test, rec){
    const lines = [];
    lines.push(`üß™ Test: ${test.name}${test.code ? ' ('+test.code+')':''}`);
    lines.push(`üë§ Login: ${rec.login}`);
    lines.push(`üìä Natija: ${rec.score}/${rec.total}`);
    lines.push('---');
    rec.details.forEach(d=>{
      lines.push(`${d.q}) tanlandi: ${d.chosen} | to‚Äòg‚Äòri: ${d.correct} ${d.ok?'‚úÖ':'‚ùå'}`);
    });
    return lines.join('\n');
  }

  function renderDetail(rec){
    let html = '<div class="card" style="margin:0">';
    html += `<strong>${escapeHtml(rec.login)}</strong> ‚Äî <span class="tag">${rec.score}/${rec.total}</span>`;
    html += '<div style="margin-top:10px"><table><thead><tr><th>#</th><th>Tanlangan</th><th>To ªg ªri</th><th>Holat</th></tr></thead><tbody>';
    rec.details.forEach(d=> html += `<tr><td>${d.q}</td><td>${d.chosen}</td><td>${d.correct}</td><td>${d.ok?'<span style="color:#22c55e">to‚Äòg‚Äòri</span>':'<span style="color:#ef4444">xato</span>'}</td></tr>`);
    html += '</tbody></table></div></div>';
    return html;
  }

  async function viewResults(code, justMade=null){
    show('userCard', false); show('playCard', false); show('resultsCard', true);
    const tests = await DB.allTests(); const t = tests.find(x=>x.code===code); if(!t){ alert('Test topilmadi'); return; }
    document.getElementById('resTitle').textContent = `${t.name} ‚Äî Natijalar`;

    const arr = await DB.getResults(code);
    const lb = document.getElementById('leaderboardWrap'); lb.innerHTML='';
    if(!arr.length){ lb.innerHTML = '<div class="muted">Natijalar yo ªq</div>'; }
    else {
      let h = '<table><thead><tr><th>#</th><th>Login</th><th>Ball</th><th>Sana</th></tr></thead><tbody>';
      arr.forEach((r,i)=> h += `<tr><td>${i+1}</td><td>${escapeHtml(r.login)}</td><td><strong>${r.score}/${r.total}</strong></td><td>${new Date(r.date).toLocaleString()}</td></tr>`);
      h += '</tbody></table>'; lb.innerHTML = h;
    }

    const dw = document.getElementById('detailWrap');
    const mine = justMade || (SESSION.login ? await DB.bestOfUser(code, SESSION.login) : null);
    if(mine){
      dw.innerHTML = renderDetail(mine);
      __lastTgText = makeTgText(t, mine);
    } else {
      dw.innerHTML = '<div class="muted">Aynan bir urinishni ko‚Äòrish uchun testni yakunlang yoki o‚Äòz natijangiz yo‚Äòq.</div>';
      __lastTgText = '';
    }
  }
  window.viewResults = viewResults;

  /* === Telegramga nusxalash === */
  function copyTg(){
    if(!__lastTgText){
      alert('Avval o‚Äòzingizning natijangizni oching (yoki testni tugating).');
      return;
    }
    if(navigator.share){
      navigator.share({ text: __lastTgText }).catch(()=>fallbackClipboard());
    } else {
      fallbackClipboard();
    }
  }
  function fallbackClipboard(){
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(__lastTgText)
        .then(()=> alert('‚úÖ Matn nusxalandi! Endi Telegramga yuboring (yopishtiring).'))
        .catch(()=> prompt('Matnni qo‚Äòlda nusxalang (Ctrl+C):', __lastTgText));
    } else {
      prompt('Matnni qo‚Äòlda nusxalang (Ctrl+C):', __lastTgText);
    }
  }
  window.copyTg = copyTg;

  /* Demo filler */
  function fillDemo(){
    document.getElementById('userLogin').value='demo';
    document.getElementById('userPass').value='demo';
  }
  window.fillDemo = fillDemo;

  /* ===== Boot: so‚Äònggi loginni to‚Äòldirish ===== */
  (function boot(){
    try{
      const last = localStorage.getItem('tm_last_login');
      if(last){
        document.getElementById('userLogin').value = last;
        switchAuth('login');
      }
    }catch(e){}
  })();

  // Start holat
  logout();
</script>
</body>
</html>
