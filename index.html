<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BrandNomi — Firebase test (ro'yxat + tiklash)</title>
  <style>
    :root{--bg:#0b1220;--card:#0f172a;--text:#e2e8f0;--muted:#94a3b8;--primary:#38bdf8}
    body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial;margin:0;padding:18px}
    .card{background:var(--card);padding:16px;border-radius:10px;max-width:640px;margin:12px auto;border:1px solid rgba(255,255,255,0.04)}
    .field{margin-bottom:10px}
    input{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)}
    button{background:var(--primary);color:#022;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .hint{color:var(--muted);font-size:13px;margin-top:6px}
    .err{color:#fca5a5;margin-top:8px}
    .ok{color:#86efac;margin-top:8px}
    .row{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="card">
    <h2>BrandNomi — test (Ro'yxat + Kirish + Tiklash)</h2>
    <p class="hint">Firebase konfiguratsiyasini kiritib, Firestore yoqilganligini tekshiring.</p>

    <!-- auth panel (tabs) -->
    <div id="tabs" class="row" style="margin-bottom:12px">
      <button id="btnLogin">Kirish</button>
      <button id="btnReg">Ro'yxatdan o'tish</button>
      <button id="btnReset">Parol tiklash</button>
    </div>

    <!-- login -->
    <form id="formLogin" style="display:block" class="card" onsubmit="return false;">
      <div class="field"><label>Login</label><input id="login_username" placeholder="login (masalan: shahboz)" required></div>
      <div class="field"><label>Parol</label><input id="login_password" type="password" placeholder="parol" required></div>
      <div class="row"><button id="loginBtn">Kirish</button></div>
      <div id="loginMsg" class="err"></div>
    </form>

    <!-- register -->
    <form id="formReg" style="display:none" class="card" onsubmit="return false;">
      <div class="field"><label>F.I.SH</label><input id="reg_fullname" placeholder="to'liq ism" required></div>
      <div class="field"><label>Login</label><input id="reg_username" placeholder="login (unique, kichik harflar)" required></div>
      <div class="field"><label>Parol</label><input id="reg_password" type="password" placeholder="parol" required></div>
      <div class="row"><button id="regBtn">Ro'yxatdan o'tish</button></div>
      <div id="regMsg" class="err"></div>
    </form>

    <!-- reset -->
    <form id="formReset" style="display:none" class="card" onsubmit="return false;">
      <div class="field"><label>F.I.SH (parolni tiklash uchun)</label><input id="reset_fullname" placeholder="to'liq ism (F.I.SH)" required></div>
      <div class="field"><label>Yangi parol</label><input id="reset_newpass" type="password" placeholder="yangi parol" required></div>
      <div class="row"><button id="resetBtn">Tiklash</button></div>
      <div id="resetMsg" class="err"></div>
    </form>

    <div style="margin-top:12px">
      <p class="hint">Kodni ishlatishdan oldin konsolni (F12 → Console) oching — kerakli xabarlar/hatoliklar shu yerda chiqadi.</p>
    </div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <script>
  (async()=>{

  // ========== 1) BU YERNI O'ZGARTIRING: o'zingizning Firebase project configini qo'ying ==========
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT",
    // storageBucket, messagingSenderId, appId — agar bo'lsa kiriting
  };
  // ================================================================================================

  // init
  try {
    firebase.initializeApp(firebaseConfig);
    console.log('Firebase initialized');
  } catch(err){
    console.error('Firebase init error', err);
    alert('Firebase initialize bo‘lmadi. Konfiguratsiyani tekshiring va Console’da xatoni ko‘ring.');
    return;
  }

  const db = firebase.firestore();

  // check connection — oddiy test: Firestorega so'rov yuborib ko'ramiz
  try {
    await db.collection('_test').doc('_ping').set({ts: Date.now()});
    console.log('Firestore write OK');
  } catch(e){
    console.error('Firestore write failed — check rules and network', e);
    alert('Firestore bilan ulanishda muammo. Console’ni tekshiring.');
    // continue — foydali xatolik xabari konsolda bor
  }

  // helper funksiyalar
  async function hashString(s){ const d=new TextEncoder().encode(s); const h=await crypto.subtle.digest('SHA-256',d); return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
  function normalize(s){ return (s||'').trim().toLowerCase(); }
  function initialsFrom(n){ const p=(n||'').trim().toUpperCase().split(/\s+/).filter(Boolean); if(p.length===0) return '??'; if(p.length===1) return p[0].slice(0,2); return (p[0][0]||'')+(p[1][0]||''); }
  function pastelFromSeed(s){ let h=0; for(let i=0;i<s.length;i++){ h=(h*31 + s.charCodeAt(i))>>>0 } return `hsl(${h%360} 70% 70%)` }

  // UI elements
  const $ = id => document.getElementById(id);
  const formLogin = $('formLogin'), formReg = $('formReg'), formReset = $('formReset');
  const btnLoginTab = $('btnLogin'), btnRegTab = $('btnReg'), btnResetTab = $('btnReset');

  btnLoginTab.onclick = ()=>{ formLogin.style.display='block'; formReg.style.display='none'; formReset.style.display='none'; $('loginMsg').textContent=''; }
  btnRegTab.onclick   = ()=>{ formLogin.style.display='none'; formReg.style.display='block'; formReset.style.display='none'; $('regMsg').textContent=''; }
  btnResetTab.onclick = ()=>{ formLogin.style.display='none'; formReg.style.display='none'; formReset.style.display='block'; $('resetMsg').textContent=''; }

  // Firestore ref helpers
  const userRef = username => db.collection('users').doc(username);

  // ========== Registration ==========
  $('regBtn').onclick = async (ev)=>{
    ev.preventDefault();
    $('regMsg').textContent = '';
    const fullname = normalize($('reg_fullname').value);
    const username = normalize($('reg_username').value);
    const password = $('reg_password').value;
    if(!fullname || !username || !password){ $('regMsg').textContent='Barcha maydonlar to‘ldirilsin.'; return; }
    try{
      console.log('Reg: checking exist', username);
      const snap = await userRef(username).get();
      if(snap.exists){ $('regMsg').textContent='Bu login allaqachon mavjud.'; return; }
      const hashed = await hashString(password);
      const doc = {
        username,
        fullname,
        fullnameLower: fullname,
        passwordHash: hashed,
        avatarColor: pastelFromSeed(username),
        createdAt: Date.now(),
        lastLoginAt: null
      };
      await userRef(username).set(doc);
      console.log('Reg: user created', username);
      $('regMsg').className = 'ok'; $('regMsg').textContent = 'Ro‘yxatdan o‘tish muvaffaqiyatli. Kirishingiz mumkin.';
      // clear form
      $('reg_fullname').value=''; $('reg_username').value=''; $('reg_password').value='';
      // go to login tab
      setTimeout(()=>{ btnLoginTab.click(); }, 900);
    }catch(err){
      console.error('Registration error', err);
      $('regMsg').className='err'; $('regMsg').textContent = 'Ro‘yxatdan o‘tishda xato. Console’ga qarang.';
    }
  };

  // ========== Login ==========
  $('loginBtn').onclick = async (ev)=>{
    ev.preventDefault();
    $('loginMsg').textContent = '';
    const username = normalize($('login_username').value);
    const password = $('login_password').value;
    if(!username || !password){ $('loginMsg').textContent='Login va parol kiriting.'; return; }
    try{
      const snap = await userRef(username).get();
      if(!snap.exists){ $('loginMsg').textContent='Login topilmadi (yoki noto‘g‘ri).'; return; }
      const data = snap.data();
      const hashed = await hashString(password);
      if(data.passwordHash !== hashed){ $('loginMsg').textContent='Parol xato.'; return; }
      // muvaffaqiyatli kirish — yangilash
      await userRef(username).update({ lastLoginAt: Date.now() });
      // session (sahifa sessiyasi)
      sessionStorage.setItem('bn_current', username);
      $('loginMsg').className='ok'; $('loginMsg').textContent='Kirish muvaffaqiyatli!';
      console.log('Login success', username);
      // show simple profile area (yoki qayta render qiling)
      setTimeout(()=>{ window.location.reload(); }, 600);
    }catch(err){
      console.error('Login error', err);
      $('loginMsg').textContent='Kirishda texnik xato. Console’ni tekshiring.';
    }
  };

  // ========== Password reset via F.I.SH ==========
  $('resetBtn').onclick = async (ev)=>{
    ev.preventDefault();
    $('resetMsg').textContent = '';
    const fullname = normalize($('reset_fullname').value);
    const newp = $('reset_newpass').value;
    if(!fullname || !newp){ $('resetMsg').textContent='F.I.SH va yangi parol kerak.'; return; }
    try{
      const q = await db.collection('users').where('fullnameLower','==',fullname).limit(1).get();
      if(q.empty){ $('resetMsg').textContent='Bunday ismli foydalanuvchi topilmadi.'; return; }
      const doc = q.docs[0];
      const username = doc.id;
      const hashed = await hashString(newp);
      await userRef(username).update({ passwordHash: hashed });
      $('resetMsg').className='ok'; $('resetMsg').textContent = `Parol tiklandi! Sizning login: @${username}`;
      console.log('Password reset for', username);
      // avtomatik login oynasiga qaytish
      setTimeout(()=>{ btnLoginTab.click(); }, 1200);
    }catch(err){
      console.error('Reset error', err);
      $('resetMsg').textContent = 'Tiklashda xatolik. Console’ni tekshiring.';
    }
  };

  // ========== Remind login (F.I.SH orqali) ==========
  $('remindLoginBtn').onclick = async ()=>{
    $('resetMsg').textContent=''; const fullname = normalize($('reset_fullname').value);
    if(!fullname){ $('resetMsg').textContent='Avval F.I.SH kiriting.'; return; }
    try{
      const q = await db.collection('users').where('fullnameLower','==',fullname).get();
      if(q.empty){ $('resetMsg').textContent='Topilmadi.'; return; }
      const list = q.docs.map(d=>'@'+d.id).join(', ');
      $('resetMsg').className='ok'; $('resetMsg').textContent = (q.size===1)? `Sizning login: ${list}` : `Mos loginlar: ${list}`;
    }catch(e){ console.error(e); $('resetMsg').textContent='Xato. Console ko‘rilsin.'; }
  };

  // ========== Simple page render: if session exist show welcome ==========
  function showWelcome(){
    const cur = sessionStorage.getItem('bn_current');
    if(!cur) return;
    // fetch user and show small alert
    userRef(cur).get().then(snap=>{
      if(!snap.exists) { sessionStorage.removeItem('bn_current'); return; }
      const d = snap.data();
      alert(`Siz tizimga kirdingiz: @${d.username}\nOxirgi kirish: ${d.lastLoginAt? new Date(d.lastLoginAt).toLocaleString() : '—'}`);
      // clear session if you want auto-logout on refresh: sessionStorage.removeItem('bn_current');
    }).catch(e=>console.error('Render welcome error',e));
  }

  // call showWelcome on load
  showWelcome();

  // end async IIFE
  })();
  </script>
</body>
</html>
