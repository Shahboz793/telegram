<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Telegram WebApp Video Player</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      color-scheme: dark;
      --bg:#0b0c10;
      --card:rgba(255,255,255,.07);
      --stroke:rgba(255,255,255,.12);
      --muted:rgba(255,255,255,.72);
      --accent1:#ff3b3b;
      --accent2:#ff7a18;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1000px 700px at 20% -10%, rgba(255,59,59,.18), transparent 55%),
                  radial-gradient(900px 650px at 90% 10%, rgba(255,122,24,.14), transparent 60%),
                  var(--bg);
      color:#fff;
    }
    .app{max-width:860px;margin:0 auto;padding:14px 14px 90px}
    .top{
      position:sticky;top:10px;z-index:10;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px;border-radius:16px;
      background:rgba(0,0,0,.35);
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand .t{font-weight:900}
    .brand .s{font-size:12px;color:var(--muted)}
    .pill{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      font-size:12px;color:var(--muted);white-space:nowrap;
      max-width: 50%;
      overflow:hidden;text-overflow:ellipsis;
    }

    .tabs{
      margin-top:12px;
      display:flex;gap:10px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      padding:10px;border-radius:16px;
    }
    .tab{
      flex:1;
      padding:12px 10px;border-radius:14px;
      border:1px solid transparent;
      background:rgba(255,255,255,.06);
      color:#fff;
      font-weight:900;
      cursor:pointer;
    }
    .tab.active{
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      border-color: rgba(255,255,255,.18);
    }

    .card{
      margin-top:12px;
      padding:12px;border-radius:16px;
      border:1px solid var(--stroke);
      background:var(--card);
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .input{
      width:100%;
      padding:12px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.28);
      color:#fff;outline:none;
    }
    .btn{
      padding:12px 14px;border-radius:14px;border:0;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color:#fff;font-weight:900;cursor:pointer;
      white-space:nowrap;
    }
    .btn.ghost{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      font-weight:800;
    }
    .btn.danger{
      background: rgba(255,59,59,.18);
      border: 1px solid rgba(255,59,59,.35);
      font-weight:900;
    }
    .muted{color:var(--muted);font-size:13px;line-height:1.5}
    .sep{height:1px;background:rgba(255,255,255,.10);margin:12px 0}

    .list{display:grid;gap:10px;margin-top:12px}
    .item{
      display:flex;gap:12px;align-items:flex-start;justify-content:space-between;
      padding:12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
    }
    .left{min-width:0}
    .name{font-weight:900;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:55vw}
    .url{color:var(--muted);font-size:12px;word-break:break-all;margin-top:6px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    /* PLAYER OVERLAY */
    body.player-on{overflow:hidden}
    #player{
      position:fixed;inset:0;z-index:99999;
      background:#000;
      display:none;
    }
    body.player-on #player{display:block}
    #pHeader{
      position:fixed;top:10px;left:10px;right:10px;z-index:100000;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:10px;border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    #pTitle{font-weight:900;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0}
    #pBody{position:absolute;inset:0; padding-top:64px;}
    #pBody iframe, #pBody video{
      width:100%;height:100%;border:0;background:#000;
    }
    .mini{
      font-size:12px;color:var(--muted);
      padding:8px 10px;border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="top">
      <div class="brand">
        <div class="t">Video WebApp</div>
        <div class="s" id="statusLine">Telegram WebApp orqali oching</div>
      </div>
      <div class="pill" id="userPill">User: —</div>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabView">Ko‘rish</button>
      <button class="tab" id="tabAdd">Qo‘shish</button>
    </div>

    <!-- VIEW -->
    <div id="viewPanel">
      <div class="card">
        <div class="row">
          <input class="input" id="search" placeholder="Qidirish (nom bo‘yicha)..." />
          <button class="btn ghost" id="exportBtn" type="button">Export</button>
          <button class="btn ghost" id="importBtn" type="button">Import</button>
        </div>
        <div class="sep"></div>
        <div class="muted">
          YouTube link (watch/youtu.be/shorts) qo‘shing. “Play” bosilganda WebApp ichida player ochiladi.
          Fullscreen/landscape bloklansa, “YouTube’da ochish” tugmasi orqali tashqarida oching.
        </div>
      </div>

      <div class="list" id="list"></div>
    </div>

    <!-- ADD -->
    <div id="addPanel" style="display:none">
      <div class="card">
        <div class="row">
          <input class="input" id="titleInput" placeholder="Video nomi (masalan: 1-dars)" />
        </div>
        <div class="row" style="margin-top:10px">
          <input class="input" id="urlInput" placeholder="YouTube link (https://youtu.be/... yoki https://www.youtube.com/watch?v=...)" />
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="saveBtn" type="button">Saqlash</button>
          <button class="btn danger" id="clearBtn" type="button">Tozalash</button>
          <span class="mini" id="hintMini">Saqlash localStorage’da</span>
        </div>
      </div>
    </div>
  </div>

  <!-- PLAYER OVERLAY -->
  <div id="player">
    <div id="pHeader">
      <button class="btn ghost" id="pBack" type="button">← Orqaga</button>
      <div id="pTitle">—</div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn ghost" id="pLand" type="button">Landscape</button>
        <button class="btn ghost" id="pFull" type="button">Fullscreen</button>
        <button class="btn" id="pOpen" type="button">YouTube’da ochish</button>
      </div>
    </div>
    <div id="pBody"></div>
  </div>

  <script>
    /* =====================
       Telegram init
    ====================== */
    const tg = window.Telegram?.WebApp;
    try {
      tg?.ready?.();
      tg?.expand?.();
      tg?.disableVerticalSwipes?.();
      tg?.setHeaderColor?.("#000000");
      tg?.setBackgroundColor?.("#000000");
      tg?.setBottomBarColor?.("#000000");
    } catch (e) {}

    const userPill = document.getElementById("userPill");
    const statusLine = document.getElementById("statusLine");

    const user = tg?.initDataUnsafe?.user || null;
    if (user) {
      const name = [user.first_name, user.last_name].filter(Boolean).join(" ");
      userPill.textContent = `User: ${name || "—"} (${user.id})`;
      statusLine.textContent = "WebApp ulandi";
    } else {
      userPill.textContent = "User: aniqlanmadi";
      statusLine.textContent = "Eslatma: Botdan WebApp qilib oching";
    }

    /* =====================
       Storage
    ====================== */
    const KEY = "yt_webapp_videos_v1";

    function loadItems() {
      try {
        const raw = localStorage.getItem(KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }
    function saveItems(arr) {
      localStorage.setItem(KEY, JSON.stringify(arr));
    }
    function makeId() {
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    let items = loadItems();
    if (!items.length) {
      items = [{
        id: makeId(),
        title: "Namuna video",
        url: "https://youtu.be/dQw4w9WgXcQ",
        createdAt: Date.now()
      }];
      saveItems(items);
    }

    /* =====================
       Tabs
    ====================== */
    const tabView = document.getElementById("tabView");
    const tabAdd  = document.getElementById("tabAdd");
    const viewPanel = document.getElementById("viewPanel");
    const addPanel  = document.getElementById("addPanel");

    function setTab(which) {
      const isView = which === "view";
      tabView.classList.toggle("active", isView);
      tabAdd.classList.toggle("active", !isView);
      viewPanel.style.display = isView ? "" : "none";
      addPanel.style.display  = isView ? "none" : "";
    }
    tabView.onclick = () => setTab("view");
    tabAdd.onclick  = () => setTab("add");

    /* =====================
       Helpers (YouTube)
    ====================== */
    function normalizeUrl(u) {
      u = (u || "").trim();
      if (!u) return "";
      if (/^youtu\.be\//i.test(u)) u = "https://" + u;
      if (/^www\.youtube\.com\//i.test(u)) u = "https://" + u;
      if (/^youtube\.com\//i.test(u)) u = "https://" + u;
      return u;
    }

    function toEmbed(url) {
      try {
        const u = new URL(url);
        const host = u.hostname.replace(/^www\./, "");
        // youtu.be/ID
        if (host === "youtu.be") {
          const id = u.pathname.replace("/", "");
          if (!id) return "";
          return `https://www.youtube.com/embed/${id}?autoplay=1&rel=0&modestbranding=1&playsinline=1`;
        }
        // youtube.com/watch?v=ID
        if (host === "youtube.com" || host === "m.youtube.com") {
          const id = u.searchParams.get("v");
          if (id) return `https://www.youtube.com/embed/${id}?autoplay=1&rel=0&modestbranding=1&playsinline=1`;
          // /shorts/ID
          const m = u.pathname.match(/\/shorts\/([^\/]+)/i);
          if (m) return `https://www.youtube.com/embed/${m[1]}?autoplay=1&rel=0&modestbranding=1&playsinline=1`;
        }
      } catch {}
      return "";
    }

    /* =====================
       Render list
    ====================== */
    const listEl = document.getElementById("list");
    const searchEl = document.getElementById("search");

    function esc(s) {
      return String(s||"")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function render() {
      const q = (searchEl.value || "").trim().toLowerCase();
      const filtered = items
        .slice()
        .sort((a,b)=> (b.createdAt||0)-(a.createdAt||0))
        .filter(x => !q || (x.title||"").toLowerCase().includes(q));

      if (!filtered.length) {
        listEl.innerHTML = `<div class="card"><div class="muted">Hali video yo‘q. “Qo‘shish”dan kiriting.</div></div>`;
        return;
      }

      listEl.innerHTML = filtered.map(it => `
        <div class="item" data-id="${it.id}">
          <div class="left">
            <div class="name">${esc(it.title || "Nomsiz")}</div>
            <div class="url">${esc(it.url)}</div>
          </div>
          <div class="actions">
            <button class="btn" data-act="play">Play</button>
            <button class="btn ghost" data-act="edit">Tahrir</button>
            <button class="btn danger" data-act="del">O‘chirish</button>
          </div>
        </div>
      `).join("");
    }

    searchEl.oninput = render;

    listEl.addEventListener("click", (e) => {
      const card = e.target.closest(".item");
      if (!card) return;
      const id = card.getAttribute("data-id");
      const it = items.find(x => x.id === id);
      if (!it) return;

      const act = e.target.getAttribute("data-act");
      if (act === "play") openPlayer(it);
      if (act === "edit") editItem(it);
      if (act === "del") delItem(it);
    });

    /* =====================
       Add / edit / delete
    ====================== */
    const titleInput = document.getElementById("titleInput");
    const urlInput   = document.getElementById("urlInput");
    const saveBtn    = document.getElementById("saveBtn");
    const clearBtn   = document.getElementById("clearBtn");

    function resetForm() {
      titleInput.value = "";
      urlInput.value = "";
    }

    saveBtn.onclick = () => {
      const title = (titleInput.value || "").trim();
      const url = normalizeUrl(urlInput.value || "");
      if (!title) { alert("Video nomini kiriting."); return; }
      if (!url) { alert("YouTube link kiriting."); return; }
      if (!toEmbed(url)) { alert("YouTube link noto‘g‘ri (watch/youtu.be/shorts format bo‘lsin)."); return; }

      items.push({ id: makeId(), title, url, createdAt: Date.now() });
      saveItems(items);
      resetForm();
      setTab("view");
      render();
    };

    clearBtn.onclick = resetForm;

    function editItem(it) {
      const t = prompt("Yangi nom:", it.title || "");
      if (t === null) return;
      const u = prompt("Yangi YouTube link:", it.url || "");
      if (u === null) return;

      const nu = normalizeUrl(u);
      if (!toEmbed(nu)) { alert("YouTube link noto‘g‘ri."); return; }

      it.title = (t || "").trim() || it.title;
      it.url = nu;
      saveItems(items);
      render();
    }

    function delItem(it) {
      if (!confirm(`O‘chirish: "${it.title}" ?`)) return;
      items = items.filter(x => x.id !== it.id);
      saveItems(items);
      render();
    }

    /* =====================
       Export / Import
    ====================== */
    document.getElementById("exportBtn").onclick = async () => {
      const data = JSON.stringify(items, null, 2);
      try {
        await navigator.clipboard.writeText(data);
        alert("Export clipboardga nusxa olindi.");
      } catch {
        prompt("Quyidagini nusxa oling:", data);
      }
    };

    document.getElementById("importBtn").onclick = () => {
      const raw = prompt("JSON ni paste qiling:");
      if (!raw) return;
      try {
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) throw new Error("not array");
        const cleaned = arr.map(x => ({
          id: String(x.id || makeId()),
          title: String(x.title || "Nomsiz"),
          url: normalizeUrl(String(x.url || "")),
          createdAt: Number(x.createdAt || Date.now())
        })).filter(x => x.url && toEmbed(x.url));
        items = cleaned;
        saveItems(items);
        render();
        alert("Import bo‘ldi.");
      } catch {
        alert("JSON xato yoki linklar yaroqsiz.");
      }
    };

    /* =====================
       Player (Fullscreen + Landscape)
    ====================== */
    const player = document.getElementById("player");
    const pBody  = document.getElementById("pBody");
    const pTitle = document.getElementById("pTitle");
    const pBack  = document.getElementById("pBack");
    const pOpen  = document.getElementById("pOpen");
    const pFull  = document.getElementById("pFull");
    const pLand  = document.getElementById("pLand");

    let currentUrl = "";

    function showBackButton(on) {
      try {
        if (!tg?.BackButton) return;
        if (on) {
          tg.BackButton.show();
          tg.BackButton.onClick(closePlayer);
        } else {
          tg.BackButton.hide();
        }
      } catch {}
    }

    async function requestAppFullscreen() {
      // 1) Telegram fullscreen (agar mavjud bo‘lsa)
      try { await tg?.requestFullscreen?.(); } catch {}

      // 2) Browser fullscreen (ko‘p WebView’da shu yordam beradi)
      try {
        const el = document.documentElement;
        if (!document.fullscreenElement && el.requestFullscreen) {
          await el.requestFullscreen();
        }
      } catch {}
    }

    async function exitAppFullscreen() {
      try { await tg?.exitFullscreen?.(); } catch {}
      try {
        if (document.fullscreenElement && document.exitFullscreen) {
          await document.exitFullscreen();
        }
      } catch {}
    }

    async function lockLandscape() {
      // Landscape lock faqat ayrim qurilma/brauzerda ishlaydi va ko‘pincha fullscreen talab qiladi.
      try {
        if (screen.orientation && screen.orientation.lock) {
          await screen.orientation.lock("landscape");
          return true;
        }
      } catch {}
      return false;
    }

    async function unlockOrientation() {
      try {
        if (screen.orientation && screen.orientation.unlock) screen.orientation.unlock();
      } catch {}
    }

    function openPlayer(it) {
      const embed = toEmbed(it.url);
      if (!embed) {
        alert("YouTube link noto‘g‘ri.");
        return;
      }

      currentUrl = it.url;
      pTitle.textContent = it.title || "—";

      // Player overlay
      document.body.classList.add("player-on");
      pBody.innerHTML = `
        <iframe
          id="ytFrame"
          src="${esc(embed)}"
          allow="autoplay; encrypted-media; fullscreen; picture-in-picture"
          allowfullscreen
          referrerpolicy="origin"
        ></iframe>
      `;

      // Telegram BackButton
      showBackButton(true);

      // History (back)
      history.pushState({ player: true }, "");
    }

    async function closePlayer() {
      pBody.innerHTML = "";
      document.body.classList.remove("player-on");
      showBackButton(false);
      currentUrl = "";
      await unlockOrientation();
      await exitAppFullscreen();
    }

    pBack.onclick = closePlayer;

    // “YouTube’da ochish” (fallback, full native)
    pOpen.onclick = () => {
      if (!currentUrl) return;
      try {
        // Telegram ichida tashqi brauzer/app’da ochish
        tg?.openLink?.(currentUrl, { try_instant_view: false });
      } catch {
        window.open(currentUrl, "_blank");
      }
    };

    // Bizning Fullscreen tugma (YouTube tugmasi ishlamasa ham)
    pFull.onclick = async () => {
      await requestAppFullscreen();
    };

    // Landscape tugma (muvaffaqiyatsiz bo‘lsa ogohlantiradi)
    pLand.onclick = async () => {
      // Landscape lock ko‘p joyda fullscreen talab qiladi
      await requestAppFullscreen();
      const ok = await lockLandscape();
      if (!ok) alert("Landscape lock qurilmangizda bloklangan bo‘lishi mumkin. Fullscreen + “YouTube’da ochish”ni sinang.");
    };

    // Back button via browser history
    window.addEventListener("popstate", () => {
      if (document.body.classList.contains("player-on")) closePlayer();
    });

    /* =====================
       First render
    ====================== */
    render();
  </script>
</body>
</html>
