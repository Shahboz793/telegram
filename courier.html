<!doctype html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <title>ğŸšš Kuryer paneli â€” Premium FastFood</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>

<body class="courier-body">
  <!-- HEADER -->
  <header class="courier-header">
    <div class="courier-header-left">
      <div class="courier-logo">ğŸ”</div>
      <div class="courier-header-text">
        <div class="courier-title">Premium FastFood â€” Kuryer</div>
        <div class="courier-subtitle">Buyurtmalarni tez va aniq yetkazish</div>
      </div>
    </div>
    <div class="courier-header-right">

      <!-- ONLINE / OFFLINE SWITCH -->
      <button id="courierStatusBtn" class="btn-chip btn-chip-green">
        ğŸŸ¢ Onlayn
      </button>

      <button
        type="button"
        class="btn-chip"
        onclick="location.href='index.html'">
        â¬… Menyuga qaytish
      </button>

      <button
        type="button"
        class="btn-chip btn-chip-danger"
        id="courierLogoutBtn">
        Chiqish
      </button>
    </div>
  </header>

  <main class="courier-main">
    <!-- LOGIN -->
    <section id="courierLoginSection" class="courier-login-section">
      <article class="courier-card courier-login-card">

        <h2 class="section-title-sm">ğŸšš Kuryer uchun kirish</h2>
        <p class="section-sub-sm">
          Admin bergan login va parolni kiriting.
        </p>

        <div class="form-grid">
          <label>
            Login
            <input id="courierLoginInput" type="text" placeholder="Masalan: sherzod" />
          </label>
          <label>
            Parol
            <input id="courierPassInput" type="password" placeholder="Masalan: 2768" />
          </label>
        </div>

        <button type="button" class="btn-primary btn-full" id="courierLoginBtn">
          Kirish
        </button>

      </article>
    </section>

    <!-- MAIN APP -->
    <section id="courierAppSection" class="courier-app-section hidden">

      <article class="courier-card">
        <div class="courier-top-panel">
          <!-- KURYER MA'LUMOTI -->
          <div class="courier-info-card">
            <div class="courier-info-main">
              <div class="courier-avatar">ğŸšš</div>
              <div>
                <div class="courier-name" id="courierNameText"></div>
                <div class="courier-meta" id="courierCarText"></div>
                <div class="courier-meta" id="courierPhoneText"></div>
              </div>
            </div>
            <div class="courier-badge-row">
              <span class="courier-badge" id="statusText">ğŸŸ¢ Onlayn</span>
            </div>
          </div>

          <!-- STATISTIKA -->
          <div class="courier-stats-row">
            <div class="courier-stat-card">
              <div class="stat-label">Bugun yetkazilgan</div>
              <div class="stat-value" id="statTodayCount">0</div>
              <div class="stat-sub">ta buyurtma</div>
            </div>
            <div class="courier-stat-card">
              <div class="stat-label">Bugun umumiy summa</div>
              <div class="stat-value" id="statTodaySum">0</div>
              <div class="stat-sub">soâ€˜m</div>
            </div>
          </div>

          <!-- TABS -->
          <div class="courier-tabs">
            <button class="courier-tab-btn active" data-tab="available">ğŸ†• Yangi zakazlar</button>
            <button class="courier-tab-btn" data-tab="my">ğŸ“¦ Mening zakazlarim</button>
            <button class="courier-tab-btn" data-tab="done">âœ… Yetkazilganlar</button>
          </div>

        </div>
      </article>

      <!-- YANGI ZAKAZLAR -->
      <section id="courierTabAvailable" class="courier-tab-page">
        <h3 class="section-title-sm">ğŸ†• Yangi zakazlar</h3>
        <div id="courierAvailableList" class="courier-orders-list"></div>
      </section>

      <!-- MENING ZAKAZLARIM -->
      <section id="courierTabMy" class="courier-tab-page hidden">
        <h3 class="section-title-sm">ğŸ“¦ Mening zakazlarim</h3>
        <div id="courierMyList" class="courier-orders-list"></div>
      </section>

      <!-- YETKAZILGAN -->
      <section id="courierTabDone" class="courier-tab-page hidden">
        <h3 class="section-title-sm">âœ… Yetkazilganlar</h3>
        <div id="courierDoneList" class="courier-orders-list"></div>
      </section>

    </section>
  </main>

  <!-- TOAST / SOUND -->
  <div id="courierToast" class="toast"></div>
  <audio id="courierNotify" src="ding.mp3" preload="auto"></audio>

  <!-- JS -->
  <script type="module">

    /* FIREBASE */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, onSnapshot,
      query, orderBy, updateDoc, doc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDVidcgjpUxkg88bxXfIFzmsFydv0rMMao",
      authDomain: "shahboz-5d0a3.firebaseapp.com",
      projectId: "shahboz-5d0a3",
      storageBucket: "shahboz-5d0a3.firebasestorage.app",
      messagingSenderId: "352024095535",
      appId: "1:352024095535:web:3f495ac74cdd40f5c54fda"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const ordersCol = collection(db, "orders");
    const couriersCol = collection(db, "couriers");

    /* DOM */
    const loginSection = document.getElementById("courierLoginSection");
    const appSection   = document.getElementById("courierAppSection");

    const loginInput = document.getElementById("courierLoginInput");
    const passInput  = document.getElementById("courierPassInput");
    const loginBtn   = document.getElementById("courierLoginBtn");
    const logoutBtn  = document.getElementById("courierLogoutBtn");

    const courierNameText  = document.getElementById("courierNameText");
    const courierCarText   = document.getElementById("courierCarText");
    const courierPhoneText = document.getElementById("courierPhoneText");

    const statusBtn = document.getElementById("courierStatusBtn");
    const statusText = document.getElementById("statusText");

    const listAvailable = document.getElementById("courierAvailableList");
    const listMy        = document.getElementById("courierMyList");
    const listDone      = document.getElementById("courierDoneList");

    const toastEl = document.getElementById("courierToast");
    const notifySoundEl = document.getElementById("courierNotify");

    /* STATE */
    let currentCourier = null;
    let courierList = [];
    let orders = [];
    let unsub = null;
    let online = true;

    /* TOOLS */
    function showToast(t){
      toastEl.textContent = t;
      toastEl.classList.add("show");
      setTimeout(()=> toastEl.classList.remove("show"), 2000);
    }

    function playNotify(){
      notifySoundEl.currentTime = 0;
      notifySoundEl.play().catch(()=>{});
    }

    /* LOAD COURIERS FROM FIRESTORE */
    async function loadCouriers(){
      const snap = await getDocs(couriersCol);
      courierList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    /* LOGIN */
    loginBtn.onclick = async () => {
      await loadCouriers();
      const login = loginInput.value.trim().toLowerCase();
      const pass  = passInput.value.trim();

      const c = courierList.find(x =>
        x.login.toLowerCase() === login &&
        x.password === pass
      );

      if(!c){
        showToast("âŒ Login yoki parol notoâ€˜gâ€˜ri");
        return;
      }

      currentCourier = c;

      courierNameText.textContent = c.name;
      courierCarText.textContent  = "ğŸš— " + c.car;
      courierPhoneText.textContent = "ğŸ“ " + c.phone;

      loginSection.classList.add("hidden");
      appSection.classList.remove("hidden");

      subscribeOrders();
      showToast("âœ… Kuryer sifatida kirdingiz");
    };

    /* ONLINE / OFFLINE */
    statusBtn.onclick = () => {
      online = !online;
      if(online){
        statusBtn.textContent = "ğŸŸ¢ Onlayn";
        statusBtn.classList.remove("btn-chip-red");
        statusBtn.classList.add("btn-chip-green");
        statusText.textContent = "ğŸŸ¢ Onlayn";
      } else {
        statusBtn.textContent = "ğŸ”´ Offline";
        statusBtn.classList.remove("btn-chip-green");
        statusBtn.classList.add("btn-chip-red");
        statusText.textContent = "ğŸ”´ Offline";
      }
    };

    /* FIRESTORE LISTENER */
    function subscribeOrders(){
      if(unsub) unsub();

      const q = query(ordersCol, orderBy("createdAt","desc"));
      unsub = onSnapshot(q, snap => {
        orders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderLists();
      });
    }

    /* RENDER LISTS */
    function renderLists(){

      const avail = orders.filter(o =>
        o.status === "courier" &&
        !o.courierLogin
      );

      const myOrders = orders.filter(o =>
        o.status === "courier" &&
        o.courierLogin === currentCourier.login
      );

      const done = orders.filter(o =>
        o.status === "delivered" &&
        o.courierLogin === currentCourier.login
      );

      listAvailable.innerHTML =
        avail.map(o => renderOrder(o, "available")).join("");

      listMy.innerHTML =
        myOrders.map(o => renderOrder(o, "my")).join("");

      listDone.innerHTML =
        done.map(o => renderOrder(o, "done")).join("");
    }

    /* RENDER ORDER CARD */
    function renderOrder(o, type){

      const items = (o.items || [])
        .map(i => `<li>${i.name} â€” ${i.qty} Ã— ${i.price} soâ€˜m</li>`)
        .join("");

      let btns = "";

      if(type === "available" && online){
        btns = `
          <button class="btn-xs btn-xs-primary"
            onclick="takeOrder('${o.id}')">Qabul qilish</button>`;
      }

      if(type === "my"){
        btns = `
          <button class="btn-xs btn-xs-primary"
            onclick="markDelivered('${o.id}')">Yetkazdim</button>`;
      }

      return `
        <article class="order-card">
          <header class="order-header">
            <div>
              <div>ID: ${o.id.slice(0,8)}...</div>
              <div>${o.customer?.name} â€¢ ${o.customer?.phone}</div>
              <div>${o.customer?.address}</div>
            </div>
            <div class="order-total">${o.totalPrice} soâ€˜m</div>
          </header>

          <ul>${items}</ul>

          <footer class="courier-card-footer">${btns}</footer>
        </article>`;
    }

    /* GLOBAL FUNCTIONS */
    window.takeOrder = async (id) => {
      await updateDoc(doc(db,"orders",id),{
        status:"courier",
        courierLogin: currentCourier.login,
        courierName: currentCourier.name,
        courierCar: currentCourier.car,
        courierPhone: currentCourier.phone,
        courierTakenAt: serverTimestamp()
      });
      showToast("ğŸ“¦ Buyurtma olindi");
    };

    window.markDelivered = async (id) =>{
      await updateDoc(doc(db,"orders",id),{
        status:"delivered",
        deliveredAt: serverTimestamp()
      });
      showToast("ğŸ‰ Yetkazildi");
    };

    /* TAB SYSTEM */
    const tabs = document.querySelectorAll(".courier-tab-btn");
    const tabAvailable = document.getElementById("courierTabAvailable");
    const tabMy = document.getElementById("courierTabMy");
    const tabDone = document.getElementById("courierTabDone");

    tabs.forEach(btn => {
      btn.addEventListener("click", () => {
        tabs.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");

        tabAvailable.classList.add("hidden");
        tabMy.classList.add("hidden");
        tabDone.classList.add("hidden");

        const t = btn.dataset.tab;
        if(t==="available") tabAvailable.classList.remove("hidden");
        if(t==="my")        tabMy.classList.remove("hidden");
        if(t==="done")      tabDone.classList.remove("hidden");
      });
    });

  </script>

</body>
</html>
