<!doctype html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸšš Kuryer paneli â€” Premium Beauty</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="style.css" />
</head>

<body class="courier-body">
  <!-- HEADER -->
  <header class="courier-header">
    <div class="courier-header-left">
      <div class="courier-logo">ğŸ”</div>
      <div class="courier-header-text">
        <div class="courier-title">Premium FastFood â€” Kuryer</div>
        <div class="courier-subtitle">Qabul qil â€¢ Olib bor â€¢ Yetkaz</div>
      </div>
    </div>
    <div class="courier-header-right">
      <button class="btn-chip" onclick="location.href='index.html'">â¬… Menyu</button>
      <button id="courierLogoutBtn" class="btn-chip btn-chip-danger">Chiqish</button>
    </div>
  </header>

  <main class="courier-main">
    <!-- LOGIN SECTION -->
    <section id="courierLoginSection" class="courier-login-section">
      <article class="courier-card courier-login-card">
        <h2>ğŸšš Kuryer uchun kirish</h2>
        <p>Admin bergan login va parolni kiriting.</p>
        <div class="form-grid">
          <label>Login <input id="courierLoginInput" autocomplete="username"></label>
          <label>Parol <input id="courierPassInput" type="password" autocomplete="current-password"></label>
        </div>
        <button id="courierLoginBtn" class="btn-chip" style="margin-top:12px;">Kirish</button>
      </article>
    </section>

    <!-- APP SECTION -->
    <section id="courierAppSection" class="courier-app-section hidden">
      <!-- INFO + STATS -->
      <article class="courier-card">
        <div class="courier-info-card">
          <div class="courier-info-main">
            <div class="courier-avatar">ğŸšš</div>
            <div>
              <div id="courierNameText" class="courier-name"></div>
              <div id="courierCarText" class="courier-meta"></div>
            </div>
          </div>
          <div class="courier-badge-row">
            <span id="courierStatusBadge" class="courier-badge">Offline</span>
          </div>
          <div style="margin-top:10px; display:flex; gap:10px;">
            <button id="goOnline"  class="btn-xs btn-xs-primary">Onlayn</button>
            <button id="goOffline" class="btn-xs btn-xs-danger">Offline</button>
          </div>
        </div>

        <div class="courier-stats-row" style="margin-top:12px;">
          <div class="courier-stat-card">
            <div class="stat-label">Bugun yetkazilgan</div>
            <div id="statTodayCount" class="stat-value">0</div>
            <div class="stat-sub">dona</div>
          </div>
          <div class="courier-stat-card">
            <div class="stat-label">Tushum</div>
            <div id="statTodaySum" class="stat-value">0</div>
            <div class="stat-sub">soâ€˜m</div>
          </div>
        </div>

        <div class="courier-tabs">
          <button class="courier-tab-btn active" data-tab="available">ğŸ†• Yangi</button>
          <button class="courier-tab-btn" data-tab="my">ğŸ“¦ Mening</button>
          <button class="courier-tab-btn" data-tab="done">âœ… Yetkazilgan</button>
        </div>
      </article>

      <!-- TAB PAGES -->
      <section id="courierTabAvailable" class="courier-tab-page"></section>
      <section id="courierTabMy"        class="courier-tab-page hidden"></section>
      <section id="courierTabDone"      class="courier-tab-page hidden"></section>
    </section>
  </main>

  <div id="courierToast" class="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, onSnapshot, query, orderBy, updateDoc, doc, serverTimestamp, getDocs
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDVidcgjpUxkg88bxXfIFzmsFydv0rMMao",
      authDomain: "shahboz-5d0a3.firebaseapp.com",
      projectId: "shahboz-5d0a3",
      storageBucket: "shahboz-5d0a3.firebasestorage.app",
      messagingSenderId: "352024095535",
      appId: "1:352024095535:web:3f495ac74cdd40f5c54fda"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const ordersCol   = collection(db, "orders");
    const couriersCol = collection(db, "couriers");

    // DOM
    const loginSec = document.getElementById("courierLoginSection");
    const appSec   = document.getElementById("courierAppSection");
    const loginBtn = document.getElementById("courierLoginBtn");
    const logoutBtn = document.getElementById("courierLogoutBtn");
    const loginInput = document.getElementById("courierLoginInput");
    const passInput  = document.getElementById("courierPassInput");
    const nameEl = document.getElementById("courierNameText");
    const carEl  = document.getElementById("courierCarText");
    const badge  = document.getElementById("courierStatusBadge");
    const tabBtns = document.querySelectorAll(".courier-tab-btn");
    const tabA = document.getElementById("courierTabAvailable");
    const tabM = document.getElementById("courierTabMy");
    const tabD = document.getElementById("courierTabDone");
    const toast = document.getElementById("courierToast");

    let currentCourier = null;
    let isOnline = false;
    const STORAGE_KEY = "beauty_courier_auth";

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"),1800);
    }

    function sound(){
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine"; o.frequency.value = 880;
        o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
        o.start();
        setTimeout(()=>{
          g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.15);
          o.stop(ctx.currentTime+0.16);
        }, 120);
      }catch(e){}
    }

    // Auth
    loginBtn.onclick = async () => {
      const login = (loginInput.value||"").trim().toLowerCase();
      const pass  = (passInput.value||"").trim();

      const snapshot = await getDocs(couriersCol);
      let found = null;
      snapshot.forEach(d=>{
        const c = d.data();
        if(c.login?.toLowerCase()===login && c.password===pass) found = c;
      });
      if(!found){ showToast("Login yoki parol xato"); return; }

      currentCourier = found;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(found));
      nameEl.textContent = found.name || "";
      carEl.textContent  = "ğŸš— " + (found.car || "");
      isOnline = true;
      badge.textContent = "Online"; badge.style.background = "#16a34a";
      loginSec.classList.add("hidden");
      appSec.classList.remove("hidden");
      showToast("Xush kelibsiz!");
      sound();
    };

    logoutBtn.onclick = () => {
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    };

    // Tabs
    tabBtns.forEach(btn=>btn.onclick = () => {
      tabBtns.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      tabA.classList.toggle("hidden", tab!=="available");
      tabM.classList.toggle("hidden", tab!=="my");
      tabD.classList.toggle("hidden", tab!=="done");
    });

    // Live orders
    onSnapshot(query(ordersCol, orderBy("createdAt","desc")), snap=>{
      const available = [];
      const mine = [];
      const done = [];
      snap.forEach(d=>{
        const o = { id:d.id, ...d.data() };
        if(o.status==="delivered") done.push(o);
        else if(o.courierId && currentCourier && o.courierId===currentCourier.id) mine.push(o);
        else if(!o.courierId && o.status!=="rejected") available.push(o);
      });

      render(available, tabA, true);
      render(mine, tabM, false);
      render(done, tabD, false);
    });

    function render(list, container, canTake){
      container.innerHTML = "";
      if(!list.length){ container.innerHTML = "<p class='cart-empty'>Hozircha maâ€™lumot yoâ€˜q.</p>"; return; }
      list.forEach(o=>{
        const addr = o.customer?.address || "";
        const name = o.customer?.name || "";
        const phone = o.customer?.phone || "";
        const lat = o.location?.lat; const lng = o.location?.lng;
        const total = (o.items||[]).reduce((s,it)=>s+Number(it.price||0)*Number(it.qty||1),0);
        const li = document.createElement("article");
        li.className = "order-card courier-order-card";
        li.innerHTML = `
          <div class="order-header">
            <div>
              <div class="order-id">#${o.id}</div>
              <div class="order-customer">ğŸ‘¤ ${name} â€¢ ğŸ“± ${phone}</div>
              <div class="order-date">ğŸ“ ${addr}</div>
            </div>
            <div class="order-total">${(total||0).toLocaleString("uz-UZ")} soâ€˜m</div>
          </div>
          <div class="order-items">
            <ul>${(o.items||[]).map(it=>`<li>${it.name} Ã— ${it.qty}</li>`).join("")}</ul>
          </div>
          <div class="courier-card-footer">
            ${lat&&lng ? `<a class="btn-xs btn-xs-secondary" href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank">ğŸ§­ Marshrut</a>` : ""}
            ${canTake ? `<button class="btn-xs btn-xs-primary" data-take="${o.id}">Qabul qilish</button>` : ""}
            ${currentCourier && o.courierId===currentCourier.id && o.status!=="delivered" ? `<button class="btn-xs btn-xs-primary" data-done="${o.id}">âœ“ Yetkazildi</button>` : ""}
            ${currentCourier && o.courierId===currentCourier.id ? `<button class="btn-xs btn-xs-danger" data-reject="${o.id}">âœ– Bekor</button>` : ""}
          </div>
        `;
        container.appendChild(li);
      });

      container.onclick = async (e) => {
        const take = e.target.closest("[data-take]");
        const done = e.target.closest("[data-done]");
        const rej  = e.target.closest("[data-reject]");
        if(take){
          const id = take.dataset.take;
          await updateDoc(doc(db,"orders",id), { courierId: currentCourier?.id || (currentCourier?.login||""), status:"courier", courierAcceptedAt: serverTimestamp() });
          showToast("Buyurtma qabul qilindi.");
          sound();
        }else if(done){
          const id = done.dataset.done;
          await updateDoc(doc(db,"orders",id), { status:"delivered", deliveredAt: serverTimestamp() });
          showToast("Yetkazilgan deb belgilandi.");
          sound();
        }else if(rej){
          const id = rej.dataset.reject;
          await updateDoc(doc(db,"orders",id), { status:"rejected", rejectedAt: serverTimestamp() });
          showToast("Bekor qilindi.");
        }
      };
    }

    // Telegram theming
    (function initTG(){
      const tg = window.Telegram?.WebApp;
      if(!tg) return;
      tg.ready();
      if(tg.colorScheme==="light"){ document.body.classList.remove("theme-dark"); }
      tg.onEvent("themeChanged", ()=>{
        if(tg.colorScheme==="light"){ document.body.classList.remove("theme-dark"); }
        else{ document.body.classList.add("theme-dark"); }
      });
    })();
  </script>
</body>
</html>
