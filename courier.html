<!doctype html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <title>ğŸšš Kuryer paneli â€” Premium FastFood</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>

<body class="courier-body">
  <!-- HEADER -->
  <header class="courier-header">
    <div class="courier-header-left">
      <div class="courier-logo">ğŸ”</div>
      <div class="courier-header-text">
        <div class="courier-title">Premium FastFood â€” Kuryer</div>
        <div class="courier-subtitle">Buyurtmalarni tez va aniq yetkazish</div>
      </div>
    </div>
    <div class="courier-header-right">
      <button
        type="button"
        class="btn-chip"
        onclick="location.href='index.html'">
        â¬… Menyuga qaytish
      </button>
      <button
        type="button"
        class="btn-chip btn-chip-danger"
        id="courierLogoutBtn">
        Chiqish
      </button>
    </div>
  </header>

  <main class="courier-main">
    <!-- LOGIN BOâ€˜LIMI -->
    <section id="courierLoginSection" class="courier-login-section">
      <article class="courier-card courier-login-card">
        <h2 class="section-title-sm">ğŸšš Kuryer uchun kirish</h2>
        <p class="section-sub-sm">
          Admin bergan login va parolni kiriting.
        </p>
        <div class="form-grid">
          <label>
            Login
            <input
              id="courierLoginInput"
              type="text"
              placeholder="Masalan: shahboz" />
          </label>
          <label>
            Parol
            <input
              id="courierPassInput"
              type="password"
              placeholder="Masalan: 2768" />
          </label>
        </div>
        <button
          type="button"
          class="btn-primary btn-full"
          id="courierLoginBtn">
          Kirish
        </button>
      </article>
    </section>

    <!-- ASOSIY KURYER APP -->
    <section
      id="courierAppSection"
      class="courier-app-section hidden">
      <article class="courier-card">
        <div class="courier-top-panel">
          <!-- KURYER MAâ€™LUMOTI -->
          <div class="courier-info-card">
            <div class="courier-info-main">
              <div class="courier-avatar">ğŸšš</div>
              <div>
                <div
                  class="courier-name"
                  id="courierNameText">
                  <!-- JS -->
                </div>
                <div
                  class="courier-meta"
                  id="courierCarText">
                  <!-- JS -->
                </div>
              </div>
            </div>
            <div class="courier-badge-row">
              <span class="courier-badge">
                Onlayn kuryer
              </span>
            </div>
          </div>

          <!-- STATISTIKA -->
          <div class="courier-stats-row">
            <div class="courier-stat-card">
              <div class="stat-label">Bugun yetkazilgan</div>
              <div class="stat-value" id="statTodayCount">0</div>
              <div class="stat-sub">ta buyurtma</div>
            </div>
            <div class="courier-stat-card">
              <div class="stat-label">Bugun umumiy summa</div>
              <div class="stat-value" id="statTodaySum">0</div>
              <div class="stat-sub">soâ€˜m</div>
            </div>
          </div>

          <!-- TABS -->
          <div class="courier-tabs">
            <button
              type="button"
              class="courier-tab-btn active"
              data-tab="available">
              ğŸ†• Yangi zakazlar
            </button>
            <button
              type="button"
              class="courier-tab-btn"
              data-tab="my">
              ğŸ“¦ Mening zakazlarim
            </button>
            <button
              type="button"
              class="courier-tab-btn"
              data-tab="done">
              âœ… Yetkazilganlar
            </button>
          </div>
        </div>
      </article>

      <!-- YANGI ZAKAZLAR -->
      <section
        id="courierTabAvailable"
        class="courier-tab-page">
        <h3 class="section-title-sm">ğŸ†• Yangi zakazlar</h3>
        <p class="section-sub-sm">
          Admin kuryerga bergan, hali hech qaysi kuryer olmagan buyurtmalar.
        </p>
        <div
          id="courierAvailableList"
          class="courier-orders-list">
        </div>
      </section>

      <!-- MENING ZAKAZLARIM -->
      <section
        id="courierTabMy"
        class="courier-tab-page hidden">
        <h3 class="section-title-sm">ğŸ“¦ Mening zakazlarim</h3>
        <p class="section-sub-sm">
          Hozir siz yetkazayotgan buyurtmalar.
        </p>
        <div
          id="courierMyList"
          class="courier-orders-list">
        </div>
      </section>

      <!-- YETKAZILGANLAR -->
      <section
        id="courierTabDone"
        class="courier-tab-page hidden">
        <h3 class="section-title-sm">âœ… Yetkazilganlar</h3>
        <p class="section-sub-sm">
          Siz yetkazib boâ€˜lgan buyurtmalar tarixi.
        </p>
        <div
          id="courierDoneList"
          class="courier-orders-list">
        </div>
      </section>
    </section>
  </main>

  <!-- TOAST VA OVOZ -->
  <div id="courierToast" class="toast"></div>
  <audio id="courierNotify" src="ding.mp3" preload="auto"></audio>

  <!-- COURIER JS (inline) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      onSnapshot,
      query,
      orderBy,
      updateDoc,
      doc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // FIREBASE CONFIG â€” app.js bilan bir xil
    const firebaseConfig = {
      apiKey: "AIzaSyDVidcgjpUxkg88bxXfIFzmsFydv0rMMao",
      authDomain: "shahboz-5d0a3.firebaseapp.com",
      projectId: "shahboz-5d0a3",
      storageBucket: "shahboz-5d0a3.firebasestorage.app",
      messagingSenderId: "352024095535",
      appId: "1:352024095535:web:3f495ac74cdd40f5c54fda",
      measurementId: "G-J8KFW5ED77"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const ordersCol = collection(db, "orders");

    // BIRINCHI KURYER: shahboz / 2768 / Cobalt 445
    const COURIERS = [
      {
        login: "shahboz",
        pass:  "2768",
        name:  "Shahboz",
        car:   "Cobalt 445"
      }
    ];

    const STORAGE_KEY = "beauty_courier_auth";

    // DOM
    const loginSection    = document.getElementById("courierLoginSection");
    const appSection      = document.getElementById("courierAppSection");
    const loginInput      = document.getElementById("courierLoginInput");
    const passInput       = document.getElementById("courierPassInput");
    const loginBtn        = document.getElementById("courierLoginBtn");
    const logoutBtn       = document.getElementById("courierLogoutBtn");

    const courierNameText = document.getElementById("courierNameText");
    const courierCarText  = document.getElementById("courierCarText");

    const statTodayCount  = document.getElementById("statTodayCount");
    const statTodaySum    = document.getElementById("statTodaySum");

    const tabButtons      = document.querySelectorAll(".courier-tab-btn");
    const tabAvailable    = document.getElementById("courierTabAvailable");
    const tabMy           = document.getElementById("courierTabMy");
    const tabDone         = document.getElementById("courierTabDone");

    const listAvailable   = document.getElementById("courierAvailableList");
    const listMy          = document.getElementById("courierMyList");
    const listDone        = document.getElementById("courierDoneList");

    const toastEl         = document.getElementById("courierToast");
    const notifySoundEl   = document.getElementById("courierNotify");

    // STATE
    let currentCourier = null;
    let orders         = [];
    let unsub          = null;
    let lastSnapshotTs = 0; // yangi zakazlar uchun

    function formatPrice(v){
      return (v || 0).toLocaleString("uz-UZ");
    }

    function showToast(msg, duration = 2000){
      if(!toastEl) return;
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      if(showToast._timer) clearTimeout(showToast._timer);
      showToast._timer = setTimeout(()=>{
        toastEl.classList.remove("show");
      }, duration);
    }

    function playNotify(){
      if(!notifySoundEl) return;
      try{
        notifySoundEl.currentTime = 0;
        notifySoundEl.play().catch(()=>{});
      }catch(e){}
    }

    function isTodayTs(seconds){
      if(!seconds) return false;
      const d   = new Date(seconds * 1000);
      const now = new Date();
      return d.getFullYear() === now.getFullYear()
          && d.getMonth()    === now.getMonth()
          && d.getDate()     === now.getDate();
    }

    function setLoggedInUI(on){
      if(on){
        loginSection.classList.add("hidden");
        appSection.classList.remove("hidden");
        if(currentCourier){
          courierNameText.textContent =
            currentCourier.name + " (login: " + currentCourier.login + ")";
          courierCarText.textContent =
            "ğŸš— " + currentCourier.car;
        }
      }else{
        appSection.classList.add("hidden");
        loginSection.classList.remove("hidden");
      }
    }

    function saveCourierToStorage(c){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(c));
      }catch(e){}
    }

    function loadCourierFromStorage(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){
        return null;
      }
    }

    function clearCourierStorage(){
      try{
        localStorage.removeItem(STORAGE_KEY);
      }catch(e){}
    }

    function handleLogin(){
      const login = (loginInput.value || "").trim().toLowerCase();
      const pass  = (passInput.value  || "").trim();

      if(!login || !pass){
        showToast("Login va parolni toâ€˜liq kiriting.");
        return;
      }

      const c = COURIERS.find(c =>
        c.login.toLowerCase() === login && c.pass === pass
      );
      if(!c){
        showToast("Notoâ€˜gâ€˜ri login yoki parol.");
        return;
      }

      currentCourier = c;
      saveCourierToStorage(c);
      setLoggedInUI(true);
      showToast("âœ… Kuryer sifatida kirdingiz.");

      subscribeCourierOrders();
    }

    function logoutCourier(){
      currentCourier = null;
      clearCourierStorage();
      if(unsub) unsub();
      unsub = null;
      orders = [];
      renderAllLists();
      setLoggedInUI(false);
      showToast("Chiqish amalga oshirildi.");
    }

    if(loginBtn)  loginBtn.addEventListener("click", handleLogin);
    if(logoutBtn) logoutBtn.addEventListener("click", logoutCourier);

    // ENTER bosganda ham login qilinsin
    [loginInput, passInput].forEach(inp=>{
      if(!inp) return;
      inp.addEventListener("keydown", e=>{
        if(e.key === "Enter") handleLogin();
      });
    });

    // TABS
    tabButtons.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const tab = btn.dataset.tab;
        tabButtons.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");

        tabAvailable.classList.add("hidden");
        tabMy.classList.add("hidden");
        tabDone.classList.add("hidden");

        if(tab === "available") tabAvailable.classList.remove("hidden");
        else if(tab === "my")   tabMy.classList.remove("hidden");
        else if(tab === "done") tabDone.classList.remove("hidden");
      });
    });

    function subscribeCourierOrders(){
      if(unsub) unsub();
      const qOrders = query(ordersCol, orderBy("createdAt","desc"));
      unsub = onSnapshot(qOrders, snap=>{
        const docs = [];
        let maxTs  = lastSnapshotTs;

        snap.forEach(d=>{
          const data = d.data();
          const obj  = { id: d.id, ...data };
          docs.push(obj);
          const s = data.createdAt?.seconds || 0;
          if(s > maxTs) maxTs = s;
        });

        // yangi "courier" statusga tushgan buyurtmalar uchun signal
        if(currentCourier){
          const newCourierOrders = docs.filter(o =>
            o.status === "courier" &&
            (!o.courierLogin || o.courierLogin === currentCourier.login) &&
            (o.createdAt?.seconds || 0) > lastSnapshotTs
          );
          if(newCourierOrders.length){
            playNotify();
            showToast("ğŸ”” Yangi kuryer chaqiruvi!", 2500);
          }
        }

        lastSnapshotTs = maxTs;
        orders = docs;
        renderAllLists();
      }, err=>{
        console.error("Kuryer orders xato:", err);
        showToast("âš ï¸ Buyurtmalarni oâ€˜qishda xato.");
      });
    }

    function renderAllLists(){
      if(!currentCourier){
        listAvailable.innerHTML = "";
        listMy.innerHTML        = "";
        listDone.innerHTML      = "";
        statTodayCount.textContent = "0";
        statTodaySum.textContent   = "0";
        return;
      }

      const avail = orders.filter(o =>
        o.status === "courier" &&
        !o.courierLogin // hali hech kim olmagan
      );
      const myActive = orders.filter(o =>
        o.status === "courier" &&
        o.courierLogin === currentCourier.login
      );
      const myDone = orders.filter(o =>
        o.status === "delivered" &&
        o.courierLogin === currentCourier.login
      );

      // Statistika (bugun yetkazilganlar)
      let todayCount = 0;
      let todaySum   = 0;
      myDone.forEach(o=>{
        if(isTodayTs(o.deliveredAt?.seconds || o.createdAt?.seconds)){
          todayCount++;
          todaySum += o.totalPrice || 0;
        }
      });
      statTodayCount.textContent = String(todayCount);
      statTodaySum.textContent   = formatPrice(todaySum);

      // Render helpers
      const renderList = (target, list, type)=>{
        if(!target) return;
        if(!list.length){
          target.innerHTML = "<p class='cart-empty'>Hozircha buyurtma yoâ€˜q.</p>";
          return;
        }
        target.innerHTML = "";
        list.forEach(o=>{
          const customer = o.customer || {};
          const itemsHtml = (o.items || []).map(i=>
            `<li>${i.name} â€” ${i.qty} Ã— ${formatPrice(i.price)} soâ€˜m</li>`
          ).join("");

          const created = o.createdAt?.seconds
            ? new Date(o.createdAt.seconds * 1000)
            : null;
          const dateStr = created
            ? created.toLocaleString("uz-UZ", { hour12:false })
            : "";

          const hasLoc = o.location &&
            typeof o.location.lat === "number" &&
            typeof o.location.lng === "number";

          let btnRow = "";
          if(type === "available"){
            btnRow = `
              <button
                class="btn-xs btn-xs-primary"
                onclick="takeOrder('${o.id}')">
                Qabul qilish
              </button>
              ${hasLoc ? `
                <button
                  class="btn-xs btn-xs-secondary"
                  onclick="openCourierMap(${o.location.lat},${o.location.lng})">
                  ğŸ“ Marshrut
                </button>
              ` : ""}
            `;
          }else if(type === "my"){
            btnRow = `
              ${hasLoc ? `
                <button
                  class="btn-xs btn-xs-secondary"
                  onclick="openCourierMap(${o.location.lat},${o.location.lng})">
                  ğŸ“ Marshrut
                </button>
              ` : ""}
              <button
                class="btn-xs btn-xs-primary"
                onclick="markDelivered('${o.id}')">
                âœ… Yetkazdim
              </button>
            `;
          }else{
            btnRow = `
              ${hasLoc ? `
                <button
                  class="btn-xs btn-xs-secondary"
                  onclick="openCourierMap(${o.location.lat},${o.location.lng})">
                  ğŸ“ Marshrut
                </button>
              ` : ""}
            `;
          }

          target.innerHTML += `
            <article class="order-card courier-order-card">
              <header class="order-header">
                <div>
                  <div class="order-id">
                    ID: ${o.id.slice(0,8)}...
                  </div>
                  ${dateStr ? `<div class="order-date">${dateStr}</div>` : ""}
                  <div class="order-customer">
                    ğŸ‘¤ ${customer.name || "-"} â€¢ ğŸ“± ${customer.phone || "-"}
                  </div>
                  <div class="order-customer">
                    ğŸ“ ${customer.address || "-"}
                  </div>
                </div>
                <div class="order-total">
                  ${formatPrice(o.totalPrice)} soâ€˜m
                </div>
              </header>

              <section class="order-items">
                <strong>Taomlar:</strong>
                <ul>${itemsHtml}</ul>
              </section>

              <footer class="courier-card-footer">
                ${btnRow}
              </footer>
            </article>
          `;
        });
      };

      renderList(listAvailable, avail,   "available");
      renderList(listMy,       myActive, "my");
      renderList(listDone,     myDone,   "done");
    }

    // Kuryer harakati
    async function takeOrder(orderId){
      if(!currentCourier) return;
      try{
        await updateDoc(doc(db,"orders",orderId),{
          status:       "courier",
          courierLogin: currentCourier.login,
          courierName:  currentCourier.name,
          courierCar:   currentCourier.car,
          courierTakenAt: serverTimestamp()
        });
        showToast("âœ… Buyurtma sizga biriktirildi.");
      }catch(e){
        console.error("takeOrder xato:", e);
        showToast("âš ï¸ Buyurtmani olishda xato.");
      }
    }

    async function markDelivered(orderId){
      if(!currentCourier) return;
      const ok = confirm("Bu buyurtmani haqiqatdan ham yetkazdingizmi?");
      if(!ok) return;
      try{
        await updateDoc(doc(db,"orders",orderId),{
          status:      "delivered",
          deliveredAt: serverTimestamp()
        });
        showToast("ğŸ‰ Buyurtma yetkazildi deb belgilandi.");
      }catch(e){
        console.error("markDelivered xato:", e);
        showToast("âš ï¸ Statusni yangilashda xato.");
      }
    }

    function openCourierMap(lat,lng){
      if(typeof lat !== "number" || typeof lng !== "number"){
        showToast("ğŸ“ Lokatsiya topilmadi.");
        return;
      }
      const url = "https://www.google.com/maps/dir/?api=1&destination=" + lat + "," + lng;
      window.open(url,"_blank");
    }

    // GLOBAL funksiyalar (HTML onclick uchun)
    window.takeOrder      = takeOrder;
    window.markDelivered  = markDelivered;
    window.openCourierMap = openCourierMap;

    // AVTO LOGIN (agar oldin kurgan boâ€˜lsa)
    (function init(){
      const saved = loadCourierFromStorage();
      if(saved){
        currentCourier = saved;
        setLoggedInUI(true);
        subscribeCourierOrders();
        showToast("âœ… Kuryer sifatida avtomatik kirdingiz.");
      }else{
        setLoggedInUI(false);
      }
    })();
  </script>
</body>
</html>
