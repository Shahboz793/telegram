<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dastavka ‚Äî Kuryer paneli</title>

  <!-- STYLE -->
  <link rel="stylesheet" href="style.css" />
</head>

<body class="courier-body">
  <!-- üîî Ding ovoz (faylni shu papkaga qo'y: ding.mp3) -->
  <audio id="notifySound" src="ding.mp3" preload="auto"></audio>

  <!-- HEADER -->
  <header class="courier-header">
    <div class="courier-header-left">
      <div class="courier-logo">üçî</div>
      <div class="courier-header-text">
        <div class="courier-title">Dastavka ‚Äî Kuryer</div>
        <div class="courier-subtitle">Bugungi zakazlarni boshqarish</div>
      </div>
    </div>
    <div class="courier-header-right">
      <button id="courierLogoutBtn" class="btn-chip btn-chip-danger hidden">
        Chiqish
      </button>
    </div>
  </header>

  <!-- MAIN -->
  <main class="courier-main">
    <!-- LOGIN BO'LIMI -->
    <section id="courierLoginSection" class="courier-login-section">
      <div class="courier-card courier-login-card">
        <h2 class="section-title-sm">Kuryer uchun kirish</h2>
        <p class="section-sub-sm">
          Admin bergan login va parolni kiriting. Bir marta kirganingizdan so‚Äòng keyingi safar avtomatik eslab qoladi.
        </p>
        <div class="form-grid">
          <label>
            Login (ism / kod)
            <input id="courierLoginInput" type="text" placeholder="Masalan, ali" />
          </label>
          <label>
            Parol
            <input id="courierPasswordInput" type="password" placeholder="******" />
          </label>
        </div>
        <button id="courierLoginBtn" class="btn-primary btn-full" style="margin-top:10px;">
          Kirish
        </button>
      </div>
    </section>

    <!-- KURYER APP BO'LIMI -->
    <section id="courierAppSection" class="courier-app-section hidden">
      <div class="courier-card">
        <!-- Kuryer haqidagi ma‚Äôlumotlar + statistika -->
        <div class="courier-top-panel">
          <div class="courier-info-card">
            <div class="courier-info-main">
              <div class="courier-avatar" id="courierAvatar">K</div>
              <div>
                <div class="courier-name" id="courierNameLabel">Kuryer</div>
                <div class="courier-meta" id="courierMetaLabel">
                  Telefon: -
                </div>
                <div class="courier-badge-row">
                  <span class="courier-badge" id="courierCarLabel">
                    üöó Avtomobil: -
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- STATISTIKA -->
          <div class="courier-stats-row">
            <div class="courier-stat-card">
              <div class="stat-label">Bugungi zakazlar</div>
              <div class="stat-value" id="todayOrdersCount">0</div>
              <div class="stat-sub">Yetkazib bergan buyurtmalaringiz soni</div>
            </div>
            <div class="courier-stat-card">
              <div class="stat-label">Bugungi summa</div>
              <div class="stat-value" id="todayOrdersTotal">0</div>
              <div class="stat-sub">Umumiy buyurtmalar qiymati, so‚Äòm</div>
            </div>
          </div>
        </div>

        <!-- TABLAR -->
        <div class="courier-tabs">
          <button
            class="courier-tab-btn active"
            data-tab="availableTab"
            id="availableTabBtn">
            Mavjud zakazlar
          </button>
          <button
            class="courier-tab-btn"
            data-tab="myTab"
            id="myTabBtn">
            Zakazlarim
          </button>
        </div>

        <!-- TAB PAGES -->
        <div class="courier-tab-page" id="availableTab">
          <h3 class="section-title-sm">Mavjud zakazlar</h3>
          <p class="section-sub-sm">
            Admin kuryerga bergan, hali hech kim olmagan buyurtmalar.
          </p>
          <div id="courierAvailableList" class="courier-orders-list"></div>
        </div>

        <div class="courier-tab-page hidden" id="myTab">
          <h3 class="section-title-sm">Mening zakazlarim</h3>
          <p class="section-sub-sm">
            Siz olgan buyurtmalar. Yetkazib bo‚Äòlgach, ‚ÄúYakunlash‚Äù tugmasini bosing.
          </p>
          <div id="courierMyList" class="courier-orders-list"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- TOAST (xabarlar) -->
  <div id="toast" class="toast"></div>

  <!-- JS (Courier mantiq) -->
  <script type="module">
    // FIREBASE MODULLARI CDN ORQALI
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      orderBy,
      onSnapshot,
      updateDoc,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // SENING KONFIGING (app.js bilan bir xil BO'LSIN)
    const firebaseConfig = {
      apiKey: "AIzaSyDVidcgjpUxkg88bxXfIFzmsFydv0rMMao",
      authDomain: "shahboz-5d0a3.firebaseapp.com",
      projectId: "shahboz-5d0a3",
      storageBucket: "shahboz-5d0a3.firebasestorage.app",
      messagingSenderId: "352024095535",
      appId: "1:352024095535:web:3f495ac74cdd40f5c54fda",
      measurementId: "G-J8KFW5ED77"
    };

    // INIT
    const app  = initializeApp(firebaseConfig);
    const db   = getFirestore(app);
    const ordersCol = collection(db, "orders");

    // DOM
    const toastEl              = document.getElementById("toast");
    const notifySoundEl        = document.getElementById("notifySound");

    const courierLoginSection  = document.getElementById("courierLoginSection");
    const courierAppSection    = document.getElementById("courierAppSection");

    const courierLoginInput    = document.getElementById("courierLoginInput");
    const courierPasswordInput = document.getElementById("courierPasswordInput");
    const courierLoginBtn      = document.getElementById("courierLoginBtn");
    const courierLogoutBtn     = document.getElementById("courierLogoutBtn");

    const courierNameLabel     = document.getElementById("courierNameLabel");
    const courierMetaLabel     = document.getElementById("courierMetaLabel");
    const courierCarLabel      = document.getElementById("courierCarLabel");
    const courierAvatar        = document.getElementById("courierAvatar");

    const availableTabBtn      = document.getElementById("availableTabBtn");
    const myTabBtn             = document.getElementById("myTabBtn");
    const availableTab         = document.getElementById("availableTab");
    const myTab                = document.getElementById("myTab");

    const courierAvailableList = document.getElementById("courierAvailableList");
    const courierMyList        = document.getElementById("courierMyList");

    const todayOrdersCountEl   = document.getElementById("todayOrdersCount");
    const todayOrdersTotalEl   = document.getElementById("todayOrdersTotal");

    // STATE
    const STORAGE_COURIER_AUTH = "courier_auth";
    let currentCourier  = null;
    let allOrders       = [];
    let lastAvailableIds = new Set();

    // DEMO KURYER L–ûGINLAR
    // Hozircha oddiy massiv. Keyin buni Firestore‚Äôdan boshqarishga o‚Äòtkazamiz.
    const COURIER_ACCOUNTS = [
      {
        id: "c1",
        login: "courier",
        password: "1234",
        name: "Kuryer",
        phone: "+99890 000 00 00",
        car: "Gentra / 01 A 234 BC"
      },
      {
        id: "c2",
        login: "ali",
        password: "1111",
        name: "Ali",
        phone: "+99891 111 11 11",
        car: "Cobalt / 01 B 777 AA"
      }
    ];

    /* HELPERS */
    function formatPrice(v){
      return (v || 0).toLocaleString("uz-UZ");
    }

    function showToast(message, duration = 2000){
      if(!toastEl) return;
      toastEl.textContent = message;
      toastEl.classList.add("show");
      if(showToast._timer) clearTimeout(showToast._timer);
      showToast._timer = setTimeout(()=>toastEl.classList.remove("show"), duration);
    }

    function playNotify(){
      if(!notifySoundEl) return;
      try{
        notifySoundEl.currentTime = 0;
        notifySoundEl.play().catch(()=>{});
      }catch(e){
        console.error("ding xato:", e);
      }
    }

    function saveCourierAuth(courier){
      localStorage.setItem(STORAGE_COURIER_AUTH, JSON.stringify({
        id: courier.id,
        login: courier.login,
        name: courier.name,
        phone: courier.phone,
        car: courier.car
      }));
    }

    function loadCourierAuth(){
      try{
        const raw = localStorage.getItem(STORAGE_COURIER_AUTH);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){
        return null;
      }
    }

    function clearCourierAuth(){
      localStorage.removeItem(STORAGE_COURIER_AUTH);
    }

    function applyCourierUI(){
      if(!currentCourier){
        courierLoginSection.classList.remove("hidden");
        courierAppSection.classList.add("hidden");
        courierLogoutBtn.classList.add("hidden");
        return;
      }
      courierLoginSection.classList.add("hidden");
      courierAppSection.classList.remove("hidden");
      courierLogoutBtn.classList.remove("hidden");

      courierNameLabel.textContent = currentCourier.name || "Kuryer";
      courierMetaLabel.textContent =
        "Telefon: " + (currentCourier.phone || "-");
      courierCarLabel.textContent =
        "üöó Avtomobil: " + (currentCourier.car || "-");

      const firstLetter = (currentCourier.name || "K").charAt(0).toUpperCase();
      courierAvatar.textContent = firstLetter;
    }

    /* LOGIN */
    function doLogin(){
      const login = (courierLoginInput.value || "").trim().toLowerCase();
      const pass  = (courierPasswordInput.value || "").trim();

      if(!login || !pass){
        showToast("Login va parolni kiriting.");
        return;
      }

      const courier = COURIER_ACCOUNTS.find(
        c => c.login.toLowerCase() === login && c.password === pass
      );
      if(!courier){
        showToast("Noto‚Äòg‚Äòri login yoki parol.");
        return;
      }
      currentCourier = courier;
      saveCourierAuth(courier);
      applyCourierUI();
      showToast("‚úÖ Kuryer sifatida kirdingiz.");
    }

    function doLogout(){
      currentCourier = null;
      clearCourierAuth();
      applyCourierUI();
      showToast("Chiqdingiz.");
    }

    courierLoginBtn.addEventListener("click", doLogin);
    courierLogoutBtn.addEventListener("click", doLogout);

    courierPasswordInput.addEventListener("keydown", e=>{
      if(e.key === "Enter"){
        doLogin();
      }
    });

    /* TABLAR */
    function switchTab(tab){
      if(tab === "available"){
        availableTabBtn.classList.add("active");
        myTabBtn.classList.remove("active");
        availableTab.classList.remove("hidden");
        myTab.classList.add("hidden");
      }else{
        availableTabBtn.classList.remove("active");
        myTabBtn.classList.add("active");
        availableTab.classList.add("hidden");
        myTab.classList.remove("hidden");
      }
    }

    availableTabBtn.addEventListener("click", ()=>switchTab("available"));
    myTabBtn.addEventListener("click", ()=>switchTab("my"));

    /* ORDERS REAL-TIME */
    function subscribeOrders(){
      const qOrders = query(ordersCol, orderBy("createdAt","desc"));
      onSnapshot(qOrders, snap=>{
        const list = [];
        snap.forEach(d=>{
          list.push({ id: d.id, ...d.data() });
        });
        allOrders = list;
        renderOrders();
      }, err=>{
        console.error("Kuryer orders xato:", err);
        showToast("‚ö†Ô∏è Buyurtmalarni o‚Äòqishda xato.");
      });
    }

    function renderOrders(){
      const now = new Date();
      const todayY = now.getFullYear();
      const todayM = now.getMonth();
      const todayD = now.getDate();

      const available = [];
      const mineActive = [];
      const mineTodayDelivered = [];

      const newAvailableIds = new Set();

      allOrders.forEach(o=>{
        const status = o.status || "pending";

        // faqat statusi "courier" bo'lgan va hali courierId yo'q / bo'sh
        const freeForCourier =
          status === "courier" &&
          (!o.courierId || o.courierId === null || o.courierId === "");

        if(freeForCourier){
          available.push(o);
          newAvailableIds.add(o.id);
        }

        if(currentCourier && o.courierId === currentCourier.id){
          // Mening zakazlarim
          if(status === "courier" || status === "delivered"){
            mineActive.push(o);
          }

          // Bugun delivered bo'lganlar bo'yicha statistika
          if(status === "delivered" && o.updatedAt?.seconds){
            const dt = new Date(o.updatedAt.seconds * 1000);
            if(
              dt.getFullYear() === todayY &&
              dt.getMonth() === todayM &&
              dt.getDate() === todayD
            ){
              mineTodayDelivered.push(o);
            }
          }
        }
      });

      // üîî yangi available order paydo bo'lsa ding + toast
      if(currentCourier){
        let hasNew = false;
        newAvailableIds.forEach(id=>{
          if(!lastAvailableIds.has(id)){
            hasNew = true;
          }
        });
        if(hasNew){
          playNotify();
          showToast("üîî Kuryer uchun yangi zakaz keldi!", 2500);
        }
      }
      lastAvailableIds = newAvailableIds;

      renderAvailableList(available);
      renderMyList(mineActive);
      renderStats(mineTodayDelivered);
    }

    function renderStats(orders){
      if(!currentCourier){
        todayOrdersCountEl.textContent = "0";
        todayOrdersTotalEl.textContent = "0";
        return;
      }
      const count = orders.length;
      const total = orders.reduce((sum,o)=>sum + (o.totalPrice || 0), 0);
      todayOrdersCountEl.textContent = String(count);
      todayOrdersTotalEl.textContent = formatPrice(total);
    }

    function renderAvailableList(list){
      if(!list.length){
        courierAvailableList.innerHTML =
          "<p class='cart-empty'>Hozircha kuryerga berilgan, bo‚Äòsh zakaz yo‚Äòq.</p>";
        return;
      }
      courierAvailableList.innerHTML = "";
      list.forEach(o=>{
        const created = o.createdAt?.seconds
          ? new Date(o.createdAt.seconds * 1000)
          : null;
        const dateStr = created
          ? created.toLocaleString("uz-UZ",{ hour12:false })
          : "";

        const customer = o.customer || {};
        const itemsHtml = (o.items || []).map(i=>
          `<li>${i.name} ‚Äî ${i.qty} dona √ó ${formatPrice(i.price)} so‚Äòm</li>`
        ).join("");

        courierAvailableList.innerHTML += `
          <article class="order-card courier-order-card">
            <header class="order-header">
              <div>
                <div class="order-id">ID: ${o.id.slice(0,8)}...</div>
                ${dateStr ? `<div class="order-date">${dateStr}</div>` : ""}
                <div class="order-customer">
                  üë§ ${customer.name || "-"} ‚Ä¢ üì± ${customer.phone || "-"}
                </div>
                <div class="order-customer">
                  üìç ${customer.address || "-"}
                </div>
              </div>
              <div class="order-total">${formatPrice(o.totalPrice || 0)} so‚Äòm</div>
            </header>
            <section class="order-items">
              <strong>Ovqatlar:</strong>
              <ul>${itemsHtml}</ul>
            </section>
            <div class="courier-card-footer">
              <button class="btn-xs btn-xs-primary" onclick="window.acceptOrder('${o.id}')">
                Olish
              </button>
            </div>
          </article>
        `;
      });
    }

    function renderMyList(list){
      if(!list.length){
        courierMyList.innerHTML =
          "<p class='cart-empty'>Sizda hozircha zakaz yo‚Äòq. 'Mavjud zakazlar'dan oling.</p>";
        return;
      }
      courierMyList.innerHTML = "";
      list.forEach(o=>{
        const created = o.createdAt?.seconds
          ? new Date(o.createdAt.seconds * 1000)
          : null;
        const dateStr = created
          ? created.toLocaleString("uz-UZ",{ hour12:false })
          : "";
        const status = o.status || "courier";
        const customer = o.customer || {};
        const itemsHtml = (o.items || []).map(i=>
          `<li>${i.name} ‚Äî ${i.qty} dona √ó ${formatPrice(i.price)} so‚Äòm</li>`
        ).join("");

        const statusLabel =
          status === "courier"  ? "Kuryerda" :
          status === "delivered"? "Yetkazildi" :
          status === "rejected" ? "Bekor qilingan" : status;

        const canFinish = (status !== "delivered" && status !== "rejected");

        courierMyList.innerHTML += `
          <article class="order-card courier-order-card">
            <header class="order-header">
              <div>
                <div class="order-id">ID: ${o.id.slice(0,8)}...</div>
                ${dateStr ? `<div class="order-date">${dateStr}</div>` : ""}
                <div class="order-customer">
                  üë§ ${customer.name || "-"} ‚Ä¢ üì± ${customer.phone || "-"}
                </div>
                <div class="order-customer">
                  üìç ${customer.address || "-"}
                </div>
              </div>
              <div class="order-total">${formatPrice(o.totalPrice || 0)} so‚Äòm</div>
            </header>
            <section class="order-items">
              <strong>Ovqatlar:</strong>
              <ul>${itemsHtml}</ul>
            </section>
            <footer class="order-footer">
              <span>Holat: ${statusLabel}</span>
              <div class="courier-card-footer">
                ${
                  canFinish
                    ? `<button class="btn-xs btn-xs-primary"
                              onclick="window.finishOrder('${o.id}')">
                         Yakunlash
                       </button>`
                    : `<button class="btn-xs btn-xs-secondary" disabled>
                         ‚úÖ Yakunlangan
                       </button>`
                }
              </div>
            </footer>
          </article>
        `;
      });
    }

    /* ORDER ACTIONS */
    async function acceptOrder(orderId){
      if(!currentCourier){
        showToast("Avval kuryer sifatida kiring.");
        return;
      }
      try{
        const ref  = doc(db,"orders",orderId);
        const snap = await getDoc(ref);
        if(!snap.exists()){
          showToast("Buyurtma topilmadi.");
          return;
        }
        const data = snap.data();
        const status = data.status || "pending";

        // allaqachon boshqa kuryer olgan bo‚Äòlishi mumkin
        if(
          status !== "courier" ||
          (data.courierId && data.courierId !== currentCourier.id)
        ){
          showToast("Bu zakazni boshqa kuryer olib bo‚Äòlgan yoki status o‚Äòzgargan.");
          return;
        }

        await updateDoc(ref,{
          courierId: currentCourier.id,
          courierName: currentCourier.name,
          courierPhone: currentCourier.phone,
          courierCar: currentCourier.car,
          status: "courier"
        });
        showToast("‚úÖ Zakaz sizga biriktirildi.");
      }catch(e){
        console.error("acceptOrder xato:", e);
        showToast("‚ö†Ô∏è Zakazni olishda xato.");
      }
    }

    async function finishOrder(orderId){
      if(!currentCourier){
        showToast("Avval kuryer sifatida kiring.");
        return;
      }
      const ok = confirm("Bu zakaz haqiqatdan ham yetkazildimi?");
      if(!ok) return;
      try{
        const ref  = doc(db,"orders",orderId);
        const snap = await getDoc(ref);
        if(!snap.exists()){
          showToast("Buyurtma topilmadi.");
          return;
        }
        const data = snap.data();
        if(data.courierId && data.courierId !== currentCourier.id){
          showToast("Bu zakaz boshqa kuryerga tegishli.");
          return;
        }
        await updateDoc(ref,{
          status: "delivered",
          updatedAt: (await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"))
            .serverTimestamp()
        }).catch(async ()=>{
          // Agar import ishlamasa, updatedAt siz ham qolishi mumkin
          await updateDoc(ref,{ status: "delivered" });
        });
        showToast("‚úÖ Zakaz yakunlandi.");
      }catch(e){
        console.error("finishOrder xato:", e);
        showToast("‚ö†Ô∏è Zakazni yakunlashda xato.");
      }
    }

    // GLOBALGA CHIQRAMIZ
    window.acceptOrder = acceptOrder;
    window.finishOrder = finishOrder;

    /* INIT */
    (function init(){
      // oldingi kuryerni tiklash
      const saved = loadCourierAuth();
      if(saved){
        currentCourier = saved;
      }
      applyCourierUI();
      subscribeOrders();
    })();
  </script>
</body>
</html>
