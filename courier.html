<!doctype html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <title>ğŸšš Kuryer paneli â€” Premium FastFood</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>

<body class="courier-body">

  <!-- HEADER -->
  <header class="courier-header">
    <div class="courier-header-left">
      <div class="courier-logo">ğŸ”</div>
      <div class="courier-header-text">
        <div class="courier-title">Premium FastFood â€” Kuryer</div>
        <div class="courier-subtitle">Buyurtmalarni tez va aniq yetkazish</div>
      </div>
    </div>

    <div class="courier-header-right">
      <button class="btn-chip" onclick="location.href='index.html'">â¬… Menyuga qaytish</button>

      <button id="courierStatusBtn" class="btn-chip btn-chip-secondary">
        Offline
      </button>

      <button class="btn-chip btn-chip-danger" id="courierLogoutBtn">
        Chiqish
      </button>
    </div>
  </header>

  <main class="courier-main">

    <!-- LOGIN SCREEN -->
    <section id="courierLoginSection" class="courier-login-section">
      <article class="courier-card courier-login-card">
        <h2 class="section-title-sm">ğŸšš Kuryer uchun kirish</h2>
        <p class="section-sub-sm">Admin bergan login va parolni kiriting.</p>

        <div class="form-grid">
          <label>Login <input id="courierLoginInput" type="text" placeholder="Masalan: ahmad"></label>
          <label>Parol <input id="courierPassInput" type="password" placeholder="Masalan: 1234"></label>
        </div>

        <button class="btn-primary btn-full" id="courierLoginBtn">Kirish</button>
      </article>
    </section>

    <!-- MAIN APP -->
    <section id="courierAppSection" class="courier-app-section hidden">
      <article class="courier-card">

        <!-- KURYER INFO -->
        <div class="courier-top-panel">
          <div class="courier-info-card">
            <div class="courier-info-main">
              <div class="courier-avatar">ğŸšš</div>
              <div>
                <div id="courierNameText" class="courier-name"></div>
                <div id="courierCarText" class="courier-meta"></div>
              </div>
            </div>
            <div class="courier-badge-row">
              <span id="courierBadge" class="courier-badge">Offline</span>
            </div>
          </div>

          <!-- STATS -->
          <div class="courier-stats-row">
            <div class="courier-stat-card">
              <div class="stat-label">Bugun yetkazilgan</div>
              <div class="stat-value" id="statTodayCount">0</div>
              <div class="stat-sub">ta buyurtma</div>
            </div>

            <div class="courier-stat-card">
              <div class="stat-label">Bugun umumiy summa</div>
              <div class="stat-value" id="statTodaySum">0</div>
              <div class="stat-sub">soâ€˜m</div>
            </div>
          </div>

          <!-- TABS -->
          <div class="courier-tabs">
            <button class="courier-tab-btn active" data-tab="available">ğŸ†• Yangi zakazlar</button>
            <button class="courier-tab-btn" data-tab="my">ğŸ“¦ Mening zakazlarim</button>
            <button class="courier-tab-btn" data-tab="done">âœ… Yetkazilganlar</button>
          </div>
        </div>

      </article>

      <!-- AVAILABLE -->
      <section id="courierTabAvailable" class="courier-tab-page">
        <h3 class="section-title-sm">ğŸ†• Yangi zakazlar</h3>
        <div id="courierAvailableList" class="courier-orders-list"></div>
      </section>

      <!-- MY ORDERS -->
      <section id="courierTabMy" class="courier-tab-page hidden">
        <h3 class="section-title-sm">ğŸ“¦ Mening zakazlarim</h3>
        <div id="courierMyList" class="courier-orders-list"></div>
      </section>

      <!-- DONE -->
      <section id="courierTabDone" class="courier-tab-page hidden">
        <h3 class="section-title-sm">âœ… Yetkazilganlar</h3>
        <div id="courierDoneList" class="courier-orders-list"></div>
      </section>

    </section>
  </main>

  <!-- TOAST + SOUND -->
  <div id="courierToast" class="toast"></div>
  <audio id="courierNotify" src="ding.mp3" preload="auto"></audio>

  <!-- SCRIPT -->
  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, where,
      onSnapshot, updateDoc, doc, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDVidcgjpUxkg88bxXfIFzmsFydv0rMMao",
      authDomain: "shahboz-5d0a3.firebaseapp.com",
      projectId: "shahboz-5d0a3",
      storageBucket: "shahboz-5d0a3.firebasestorage.app",
      messagingSenderId: "352024095535",
      appId: "1:352024095535:web:3f495ac74cdd40f5c54fda"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ================================
       GLOBAL STATE
    ================================== */
    let currentCourier = null;
    let courierDocId = null;

    let orders = [];
    let unsub = null;
    let lastSnapshotTs = 0;

    /* ================================
       DOM ELEMENTS
    ================================== */
    const loginSection = document.getElementById("courierLoginSection");
    const appSection = document.getElementById("courierAppSection");

    const loginInput = document.getElementById("courierLoginInput");
    const passInput = document.getElementById("courierPassInput");
    const loginBtn = document.getElementById("courierLoginBtn");
    const logoutBtn = document.getElementById("courierLogoutBtn");

    const courierStatusBtn = document.getElementById("courierStatusBtn");
    const courierBadge = document.getElementById("courierBadge");

    const courierNameText = document.getElementById("courierNameText");
    const courierCarText = document.getElementById("courierCarText");

    const statTodayCount = document.getElementById("statTodayCount");
    const statTodaySum = document.getElementById("statTodaySum");

    const listAvailable = document.getElementById("courierAvailableList");
    const listMy = document.getElementById("courierMyList");
    const listDone = document.getElementById("courierDoneList");

    const toastEl = document.getElementById("courierToast");
    const notifySound = document.getElementById("courierNotify");

    /* ================================
       HELPERS
    ================================== */
    function showToast(msg) {
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 2000);
    }

    function playNotify() {
      notifySound.currentTime = 0;
      notifySound.play().catch(()=>{});
    }

    function formatPrice(v) {
      return (v || 0).toLocaleString("uz-UZ");
    }

    function isToday(ts) {
      if (!ts) return false;
      const d = new Date(ts * 1000);
      const n = new Date();
      return d.getFullYear() === n.getFullYear() &&
             d.getMonth() === n.getMonth() &&
             d.getDate() === n.getDate();
    }

    function setLoggedInUI(on) {
      if (on) {
        loginSection.classList.add("hidden");
        appSection.classList.remove("hidden");
      } else {
        loginSection.classList.remove("hidden");
        appSection.classList.add("hidden");
      }
    }

    /* ================================
       LOGIN
    ================================== */
    async function handleLogin() {
      const login = loginInput.value.trim().toLowerCase();
      const pass  = passInput.value.trim();

      if (!login || !pass) {
        showToast("Login va parolni kiriting");
        return;
      }

      const q = query(
        collection(db, "couriers"),
        where("login", "==", login),
        where("password", "==", pass)
      );

      const snap = await getDocs(q);

      if (snap.empty) {
        showToast("Notoâ€˜gâ€˜ri login yoki parol");
        return;
      }

      snap.forEach(docu => {
        courierDocId = docu.id;
        currentCourier = docu.data();
      });

      courierNameText.textContent = currentCourier.name;
      courierCarText.textContent = "ğŸš— " + currentCourier.car;

      // Online qilish
      await updateDoc(doc(db, "couriers", courierDocId), {
        status: "online",
        updatedAt: serverTimestamp()
      });

      courierBadge.textContent = "Online";
      courierBadge.classList.add("badge-online");

      setLoggedInUI(true);
      subscribeOrders();

      showToast("Kirish muvaffaqiyatli!");
    }

    loginBtn.addEventListener("click", handleLogin);

    /* ENTER bilan login */
    passInput.addEventListener("keydown", e => {
      if (e.key === "Enter") handleLogin();
    });

    /* ================================
       OFFLINE / ONLINE
    ================================== */
    courierStatusBtn.onclick = async () => {
      if (!currentCourier) return;

      const newStatus = currentCourier.status === "online" ? "offline" : "online";

      await updateDoc(doc(db, "couriers", courierDocId), {
        status: newStatus,
        updatedAt: serverTimestamp()
      });

      currentCourier.status = newStatus;

      courierBadge.textContent = newStatus === "online" ? "Online" : "Offline";
      courierStatusBtn.textContent = newStatus === "online" ? "Ishda (online)" : "Offline";

      showToast("Holat: " + newStatus);
    };

    /* ================================
       LOGOUT
    ================================== */
    logoutBtn.onclick = async () => {
      if (currentCourier) {
        await updateDoc(doc(db, "couriers", courierDocId), {
          status: "offline",
          updatedAt: serverTimestamp()
        });
      }

      currentCourier = null;
      courierDocId = null;
      setLoggedInUI(false);

      if (unsub) unsub();

      showToast("Chiqildi");
    };

    /* ================================
       SUBSCRIBE ORDERS
    ================================== */
    function subscribeOrders() {
      const qOrders = query(collection(db, "orders"), orderBy("createdAt", "desc"));

      unsub = onSnapshot(qOrders, snap => {
        orders = [];
        let maxTS = lastSnapshotTs;

        snap.forEach(d => {
          const o = { id: d.id, ...d.data() };
          orders.push(o);

          const ts = o.createdAt?.seconds || 0;
          if (ts > maxTS) maxTS = ts;
        });

        // Signal
        if (maxTS > lastSnapshotTs) playNotify();
        lastSnapshotTs = maxTS;

        renderAllLists();
      });
    }

    /* ================================
       RENDER LISTS
    ================================== */
    function renderAllLists() {

      const available = orders.filter(o => o.status === "courier" && !o.courierLogin);
      const myOrders  = orders.filter(o => o.status === "courier" && o.courierLogin === currentCourier.login);
      const doneOrders = orders.filter(o => o.status === "delivered" && o.courierLogin === currentCourier.login);

      listAvailable.innerHTML = buildListHTML(available, "available");
      listMy.innerHTML        = buildListHTML(myOrders, "my");
      listDone.innerHTML      = buildListHTML(doneOrders, "done");

      // Stats
      let tc = 0;
      let ts = 0;
      doneOrders.forEach(o => {
        if (isToday(o.deliveredAt?.seconds || o.createdAt?.seconds)) {
          tc++;
          ts += (o.totalPrice || 0);
        }
      });

      statTodayCount.textContent = tc;
      statTodaySum.textContent   = formatPrice(ts);
    }

    function buildListHTML(list, type) {
      if (!list.length) return `<p class='cart-empty'>Buyurtma yoâ€˜q.</p>`;

      return list.map(o => {

        const c = o.customer || {};
        const items = (o.items || [])
          .map(i => `<li>${i.name} â€” ${i.qty} Ã— ${formatPrice(i.price)}</li>`)
          .join("");

        const ts = o.createdAt?.seconds
          ? new Date(o.createdAt.seconds * 1000).toLocaleString("uz-UZ")
          : "";

        let btns = "";

        if (type === "available")
          btns = `<button class="btn-xs btn-xs-primary" onclick="takeOrder('${o.id}')">Qabul qilish</button>`;

        if (type === "my")
          btns =
            `<button class="btn-xs btn-xs-secondary" onclick="openMap(${o.location?.lat},${o.location?.lng})">ğŸ“ Marshrut</button>
             <button class="btn-xs btn-xs-primary" onclick="markDelivered('${o.id}')">Yetkazdim</button>`;

        if (type === "done")
          btns =
            `<button class="btn-xs btn-xs-secondary" onclick="openMap(${o.location?.lat},${o.location?.lng})">ğŸ“ Marshrut</button>`;

        return `
          <article class="order-card courier-order-card">
            <header class="order-header">
              <div>
                <div class="order-id">ID: ${o.id.slice(0, 8)}...</div>
                <div class="order-date">${ts}</div>
                <div class="order-customer">ğŸ‘¤ ${c.name} â€¢ ${c.phone}</div>
                <div class="order-customer">ğŸ“ ${c.address}</div>
              </div>
              <div class="order-total">${formatPrice(o.totalPrice)} soâ€˜m</div>
            </header>

            <section class="order-items">
              <strong>Taomlar:</strong>
              <ul>${items}</ul>
            </section>

            <footer class="courier-card-footer">${btns}</footer>
          </article>
        `;
      }).join("");
    }

    /* ================================
       TAKE ORDER
    ================================== */
    window.takeOrder = async id => {
      await updateDoc(doc(db, "orders", id), {
        courierLogin: currentCourier.login,
        courierName: currentCourier.name,
        courierCar: currentCourier.car,
        status: "courier"
      });
      showToast("Buyurtma olindi");
    };

    /* ================================
       DELIVER ORDER
    ================================== */
    window.markDelivered = async id => {
      await updateDoc(doc(db, "orders", id), {
        status: "delivered",
        deliveredAt: serverTimestamp()
      });
      showToast("Yetkazildi");
    };

    /* ================================
       MAP OPEN
    ================================== */
    window.openMap = (lat, lng) => {
      window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`);
    };

  </script>
</body>
</html>
