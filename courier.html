<!doctype html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <title>ğŸšš Kuryer paneli â€” Premium FastFood</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>

<body class="courier-body">
  <!-- HEADER -->
  <header class="courier-header">
    <div class="courier-header-left">
      <div class="courier-logo">ğŸ”</div>
      <div class="courier-header-text">
        <div class="courier-title">Premium FastFood â€” Kuryer</div>
        <div class="courier-subtitle">Buyurtmalarni tez va aniq yetkazish</div>
      </div>
    </div>
    <div class="courier-header-right">
      <button
        type="button"
        class="btn-chip"
        onclick="location.href='index.html'">
        â¬… Menyuga qaytish
      </button>
      <button
        type="button"
        class="btn-chip btn-chip-danger"
        id="courierLogoutBtn">
        Chiqish
      </button>
    </div>
  </header>

  <main class="courier-main">
    <!-- LOGIN BOâ€˜LIMI -->
    <section id="courierLoginSection" class="courier-login-section">
      <article class="courier-card courier-login-card">
        <h2 class="section-title-sm">ğŸšš Kuryer uchun kirish</h2>
        <p class="section-sub-sm">
          Admin bergan login va parolni kiriting.
        </p>
        <div class="form-grid">
          <label>
            Login
            <input id="courierLoginInput" type="text" placeholder="Masalan: aziz" />
          </label>
          <label>
            Parol
            <input id="courierPassInput" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢" />
          </label>
        </div>
        <button type="button" class="btn-primary btn-full" id="courierLoginBtn">
          Kirish
        </button>
      </article>
    </section>

    <!-- ASOSIY KURYER APP -->
    <section id="courierAppSection" class="courier-app-section hidden">
      <article class="courier-card">
        <div class="courier-top-panel">

          <!-- KURYER INFO -->
          <div class="courier-info-card">
            <div class="courier-info-main">
              <div class="courier-avatar">ğŸšš</div>
              <div>
                <div class="courier-name" id="courierNameText"></div>
                <div class="courier-meta" id="courierCarText"></div>
              </div>
            </div>
            <div class="courier-badge-row">
              <span class="courier-badge">Onlayn kuryer</span>
            </div>
          </div>

          <!-- STAT -->
          <div class="courier-stats-row">
            <div class="courier-stat-card">
              <div class="stat-label">Bugun yetkazilgan</div>
              <div class="stat-value" id="statTodayCount">0</div>
              <div class="stat-sub">ta buyurtma</div>
            </div>
            <div class="courier-stat-card">
              <div class="stat-label">Bugun summa</div>
              <div class="stat-value" id="statTodaySum">0</div>
              <div class="stat-sub">soâ€˜m</div>
            </div>
          </div>

          <!-- TABS -->
          <div class="courier-tabs">
            <button class="courier-tab-btn active" data-tab="available">ğŸ†• Yangi zakazlar</button>
            <button class="courier-tab-btn" data-tab="my">ğŸ“¦ Mening zakazlarim</button>
            <button class="courier-tab-btn" data-tab="done">âœ… Yetkazilganlar</button>
          </div>
        </div>
      </article>

      <!-- YANGI ZAKAZLAR -->
      <section id="courierTabAvailable" class="courier-tab-page">
        <h3 class="section-title-sm">ğŸ†• Yangi zakazlar</h3>
        <p class="section-sub-sm">
          Admin kuryerga bergan, hali hech kim olmagan buyurtmalar.
        </p>
        <div id="courierAvailableList" class="courier-orders-list"></div>
      </section>

      <!-- MENING ZAKAZLARIM -->
      <section id="courierTabMy" class="courier-tab-page hidden">
        <h3 class="section-title-sm">ğŸ“¦ Mening zakazlarim</h3>
        <div id="courierMyList" class="courier-orders-list"></div>
      </section>

      <!-- YETKAZILGANLAR -->
      <section id="courierTabDone" class="courier-tab-page hidden">
        <h3 class="section-title-sm">âœ… Yetkazilgan buyurtmalar</h3>
        <div id="courierDoneList" class="courier-orders-list"></div>
      </section>

    </section>
  </main>

  <!-- TOAST + OVOZ -->
  <div id="courierToast" class="toast"></div>
  <audio id="courierNotify" src="ding.mp3" preload="auto"></audio>

  <!-- KURYER JS -->
  <script type="module">
    /* =============================
         FIREBASE INIT
    ============================== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      onSnapshot,
      query,
      orderBy,
      where,
      updateDoc,
      doc,
      serverTimestamp,
      getDocs
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDVidcgjpUxkg88bxXfIFzmsFydv0rMMao",
      authDomain: "shahboz-5d0a3.firebaseapp.com",
      projectId: "shahboz-5d0a3",
      storageBucket: "shahboz-5d0a3.firebasestorage.app",
      messagingSenderId: "352024095535",
      appId: "1:352024095535:web:3f495ac74cdd40f5c54fda"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const couriersCol = collection(db, "couriers");
    const ordersCol   = collection(db, "orders");

    /* =============================
         DOM ELEMENTS
    ============================== */
    const loginSection = document.getElementById("courierLoginSection");
    const appSection   = document.getElementById("courierAppSection");

    const loginInput = document.getElementById("courierLoginInput");
    const passInput  = document.getElementById("courierPassInput");
    const loginBtn   = document.getElementById("courierLoginBtn");
    const logoutBtn  = document.getElementById("courierLogoutBtn");

    const courierNameText = document.getElementById("courierNameText");
    const courierCarText  = document.getElementById("courierCarText");

    const statTodayCount = document.getElementById("statTodayCount");
    const statTodaySum   = document.getElementById("statTodaySum");

    const tabBtns = document.querySelectorAll(".courier-tab-btn");
    const tabAvailable = document.getElementById("courierTabAvailable");
    const tabMy        = document.getElementById("courierTabMy");
    const tabDone      = document.getElementById("courierTabDone");

    const listAvailable = document.getElementById("courierAvailableList");
    const listMy        = document.getElementById("courierMyList");
    const listDone      = document.getElementById("courierDoneList");

    const toastEl = document.getElementById("courierToast");
    const notifyEl = document.getElementById("courierNotify");

    /* =============================
         STATE
    ============================== */
    let currentCourier = null;
    let orders = [];
    let unsub = null;
    let lastTs = 0;

    /* =============================
         HELPERS
    ============================== */
    function formatPrice(v){
      return (v || 0).toLocaleString("uz-UZ");
    }

    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=> toastEl.classList.remove("show"), 2000);
    }

    function playNotify(){
      try {
        notifyEl.currentTime = 0;
        notifyEl.play().catch(()=>{});
      } catch(e){}
    }

    function setUI(logged){
      if(logged){
        loginSection.classList.add("hidden");
        appSection.classList.remove("hidden");
      } else {
        appSection.classList.add("hidden");
        loginSection.classList.remove("hidden");
      }
    }

    /* =============================
         LOGIN â€” FIRESTORE BOâ€˜YICHA
    ============================== */
    async function handleLogin(){
      const login = loginInput.value.trim().toLowerCase();
      const pass  = passInput.value.trim();

      if(!login || !pass){
        showToast("Login va parolni toâ€˜liq kiriting.");
        return;
      }

      const q = query(couriersCol, where("login", "==", login));
      const snap = await getDocs(q);

      if(snap.empty){
        showToast("Kuryer topilmadi.");
        return;
      }

      const courier = snap.docs[0].data();
      courier.id = snap.docs[0].id;

      if(courier.status === "deleted"){
        showToast("Bu kuryer oâ€˜chirilgan.");
        return;
      }

      if(courier.status === "blocked"){
        showToast("Kuryer bloklangan. Administrator bilan bogâ€˜laning.");
        return;
      }

      if(courier.password !== pass){
        showToast("Notoâ€˜gâ€˜ri parol.");
        return;
      }

      currentCourier = courier;
      localStorage.setItem("fastfood_courier", JSON.stringify(courier));

      courierNameText.textContent = courier.name;
      courierCarText.textContent  = "ğŸš— " + (courier.car || "");

      showToast("Kuryer sifatida kirdingiz.");
      setUI(true);

      subscribeOrders();
    }

    loginBtn.addEventListener("click", handleLogin);
    loginInput.addEventListener("keydown", e=> e.key==="Enter" && handleLogin());
    passInput.addEventListener("keydown", e=> e.key==="Enter" && handleLogin());

    logoutBtn.addEventListener("click", ()=>{
      localStorage.removeItem("fastfood_courier");
      currentCourier = null;
      if(unsub) unsub();
      unsub = null;
      setUI(false);
      showToast("Chiqdingiz.");
    });

    /* =============================
         ORDERS REALTIME
    ============================== */
    function subscribeOrders(){
      if(unsub) unsub();

      const qOrders = query(ordersCol, orderBy("createdAt","desc"));
      unsub = onSnapshot(qOrders, snap=>{
        orders = snap.docs.map(d=>({ id:d.id, ...d.data() }));

        // yangi buyurtma signali
        orders.forEach(o=>{
          const ts = o.createdAt?.seconds || 0;
          if(ts > lastTs && o.status === "courier"){
            playNotify();
            showToast("ğŸ”” Yangi buyurtma!");
          }
        });

        lastTs = Math.max(...orders.map(o=>o.createdAt?.seconds || 0), lastTs);

        renderLists();
      });
    }

    /* =============================
         RENDER LISTS
    ============================== */
    function renderLists(){
      if(!currentCourier) return;

      const available = orders.filter(o =>
        o.status === "courier" && !o.courierLogin
      );
      const my = orders.filter(o =>
        o.status === "courier" && o.courierLogin === currentCourier.login
      );
      const done = orders.filter(o =>
        o.status === "delivered" && o.courierLogin === currentCourier.login
      );

      listAvailable.innerHTML = renderOrderCards(available, "available");
      listMy.innerHTML        = renderOrderCards(my, "my");
      listDone.innerHTML      = renderOrderCards(done, "done");

      // statistika
      let cnt = 0, sum = 0;
      done.forEach(o=>{
        cnt++;
        sum += o.totalPrice || 0;
      });
      statTodayCount.textContent = cnt;
      statTodaySum.textContent   = formatPrice(sum);
    }

    function renderOrderCards(arr, type){
      if(!arr.length){
        return "<p class='cart-empty'>Buyurtma yoâ€˜q.</p>";
      }

      return arr.map(o=>{
        const cust = o.customer || {};
        const items = (o.items||[])
          .map(i=>`<li>${i.name} â€” ${i.qty}Ã—${formatPrice(i.price)} soâ€˜m</li>`)
          .join("");

        const locBtn = o.location
          ? `<button class="btn-xs btn-xs-secondary" onclick="openMap(${o.location.lat},${o.location.lng})">ğŸ“ Marshrut</button>`
          : "";

        let btnRow = "";
        if(type === "available"){
          btnRow = `
            <button class="btn-xs btn-xs-primary" onclick="takeOrder('${o.id}')">Qabul qilish</button>
            ${locBtn}
          `;
        } else if(type === "my"){
          btnRow = `
            ${locBtn}
            <button class="btn-xs btn-xs-primary" onclick="markDelivered('${o.id}')">Yetkazdim</button>
          `;
        } else {
          btnRow = locBtn;
        }

        return `
        <article class="order-card courier-order-card">
          <header class="order-header">
            <div>
              <div class="order-id">ID: ${o.id.slice(0,8)}...</div>
              <div class="order-customer">ğŸ‘¤ ${cust.name || ""} â€¢ ğŸ“± ${cust.phone || ""}</div>
              <div class="order-customer">ğŸ“ ${cust.address || ""}</div>
            </div>
            <div class="order-total">${formatPrice(o.totalPrice)} soâ€˜m</div>
          </header>

          <section class="order-items">
            <strong>Taomlar:</strong>
            <ul>${items}</ul>
          </section>

          <footer class="courier-card-footer">${btnRow}</footer>
        </article>
        `;
      }).join("");
    }

    /* =============================
         ACTIONS
    ============================== */
    async function takeOrder(id){
      if(!currentCourier) return;
      await updateDoc(doc(db,"orders",id),{
        status: "courier",
        courierLogin: currentCourier.login,
        courierName: currentCourier.name,
        courierCar: currentCourier.car,
        courierTakenAt: serverTimestamp()
      });
      showToast("Buyurtma olindi.");
    }

    async function markDelivered(id){
      if(!currentCourier) return;
      await updateDoc(doc(db,"orders",id),{
        status: "delivered",
        deliveredAt: serverTimestamp()
      });
      showToast("Yetkazildi.");
    }

    function openMap(lat,lng){
      if(lat && lng){
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`,"_blank");
      }
    }

    window.takeOrder = takeOrder;
    window.markDelivered = markDelivered;
    window.openMap = openMap;

    /* =============================
         AUTO LOGIN
    ============================== */
    (function(){
      const saved = localStorage.getItem("fastfood_courier");
      if(saved){
        currentCourier = JSON.parse(saved);
        courierNameText.textContent = currentCourier.name;
        courierCarText.textContent  = "ğŸš— " + currentCourier.car;
        setUI(true);
        subscribeOrders();
      }
    })();

  </script>
</body>
</html>
