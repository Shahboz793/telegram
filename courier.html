<!doctype html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <title>ğŸšš Kuryer paneli â€” Premium FastFood</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/5787/5787016.png">
  <!-- Asosiy dizayn â€“ index sahifadagi style.css ni ishlatamiz -->
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Kuryer sahifasiga biroz oâ€˜ziga xoslik */
    .courier-header-title{
      font-size:18px;
      font-weight:700;
    }
    .courier-header-sub{
      font-size:12px;
      color:var(--muted);
    }
    .courier-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      background:rgba(34,197,94,.08);
      font-size:11px;
    }
    .courier-login-card{
      max-width:420px;
      margin:40px auto 0;
    }
    .courier-top-bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .courier-name{
      font-size:13px;
      font-weight:600;
    }
    .courier-status-text{
      font-size:11px;
      color:var(--muted);
    }
    .courier-columns{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    @media (min-width:860px){
      .courier-columns{
        display:grid;
        grid-template-columns:1.1fr 1.1fr 1.1fr;
      }
    }
    .courier-order-list{
      max-height:330px;
      overflow-y:auto;
      padding-right:4px;
      font-size:12px;
    }
    .courier-order-list::-webkit-scrollbar{
      width:4px;
    }
    .courier-order-list::-webkit-scrollbar-thumb{
      background:rgba(148,163,184,.6);
      border-radius:999px;
    }
    .courier-order-actions{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }
    .pill-green{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      background:rgba(34,197,94,.12);
      color:#166534;
      font-size:11px;
    }
  </style>
</head>

<body>
  <div class="page-wrap">

    <!-- HEADER -->
    <header class="app-header">
      <div class="logo-wrap">
        <div class="logo-circle">ğŸšš</div>
        <div class="logo-text">
          <div class="logo-title">Kuryer paneli</div>
          <div class="logo-sub">Premium FastFood buyurtmalari</div>
        </div>
      </div>

      <div class="header-right">
        <button type="button" class="icon-btn" onclick="location.href='index.html'">ğŸ”</button>
      </div>
    </header>

    <!-- LOGIN BO'LIMI -->
    <main id="courierLoginSection">
      <article class="card courier-login-card">
        <h2 class="section-title">ğŸ” Kuryer sifatida kirish</h2>
        <p class="section-sub">
          Admin tomonidan <b>couriers</b> roâ€˜yxatiga qoâ€˜shilgan boâ€˜lsangiz, login va parol bilan kirasiz.
        </p>

        <div class="form-grid" style="margin-top:8px;">
          <label>
            Login
            <input id="courierLoginInput" placeholder="courier01">
          </label>
          <label>
            Parol
            <input id="courierPasswordInput" type="password" placeholder="maxfiy parol">
          </label>
        </div>

        <button id="courierLoginBtn" class="btn-primary btn-full" type="button">
          ğŸš€ Kirish
        </button>

        <p class="section-sub" style="margin-top:8px;font-size:11px;">
          Eslatma: <br>
          â€¢ Faqat <b>status: active</b> boâ€˜lgan kuryerlar kira oladi. <br>
          â€¢ Agar admin sizni bloklasa yoki oâ€˜chirsa, bu yerga kira olmaysiz.
        </p>
      </article>
    </main>

    <!-- ASOSIY KURYER SAHIFASI -->
    <main id="courierMainSection" class="hidden">
      <div class="admin-top-bar courier-top-bar">
        <div>
          <div class="courier-header-title">ğŸšš Kuryer paneli</div>
          <div id="courierStatusLine" class="courier-header-sub">
            Buyurtmalar real vaqt rejimida yangilanadi.
          </div>
        </div>
        <div style="text-align:right;">
          <div id="courierNameLine" class="courier-name">â€”</div>
          <div class="courier-status-text">
            <span class="courier-badge">
              <span>ğŸŸ¢</span><span>Faol kuryer</span>
            </span>
          </div>
          <button class="btn-ghost" type="button" style="margin-top:4px;" onclick="courierLogout()">
            âï¸ Chiqish
          </button>
        </div>
      </div>

      <div class="courier-columns">

        <!-- YANGI BUYURTMALAR -->
        <article class="card">
          <h3 class="card-title">ğŸ†• Yangi buyurtmalar</h3>
          <p class="section-sub">Admin tasdiqlagan, kuryer biriktirilmagan buyurtmalar.</p>
          <div id="courierNewOrders" class="courier-order-list"></div>
        </article>

        <!-- MENING FAOL BUYURTMALARIM -->
        <article class="card">
          <h3 class="card-title">ğŸšš Mening faol buyurtmalarim</h3>
          <p class="section-sub">
            Yoâ€˜lda boâ€˜lgan yoki mijoz tasdigâ€˜ini kutayotgan buyurtmalar.
          </p>
          <div id="courierActiveOrders" class="courier-order-list"></div>
        </article>

        <!-- YAKUNLANGANLAR -->
        <article class="card">
          <h3 class="card-title">âœ… Yakunlangan buyurtmalar</h3>
          <p class="section-sub">
            Mijoz tasdiqlagan yetkazilgan buyurtmalar.
          </p>
          <div id="courierDoneOrders" class="courier-order-list"></div>
        </article>

      </div>
    </main>

  </div>

  <!-- TOAST -->
  <div id="toast" class="toast"></div>

  <!-- FIREBASE + SCRIPT -->
  <script type="module">
    // FIREBASE MODULLARI
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      getDocs,
      query,
      where,
      updateDoc,
      onSnapshot,
      serverTimestamp,
      orderBy
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // SENING KONFIGING (app.js bilan bir xil)
    const firebaseConfig = {
      apiKey: "AIzaSyDVidcgjpUxkg88bxXfIFzmsFydv0rMMao",
      authDomain: "shahboz-5d0a3.firebaseapp.com",
      projectId: "shahboz-5d0a3",
      storageBucket: "shahboz-5d0a3.firebasestorage.app",
      messagingSenderId: "352024095535",
      appId: "1:352024095535:web:3f495ac74cdd40f5c54fda",
      measurementId: "G-J8KFW5ED77"
    };

    // INIT
    const app  = initializeApp(firebaseConfig);
    const db   = getFirestore(app);

    const ordersCol   = collection(db,"orders");
    const couriersCol = collection(db,"couriers");

    const STORAGE_COURIER_SESSION = "beauty_courier_session";

    // DOM
    const courierLoginSection = document.getElementById("courierLoginSection");
    const courierMainSection  = document.getElementById("courierMainSection");

    const courierLoginInput   = document.getElementById("courierLoginInput");
    const courierPasswordInput= document.getElementById("courierPasswordInput");
    const courierLoginBtn     = document.getElementById("courierLoginBtn");

    const courierNameLine     = document.getElementById("courierNameLine");
    const courierStatusLine   = document.getElementById("courierStatusLine");

    const courierNewOrdersEl   = document.getElementById("courierNewOrders");
    const courierActiveOrdersEl= document.getElementById("courierActiveOrders");
    const courierDoneOrdersEl  = document.getElementById("courierDoneOrders");

    const toastEl = document.getElementById("toast");

    // STATE
    let currentCourier = null;
    let allOrders      = [];
    let unsubscribeOrders = null;

    /* HELPERS */
    function showToast(message, duration = 2000){
      if(!toastEl) return;
      toastEl.textContent = message;
      toastEl.classList.add("show");
      if(showToast._timer) clearTimeout(showToast._timer);
      showToast._timer = setTimeout(()=>toastEl.classList.remove("show"), duration);
    }

    function formatPrice(v){
      return (v || 0).toLocaleString("uz-UZ");
    }

    function shortId(id){
      return id ? id.slice(0,8) + "..." : "";
    }

    function openMapsRouteTo(lat,lng){
      if(typeof lat !== "number" || typeof lng !== "number"){
        showToast("ğŸ“ Manzil GPS maâ€™lumoti yoâ€˜q.");
        return;
      }

      if(!navigator.geolocation){
        const url = "https://www.google.com/maps/dir/?api=1&destination=" + lat + "," + lng;
        window.open(url,"_blank");
        return;
      }

      showToast("ğŸ“ Joylashuvingiz olinmoqda...",2500);

      navigator.geolocation.getCurrentPosition(
        pos=>{
          const myLat = pos.coords.latitude;
          const myLng = pos.coords.longitude;
          const url   = `https://www.google.com/maps/dir/?api=1&origin=${myLat},${myLng}&destination=${lat},${lng}`;
          window.open(url,"_blank");
        },
        err=>{
          console.error("Courier GPS xato:", err);
          const url = "https://www.google.com/maps/dir/?api=1&destination=" + lat + "," + lng;
          window.open(url,"_blank");
        },
        { enableHighAccuracy:true, timeout:8000 }
      );
    }

    function openMapsPoint(lat,lng){
      if(typeof lat !== "number" || typeof lng !== "number"){
        showToast("ğŸ“ Manzil GPS maâ€™lumoti yoâ€˜q.");
        return;
      }
      const url = `https://www.google.com/maps?q=${lat},${lng}&z=16`;
      window.open(url,"_blank");
    }

    /* LOGIN / SESSION */
    function updateCourierUI(){
      if(currentCourier){
        courierLoginSection.classList.add("hidden");
        courierMainSection.classList.remove("hidden");
        courierNameLine.textContent = currentCourier.name
          ? currentCourier.name + " (" + (currentCourier.login || "") + ")"
          : (currentCourier.login || "");
        courierStatusLine.textContent = "Buyurtmalar real vaqt rejimida yangilanadi.";
      }else{
        courierLoginSection.classList.remove("hidden");
        courierMainSection.classList.add("hidden");
        courierNameLine.textContent = "â€”";
      }
    }

    async function courierLogin(){
      const login = (courierLoginInput.value || "").trim();
      const pass  = (courierPasswordInput.value || "").trim();
      if(!login || !pass){
        showToast("Login va parolni kiriting.");
        return;
      }

      try{
        const qCour = query(
          couriersCol,
          where("login","==",login),
          where("password","==",pass)
        );
        const snap = await getDocs(qCour);
        if(snap.empty){
          showToast("âŒ Notoâ€˜gâ€˜ri login yoki parol.");
          return;
        }
        const d    = snap.docs[0];
        const data = d.data() || {};
        const status = data.status || "active";

        if(status === "blocked"){
          showToast("ğŸš« Siz bloklangansiz. Admin bilan bogâ€˜laning.");
          return;
        }
        if(status === "deleted"){
          showToast("ğŸ—‘ Hisobingiz oâ€˜chirilgan.");
          return;
        }

        currentCourier = {
          id: d.id,
          ...data
        };

        // Session saqlaymiz
        localStorage.setItem(
          STORAGE_COURIER_SESSION,
          JSON.stringify({ id:d.id, login:data.login || login })
        );

        showToast("âœ… Kuryer sifatida kirdingiz.",2500);
        updateCourierUI();
        subscribeCourierOrders();

      }catch(e){
        console.error("Courier login xato:", e);
        showToast("âš ï¸ Kirishda xato.");
      }
    }

    function courierLogout(){
      currentCourier = null;
      localStorage.removeItem(STORAGE_COURIER_SESSION);
      if(unsubscribeOrders) unsubscribeOrders();
      allOrders = [];
      renderCourierLists();
      updateCourierUI();
      showToast("âï¸ Chiqdingiz.",2000);
    }

    async function restoreCourierSession(){
      try{
        const raw = localStorage.getItem(STORAGE_COURIER_SESSION);
        if(!raw) return;
        const sess = JSON.parse(raw);
        if(!sess || !sess.id) return;

        const snap = await getDoc(doc(db,"couriers",sess.id));
        if(!snap.exists()){
          localStorage.removeItem(STORAGE_COURIER_SESSION);
          return;
        }
        const data   = snap.data() || {};
        const status = data.status || "active";
        if(status === "blocked" || status === "deleted"){
          localStorage.removeItem(STORAGE_COURIER_SESSION);
          return;
        }

        currentCourier = {
          id: snap.id,
          ...data
        };
        updateCourierUI();
        subscribeCourierOrders();
        showToast("ğŸ‘‹ Qayta xush kelibsiz, " + (currentCourier.name || currentCourier.login || "kuryer") + ".",2500);
      }catch(e){
        console.error("Session tiklash xato:", e);
      }
    }

    /* REAL-TIME ORDERS */
    function subscribeCourierOrders(){
      if(!currentCourier) return;
      if(unsubscribeOrders) unsubscribeOrders();

      const qOrders = query(ordersCol, orderBy("createdAt","desc"));
      unsubscribeOrders = onSnapshot(qOrders, snap=>{
        const list = [];
        snap.forEach(d=>{
          list.push({ id:d.id, ...d.data() });
        });
        allOrders = list;
        renderCourierLists();
      },err=>{
        console.error("Courier orders snapshot xato:", err);
        showToast("âš ï¸ Buyurtmalarni oâ€˜qishda xato.");
      });
    }

    function splitOrdersForCourier(){
      if(!currentCourier) return { newOrders:[], active:[], done:[] };

      const myId = currentCourier.id;

      const newOrders = allOrders.filter(o=>
        o.status === "confirmed" &&
        (!o.courier || !o.courier.id) &&
        !o.awaitClientConfirm
      );

      const active = allOrders.filter(o=>{
        if(!o.courier || o.courier.id !== myId) return false;
        if(o.status === "courier") return true;
        if(o.status === "delivered" && o.awaitClientConfirm) return true;
        return false;
      });

      const done = allOrders.filter(o=>{
        if(!o.courier || o.courier.id !== myId) return false;
        return o.status === "delivered" && !o.awaitClientConfirm;
      });

      return { newOrders, active, done };
    }

    function renderCourierLists(){
      if(!courierNewOrdersEl || !courierActiveOrdersEl || !courierDoneOrdersEl) return;

      const { newOrders, active, done } = splitOrdersForCourier();

      // Helper: bitta order kartasini HTML koâ€˜rinishida beradigan funksiyalar
      function renderOrderCard(o, type){
        const customer = o.customer || {};
        const hasLoc   = o.location && typeof o.location.lat === "number" && typeof o.location.lng === "number";
        const created  = o.createdAt?.seconds
          ? new Date(o.createdAt.seconds*1000)
          : null;
        const dateStr  = created
          ? created.toLocaleString("uz-UZ",{hour12:false})
          : "";

        const itemsHtml = (o.items || []).map(i=>
          `<li>${i.name} â€” ${i.qty} dona Ã— ${formatPrice(i.price)} soâ€˜m</li>`
        ).join("");

        let statusLabel = "";
        if(type === "new"){
          statusLabel = "ğŸ†• Yangi (tasdiqlangan)";
        }else if(type === "active"){
          if(o.status === "courier"){
            statusLabel = "ğŸšš Yoâ€˜lda";
          }else if(o.status === "delivered" && o.awaitClientConfirm){
            statusLabel = "â³ Mijoz tasdigâ€˜ini kutmoqda";
          }else{
            statusLabel = "Faol";
          }
        }else{
          statusLabel = "âœ… Yakunlangan";
        }

        let actionsHtml = "";

        if(type === "new"){
          actionsHtml = `
            <div class="courier-order-actions">
              <button class="btn-xs btn-xs-primary" onclick="acceptOrder('${o.id}')">
                âœ… Qabul qilish
              </button>
              ${
                hasLoc
                  ? `<button class="btn-xs btn-xs-secondary" onclick="openOrderPoint('${o.id}')">ğŸ“ Manzil</button>`
                  : ""
              }
            </div>
          `;
        }else if(type === "active"){
          actionsHtml = `
            <div class="courier-order-actions">
              ${
                hasLoc
                  ? `<button class="btn-xs btn-xs-secondary" onclick="openOrderRoute('${o.id}')">ğŸ“ Marshrut</button>`
                  : ""
              }
              <button class="btn-xs btn-xs-primary" onclick="markDelivered('${o.id}')">
                âœ… Yetkazdim
              </button>
            </div>
          `;
          if(o.status === "delivered" && o.awaitClientConfirm){
            actionsHtml += `
              <div style="margin-top:4px;font-size:11px;color:#b91c1c;">
                â³ Mijozning â€œyetkazildiâ€ tasdigâ€˜i kutilmoqda.
              </div>
            `;
          }
        }else{
          // done
          actionsHtml = `
            <div class="courier-order-actions">
              ${
                hasLoc
                  ? `<button class="btn-xs btn-xs-secondary" onclick="openOrderPoint('${o.id}')">ğŸ“ Manzil</button>`
                  : ""
              }
              <span class="pill-green">âœ… Tasdiqlangan yetkazma</span>
            </div>
          `;
        }

        return `
          <article class="order-card">
            <header class="order-header">
              <div>
                <div class="order-id">ID: ${shortId(o.id)}</div>
                ${dateStr ? `<div class="order-date">${dateStr}</div>` : ""}
                <div class="order-customer">
                  ğŸ‘¤ ${customer.name || "-"} â€¢ ğŸ“± ${customer.phone || "-"}
                </div>
                <div class="order-customer">
                  ğŸ“ ${customer.address || "-"}
                </div>
              </div>
              <div class="order-total">${formatPrice(o.totalPrice)} soâ€˜m</div>
            </header>
            <div class="order-status-row">
              <span class="status-pill status-${o.status || "pending"}">
                ${statusLabel}
              </span>
            </div>
            <section class="order-items">
              <strong>Mahsulotlar:</strong>
              <ul>${itemsHtml}</ul>
            </section>
            ${actionsHtml}
          </article>
        `;
      }

      // NEW
      if(!newOrders.length){
        courierNewOrdersEl.innerHTML = `<p class="cart-empty">Hozircha yangi buyurtma yoâ€˜q.</p>`;
      }else{
        courierNewOrdersEl.innerHTML = newOrders.map(o=>renderOrderCard(o,"new")).join("");
      }

      // ACTIVE
      if(!active.length){
        courierActiveOrdersEl.innerHTML = `<p class="cart-empty">Faol buyurtmalaringiz yoâ€˜q.</p>`;
      }else{
        courierActiveOrdersEl.innerHTML = active.map(o=>renderOrderCard(o,"active")).join("");
      }

      // DONE
      if(!done.length){
        courierDoneOrdersEl.innerHTML = `<p class="cart-empty">Hali yakunlangan buyurtmangiz yoâ€˜q.</p>`;
      }else{
        courierDoneOrdersEl.innerHTML = done.map(o=>renderOrderCard(o,"done")).join("");
      }
    }

    /* ACTIONS (GLOBAL) */
    async function acceptOrder(orderId){
      if(!currentCourier) return;
      try{
        const ref  = doc(db,"orders",orderId);
        const snap = await getDoc(ref);
        if(!snap.exists()){
          showToast("Buyurtma topilmadi.");
          return;
        }
        const data = snap.data() || {};
        if(data.status !== "confirmed"){
          showToast("Bu buyurtma endi yangi emas.");
          return;
        }
        if(data.courier && data.courier.id){
          showToast("Bu buyurtmaga allaqachon boshqa kuryer biriktirilgan.");
          return;
        }

        await updateDoc(ref,{
          status:"courier",
          courier:{
            id: currentCourier.id,
            name: currentCourier.name || "",
            phone: currentCourier.phone || "",
            car: currentCourier.car || "",
            plate: currentCourier.plate || "",
            login: currentCourier.login || ""
          },
          updatedAt: serverTimestamp()
        });

        showToast("âœ… Buyurtma sizga biriktirildi.",2500);
      }catch(e){
        console.error("acceptOrder xato:", e);
        showToast("âš ï¸ Qabul qilishda xato.");
      }
    }

    async function markDelivered(orderId){
      if(!currentCourier) return;
      const ok = confirm("Bu buyurtmani HAQIQATDAN mijozga yetkazdingizmi?\n\nOK â€” Ha, yetkazdim.\nCancel â€” Yoâ€˜q.");
      if(!ok) return;
      try{
        const ref  = doc(db,"orders",orderId);
        const snap = await getDoc(ref);
        if(!snap.exists()){
          showToast("Buyurtma topilmadi.");
          return;
        }
        const data = snap.data() || {};
        if(!data.courier || data.courier.id !== currentCourier.id){
          showToast("Bu buyurtma sizga biriktirilmagan.");
          return;
        }

        await updateDoc(ref,{
          status:"delivered",
          awaitClientConfirm:true,
          updatedAt:serverTimestamp()
        });

        showToast("âœ… Yetkazildi deb belgilandi. Mijoz tasdigâ€˜i kutilmoqda.",3000);
      }catch(e){
        console.error("markDelivered xato:", e);
        showToast("âš ï¸ Status yangilashda xato.");
      }
    }

    // Google Maps tugmalari
    function openOrderRoute(orderId){
      const o = allOrders.find(x=>x.id===orderId);
      if(!o || !o.location){
        showToast("ğŸ“ GPS maâ€™lumoti topilmadi.");
        return;
      }
      openMapsRouteTo(o.location.lat,o.location.lng);
    }
    function openOrderPoint(orderId){
      const o = allOrders.find(x=>x.id===orderId);
      if(!o || !o.location){
        showToast("ğŸ“ GPS maâ€™lumoti topilmadi.");
        return;
      }
      openMapsPoint(o.location.lat,o.location.lng);
    }

    // GLOBALGA EKSPORT
    window.acceptOrder    = acceptOrder;
    window.markDelivered  = markDelivered;
    window.openOrderRoute = openOrderRoute;
    window.openOrderPoint = openOrderPoint;
    window.courierLogout  = courierLogout;

    // EVENT
    if(courierLoginBtn){
      courierLoginBtn.addEventListener("click", courierLogin);
    }
    courierPasswordInput?.addEventListener("keydown", e=>{
      if(e.key === "Enter") courierLogin();
    });
    courierLoginInput?.addEventListener("keydown", e=>{
      if(e.key === "Enter") courierLogin();
    });

    // INIT
    (function init(){
      // Kuryer sessiyasi boâ€˜lsa â€“ avtomatik tiklaymiz
      restoreCourierSession();
    })();
  </script>
</body>
</html>
