<!doctype html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <title>ğŸšš Kuryer paneli â€” Premium FastFood</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css">

  <style>
    /* Kuryer interfeysi uchun min CSS (sizning style.css bilan mos) */
    .hidden{display:none!important}
    .courier-body{background:#0f172a;color:white;font-family:"Poppins",sans-serif}
    .courier-header{display:flex;justify-content:space-between;padding:12px 16px;background:#1e293b}
    .courier-header-left{display:flex;align-items:center;gap:10px}
    .courier-logo{font-size:32px}
    .courier-title{font-size:18px;font-weight:600}
    .courier-subtitle{font-size:12px;opacity:.7;margin-top:-4px}
    .courier-main{padding:16px}
    .courier-card{background:#1e293b;padding:16px;border-radius:12px;margin-bottom:14px}
    .btn-primary{background:#2563eb;color:white;border:none;padding:10px 16px;border-radius:8px;font-size:15px;width:100%}
    .btn-chip{padding:6px 14px;border-radius:20px;background:#334155;color:white;border:none}
    .btn-chip-danger{background:#dc2626}
    .courier-tab-btn{padding:8px 12px;border-radius:8px;border:none;background:#334155;color:white}
    .courier-tab-btn.active{background:#2563eb}
    .courier-orders-list .order-card{background:#0f172a;padding:12px;border-radius:10px;margin-bottom:10px;border:1px solid #334155}
    .order-header{display:flex;justify-content:space-between}
    .btn-xs{padding:6px 10px;border-radius:6px;background:#2563eb;color:white;border:none;font-size:13px}
    .btn-xs-secondary{background:#475569}
  </style>
</head>

<body class="courier-body">

  <!-- HEADER -->
  <header class="courier-header">
    <div class="courier-header-left">
      <div class="courier-logo">ğŸšš</div>
      <div>
        <div class="courier-title">Premium FastFood â€” Kuryer</div>
        <div class="courier-subtitle">Buyurtma yetkazish tizimi</div>
      </div>
    </div>
    <div class="courier-header-right">
      <button class="btn-chip" onclick="location.href='index.html'">â¬… Orqaga</button>
      <button class="btn-chip btn-chip-danger" id="logoutBtn">Chiqish</button>
    </div>
  </header>

  <main class="courier-main">

    <!-- LOGIN SECTION -->
    <section id="loginSection">
      <article class="courier-card">
        <h2 style="margin:0 0 4px 0;">Kuryer uchun kirish</h2>
        <p style="opacity:.7;margin:0 0 8px 0;">Admin beradigan login/parolni kiriting</p>

        <label>Login
          <input id="loginInput" type="text" class="search-input" placeholder="login">
        </label><br><br>

        <label>Parol
          <input id="passInput" type="password" class="search-input" placeholder="parol">
        </label><br><br>

        <button class="btn-primary" id="loginBtn">Kirish</button>
      </article>
    </section>

    <!-- MAIN APP -->
    <section id="appSection" class="hidden">

      <article class="courier-card">

        <!-- KURYER INFO -->
        <div style="display:flex;align-items:center;gap:14px;">
          <div style="font-size:36px;">ğŸ‘¤</div>
          <div>
            <div id="courierName" style="font-size:18px;font-weight:600;">â€”</div>
            <div id="courierInfo" style="opacity:.7;font-size:14px;">â€”</div>
          </div>
        </div>

        <!-- TABS -->
        <div style="display:flex;gap:8px;margin-top:16px;">
          <button class="courier-tab-btn active" data-tab="available">ğŸ†• Yangi</button>
          <button class="courier-tab-btn" data-tab="my">ğŸ“¦ Mening</button>
          <button class="courier-tab-btn" data-tab="done">âœ… Yetkazilgan</button>
        </div>

      </article>

      <!-- TAB PAGES -->
      <div id="tabAvailable" class="courier-orders-list"></div>
      <div id="tabMy" class="courier-orders-list hidden"></div>
      <div id="tabDone" class="courier-orders-list hidden"></div>

    </section>

  </main>

  <!-- NOTIFICATION -->
  <audio id="notifySound" src="ding.mp3" preload="auto"></audio>
  <div id="toast" class="toast"></div>

  <!-- ====================== FIREBASE + APP ====================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, onSnapshot, updateDoc,
      doc, query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    /* FIREBASE CONFIG (index bilan bir xil) */
    const firebaseConfig = {
      apiKey: "AIzaSyDVidcgjpUxkg88bxXfIFzmsFydv0rMMao",
      authDomain: "shahboz-5d0a3.firebaseapp.com",
      projectId: "shahboz-5d0a3",
      storageBucket: "shahboz-5d0a3.firebasestorage.app",
      messagingSenderId: "352024095535",
      appId: "1:352024095535:web:3f495ac74cdd40f5c54fda"
    };

    const app  = initializeApp(firebaseConfig);
    const db   = getFirestore(app);
    const ORDERS = collection(db, "orders");
    const COURIERS = collection(db, "couriers");

    /* UI ELEMENTS */
    const loginSection = document.getElementById("loginSection");
    const appSection   = document.getElementById("appSection");
    const loginBtn     = document.getElementById("loginBtn");
    const logoutBtn    = document.getElementById("logoutBtn");

    const loginInput   = document.getElementById("loginInput");
    const passInput    = document.getElementById("passInput");

    const courierName  = document.getElementById("courierName");
    const courierInfo  = document.getElementById("courierInfo");

    const tabBtns      = document.querySelectorAll(".courier-tab-btn");
    const tabAvailable = document.getElementById("tabAvailable");
    const tabMy        = document.getElementById("tabMy");
    const tabDone      = document.getElementById("tabDone");

    const toastEl      = document.getElementById("toast");
    const notifySound  = document.getElementById("notifySound");

    let currentCourier = null;
    let allOrders = [];

    /* TOAST */
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=> toastEl.classList.remove("show"), 2000);
    }

    /* LOGIN */
    loginBtn.onclick = async () => {
      const login = loginInput.value.trim();
      const pass  = passInput.value.trim();

      if(!login || !pass){
        toast("Login yoki parol boâ€˜sh");
        return;
      }

      // FIRESTORE COURIERS ichidan tekshiramiz
      const q = query(COURIERS);
      let courier = null;

      await new Promise(resolve=>{
        onSnapshot(q, snap=>{
          snap.forEach(d=>{
            const c = d.data();
            if(c.login === login && c.password === pass && c.status !== "deleted"){
              courier = {...c, id: d.id};
            }
          });
          resolve();
        });
      });

      if(!courier){
        toast("Login yoki parol notoâ€˜gâ€˜ri");
        return;
      }

      if(courier.status === "blocked"){
        toast("Kuryer bloklangan â€” admin bilan bogâ€˜laning");
        return;
      }

      currentCourier = courier;
      localStorage.setItem("fastfood_courier", JSON.stringify(courier));

      courierName.textContent = courier.name;
      courierInfo.innerHTML =
        `ğŸ“± ${courier.phone}<br>
         ğŸš— ${courier.car}<br>
         ğŸ”¢ ${courier.plate}<br>
         ğŸ”‘ ${courier.login}`;

      loginSection.classList.add("hidden");
      appSection.classList.remove("hidden");

      subscribeOrders();
      toast("Kirish muvaffaqiyatli");
    };

    /* LOGOUT */
    logoutBtn.onclick = () => {
      localStorage.removeItem("fastfood_courier");
      location.reload();
    };

    /* AUTO LOGIN */
    const saved = localStorage.getItem("fastfood_courier");
    if(saved){
      currentCourier = JSON.parse(saved);
      courierName.textContent = currentCourier.name;
      courierInfo.innerHTML =
        `ğŸ“± ${currentCourier.phone}<br>
         ğŸš— ${currentCourier.car}<br>
         ğŸ”¢ ${currentCourier.plate}<br>
         ğŸ”‘ ${currentCourier.login}`;

      loginSection.classList.add("hidden");
      appSection.classList.remove("hidden");

      subscribeOrders();
    }

    /* TAB SYSTEM */
    tabBtns.forEach(btn=>{
      btn.onclick = () => {
        tabBtns.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");

        tabAvailable.classList.add("hidden");
        tabMy.classList.add("hidden");
        tabDone.classList.add("hidden");

        if(btn.dataset.tab === "available") tabAvailable.classList.remove("hidden");
        if(btn.dataset.tab === "my")        tabMy.classList.remove("hidden");
        if(btn.dataset.tab === "done")      tabDone.classList.remove("hidden");
      };
    });

    /* LISTENER FOR ORDERS */
    function subscribeOrders(){
      onSnapshot(query(ORDERS, orderBy("createdAt","desc")), snap=>{
        allOrders = [];
        snap.forEach(d=>{
          allOrders.push({id:d.id, ...d.data()});
        });
        renderOrders();
      });
    }

    function renderOrders(){
      const avail = allOrders.filter(o => o.status==="courier" && !o.courierLogin);
      const mine  = allOrders.filter(o => o.status==="courier" && o.courierLogin===currentCourier.login);
      const done  = allOrders.filter(o => o.status==="delivered" && o.courierLogin===currentCourier.login);

      renderList(tabAvailable, avail, "available");
      renderList(tabMy, mine, "my");
      renderList(tabDone, done, "done");
    }

    function renderList(target, list, type){
      target.innerHTML = "";

      if(!list.length){
        target.innerHTML = "<p style='opacity:.7'>Hozircha buyurtma yoâ€˜q</p>";
        return;
      }

      list.forEach(o=>{
        target.innerHTML += `
          <div class="order-card">
            <div class="order-header">
              <div>
                <b>${o.customer?.name || "-"}</b><br>
                ğŸ“± ${o.customer?.phone || "-"}<br>
                ğŸ“ ${o.customer?.address || "-"}
              </div>
              <div>${(o.totalPrice||0).toLocaleString("uz-UZ")} soâ€˜m</div>
            </div>
            <div style="margin-top:8px;">
              ${(o.items||[]).map(i=>`â€¢ ${i.name} â€” ${i.qty}`).join("<br>")}
            </div>

            <div style="margin-top:10px;display:flex;gap:8px;">
              ${
                type==="available"
                ? `<button class="btn-xs" onclick="takeOrder('${o.id}')">Qabul qilish</button>`
                : ""
              }
              ${
                type==="my"
                ? `<button class="btn-xs" onclick="markDelivered('${o.id}')">Yetkazdim</button>`
                : ""
              }
            </div>
          </div>
        `;
      });
    }

    /* GLOBAL FUNCTIONS */
    window.takeOrder = async (id)=>{
      await updateDoc(doc(db,"orders",id),{
        status:"courier",
        courierLogin:currentCourier.login,
        courierName:currentCourier.name,
        courierCar:currentCourier.car,
        updatedAt:serverTimestamp()
      });
      toast("Buyurtma olindi");
    };

    window.markDelivered = async (id)=>{
      await updateDoc(doc(db,"orders",id),{
        status:"delivered",
        deliveredAt:serverTimestamp()
      });
      toast("Buyurtma yetkazildi");
    };
  </script>

</body>
</html>
