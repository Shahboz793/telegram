<!doctype html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <title>ğŸšš Kuryer paneli â€” Premium FastFood</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />

  <style>
    .courier-status-toggle {
      margin-top: 6px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .status-indicator {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      color: #fff;
    }
    .online {
      background: #10b981;
    }
    .offline {
      background: #ef4444;
    }
  </style>
</head>

<body class="courier-body">

  <!-- HEADER -->
  <header class="courier-header">
    <div class="courier-header-left">
      <div class="courier-logo">ğŸ”</div>
      <div class="courier-header-text">
        <div class="courier-title">Premium FastFood â€” Kuryer</div>
        <div class="courier-subtitle">Buyurtmalarni tez va aniq yetkazish</div>
      </div>
    </div>

    <div class="courier-header-right">
      <button type="button" class="btn-chip" onclick="location.href='index.html'">
        â¬… Menyuga qaytish
      </button>
      <button type="button" class="btn-chip btn-chip-danger" id="courierLogoutBtn">
        Chiqish
      </button>
    </div>
  </header>


  <main class="courier-main">

    <!-- LOGIN -->
    <section id="courierLoginSection" class="courier-login-section">
      <article class="courier-card courier-login-card">

        <h2 class="section-title-sm">ğŸšš Kuryer uchun kirish</h2>
        <p class="section-sub-sm">Admin bergan login va parolni kiriting.</p>

        <div class="form-grid">
          <label>Login
            <input id="courierLoginInput" type="text" placeholder="login">
          </label>

          <label>Parol
            <input id="courierPassInput" type="password" placeholder="â€¢â€¢â€¢â€¢">
          </label>
        </div>

        <button id="courierLoginBtn" class="btn-primary btn-full">
          Kirish
        </button>

      </article>
    </section>


    <!-- KURYER PANELI -->
    <section id="courierAppSection" class="courier-app-section hidden">

      <article class="courier-card">

        <div class="courier-top-panel">

          <!-- INFO -->
          <div class="courier-info-card">
            <div class="courier-info-main">

              <div class="courier-avatar">ğŸšš</div>

              <div>
                <div id="courierNameText" class="courier-name"></div>
                <div id="courierCarText" class="courier-meta"></div>

                <div class="courier-status-toggle">
                  <button id="goOnlineBtn" class="btn-xs btn-xs-primary">Online</button>
                  <button id="goOfflineBtn" class="btn-xs btn-xs-secondary">Offline</button>

                  <span id="courierStatusIndicator"
                        class="status-indicator offline">Offline</span>
                </div>

              </div>

            </div>
          </div>


          <!-- STATISTIKA -->
          <div class="courier-stats-row">
            <div class="courier-stat-card">
              <div class="stat-label">Bugun yetkazilgan</div>
              <div id="statTodayCount" class="stat-value">0</div>
              <div class="stat-sub">ta buyurtma</div>
            </div>

            <div class="courier-stat-card">
              <div class="stat-label">Bugun umumiy summa</div>
              <div id="statTodaySum" class="stat-value">0</div>
              <div class="stat-sub">soâ€˜m</div>
            </div>
          </div>


          <!-- TABS -->
          <div class="courier-tabs">
            <button class="courier-tab-btn active" data-tab="available">ğŸ†• Yangi zakazlar</button>
            <button class="courier-tab-btn" data-tab="my">ğŸ“¦ Mening zakazlarim</button>
            <button class="courier-tab-btn" data-tab="done">âœ… Yetkazilganlar</button>
          </div>

        </div>

      </article>



      <!-- Yangi -->
      <section id="courierTabAvailable" class="courier-tab-page">
        <h3 class="section-title-sm">ğŸ†• Yangi zakazlar</h3>
        <div id="courierAvailableList" class="courier-orders-list"></div>
      </section>

      <!-- Mening -->
      <section id="courierTabMy" class="courier-tab-page hidden">
        <h3 class="section-title-sm">ğŸ“¦ Mening zakazlarim</h3>
        <div id="courierMyList" class="courier-orders-list"></div>
      </section>

      <!-- Yakunlangan -->
      <section id="courierTabDone" class="courier-tab-page hidden">
        <h3 class="section-title-sm">âœ… Yetkazilganlar</h3>
        <div id="courierDoneList" class="courier-orders-list"></div>
      </section>

    </section>

  </main>



  <!-- TOAST + SOUND -->
  <div id="courierToast" class="toast"></div>
  <audio id="courierNotify" src="ding.mp3" preload="auto"></audio>



  <!-- ============================ -->
  <!--         JS LOGIKA           -->
  <!-- ============================ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      getDocs,
      onSnapshot,
      updateDoc,
      query,
      orderBy,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyDVidcgjpUxkg88bxXfIFzmsFydv0rMMao",
      authDomain: "shahboz-5d0a3.firebaseapp.com",
      projectId: "shahboz-5d0a3",
      storageBucket: "shahboz-5d0a3.firebasestorage.app",
      messagingSenderId: "352024095535",
      appId: "1:352024095535:web:3f495ac74cdd40f5c54fda",
      measurementId: "G-J8KFW5ED77"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const ordersCol = collection(db, "orders");
    const couriersCol = collection(db, "couriers");


    // =========================
    // STATE
    // =========================
    let currentCourier = null;
    let orders = [];
    let unsub = null;
    let lastSnapshotTs = 0;




    // =========================
    // UTIL
    // =========================
    function formatPrice(v) {
      return (v || 0).toLocaleString("uz-UZ");
    }

    function showToast(msg, duration = 2000) {
      const t = document.getElementById("courierToast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), duration);
    }

    function playNotify() {
      const s = document.getElementById("courierNotify");
      s.currentTime = 0;
      s.play().catch(() => {});
    }

    function isToday(seconds) {
      if (!seconds) return false;
      const d = new Date(seconds * 1000);
      const now = new Date();
      return (
        d.getFullYear() === now.getFullYear() &&
        d.getMonth() === now.getMonth() &&
        d.getDate() === now.getDate()
      );
    }



    // ==============================
    // LOGIN â€” Admin qoâ€˜shgan kuryer
    // ==============================
    async function handleLogin() {
      const login = document.getElementById("courierLoginInput").value.trim().toLowerCase();
      const pass = document.getElementById("courierPassInput").value.trim();

      if (!login || !pass) {
        showToast("Login va parolni kiriting");
        return;
      }

      const all = await getDocs(couriersCol);
      let found = null;

      all.forEach(d => {
        const c = d.data();
        if (c.login.toLowerCase() === login && c.password === pass) {
          found = { id: d.id, ...c };
        }
      });

      if (!found) {
        showToast("Login yoki parol notoâ€˜gâ€˜ri");
        return;
      }

      currentCourier = found;
      localStorage.setItem("courier_auth", JSON.stringify(found));

      initCourierUI(found);
      subscribeOrders();

      showToast("Xush kelibsiz, " + found.name);
    }



    // ==============================
    // UI
    // ==============================
    function initCourierUI(c) {
      document.getElementById("courierLoginSection").classList.add("hidden");
      document.getElementById("courierAppSection").classList.remove("hidden");

      document.getElementById("courierNameText").textContent = c.name;
      document.getElementById("courierCarText").textContent =
        "ğŸ“ " + c.phone + " â€¢ ğŸš— " + c.car + " â€¢ " + c.plate;

      updateStatusIndicator(c.online ? true : false);
    }

    function updateStatusIndicator(isOnline) {
      const el = document.getElementById("courierStatusIndicator");

      if (isOnline) {
        el.textContent = "Online";
        el.classList.add("online");
        el.classList.remove("offline");
      } else {
        el.textContent = "Offline";
        el.classList.add("offline");
        el.classList.remove("online");
      }
    }



    // ==============================
    // ONLINE / OFFLINE
    // ==============================
    async function setCourierStatus(state) {
      if (!currentCourier) return;

      await updateDoc(doc(db, "couriers", currentCourier.id), {
        online: state,
        updatedAt: serverTimestamp()
      });

      currentCourier.online = state;
      updateStatusIndicator(state);

      showToast(state ? "Online boâ€˜ldingiz" : "Offline boâ€˜ldingiz");
    }

    document.getElementById("goOnlineBtn").onclick = () => setCourierStatus(true);
    document.getElementById("goOfflineBtn").onclick = () => setCourierStatus(false);



    // ==============================
    // ZAKAZLARNI REAL-TIME KOâ€˜RISH
    // ==============================
    function subscribeOrders() {
      if (unsub) unsub();

      unsub = onSnapshot(query(ordersCol, orderBy("createdAt", "desc")), snap => {
        let arr = [];
        let maxTs = lastSnapshotTs;

        snap.forEach(d => {
          const o = { id: d.id, ...d.data() };
          arr.push(o);
          const s = o.createdAt?.seconds || 0;
          if (s > maxTs) maxTs = s;
        });

        // Ding â€“ faqat yangi order tushsa
        if (currentCourier?.online) {
          const newOnes = arr.filter(
            o => o.status === "courier" && !o.courierLogin && o.createdAt?.seconds > lastSnapshotTs
          );
          if (newOnes.length) playNotify();
        }

        lastSnapshotTs = maxTs;
        orders = arr;

        renderLists();
      });
    }



    // ==============================
    // LISTLARNI RENDER QILISH
    // ==============================
    function renderLists() {
      if (!currentCourier) return;

      const available = orders.filter(
        o => o.status === "courier" && !o.courierLogin
      );

      const mine = orders.filter(
        o => o.status === "courier" && o.courierLogin === currentCourier.login
      );

      const done = orders.filter(
        o => o.status === "delivered" && o.courierLogin === currentCourier.login
      );


      render("courierAvailableList", available, "available");
      render("courierMyList", mine, "my");
      render("courierDoneList", done, "done");

      // statistika
      let cnt = 0, sum = 0;
      done.forEach(o => {
        if (isToday(o.deliveredAt?.seconds)) {
          cnt++;
          sum += o.totalPrice || 0;
        }
      });
      document.getElementById("statTodayCount").textContent = cnt;
      document.getElementById("statTodaySum").textContent = formatPrice(sum);
    }



    function render(targetId, list, type) {
      const el = document.getElementById(targetId);
      if (!list.length) {
        el.innerHTML = "<p class='cart-empty'>Hozircha yoâ€˜q.</p>";
        return;
      }
      el.innerHTML = "";

      list.forEach(o => {

        const customer = o.customer || {};

        const items = (o.items || [])
          .map(i => `<li>${i.name} â€” ${i.qty} Ã— ${formatPrice(i.price)}</li>`)
          .join("");

        const hasLoc = o.location?.lat && o.location?.lng;

        let btns = "";

        if (type === "available") {
          btns = `
            <button class="btn-xs btn-xs-primary" onclick="takeOrder('${o.id}')">Qabul qilish</button>
            ${hasLoc ? `<button class="btn-xs btn-xs-secondary" onclick="openMap(${o.location.lat},${o.location.lng})">ğŸ“ Marshrut</button>` : ""}
          `;
        }

        if (type === "my") {
          btns = `
            ${hasLoc ? `<button class="btn-xs btn-xs-secondary" onclick="openMap(${o.location.lat},${o.location.lng})">ğŸ“ Marshrut</button>` : ""}
            <button class="btn-xs btn-xs-primary" onclick="markDelivered('${o.id}')">Yetkazdim</button>
          `;
        }

        if (type === "done") {
          btns = `${hasLoc ? `<button class="btn-xs btn-xs-secondary" onclick="openMap(${o.location.lat},${o.location.lng})">ğŸ“ Marshrut</button>` : ""}`;
        }


        el.innerHTML += `
          <article class="order-card courier-order-card">
            <header class="order-header">
              <div>
                <div class="order-id">ID: ${o.id.slice(0,8)}...</div>
                <div class="order-customer">ğŸ‘¤ ${customer.name || "-"} â€¢ ğŸ“± ${customer.phone || "-"}</div>
                <div class="order-customer">ğŸ“ ${customer.address || "-"}</div>
              </div>
              <div class="order-total">${formatPrice(o.totalPrice)} soâ€˜m</div>
            </header>

            <section class="order-items">
              <ul>${items}</ul>
            </section>

            <footer class="courier-card-footer">${btns}</footer>
          </article>
        `;
      });
    }



    // ==============================
    // ORDER ACTIONS
    // ==============================
    window.takeOrder = async function(id) {
      if (!currentCourier) return;

      await updateDoc(doc(db, "orders", id), {
        courierLogin: currentCourier.login,
        courierName: currentCourier.name,
        courierCar: currentCourier.car,
        status: "courier",
        courierTakenAt: serverTimestamp()
      });

      showToast("Sizga biriktirildi");
    };


    window.markDelivered = async function(id) {
      if (!currentCourier) return;

      const ok = confirm("Yetkazdingizmi?");
      if (!ok) return;

      await updateDoc(doc(db, "orders", id), {
        status: "delivered",
        deliveredAt: serverTimestamp()
      });

      showToast("Yetkazilgan deb belgilandi");
    };


    window.openMap = function(lat, lng) {
      window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, "_blank");
    };



    // ==============================
    // LOGOUT
    // ==============================
    document.getElementById("courierLogoutBtn").onclick = () => {
      localStorage.removeItem("courier_auth");
      location.reload();
    };


    // ==============================
    // AUTO LOGIN
    // ==============================
    (function init() {
      const stored = localStorage.getItem("courier_auth");
      if (stored) {
        currentCourier = JSON.parse(stored);
        initCourierUI(currentCourier);
        subscribeOrders();
      }
    })();

  </script>

</body>
</html>
