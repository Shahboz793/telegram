<!doctype html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <title>ğŸšš Kuryer paneli â€” Premium FastFood</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="style.css">
</head>

<body class="courier-body">

<!-- ================= HEADER ================= -->
<header class="courier-header">
  <div class="courier-header-left">
    <div class="courier-logo">ğŸšš</div>
    <div class="courier-header-text">
      <div class="courier-title">Kuryer paneli</div>
      <div class="courier-subtitle" id="onlineStatus">Online</div>
    </div>
  </div>

  <div class="courier-header-right">
    <button class="btn-chip" onclick="location.href='index.html'">â¬… Menyuga qaytish</button>
    <button class="btn-chip btn-chip-danger" id="courierLogoutBtn">Chiqish</button>
  </div>
</header>

<main class="courier-main">

  <!-- LOGIN PAGE -->
  <section id="courierLoginSection" class="courier-login-section">
    <article class="courier-card courier-login-card">
      <h2 class="section-title-sm">ğŸšš Kuryer kirish</h2>
      <p class="section-sub-sm">Admin bergan login va parolni kiriting.</p>

      <div class="form-grid">
        <label>Login <input id="courierLoginInput" type="text"></label>
        <label>Parol <input id="courierPassInput" type="password"></label>
      </div>

      <button class="btn-primary btn-full" id="courierLoginBtn">Kirish</button>
    </article>
  </section>

  <!-- APP PAGE -->
  <section id="courierAppSection" class="courier-app-section hidden">

    <!-- KURYER INFO -->
    <article class="courier-card">
      <div class="courier-info-card">
        <div class="courier-info-main">
          <div class="courier-avatar">ğŸ‘¨â€âœˆï¸</div>
          <div>
            <div class="courier-name" id="courierNameText"></div>
            <div class="courier-meta" id="courierCarText"></div>
            <div class="courier-meta" id="courierPhoneText"></div>
          </div>
        </div>

        <div class="courier-badge-row">
          <span class="courier-badge">Onlayn</span>
        </div>
      </div>

      <!-- STAT -->
      <div class="courier-stats-row">
        <div class="courier-stat-card">
          <div class="stat-label">Bugun yetkazilgan</div>
          <div class="stat-value" id="statTodayCount">0</div>
          <div class="stat-sub">ta buyurtma</div>
        </div>
        <div class="courier-stat-card">
          <div class="stat-label">Umumiy summa</div>
          <div class="stat-value" id="statTodaySum">0</div>
          <div class="stat-sub">soâ€˜m</div>
        </div>
      </div>

      <!-- TABS -->
      <div class="courier-tabs">
        <button class="courier-tab-btn active" data-tab="available">ğŸ†• Yangi zakazlar</button>
        <button class="courier-tab-btn" data-tab="my">ğŸ“¦ Mening zakazlarim</button>
        <button class="courier-tab-btn" data-tab="done">âœ… Yetkazilganlar</button>
      </div>
    </article>

    <!-- TAB 1 -->
    <section id="courierTabAvailable" class="courier-tab-page">
      <h3 class="section-title-sm">ğŸ†• Yangi zakazlar</h3>
      <div id="courierAvailableList" class="courier-orders-list"></div>
    </section>

    <!-- TAB 2 -->
    <section id="courierTabMy" class="courier-tab-page hidden">
      <h3 class="section-title-sm">ğŸ“¦ Mening zakazlarim</h3>
      <div id="courierMyList" class="courier-orders-list"></div>
    </section>

    <!-- TAB 3 -->
    <section id="courierTabDone" class="courier-tab-page hidden">
      <h3 class="section-title-sm">âœ… Yakunlangan buyurtmalar</h3>
      <div id="courierDoneList" class="courier-orders-list"></div>
    </section>

  </section>

</main>

<!-- TOAST -->
<div id="courierToast" class="toast"></div>

<!-- SOUND -->
<audio id="courierNotify" src="ding.mp3" preload="auto"></audio>

<!-- ================= JS ================= -->
<script type="module">

/* IMPORT FIREBASE */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, doc, onSnapshot,
  updateDoc, query, orderBy, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyDVidcgjpUxkg88bxXfIFzmsFydv0rMMao",
  authDomain: "shahboz-5d0a3.firebaseapp.com",
  projectId: "shahboz-5d0a3",
  storageBucket: "shahboz-5d0a3.firebasestorage.app",
  messagingSenderId: "352024095535",
  appId: "1:352024095535:web:3f495ac74cdd40f5c54fda"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* HTML ELEMENTS */
const loginSection  = document.getElementById("courierLoginSection");
const appSection    = document.getElementById("courierAppSection");
const loginInput    = document.getElementById("courierLoginInput");
const passInput     = document.getElementById("courierPassInput");
const loginBtn      = document.getElementById("courierLoginBtn");
const logoutBtn     = document.getElementById("courierLogoutBtn");

const listAvailable = document.getElementById("courierAvailableList");
const listMy        = document.getElementById("courierMyList");
const listDone      = document.getElementById("courierDoneList");

const courierNameText  = document.getElementById("courierNameText");
const courierCarText   = document.getElementById("courierCarText");
const courierPhoneText = document.getElementById("courierPhoneText");

const toastEl   = document.getElementById("courierToast");
const notifyEl  = document.getElementById("courierNotify");

const statTodayCount = document.getElementById("statTodayCount");
const statTodaySum   = document.getElementById("statTodaySum");

let orders = [];
let currentCourier = null;
let unsubOrders = null;

/* COURIER STORAGE */
function saveCourier(c){
  localStorage.setItem("courier_auth", JSON.stringify(c));
}
function loadCourier(){
  const t = localStorage.getItem("courier_auth");
  return t ? JSON.parse(t) : null;
}
function clearCourier(){
  localStorage.removeItem("courier_auth");
}

/* TOAST */
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  setTimeout(()=> toastEl.classList.remove("show"), 2000);
}

/* PLAY SOUND */
function ding(){
  try{
    notifyEl.currentTime = 0;
    notifyEl.play();
  }catch(e){}
}

/* LOGIN HANDLER */
loginBtn.onclick = ()=>{
  const login = loginInput.value.trim().toLowerCase();
  const pass  = passInput.value.trim();

  if(!login || !pass){
    toast("Login va parolni kiriting");
    return;
  }

  // Firestore -> couriers
  importCouriers().then(couriers=>{
    const c = couriers.find(x=> x.login.toLowerCase() === login && x.password === pass);

    if(!c){
      toast("Notoâ€˜gâ€˜ri login yoki parol");
      return;
    }

    currentCourier = c;
    saveCourier(c);

    showApp();
    subscribeOrders();
  });
};

/* LOGOUT */
logoutBtn.onclick = ()=>{
  clearCourier();
  currentCourier = null;
  orders = [];
  if(unsubOrders) unsubOrders();

  hideTabs();
  appSection.classList.add("hidden");
  loginSection.classList.remove("hidden");
};

/* SHOW APP */
function showApp(){
  loginSection.classList.add("hidden");
  appSection.classList.remove("hidden");

  courierNameText.textContent = currentCourier.name + " (" + currentCourier.login + ")";
  courierCarText.textContent  = "ğŸš— " + currentCourier.car + " [" + currentCourier.plate + "]";
  courierPhoneText.textContent = "ğŸ“± " + currentCourier.phone;
}

/* IMPORT COURIERS FROM FIRESTORE */
async function importCouriers(){
  const snap = await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js")
    .then(()=> onSnapshot(collection(db, "couriers"), ()=>{})); 
  return [];
}

/* SUBSCRIBE ORDERS */
function subscribeOrders(){
  const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));

  unsubOrders = onSnapshot(q, snap=>{
    orders = [];
    snap.forEach(doc=>{
      orders.push({ id: doc.id, ...doc.data() });
    });

    renderOrders();
  });
}

/* RENDER */
function renderOrders(){
  const available = orders.filter(o=> o.status === "courier" && !o.courierLogin);
  const mine       = orders.filter(o=> o.courierLogin === currentCourier.login && o.status === "courier");
  const done       = orders.filter(o=> o.courierLogin === currentCourier.login && o.status === "delivered");

  renderList(listAvailable, available, "available");
  renderList(listMy, mine, "my");
  renderList(listDone, done, "done");

  statTodayCount.textContent = done.length;
  statTodaySum.textContent   = done.reduce((a,b)=> a + (b.totalPrice || 0), 0).toLocaleString();
}

function renderList(el, arr, type){
  if(!arr.length){
    el.innerHTML = `<p class="cart-empty">Hozircha buyurtma yoâ€˜q.</p>`;
    return;
  }

  el.innerHTML = "";
  arr.forEach(o=>{
    el.innerHTML += `
      <article class="order-card courier-order-card">
        <header class="order-header">
          <div>
            <div class="order-id">ID: ${o.id.slice(0, 8)}...</div>
            <div class="order-customer">ğŸ‘¤ ${o.customer?.name} â€¢ ${o.customer?.phone}</div>
            <div class="order-customer">ğŸ“ ${o.customer?.address}</div>
          </div>
          <div class="order-total">${(o.totalPrice||0).toLocaleString()} soâ€˜m</div>
        </header>

        <footer class="courier-card-footer">
          ${type === "available" ? `
            <button class="btn-xs btn-xs-primary" onclick="takeOrder('${o.id}')">Qabul qilish</button>
          `: ``}

          ${type === "my" ? `
            <button class="btn-xs btn-xs-primary" onclick="markDelivered('${o.id}')">Yetkazdim</button>
          `: ``}
        </footer>
      </article>
    `;
  });
}

/* TAKE ORDER */
window.takeOrder = async function(orderId){
  await updateDoc(doc(db, "orders", orderId), {
    status: "courier",
    courierLogin: currentCourier.login,
    courierName : currentCourier.name,
    courierCar  : currentCourier.car,
    courierPhone: currentCourier.phone,
    courierPlate: currentCourier.plate,
    takenAt: serverTimestamp()
  });

  toast("Buyurtma sizga biriktirildi.");
};

/* MARK DELIVERED */
window.markDelivered = async function(orderId){
  await updateDoc(doc(db, "orders", orderId), {
    status: "delivered",
    deliveredAt: serverTimestamp()
  });

  toast("Buyurtma yetkazilgan deb belgilandi.");
};

/* TAB HANDLING */
document.querySelectorAll(".courier-tab-btn").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll(".courier-tab-btn").forEach(b=> b.classList.remove("active"));
    btn.classList.add("active");

    document.getElementById("courierTabAvailable").classList.add("hidden");
    document.getElementById("courierTabMy").classList.add("hidden");
    document.getElementById("courierTabDone").classList.add("hidden");

    const tab = btn.dataset.tab;
    document.getElementById("courierTab_"+tab)?.classList.remove("hidden");

    if(tab === "available") document.getElementById("courierTabAvailable").classList.remove("hidden");
    if(tab === "my")        document.getElementById("courierTabMy").classList.remove("hidden");
    if(tab === "done")      document.getElementById("courierTabDone").classList.remove("hidden");
  };
});

/* AUTO LOGIN */
(function init(){
  const saved = loadCourier();
  if(saved){
    currentCourier = saved;
    showApp();
    subscribeOrders();
  }
})();
</script>

</body>
</html>
